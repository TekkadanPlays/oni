import"./chunk-tvrdndbw.js";function m7(J){return J&&J.__esModule&&Object.prototype.hasOwnProperty.call(J,"default")?J.default:J}var o8={exports:{}};(function(J,Y){(function(Z){var Q=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,X=/^(?=([^\/?#]*))\1([^]*)$/,q=/(?:\/|^)\.(?=\/)/g,W=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,z={buildAbsoluteURL:function(H,G,j){if(j=j||{},H=H.trim(),G=G.trim(),!G){if(!j.alwaysNormalize)return H;var N=z.parseURL(H);if(!N)throw new Error("Error trying to parse base URL.");return N.path=z.normalizePath(N.path),z.buildURLFromParts(N)}var K=z.parseURL(G);if(!K)throw new Error("Error trying to parse relative URL.");if(K.scheme){if(!j.alwaysNormalize)return G;return K.path=z.normalizePath(K.path),z.buildURLFromParts(K)}var V=z.parseURL(H);if(!V)throw new Error("Error trying to parse base URL.");if(!V.netLoc&&V.path&&V.path[0]!=="/"){var U=X.exec(V.path);V.netLoc=U[1],V.path=U[2]}if(V.netLoc&&!V.path)V.path="/";var O={scheme:V.scheme,netLoc:K.netLoc,path:null,params:K.params,query:K.query,fragment:K.fragment};if(!K.netLoc){if(O.netLoc=V.netLoc,K.path[0]!=="/")if(!K.path){if(O.path=V.path,!K.params){if(O.params=V.params,!K.query)O.query=V.query}}else{var _=V.path,A=_.substring(0,_.lastIndexOf("/")+1)+K.path;O.path=z.normalizePath(A)}}if(O.path===null)O.path=j.alwaysNormalize?z.normalizePath(K.path):K.path;return z.buildURLFromParts(O)},parseURL:function(H){var G=Q.exec(H);if(!G)return null;return{scheme:G[1]||"",netLoc:G[2]||"",path:G[3]||"",params:G[4]||"",query:G[5]||"",fragment:G[6]||""}},normalizePath:function(H){H=H.split("").reverse().join("").replace(q,"");while(H.length!==(H=H.replace(W,"")).length);return H.split("").reverse().join("")},buildURLFromParts:function(H){return H.scheme+H.netLoc+H.path+H.params+H.query+H.fragment}};J.exports=z})()})(o8);var DJ=o8.exports;function aJ(J,Y){var Z=Object.keys(J);if(Object.getOwnPropertySymbols){var Q=Object.getOwnPropertySymbols(J);Y&&(Q=Q.filter(function(X){return Object.getOwnPropertyDescriptor(J,X).enumerable})),Z.push.apply(Z,Q)}return Z}function z0(J){for(var Y=1;Y<arguments.length;Y++){var Z=arguments[Y]!=null?arguments[Y]:{};Y%2?aJ(Object(Z),!0).forEach(function(Q){f7(J,Q,Z[Q])}):Object.getOwnPropertyDescriptors?Object.defineProperties(J,Object.getOwnPropertyDescriptors(Z)):aJ(Object(Z)).forEach(function(Q){Object.defineProperty(J,Q,Object.getOwnPropertyDescriptor(Z,Q))})}return J}function g7(J,Y){if(typeof J!="object"||!J)return J;var Z=J[Symbol.toPrimitive];if(Z!==void 0){var Q=Z.call(J,Y||"default");if(typeof Q!="object")return Q;throw new TypeError("@@toPrimitive must return a primitive value.")}return(Y==="string"?String:Number)(J)}function u7(J){var Y=g7(J,"string");return typeof Y=="symbol"?Y:String(Y)}function f7(J,Y,Z){if(Y=u7(Y),Y in J)Object.defineProperty(J,Y,{value:Z,enumerable:!0,configurable:!0,writable:!0});else J[Y]=Z;return J}function Y0(){return Y0=Object.assign?Object.assign.bind():function(J){for(var Y=1;Y<arguments.length;Y++){var Z=arguments[Y];for(var Q in Z)if(Object.prototype.hasOwnProperty.call(Z,Q))J[Q]=Z[Q]}return J},Y0.apply(this,arguments)}var h=Number.isFinite||function(J){return typeof J==="number"&&isFinite(J)},c7=Number.isSafeInteger||function(J){return typeof J==="number"&&Math.abs(J)<=d7},d7=Number.MAX_SAFE_INTEGER||9007199254740991,$=function(J){return J.MEDIA_ATTACHING="hlsMediaAttaching",J.MEDIA_ATTACHED="hlsMediaAttached",J.MEDIA_DETACHING="hlsMediaDetaching",J.MEDIA_DETACHED="hlsMediaDetached",J.BUFFER_RESET="hlsBufferReset",J.BUFFER_CODECS="hlsBufferCodecs",J.BUFFER_CREATED="hlsBufferCreated",J.BUFFER_APPENDING="hlsBufferAppending",J.BUFFER_APPENDED="hlsBufferAppended",J.BUFFER_EOS="hlsBufferEos",J.BUFFER_FLUSHING="hlsBufferFlushing",J.BUFFER_FLUSHED="hlsBufferFlushed",J.MANIFEST_LOADING="hlsManifestLoading",J.MANIFEST_LOADED="hlsManifestLoaded",J.MANIFEST_PARSED="hlsManifestParsed",J.LEVEL_SWITCHING="hlsLevelSwitching",J.LEVEL_SWITCHED="hlsLevelSwitched",J.LEVEL_LOADING="hlsLevelLoading",J.LEVEL_LOADED="hlsLevelLoaded",J.LEVEL_UPDATED="hlsLevelUpdated",J.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",J.LEVELS_UPDATED="hlsLevelsUpdated",J.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",J.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",J.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",J.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",J.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",J.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",J.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",J.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",J.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",J.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",J.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",J.CUES_PARSED="hlsCuesParsed",J.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",J.INIT_PTS_FOUND="hlsInitPtsFound",J.FRAG_LOADING="hlsFragLoading",J.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",J.FRAG_LOADED="hlsFragLoaded",J.FRAG_DECRYPTED="hlsFragDecrypted",J.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",J.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",J.FRAG_PARSING_METADATA="hlsFragParsingMetadata",J.FRAG_PARSED="hlsFragParsed",J.FRAG_BUFFERED="hlsFragBuffered",J.FRAG_CHANGED="hlsFragChanged",J.FPS_DROP="hlsFpsDrop",J.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",J.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",J.ERROR="hlsError",J.DESTROYING="hlsDestroying",J.KEY_LOADING="hlsKeyLoading",J.KEY_LOADED="hlsKeyLoaded",J.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",J.BACK_BUFFER_REACHED="hlsBackBufferReached",J.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",J}({}),g=function(J){return J.NETWORK_ERROR="networkError",J.MEDIA_ERROR="mediaError",J.KEY_SYSTEM_ERROR="keySystemError",J.MUX_ERROR="muxError",J.OTHER_ERROR="otherError",J}({}),I=function(J){return J.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",J.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",J.KEY_SYSTEM_NO_SESSION="keySystemNoSession",J.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",J.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",J.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",J.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",J.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",J.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",J.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",J.MANIFEST_LOAD_ERROR="manifestLoadError",J.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",J.MANIFEST_PARSING_ERROR="manifestParsingError",J.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",J.LEVEL_EMPTY_ERROR="levelEmptyError",J.LEVEL_LOAD_ERROR="levelLoadError",J.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",J.LEVEL_PARSING_ERROR="levelParsingError",J.LEVEL_SWITCH_ERROR="levelSwitchError",J.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",J.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",J.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",J.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",J.FRAG_LOAD_ERROR="fragLoadError",J.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",J.FRAG_DECRYPT_ERROR="fragDecryptError",J.FRAG_PARSING_ERROR="fragParsingError",J.FRAG_GAP="fragGap",J.REMUX_ALLOC_ERROR="remuxAllocError",J.KEY_LOAD_ERROR="keyLoadError",J.KEY_LOAD_TIMEOUT="keyLoadTimeOut",J.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",J.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",J.BUFFER_APPEND_ERROR="bufferAppendError",J.BUFFER_APPENDING_ERROR="bufferAppendingError",J.BUFFER_STALLED_ERROR="bufferStalledError",J.BUFFER_FULL_ERROR="bufferFullError",J.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",J.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",J.INTERNAL_EXCEPTION="internalException",J.INTERNAL_ABORTED="aborted",J.UNKNOWN="unknown",J}({}),h0=function J(){},HJ={trace:h0,debug:h0,log:h0,warn:h0,info:h0,error:h0},J6=HJ;function l7(J){let Y=self.console[J];if(Y)return Y.bind(self.console,`[${J}] >`);return h0}function o7(J,...Y){Y.forEach(function(Z){J6[Z]=J[Z]?J[Z].bind(J):l7(Z)})}function n7(J,Y){if(typeof console==="object"&&J===!0||typeof J==="object"){o7(J,"debug","log","info","warn","error");try{J6.log(`Debug logs enabled for "${Y}" in hls.js version 1.5.18`)}catch(Z){J6=HJ}}else J6=HJ}var B=J6,i7=/^(\d+)x(\d+)$/,tJ=/(.+?)=(".*?"|.*?)(?:,|$)/g;class J0{constructor(J){if(typeof J==="string")J=J0.parseAttrList(J);Y0(this,J)}get clientAttrs(){return Object.keys(this).filter((J)=>J.substring(0,2)==="X-")}decimalInteger(J){let Y=parseInt(this[J],10);if(Y>Number.MAX_SAFE_INTEGER)return 1/0;return Y}hexadecimalInteger(J){if(this[J]){let Y=(this[J]||"0x").slice(2);Y=(Y.length&1?"0":"")+Y;let Z=new Uint8Array(Y.length/2);for(let Q=0;Q<Y.length/2;Q++)Z[Q]=parseInt(Y.slice(Q*2,Q*2+2),16);return Z}else return null}hexadecimalIntegerAsNumber(J){let Y=parseInt(this[J],16);if(Y>Number.MAX_SAFE_INTEGER)return 1/0;return Y}decimalFloatingPoint(J){return parseFloat(this[J])}optionalFloat(J,Y){let Z=this[J];return Z?parseFloat(Z):Y}enumeratedString(J){return this[J]}bool(J){return this[J]==="YES"}decimalResolution(J){let Y=i7.exec(this[J]);if(Y===null)return;return{width:parseInt(Y[1],10),height:parseInt(Y[2],10)}}static parseAttrList(J){let Y,Z={},Q='"';tJ.lastIndex=0;while((Y=tJ.exec(J))!==null){let X=Y[2];if(X.indexOf('"')===0&&X.lastIndexOf('"')===X.length-1)X=X.slice(1,-1);let q=Y[1].trim();Z[q]=X}return Z}}function s7(J){return J!=="ID"&&J!=="CLASS"&&J!=="START-DATE"&&J!=="DURATION"&&J!=="END-DATE"&&J!=="END-ON-NEXT"}function r7(J){return J==="SCTE35-OUT"||J==="SCTE35-IN"}class TJ{constructor(J,Y){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,Y){let Z=Y.attr;for(let Q in Z)if(Object.prototype.hasOwnProperty.call(J,Q)&&J[Q]!==Z[Q]){B.warn(`DATERANGE tag attribute: "${Q}" does not match for tags with ID: "${J.ID}"`),this._badValueForSameId=Q;break}J=Y0(new J0({}),Z,J)}if(this.attr=J,this._startDate=new Date(J["START-DATE"]),"END-DATE"in this.attr){let Z=new Date(this.attr["END-DATE"]);if(h(Z.getTime()))this._endDate=Z}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;let J=this.duration;if(J!==null)return new Date(this._startDate.getTime()+J*1000);return null}get duration(){if("DURATION"in this.attr){let J=this.attr.decimalFloatingPoint("DURATION");if(h(J))return J}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1000;return null}get plannedDuration(){if("PLANNED-DURATION"in this.attr)return this.attr.decimalFloatingPoint("PLANNED-DURATION");return null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&h(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class q6{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var s={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class SJ{constructor(J){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[s.AUDIO]:null,[s.VIDEO]:null,[s.AUDIOVIDEO]:null},this.baseurl=J}setByteRange(J,Y){let Z=J.split("@",2),Q;if(Z.length===1)Q=(Y==null?void 0:Y.byteRangeEndOffset)||0;else Q=parseInt(Z[1]);this._byteRange=[Q,parseInt(Z[0])+Q]}get byteRange(){if(!this._byteRange)return[];return this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){if(!this._url&&this.baseurl&&this.relurl)this._url=DJ.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0});return this._url||""}set url(J){this._url=J}}class O6 extends SJ{constructor(J,Y){super(Y);this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new q6,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=J}get decryptdata(){let{levelkeys:J}=this;if(!J&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let Y=this.levelkeys.identity;if(Y)this._decryptdata=Y.getDecryptData(this.sn);else{let Z=Object.keys(this.levelkeys);if(Z.length===1)return this._decryptdata=this.levelkeys[Z[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null)return null;if(!h(this.programDateTime))return null;let J=!h(this.duration)?0:this.duration;return this.programDateTime+J*1000}get encrypted(){var J;if((J=this._decryptdata)!=null&&J.encrypted)return!0;else if(this.levelkeys){let Y=Object.keys(this.levelkeys),Z=Y.length;if(Z>1||Z===1&&this.levelkeys[Y[0]].encrypted)return!0}return!1}setKeyFormat(J){if(this.levelkeys){let Y=this.levelkeys[J];if(Y&&!this._decryptdata)this._decryptdata=Y.getDecryptData(this.sn)}}abortRequests(){var J,Y;(J=this.loader)==null||J.abort(),(Y=this.keyLoader)==null||Y.abort()}setElementaryStreamInfo(J,Y,Z,Q,X,q=!1){let{elementaryStreams:W}=this,z=W[J];if(!z){W[J]={startPTS:Y,endPTS:Z,startDTS:Q,endDTS:X,partial:q};return}z.startPTS=Math.min(z.startPTS,Y),z.endPTS=Math.max(z.endPTS,Z),z.startDTS=Math.min(z.startDTS,Q),z.endDTS=Math.max(z.endDTS,X)}clearElementaryStreamInfo(){let{elementaryStreams:J}=this;J[s.AUDIO]=null,J[s.VIDEO]=null,J[s.AUDIOVIDEO]=null}}class n8 extends SJ{constructor(J,Y,Z,Q,X){super(Z);this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new q6,this.duration=J.decimalFloatingPoint("DURATION"),this.gap=J.bool("GAP"),this.independent=J.bool("INDEPENDENT"),this.relurl=J.enumeratedString("URI"),this.fragment=Y,this.index=Q;let q=J.enumeratedString("BYTERANGE");if(q)this.setByteRange(q,X);if(X)this.fragOffset=X.fragOffset+X.duration}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams:J}=this;return!!(J.audio||J.video||J.audiovideo)}}var a7=10;class i8{constructor(J){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=J}reloaded(J){if(!J){this.advanced=!0,this.updated=!0;return}let Y=this.lastPartSn-J.lastPartSn,Z=this.lastPartIndex-J.lastPartIndex;if(this.updated=this.endSN!==J.endSN||!!Z||!!Y||!this.live,this.advanced=this.endSN>J.endSN||Y>0||Y===0&&Z>0,this.updated||this.advanced)this.misses=Math.floor(J.misses*0.6);else this.misses=J.misses+1;this.availabilityDelay=J.availabilityDelay}get hasProgramDateTime(){if(this.fragments.length)return h(this.fragments[this.fragments.length-1].programDateTime);return!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||a7}get drift(){let J=this.driftEndTime-this.driftStartTime;if(J>0)return(this.driftEnd-this.driftStart)*1000/J;return 1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var J;if((J=this.partList)!=null&&J.length)return this.partList[this.partList.length-1].end;return this.fragmentEnd}get fragmentEnd(){var J;if((J=this.fragments)!=null&&J.length)return this.fragments[this.fragments.length-1].end;return 0}get age(){if(this.advancedDateTime)return Math.max(Date.now()-this.advancedDateTime,0)/1000;return 0}get lastPartIndex(){var J;if((J=this.partList)!=null&&J.length)return this.partList[this.partList.length-1].index;return-1}get lastPartSn(){var J;if((J=this.partList)!=null&&J.length)return this.partList[this.partList.length-1].fragment.sn;return this.endSN}}function hJ(J){return Uint8Array.from(atob(J),(Y)=>Y.charCodeAt(0))}function t7(J){let Y=GJ(J).subarray(0,16),Z=new Uint8Array(16);return Z.set(Y,16-Y.length),Z}function e7(J){let Y=function Z(Q,X,q){let W=Q[X];Q[X]=Q[q],Q[q]=W};Y(J,0,3),Y(J,1,2),Y(J,4,5),Y(J,6,7)}function JZ(J){let Y=J.split(":"),Z=null;if(Y[0]==="data"&&Y.length===2){let Q=Y[1].split(";"),X=Q[Q.length-1].split(",");if(X.length===2){let q=X[0]==="base64",W=X[1];if(q)Q.splice(-1,1),Z=hJ(W);else Z=t7(W)}}return Z}function GJ(J){return Uint8Array.from(unescape(encodeURIComponent(J)),(Y)=>Y.charCodeAt(0))}var i0=typeof self!=="undefined"?self:void 0,t={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},K0={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function eJ(J){switch(J){case K0.FAIRPLAY:return t.FAIRPLAY;case K0.PLAYREADY:return t.PLAYREADY;case K0.WIDEVINE:return t.WIDEVINE;case K0.CLEARKEY:return t.CLEARKEY}}var t0={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",FAIRPLAY:"94ce86fb07ff4f43adb893d2fa968ca2",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function J8(J){if(J===t0.WIDEVINE)return t.WIDEVINE;else if(J===t0.PLAYREADY)return t.PLAYREADY;else if(J===t0.CENC||J===t0.CLEARKEY)return t.CLEARKEY}function Y8(J){switch(J){case t.FAIRPLAY:return K0.FAIRPLAY;case t.PLAYREADY:return K0.PLAYREADY;case t.WIDEVINE:return K0.WIDEVINE;case t.CLEARKEY:return K0.CLEARKEY}}function c6(J){let{drmSystems:Y,widevineLicenseUrl:Z}=J,Q=Y?[t.FAIRPLAY,t.WIDEVINE,t.PLAYREADY,t.CLEARKEY].filter((X)=>!!Y[X]):[];if(!Q[t.WIDEVINE]&&Z)Q.push(t.WIDEVINE);return Q}var s8=function(J){if(i0!=null&&(J=i0.navigator)!=null&&J.requestMediaKeySystemAccess)return self.navigator.requestMediaKeySystemAccess.bind(self.navigator);else return null}();function YZ(J,Y,Z,Q){let X;switch(J){case t.FAIRPLAY:X=["cenc","sinf"];break;case t.WIDEVINE:case t.PLAYREADY:X=["cenc"];break;case t.CLEARKEY:X=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${J}`)}return ZZ(X,Y,Z,Q)}function ZZ(J,Y,Z,Q){return[{initDataTypes:J,persistentState:Q.persistentState||"optional",distinctiveIdentifier:Q.distinctiveIdentifier||"optional",sessionTypes:Q.sessionTypes||[Q.sessionType||"temporary"],audioCapabilities:Y.map((q)=>({contentType:`audio/mp4; codecs="${q}"`,robustness:Q.audioRobustness||"",encryptionScheme:Q.audioEncryptionScheme||null})),videoCapabilities:Z.map((q)=>({contentType:`video/mp4; codecs="${q}"`,robustness:Q.videoRobustness||"",encryptionScheme:Q.videoEncryptionScheme||null}))}]}function v0(J,Y,Z){return Uint8Array.prototype.slice?J.slice(Y,Z):new Uint8Array(Array.prototype.slice.call(J,Y,Z))}var yJ=(J,Y)=>{if(Y+10<=J.length){if(J[Y]===73&&J[Y+1]===68&&J[Y+2]===51){if(J[Y+3]<255&&J[Y+4]<255){if(J[Y+6]<128&&J[Y+7]<128&&J[Y+8]<128&&J[Y+9]<128)return!0}}}return!1},r8=(J,Y)=>{if(Y+10<=J.length){if(J[Y]===51&&J[Y+1]===68&&J[Y+2]===73){if(J[Y+3]<255&&J[Y+4]<255){if(J[Y+6]<128&&J[Y+7]<128&&J[Y+8]<128&&J[Y+9]<128)return!0}}}return!1},Z6=(J,Y)=>{let Z=Y,Q=0;while(yJ(J,Y)){Q+=10;let X=k6(J,Y+6);if(Q+=X,r8(J,Y+10))Q+=10;Y+=Q}if(Q>0)return J.subarray(Z,Z+Q);return},k6=(J,Y)=>{let Z=0;return Z=(J[Y]&127)<<21,Z|=(J[Y+1]&127)<<14,Z|=(J[Y+2]&127)<<7,Z|=J[Y+3]&127,Z},QZ=(J,Y)=>{return yJ(J,Y)&&k6(J,Y+6)+10<=J.length-Y},kJ=(J)=>{let Y=t8(J);for(let Z=0;Z<Y.length;Z++){let Q=Y[Z];if(a8(Q))return GZ(Q)}return},a8=(J)=>{return J&&J.key==="PRIV"&&J.info==="com.apple.streaming.transportStreamTimestamp"},XZ=(J)=>{let Y=String.fromCharCode(J[0],J[1],J[2],J[3]),Z=k6(J,4),Q=10;return{type:Y,size:Z,data:J.subarray(10,10+Z)}},t8=(J)=>{let Y=0,Z=[];while(yJ(J,Y)){let Q=k6(J,Y+6);Y+=10;let X=Y+Q;while(Y+8<X){let q=XZ(J.subarray(Y)),W=qZ(q);if(W)Z.push(W);Y+=q.size+10}if(r8(J,Y))Y+=10}return Z},qZ=(J)=>{if(J.type==="PRIV")return WZ(J);else if(J.type[0]==="W")return HZ(J);return zZ(J)},WZ=(J)=>{if(J.size<2)return;let Y=w0(J.data,!0),Z=new Uint8Array(J.data.subarray(Y.length+1));return{key:J.type,info:Y,data:Z.buffer}},zZ=(J)=>{if(J.size<2)return;if(J.type==="TXXX"){let Z=1,Q=w0(J.data.subarray(Z),!0);Z+=Q.length+1;let X=w0(J.data.subarray(Z));return{key:J.type,info:Q,data:X}}let Y=w0(J.data.subarray(1));return{key:J.type,data:Y}},HZ=(J)=>{if(J.type==="WXXX"){if(J.size<2)return;let Z=1,Q=w0(J.data.subarray(Z),!0);Z+=Q.length+1;let X=w0(J.data.subarray(Z));return{key:J.type,info:Q,data:X}}let Y=w0(J.data);return{key:J.type,data:Y}},GZ=(J)=>{if(J.data.byteLength===8){let Y=new Uint8Array(J.data),Z=Y[3]&1,Q=(Y[4]<<23)+(Y[5]<<15)+(Y[6]<<7)+Y[7];if(Q/=45,Z)Q+=47721858.84;return Math.round(Q)}return},w0=(J,Y=!1)=>{let Z=jZ();if(Z){let G=Z.decode(J);if(Y){let j=G.indexOf("\x00");return j!==-1?G.substring(0,j):G}return G.replace(/\0/g,"")}let Q=J.length,X,q,W,z="",H=0;while(H<Q){if(X=J[H++],X===0&&Y)return z;else if(X===0||X===3)continue;switch(X>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:z+=String.fromCharCode(X);break;case 12:case 13:q=J[H++],z+=String.fromCharCode((X&31)<<6|q&63);break;case 14:q=J[H++],W=J[H++],z+=String.fromCharCode((X&15)<<12|(q&63)<<6|(W&63)<<0);break}}return z},d6;function jZ(){if(navigator.userAgent.includes("PlayStation 4"))return;if(!d6&&typeof self.TextDecoder!=="undefined")d6=new self.TextDecoder("utf-8");return d6}var R0={hexDump:function(J){let Y="";for(let Z=0;Z<J.length;Z++){let Q=J[Z].toString(16);if(Q.length<2)Q="0"+Q;Y+=Q}return Y}},w6=Math.pow(2,32)-1,NZ=[].push,e8={video:1,audio:2,id3:3,text:4};function Z0(J){return String.fromCharCode.apply(null,J)}function JY(J,Y){let Z=J[Y]<<8|J[Y+1];return Z<0?65536+Z:Z}function p(J,Y){let Z=YY(J,Y);return Z<0?4294967296+Z:Z}function Z8(J,Y){let Z=p(J,Y);return Z*=Math.pow(2,32),Z+=p(J,Y+4),Z}function YY(J,Y){return J[Y]<<24|J[Y+1]<<16|J[Y+2]<<8|J[Y+3]}function l6(J,Y,Z){J[Y]=Z>>24,J[Y+1]=Z>>16&255,J[Y+2]=Z>>8&255,J[Y+3]=Z&255}function KZ(J){let Y=J.byteLength;for(let Z=0;Z<Y;){let Q=p(J,Z);if(Q>8&&J[Z+4]===109&&J[Z+5]===111&&J[Z+6]===111&&J[Z+7]===102)return!0;Z=Q>1?Z+Q:Y}return!1}function c(J,Y){let Z=[];if(!Y.length)return Z;let Q=J.byteLength;for(let X=0;X<Q;){let q=p(J,X),W=Z0(J.subarray(X+4,X+8)),z=q>1?X+q:Q;if(W===Y[0])if(Y.length===1)Z.push(J.subarray(X+8,z));else{let H=c(J.subarray(X+8,z),Y.slice(1));if(H.length)NZ.apply(Z,H)}X=z}return Z}function VZ(J){let Y=[],Z=J[0],Q=8,X=p(J,Q);Q+=4;let q=0,W=0;if(Z===0)q=p(J,Q),W=p(J,Q+4),Q+=8;else q=Z8(J,Q),W=Z8(J,Q+8),Q+=16;Q+=2;let z=J.length+W,H=JY(J,Q);Q+=2;for(let G=0;G<H;G++){let j=Q,N=p(J,j);j+=4;let K=N&2147483647;if((N&2147483648)>>>31===1)return B.warn("SIDX has hierarchical references (not supported)"),null;let U=p(J,j);j+=4,Y.push({referenceSize:K,subsegmentDuration:U,info:{duration:U/X,start:z,end:z+K-1}}),z+=K,j+=4,Q=j}return{earliestPresentationTime:q,timescale:X,version:Z,referencesCount:H,references:Y}}function ZY(J){let Y=[],Z=c(J,["moov","trak"]);for(let X=0;X<Z.length;X++){let q=Z[X],W=c(q,["tkhd"])[0];if(W){let z=W[0],H=p(W,z===0?12:20),G=c(q,["mdia","mdhd"])[0];if(G){z=G[0];let j=p(G,z===0?12:20),N=c(q,["mdia","hdlr"])[0];if(N){let K=Z0(N.subarray(8,12)),V={soun:s.AUDIO,vide:s.VIDEO}[K];if(V){let U=c(q,["mdia","minf","stbl","stsd"])[0],O=UZ(U);Y[H]={timescale:j,type:V},Y[V]=z0({timescale:j,id:H},O)}}}}}return c(J,["moov","mvex","trex"]).forEach((X)=>{let q=p(X,4),W=Y[q];if(W)W.default={duration:p(X,12),flags:p(X,20)}}),Y}function UZ(J){let Y=J.subarray(8),Z=Y.subarray(86),Q=Z0(Y.subarray(4,8)),X=Q,q=Q==="enca"||Q==="encv";if(q){let z=c(Y,[Q])[0].subarray(Q==="enca"?28:78);c(z,["sinf"]).forEach((G)=>{let j=c(G,["schm"])[0];if(j){let N=Z0(j.subarray(4,8));if(N==="cbcs"||N==="cenc"){let K=c(G,["frma"])[0];if(K)X=Z0(K)}}})}switch(X){case"avc1":case"avc2":case"avc3":case"avc4":{let W=c(Z,["avcC"])[0];X+="."+W6(W[1])+W6(W[2])+W6(W[3]);break}case"mp4a":{let W=c(Y,[Q])[0],z=c(W.subarray(28),["esds"])[0];if(z&&z.length>12){let H=4;if(z[H++]!==3)break;H=o6(z,H),H+=2;let G=z[H++];if(G&128)H+=2;if(G&64)H+=z[H++];if(z[H++]!==4)break;H=o6(z,H);let j=z[H++];if(j===64)X+="."+W6(j);else break;if(H+=12,z[H++]!==5)break;H=o6(z,H);let N=z[H++],K=(N&248)>>3;if(K===31)K+=1+((N&7)<<3)+((z[H]&224)>>5);X+="."+K}break}case"hvc1":case"hev1":{let W=c(Z,["hvcC"])[0],z=W[1],H=["","A","B","C"][z>>6],G=z&31,j=p(W,2),N=(z&32)>>5?"H":"L",K=W[12],V=W.subarray(6,12);X+="."+H+G,X+="."+j.toString(16).toUpperCase(),X+="."+N+K;let U="";for(let O=V.length;O--;){let _=V[O];if(_||U)U="."+_.toString(16).toUpperCase()+U}X+=U;break}case"dvh1":case"dvhe":{let W=c(Z,["dvcC"])[0],z=W[2]>>1&127,H=W[2]<<5&32|W[3]>>3&31;X+="."+B0(z)+"."+B0(H);break}case"vp09":{let W=c(Z,["vpcC"])[0],z=W[4],H=W[5],G=W[6]>>4&15;X+="."+B0(z)+"."+B0(H)+"."+B0(G);break}case"av01":{let W=c(Z,["av1C"])[0],z=W[1]>>>5,H=W[1]&31,G=W[2]>>>7?"H":"M",j=(W[2]&64)>>6,N=(W[2]&32)>>5,K=z===2&&j?N?12:10:j?10:8,V=(W[2]&16)>>4,U=(W[2]&8)>>3,O=(W[2]&4)>>2,_=W[2]&3,A=1,R=1,E=1,F=0;X+="."+z+"."+B0(H)+G+"."+B0(K)+"."+V+"."+U+O+_+"."+B0(1)+"."+B0(1)+"."+B0(1)+".0";break}}return{codec:X,encrypted:q}}function o6(J,Y){let Z=Y+5;while(J[Y++]&128&&Y<Z);return Y}function W6(J){return("0"+J.toString(16).toUpperCase()).slice(-2)}function B0(J){return(J<10?"0":"")+J}function $Z(J,Y){if(!J||!Y)return J;let Z=Y.keyId;if(Z&&Y.isCommonEncryption)c(J,["moov","trak"]).forEach((X)=>{let W=c(X,["mdia","minf","stbl","stsd"])[0].subarray(8),z=c(W,["enca"]),H=z.length>0;if(!H)z=c(W,["encv"]);z.forEach((G)=>{let j=H?G.subarray(28):G.subarray(78);c(j,["sinf"]).forEach((K)=>{let V=QY(K);if(V){let U=V.subarray(8,24);if(!U.some((O)=>O!==0))B.log(`[eme] Patching keyId in 'enc${H?"a":"v"}>sinf>>tenc' box: ${R0.hexDump(U)} -> ${R0.hexDump(Z)}`),V.set(Z,8)}})})});return J}function QY(J){let Y=c(J,["schm"])[0];if(Y){let Z=Z0(Y.subarray(4,8));if(Z==="cbcs"||Z==="cenc")return c(J,["schi","tenc"])[0]}return null}function OZ(J,Y){return c(Y,["moof","traf"]).reduce((Z,Q)=>{let X=c(Q,["tfdt"])[0],q=X[0],W=c(Q,["tfhd"]).reduce((z,H)=>{let G=p(H,4),j=J[G];if(j){let N=p(X,4);if(q===1){if(N===w6)return B.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),z;N*=w6+1,N+=p(X,8)}let K=j.timescale||90000,V=N/K;if(h(V)&&(z===null||V<z))return V}return z},null);if(W!==null&&h(W)&&(Z===null||W<Z))return W;return Z},null)}function _Z(J,Y){let Z=0,Q=0,X=0,q=c(J,["moof","traf"]);for(let W=0;W<q.length;W++){let z=q[W],H=c(z,["tfhd"])[0],G=p(H,4),j=Y[G];if(!j)continue;let N=j.default,K=p(H,0)|(N==null?void 0:N.flags),V=N==null?void 0:N.duration;if(K&8)if(K&2)V=p(H,12);else V=p(H,8);let U=j.timescale||90000,O=c(z,["trun"]);for(let _=0;_<O.length;_++){if(Z=AZ(O[_]),!Z&&V){let A=p(O[_],4);Z=V*A}if(j.type===s.VIDEO)Q+=Z/U;else if(j.type===s.AUDIO)X+=Z/U}}if(Q===0&&X===0){let W=1/0,z=0,H=0,G=c(J,["sidx"]);for(let j=0;j<G.length;j++){let N=VZ(G[j]);if(N!=null&&N.references){W=Math.min(W,N.earliestPresentationTime/N.timescale);let K=N.references.reduce((V,U)=>V+U.info.duration||0,0);z=Math.max(z,K+N.earliestPresentationTime/N.timescale),H=z-W}}if(H&&h(H))return H}if(Q)return Q;return X}function AZ(J){let Y=p(J,0),Z=8;if(Y&1)Z+=4;if(Y&4)Z+=4;let Q=0,X=p(J,4);for(let q=0;q<X;q++){if(Y&256){let W=p(J,Z);Q+=W,Z+=4}if(Y&512)Z+=4;if(Y&1024)Z+=4;if(Y&2048)Z+=4}return Q}function BZ(J,Y,Z){c(Y,["moof","traf"]).forEach((Q)=>{c(Q,["tfhd"]).forEach((X)=>{let q=p(X,4),W=J[q];if(!W)return;let z=W.timescale||90000;c(Q,["tfdt"]).forEach((H)=>{let G=H[0],j=Z*z;if(j){let N=p(H,4);if(G===0)N-=j,N=Math.max(N,0),l6(H,4,N);else{N*=Math.pow(2,32),N+=p(H,8),N-=j,N=Math.max(N,0);let K=Math.floor(N/(w6+1)),V=Math.floor(N%(w6+1));l6(H,4,K),l6(H,8,V)}}})})})}function RZ(J){let Y={valid:null,remainder:null},Z=c(J,["moof"]);if(Z.length<2)return Y.remainder=J,Y;let Q=Z[Z.length-1];return Y.valid=v0(J,0,Q.byteOffset-8),Y.remainder=v0(J,Q.byteOffset-8),Y}function $0(J,Y){let Z=new Uint8Array(J.length+Y.length);return Z.set(J),Z.set(Y,J.length),Z}function Q8(J,Y){let Z=[],Q=Y.samples,X=Y.timescale,q=Y.id,W=!1;return c(Q,["moof"]).map((H)=>{let G=H.byteOffset-8;c(H,["traf"]).map((N)=>{let K=c(N,["tfdt"]).map((V)=>{let U=V[0],O=p(V,4);if(U===1)O*=Math.pow(2,32),O+=p(V,8);return O/X})[0];if(K!==void 0)J=K;return c(N,["tfhd"]).map((V)=>{let U=p(V,4),O=p(V,0)&16777215,_=(O&1)!==0,A=(O&2)!==0,R=(O&8)!==0,E=0,F=(O&16)!==0,P=0,w=(O&32)!==0,b=8;if(U===q){if(_)b+=8;if(A)b+=4;if(R)E=p(V,b),b+=4;if(F)P=p(V,b),b+=4;if(w)b+=4;if(Y.type==="video")W=MZ(Y.codec);c(N,["trun"]).map((x)=>{let D=x[0],L=p(x,0)&16777215,k=(L&1)!==0,T=0,u=(L&4)!==0,f=(L&256)!==0,v=0,n=(L&512)!==0,i=0,y=(L&1024)!==0,S=(L&2048)!==0,o=0,r=p(x,4),d=8;if(k)T=p(x,d),d+=4;if(u)d+=4;let e=T+G;for(let Q0=0;Q0<r;Q0++){if(f)v=p(x,d),d+=4;else v=E;if(n)i=p(x,d),d+=4;else i=P;if(y)d+=4;if(S){if(D===0)o=p(x,d);else o=YY(x,d);d+=4}if(Y.type===s.VIDEO){let H0=0;while(H0<i){let j0=p(Q,e);if(e+=4,FZ(W,Q[e])){let T0=Q.subarray(e,e+j0);XY(T0,W?2:1,J+o/X,Z)}e+=j0,H0+=j0+4}}J+=v/X}})}})})}),Z}function MZ(J){if(!J)return!1;let Y=J.indexOf("."),Z=Y<0?J:J.substring(0,Y);return Z==="hvc1"||Z==="hev1"||Z==="dvh1"||Z==="dvhe"}function FZ(J,Y){if(J){let Z=Y>>1&63;return Z===39||Z===40}else return(Y&31)===6}function XY(J,Y,Z,Q){let X=qY(J),q=0;q+=Y;let W=0,z=0,H=0;while(q<X.length){W=0;do{if(q>=X.length)break;H=X[q++],W+=H}while(H===255);z=0;do{if(q>=X.length)break;H=X[q++],z+=H}while(H===255);let G=X.length-q,j=q;if(z<G)q+=z;else if(z>G){B.error(`Malformed SEI payload. ${z} is too small, only ${G} bytes left to parse.`);break}if(W===4){if(X[j++]===181){let K=JY(X,j);if(j+=2,K===49){let V=p(X,j);if(j+=4,V===1195456820){let U=X[j++];if(U===3){let O=X[j++],_=31&O,A=64&O,R=A?2+_*3:0,E=new Uint8Array(R);if(A){E[0]=O;for(let F=1;F<R;F++)E[F]=X[j++]}Q.push({type:U,payloadType:W,pts:Z,bytes:E})}}}}}else if(W===5){if(z>16){let N=[];for(let U=0;U<16;U++){let O=X[j++].toString(16);if(N.push(O.length==1?"0"+O:O),U===3||U===5||U===7||U===9)N.push("-")}let K=z-16,V=new Uint8Array(K);for(let U=0;U<K;U++)V[U]=X[j++];Q.push({payloadType:W,pts:Z,uuid:N.join(""),userData:w0(V),userDataBytes:V})}}}}function qY(J){let Y=J.byteLength,Z=[],Q=1;while(Q<Y-2)if(J[Q]===0&&J[Q+1]===0&&J[Q+2]===3)Z.push(Q+2),Q+=2;else Q++;if(Z.length===0)return J;let X=Y-Z.length,q=new Uint8Array(X),W=0;for(Q=0;Q<X;W++,Q++){if(W===Z[0])W++,Z.shift();q[Q]=J[W]}return q}function EZ(J){let Y=J[0],Z="",Q="",X=0,q=0,W=0,z=0,H=0,G=0;if(Y===0){while(Z0(J.subarray(G,G+1))!=="\x00")Z+=Z0(J.subarray(G,G+1)),G+=1;Z+=Z0(J.subarray(G,G+1)),G+=1;while(Z0(J.subarray(G,G+1))!=="\x00")Q+=Z0(J.subarray(G,G+1)),G+=1;Q+=Z0(J.subarray(G,G+1)),G+=1,X=p(J,12),q=p(J,16),z=p(J,20),H=p(J,24),G=28}else if(Y===1){G+=4,X=p(J,G),G+=4;let N=p(J,G);G+=4;let K=p(J,G);if(G+=4,W=4294967296*N+K,!c7(W))W=Number.MAX_SAFE_INTEGER,B.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box");z=p(J,G),G+=4,H=p(J,G),G+=4;while(Z0(J.subarray(G,G+1))!=="\x00")Z+=Z0(J.subarray(G,G+1)),G+=1;Z+=Z0(J.subarray(G,G+1)),G+=1;while(Z0(J.subarray(G,G+1))!=="\x00")Q+=Z0(J.subarray(G,G+1)),G+=1;Q+=Z0(J.subarray(G,G+1)),G+=1}let j=J.subarray(G,J.byteLength);return{schemeIdUri:Z,value:Q,timeScale:X,presentationTime:W,presentationTimeDelta:q,eventDuration:z,id:H,payload:j}}function IZ(J,...Y){let Z=Y.length,Q=8,X=Z;while(X--)Q+=Y[X].byteLength;let q=new Uint8Array(Q);q[0]=Q>>24&255,q[1]=Q>>16&255,q[2]=Q>>8&255,q[3]=Q&255,q.set(J,4);for(X=0,Q=8;X<Z;X++)q.set(Y[X],Q),Q+=Y[X].byteLength;return q}function wZ(J,Y,Z){if(J.byteLength!==16)throw new RangeError("Invalid system id");let Q,X;if(Y){Q=1,X=new Uint8Array(Y.length*16);for(let z=0;z<Y.length;z++){let H=Y[z];if(H.byteLength!==16)throw new RangeError("Invalid key");X.set(H,z*16)}}else Q=0,X=new Uint8Array;let q;if(Q>0){if(q=new Uint8Array(4),Y.length>0)new DataView(q.buffer).setUint32(0,Y.length,!1)}else q=new Uint8Array;let W=new Uint8Array(4);if(Z&&Z.byteLength>0)new DataView(W.buffer).setUint32(0,Z.byteLength,!1);return IZ([112,115,115,104],new Uint8Array([Q,0,0,0]),J,q,X,W,Z||new Uint8Array)}function LZ(J){let Y=[];if(J instanceof ArrayBuffer){let Z=J.byteLength,Q=0;while(Q+32<Z){let X=new DataView(J,Q),q=PZ(X);Y.push(q),Q+=q.size}}return Y}function PZ(J){let Y=J.getUint32(0),Z=J.byteOffset,Q=J.byteLength;if(Q<Y)return{offset:Z,size:Q};if(J.getUint32(4)!==1886614376)return{offset:Z,size:Y};let q=J.getUint32(8)>>>24;if(q!==0&&q!==1)return{offset:Z,size:Y};let W=J.buffer,z=R0.hexDump(new Uint8Array(W,Z+12,16)),H=J.getUint32(28),G=null,j=null;if(q===0){if(Y-32<H||H<22)return{offset:Z,size:Y};j=new Uint8Array(W,Z+32,H)}else if(q===1){if(!H||Q<Z+32+H*16+16)return{offset:Z,size:Y};G=[];for(let N=0;N<H;N++)G.push(new Uint8Array(W,Z+32+N*16,16))}return{version:q,systemId:z,kids:G,data:j,offset:Z,size:Y}}var z6={};class Q6{static clearKeyUriToKeyIdMap(){z6={}}constructor(J,Y,Z,Q=[1],X=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=J,this.uri=Y,this.keyFormat=Z,this.keyFormatVersions=Q,this.iv=X,this.encrypted=J?J!=="NONE":!1,this.isCommonEncryption=this.encrypted&&J!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";else switch(this.keyFormat){case K0.FAIRPLAY:case K0.WIDEVINE:case K0.PLAYREADY:case K0.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(J){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){if(typeof J!=="number"){if(this.method==="AES-128"&&!this.iv)B.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`);J=0}let Z=CZ(J);return new Q6(this.method,this.uri,"identity",this.keyFormatVersions,Z)}let Y=JZ(this.uri);if(Y)switch(this.keyFormat){case K0.WIDEVINE:if(this.pssh=Y,Y.length>=22)this.keyId=Y.subarray(Y.length-22,Y.length-6);break;case K0.PLAYREADY:{let Z=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=wZ(Z,null,Y);let Q=new Uint16Array(Y.buffer,Y.byteOffset,Y.byteLength/2),X=String.fromCharCode.apply(null,Array.from(Q)),q=X.substring(X.indexOf("<"),X.length),H=new DOMParser().parseFromString(q,"text/xml").getElementsByTagName("KID")[0];if(H){let G=H.childNodes[0]?H.childNodes[0].nodeValue:H.getAttribute("VALUE");if(G){let j=hJ(G).subarray(0,16);e7(j),this.keyId=j}}break}default:{let Z=Y.subarray(0,16);if(Z.length!==16){let Q=new Uint8Array(16);Q.set(Z,16-Z.length),Z=Q}this.keyId=Z;break}}if(!this.keyId||this.keyId.byteLength!==16){let Z=z6[this.uri];if(!Z){let Q=Object.keys(z6).length%Number.MAX_SAFE_INTEGER;Z=new Uint8Array(16),new DataView(Z.buffer,12,4).setUint32(0,Q),z6[this.uri]=Z}this.keyId=Z}return this}}function CZ(J){let Y=new Uint8Array(16);for(let Z=12;Z<16;Z++)Y[Z]=J>>8*(15-Z)&255;return Y}var WY=/\{\$([a-zA-Z0-9-_]+)\}/g;function X8(J){return WY.test(J)}function N0(J,Y,Z){if(J.variableList!==null||J.hasVariableRefs)for(let Q=Z.length;Q--;){let X=Z[Q],q=Y[X];if(q)Y[X]=jJ(J,q)}}function jJ(J,Y){if(J.variableList!==null||J.hasVariableRefs){let Z=J.variableList;return Y.replace(WY,(Q)=>{let X=Q.substring(2,Q.length-1),q=Z==null?void 0:Z[X];if(q===void 0)return J.playlistParsingError||(J.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${X}"`)),Q;return q})}return Y}function q8(J,Y,Z){let Q=J.variableList;if(!Q)J.variableList=Q={};let X,q;if("QUERYPARAM"in Y){X=Y.QUERYPARAM;try{let W=new self.URL(Z).searchParams;if(W.has(X))q=W.get(X);else throw new Error(`"${X}" does not match any query parameter in URI: "${Z}"`)}catch(W){J.playlistParsingError||(J.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${W.message}`))}}else X=Y.NAME,q=Y.VALUE;if(X in Q)J.playlistParsingError||(J.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${X}"`));else Q[X]=q||""}function bZ(J,Y,Z){let Q=Y.IMPORT;if(Z&&Q in Z){let X=J.variableList;if(!X)J.variableList=X={};X[Q]=Z[Q]}else J.playlistParsingError||(J.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${Q}"`))}function p0(J=!0){if(typeof self==="undefined")return;return(J||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function xZ(J){return typeof self!=="undefined"&&J===self.ManagedMediaSource}var L6={audio:{a3ds:1,"ac-3":0.95,"ac-4":1,alac:0.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":0.9,enca:1,fLaC:0.9,flac:0.9,FLAC:0.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:0.8,drac:1,dva1:1,dvav:1,dvh1:0.7,dvhe:0.7,encv:1,hev1:0.75,hvc1:0.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:0.9},text:{stpp:1,wvtt:1}};function DZ(J,Y){let Z=L6[Y];return!!Z&&!!Z[J.slice(0,4)]}function n6(J,Y,Z=!0){return!J.split(",").some((Q)=>!zY(Q,Y,Z))}function zY(J,Y,Z=!0){var Q;let X=p0(Z);return(Q=X==null?void 0:X.isTypeSupported(X6(J,Y)))!=null?Q:!1}function X6(J,Y){return`${Y}/mp4;codecs="${J}"`}function W8(J){if(J){let Y=J.substring(0,4);return L6.video[Y]}return 2}function P6(J){return J.split(",").reduce((Y,Z)=>{let Q=L6.video[Z];if(Q)return(Q*2+Y)/(Y?3:2);return(L6.audio[Z]+Y)/(Y?2:1)},0)}var i6={};function TZ(J,Y=!0){if(i6[J])return i6[J];let Z={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[J];for(let Q=0;Q<Z.length;Q++)if(zY(Z[Q],"audio",Y))return i6[J]=Z[Q],Z[Q];return J}var SZ=/flac|opus/i;function C6(J,Y=!0){return J.replace(SZ,(Z)=>TZ(Z.toLowerCase(),Y))}function z8(J,Y){if(J&&J!=="mp4a")return J;return Y?Y.split(",")[0]:Y}function hZ(J){let Y=J.split(",");for(let Z=0;Z<Y.length;Z++){let Q=Y[Z].split(".");if(Q.length>2){let X=Q.shift()+".";X+=parseInt(Q.shift()).toString(16),X+=("000"+parseInt(Q.shift()).toString(16)).slice(-4),Y[Z]=X}}return Y.join(",")}var H8=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,G8=/#EXT-X-MEDIA:(.*)/g,yZ=/^#EXT(?:INF|-X-TARGETDURATION):/m,j8=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),kZ=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class E0{static findGroup(J,Y){for(let Z=0;Z<J.length;Z++){let Q=J[Z];if(Q.id===Y)return Q}}static resolve(J,Y){return DJ.buildAbsoluteURL(Y,J,{alwaysNormalize:!0})}static isMediaPlaylist(J){return yZ.test(J)}static parseMasterPlaylist(J,Y){let Z=X8(J),Q={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:Z},X=[];H8.lastIndex=0;let q;while((q=H8.exec(J))!=null)if(q[1]){var W;let H=new J0(q[1]);N0(Q,H,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);let G=jJ(Q,q[2]),j={attrs:H,bitrate:H.decimalInteger("BANDWIDTH")||H.decimalInteger("AVERAGE-BANDWIDTH"),name:H.NAME,url:E0.resolve(G,Y)},N=H.decimalResolution("RESOLUTION");if(N)j.width=N.width,j.height=N.height;if(vZ(H.CODECS,j),!((W=j.unknownCodecs)!=null&&W.length))X.push(j);Q.levels.push(j)}else if(q[3]){let H=q[3],G=q[4];switch(H){case"SESSION-DATA":{let j=new J0(G);N0(Q,j,["DATA-ID","LANGUAGE","VALUE","URI"]);let N=j["DATA-ID"];if(N){if(Q.sessionData===null)Q.sessionData={};Q.sessionData[N]=j}break}case"SESSION-KEY":{let j=N8(G,Y,Q);if(j.encrypted&&j.isSupported()){if(Q.sessionKeys===null)Q.sessionKeys=[];Q.sessionKeys.push(j)}else B.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${G}"`);break}case"DEFINE":{{let j=new J0(G);N0(Q,j,["NAME","VALUE","QUERYPARAM"]),q8(Q,j,Y)}break}case"CONTENT-STEERING":{let j=new J0(G);N0(Q,j,["SERVER-URI","PATHWAY-ID"]),Q.contentSteering={uri:E0.resolve(j["SERVER-URI"],Y),pathwayId:j["PATHWAY-ID"]||"."};break}case"START":{Q.startTimeOffset=K8(G);break}}}let z=X.length>0&&X.length<Q.levels.length;if(Q.levels=z?X:Q.levels,Q.levels.length===0)Q.playlistParsingError=new Error("no levels found in manifest");return Q}static parseMasterPlaylistMedia(J,Y,Z){let Q,X={},q=Z.levels,W={AUDIO:q.map((H)=>({id:H.attrs.AUDIO,audioCodec:H.audioCodec})),SUBTITLES:q.map((H)=>({id:H.attrs.SUBTITLES,textCodec:H.textCodec})),"CLOSED-CAPTIONS":[]},z=0;G8.lastIndex=0;while((Q=G8.exec(J))!==null){let H=new J0(Q[1]),G=H.TYPE;if(G){let j=W[G],N=X[G]||[];X[G]=N,N0(Z,H,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);let K=H.LANGUAGE,V=H["ASSOC-LANGUAGE"],U=H.CHANNELS,O=H.CHARACTERISTICS,_=H["INSTREAM-ID"],A={attrs:H,bitrate:0,id:z++,groupId:H["GROUP-ID"]||"",name:H.NAME||K||"",type:G,default:H.bool("DEFAULT"),autoselect:H.bool("AUTOSELECT"),forced:H.bool("FORCED"),lang:K,url:H.URI?E0.resolve(H.URI,Y):""};if(V)A.assocLang=V;if(U)A.channels=U;if(O)A.characteristics=O;if(_)A.instreamId=_;if(j!=null&&j.length){let R=E0.findGroup(j,A.groupId)||j[0];V8(A,R,"audioCodec"),V8(A,R,"textCodec")}N.push(A)}}return X}static parseLevelPlaylist(J,Y,Z,Q,X,q){let W=new i8(Y),z=W.fragments,H=null,G=0,j=0,N=0,K=0,V=null,U=new O6(Q,Y),O,_,A,R=-1,E=!1,F=null;j8.lastIndex=0,W.m3u8=J,W.hasVariableRefs=X8(J);while((O=j8.exec(J))!==null){if(E){if(E=!1,U=new O6(Q,Y),U.start=N,U.sn=G,U.cc=K,U.level=Z,H){if(U.initSegment=H,U.rawProgramDateTime=H.rawProgramDateTime,H.rawProgramDateTime=null,F)U.setByteRange(F),F=null}}let x=O[1];if(x){U.duration=parseFloat(x);let D=(" "+O[2]).slice(1);U.title=D||null,U.tagList.push(D?["INF",x,D]:["INF",x])}else if(O[3]){if(h(U.duration)){if(U.start=N,A)O8(U,A,W);U.sn=G,U.level=Z,U.cc=K,z.push(U);let D=(" "+O[3]).slice(1);U.relurl=jJ(W,D),U8(U,V),V=U,N+=U.duration,G++,j=0,E=!0}}else if(O[4]){let D=(" "+O[4]).slice(1);if(V)U.setByteRange(D,V);else U.setByteRange(D)}else if(O[5]){if(U.rawProgramDateTime=(" "+O[5]).slice(1),U.tagList.push(["PROGRAM-DATE-TIME",U.rawProgramDateTime]),R===-1)R=z.length}else{if(O=O[0].match(kZ),!O){B.warn("No matches on slow regex match for level playlist!");continue}for(_=1;_<O.length;_++)if(typeof O[_]!=="undefined")break;let D=(" "+O[_]).slice(1),L=(" "+O[_+1]).slice(1),k=O[_+2]?(" "+O[_+2]).slice(1):"";switch(D){case"PLAYLIST-TYPE":W.type=L.toUpperCase();break;case"MEDIA-SEQUENCE":G=W.startSN=parseInt(L);break;case"SKIP":{let T=new J0(L);N0(W,T,["RECENTLY-REMOVED-DATERANGES"]);let u=T.decimalInteger("SKIPPED-SEGMENTS");if(h(u)){W.skippedSegments=u;for(let v=u;v--;)z.unshift(null);G+=u}let f=T.enumeratedString("RECENTLY-REMOVED-DATERANGES");if(f)W.recentlyRemovedDateranges=f.split("\t");break}case"TARGETDURATION":W.targetduration=Math.max(parseInt(L),1);break;case"VERSION":W.version=parseInt(L);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":W.live=!1;break;case"#":if(L||k)U.tagList.push(k?[L,k]:[L]);break;case"DISCONTINUITY":K++,U.tagList.push(["DIS"]);break;case"GAP":U.gap=!0,U.tagList.push([D]);break;case"BITRATE":U.tagList.push([D,L]);break;case"DATERANGE":{let T=new J0(L);N0(W,T,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),N0(W,T,T.clientAttrs);let u=new TJ(T,W.dateRanges[T.ID]);if(u.isValid||W.skippedSegments)W.dateRanges[u.id]=u;else B.warn(`Ignoring invalid DATERANGE tag: "${L}"`);U.tagList.push(["EXT-X-DATERANGE",L]);break}case"DEFINE":{{let T=new J0(L);if(N0(W,T,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in T)bZ(W,T,q);else q8(W,T,Y)}break}case"DISCONTINUITY-SEQUENCE":K=parseInt(L);break;case"KEY":{let T=N8(L,Y,W);if(T.isSupported()){if(T.method==="NONE"){A=void 0;break}if(!A)A={};if(A[T.keyFormat])A=Y0({},A);A[T.keyFormat]=T}else B.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${L}"`);break}case"START":W.startTimeOffset=K8(L);break;case"MAP":{let T=new J0(L);if(N0(W,T,["BYTERANGE","URI"]),U.duration){let u=new O6(Q,Y);if($8(u,T,Z,A),H=u,U.initSegment=H,H.rawProgramDateTime&&!U.rawProgramDateTime)U.rawProgramDateTime=H.rawProgramDateTime}else{let u=U.byteRangeEndOffset;if(u){let f=U.byteRangeStartOffset;F=`${u-f}@${f}`}else F=null;$8(U,T,Z,A),H=U,E=!0}break}case"SERVER-CONTROL":{let T=new J0(L);W.canBlockReload=T.bool("CAN-BLOCK-RELOAD"),W.canSkipUntil=T.optionalFloat("CAN-SKIP-UNTIL",0),W.canSkipDateRanges=W.canSkipUntil>0&&T.bool("CAN-SKIP-DATERANGES"),W.partHoldBack=T.optionalFloat("PART-HOLD-BACK",0),W.holdBack=T.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{let T=new J0(L);W.partTarget=T.decimalFloatingPoint("PART-TARGET");break}case"PART":{let T=W.partList;if(!T)T=W.partList=[];let u=j>0?T[T.length-1]:void 0,f=j++,v=new J0(L);N0(W,v,["BYTERANGE","URI"]);let n=new n8(v,U,Y,f,u);T.push(n),U.duration+=n.duration;break}case"PRELOAD-HINT":{let T=new J0(L);N0(W,T,["URI"]),W.preloadHint=T;break}case"RENDITION-REPORT":{let T=new J0(L);N0(W,T,["URI"]),W.renditionReports=W.renditionReports||[],W.renditionReports.push(T);break}default:B.warn(`line parsed but not handled: ${O}`);break}}}if(V&&!V.relurl){if(z.pop(),N-=V.duration,W.partList)W.fragmentHint=V}else if(W.partList){if(U8(U,V),U.cc=K,W.fragmentHint=U,A)O8(U,A,W)}let P=z.length,w=z[0],b=z[P-1];if(N+=W.skippedSegments*W.targetduration,N>0&&P&&b){W.averagetargetduration=N/P;let x=b.sn;if(W.endSN=x!=="initSegment"?x:0,!W.live)b.endList=!0;if(w)W.startCC=w.cc}else W.endSN=0,W.startCC=0;if(W.fragmentHint)N+=W.fragmentHint.duration;if(W.totalduration=N,W.endCC=K,R>0)pZ(z,R);return W}}function N8(J,Y,Z){var Q,X;let q=new J0(J);N0(Z,q,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);let W=(Q=q.METHOD)!=null?Q:"",z=q.URI,H=q.hexadecimalInteger("IV"),G=q.KEYFORMATVERSIONS,j=(X=q.KEYFORMAT)!=null?X:"identity";if(z&&q.IV&&!H)B.error(`Invalid IV: ${q.IV}`);let N=z?E0.resolve(z,Y):"",K=(G?G:"1").split("/").map(Number).filter(Number.isFinite);return new Q6(W,N,j,K,H)}function K8(J){let Z=new J0(J).decimalFloatingPoint("TIME-OFFSET");if(h(Z))return Z;return null}function vZ(J,Y){let Z=(J||"").split(/[ ,]+/).filter((Q)=>Q);["video","audio","text"].forEach((Q)=>{let X=Z.filter((q)=>DZ(q,Q));if(X.length)Y[`${Q}Codec`]=X.join(","),Z=Z.filter((q)=>X.indexOf(q)===-1)}),Y.unknownCodecs=Z}function V8(J,Y,Z){let Q=Y[Z];if(Q)J[Z]=Q}function pZ(J,Y){let Z=J[Y];for(let Q=Y;Q--;){let X=J[Q];if(!X)return;X.programDateTime=Z.programDateTime-X.duration*1000,Z=X}}function U8(J,Y){if(J.rawProgramDateTime)J.programDateTime=Date.parse(J.rawProgramDateTime);else if(Y!=null&&Y.programDateTime)J.programDateTime=Y.endProgramDateTime;if(!h(J.programDateTime))J.programDateTime=null,J.rawProgramDateTime=null}function $8(J,Y,Z,Q){if(J.relurl=Y.URI,Y.BYTERANGE)J.setByteRange(Y.BYTERANGE);if(J.level=Z,J.sn="initSegment",Q)J.levelkeys=Q;J.initSegment=null}function O8(J,Y,Z){J.levelkeys=Y;let{encryptedFragments:Q}=Z;if((!Q.length||Q[Q.length-1].levelkeys!==Y)&&Object.keys(Y).some((X)=>Y[X].isCommonEncryption))Q.push(J)}var l={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},m={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function _8(J){let{type:Y}=J;switch(Y){case l.AUDIO_TRACK:return m.AUDIO;case l.SUBTITLE_TRACK:return m.SUBTITLE;default:return m.MAIN}}function s6(J,Y){let Z=J.url;if(Z===void 0||Z.indexOf("data:")===0)Z=Y.url;return Z}class HY{constructor(J){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=J,this.registerListeners()}startLoad(J){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls:J}=this;J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.LEVEL_LOADING,this.onLevelLoading,this),J.on($.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),J.on($.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){let{hls:J}=this;J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.LEVEL_LOADING,this.onLevelLoading,this),J.off($.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),J.off($.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(J){let Y=this.hls.config,Z=Y.pLoader,Q=Y.loader,q=new(Z||Q)(Y);return this.loaders[J.type]=q,q}getInternalLoader(J){return this.loaders[J.type]}resetInternalLoader(J){if(this.loaders[J])delete this.loaders[J]}destroyInternalLoaders(){for(let J in this.loaders){let Y=this.loaders[J];if(Y)Y.destroy();this.resetInternalLoader(J)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(J,Y){let{url:Z}=Y;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:l.MANIFEST,url:Z,deliveryDirectives:null})}onLevelLoading(J,Y){let{id:Z,level:Q,pathwayId:X,url:q,deliveryDirectives:W}=Y;this.load({id:Z,level:Q,pathwayId:X,responseType:"text",type:l.LEVEL,url:q,deliveryDirectives:W})}onAudioTrackLoading(J,Y){let{id:Z,groupId:Q,url:X,deliveryDirectives:q}=Y;this.load({id:Z,groupId:Q,level:null,responseType:"text",type:l.AUDIO_TRACK,url:X,deliveryDirectives:q})}onSubtitleTrackLoading(J,Y){let{id:Z,groupId:Q,url:X,deliveryDirectives:q}=Y;this.load({id:Z,groupId:Q,level:null,responseType:"text",type:l.SUBTITLE_TRACK,url:X,deliveryDirectives:q})}load(J){var Y;let Z=this.hls.config,Q=this.getInternalLoader(J);if(Q){let H=Q.context;if(H&&H.url===J.url&&H.level===J.level){B.trace("[playlist-loader]: playlist request ongoing");return}B.log(`[playlist-loader]: aborting previous loader for type: ${J.type}`),Q.abort()}let X;if(J.type===l.MANIFEST)X=Z.manifestLoadPolicy.default;else X=Y0({},Z.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null});if(Q=this.createInternalLoader(J),h((Y=J.deliveryDirectives)==null?void 0:Y.part)){let H;if(J.type===l.LEVEL&&J.level!==null)H=this.hls.levels[J.level].details;else if(J.type===l.AUDIO_TRACK&&J.id!==null)H=this.hls.audioTracks[J.id].details;else if(J.type===l.SUBTITLE_TRACK&&J.id!==null)H=this.hls.subtitleTracks[J.id].details;if(H){let{partTarget:G,targetduration:j}=H;if(G&&j){let N=Math.max(G*3,j*0.8)*1000;X=Y0({},X,{maxTimeToFirstByteMs:Math.min(N,X.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(N,X.maxTimeToFirstByteMs)})}}}let q=X.errorRetry||X.timeoutRetry||{},W={loadPolicy:X,timeout:X.maxLoadTimeMs,maxRetry:q.maxNumRetry||0,retryDelay:q.retryDelayMs||0,maxRetryDelay:q.maxRetryDelayMs||0},z={onSuccess:(H,G,j,N)=>{let K=this.getInternalLoader(j);this.resetInternalLoader(j.type);let V=H.data;if(V.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(H,j,new Error("no EXTM3U delimiter"),N||null,G);return}if(G.parsing.start=performance.now(),E0.isMediaPlaylist(V))this.handleTrackOrLevelPlaylist(H,G,j,N||null,K);else this.handleMasterPlaylist(H,G,j,N)},onError:(H,G,j,N)=>{this.handleNetworkError(G,j,!1,H,N)},onTimeout:(H,G,j)=>{this.handleNetworkError(G,j,!0,void 0,H)}};Q.load(J,W,z)}handleMasterPlaylist(J,Y,Z,Q){let X=this.hls,q=J.data,W=s6(J,Z),z=E0.parseMasterPlaylist(q,W);if(z.playlistParsingError){this.handleManifestParsingError(J,Z,z.playlistParsingError,Q,Y);return}let{contentSteering:H,levels:G,sessionData:j,sessionKeys:N,startTimeOffset:K,variableList:V}=z;this.variableList=V;let{AUDIO:U=[],SUBTITLES:O,"CLOSED-CAPTIONS":_}=E0.parseMasterPlaylistMedia(q,W,z);if(U.length){if(!U.some((R)=>!R.url)&&G[0].audioCodec&&!G[0].attrs.AUDIO)B.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),U.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new J0({}),bitrate:0,url:""})}X.trigger($.MANIFEST_LOADED,{levels:G,audioTracks:U,subtitles:O,captions:_,contentSteering:H,url:W,stats:Y,networkDetails:Q,sessionData:j,sessionKeys:N,startTimeOffset:K,variableList:V})}handleTrackOrLevelPlaylist(J,Y,Z,Q,X){let q=this.hls,{id:W,level:z,type:H}=Z,G=s6(J,Z),j=0,N=h(z)?z:h(W)?W:0,K=_8(Z),V=E0.parseLevelPlaylist(J.data,G,N,K,0,this.variableList);if(H===l.MANIFEST){let U={attrs:new J0({}),bitrate:0,details:V,name:"",url:G};q.trigger($.MANIFEST_LOADED,{levels:[U],audioTracks:[],url:G,stats:Y,networkDetails:Q,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}Y.parsing.end=performance.now(),Z.levelDetails=V,this.handlePlaylistLoaded(V,J,Y,Z,Q,X)}handleManifestParsingError(J,Y,Z,Q,X){this.hls.trigger($.ERROR,{type:g.NETWORK_ERROR,details:I.MANIFEST_PARSING_ERROR,fatal:Y.type===l.MANIFEST,url:J.url,err:Z,error:Z,reason:Z.message,response:J,context:Y,networkDetails:Q,stats:X})}handleNetworkError(J,Y,Z=!1,Q,X){let q=`A network ${Z?"timeout":"error"+(Q?" (status "+Q.code+")":"")} occurred while loading ${J.type}`;if(J.type===l.LEVEL)q+=`: ${J.level} id: ${J.id}`;else if(J.type===l.AUDIO_TRACK||J.type===l.SUBTITLE_TRACK)q+=` id: ${J.id} group-id: "${J.groupId}"`;let W=new Error(q);B.warn(`[playlist-loader]: ${q}`);let z=I.UNKNOWN,H=!1,G=this.getInternalLoader(J);switch(J.type){case l.MANIFEST:z=Z?I.MANIFEST_LOAD_TIMEOUT:I.MANIFEST_LOAD_ERROR,H=!0;break;case l.LEVEL:z=Z?I.LEVEL_LOAD_TIMEOUT:I.LEVEL_LOAD_ERROR,H=!1;break;case l.AUDIO_TRACK:z=Z?I.AUDIO_TRACK_LOAD_TIMEOUT:I.AUDIO_TRACK_LOAD_ERROR,H=!1;break;case l.SUBTITLE_TRACK:z=Z?I.SUBTITLE_TRACK_LOAD_TIMEOUT:I.SUBTITLE_LOAD_ERROR,H=!1;break}if(G)this.resetInternalLoader(J.type);let j={type:g.NETWORK_ERROR,details:z,fatal:H,url:J.url,loader:G,context:J,error:W,networkDetails:Y,stats:X};if(Q){let N=(Y==null?void 0:Y.url)||J.url;j.response=z0({url:N,data:void 0},Q)}this.hls.trigger($.ERROR,j)}handlePlaylistLoaded(J,Y,Z,Q,X,q){let W=this.hls,{type:z,level:H,id:G,groupId:j,deliveryDirectives:N}=Q,K=s6(Y,Q),V=_8(Q),U=typeof Q.level==="number"&&V===m.MAIN?H:void 0;if(!J.fragments.length){let _=new Error("No Segments found in Playlist");W.trigger($.ERROR,{type:g.NETWORK_ERROR,details:I.LEVEL_EMPTY_ERROR,fatal:!1,url:K,error:_,reason:_.message,response:Y,context:Q,level:U,parent:V,networkDetails:X,stats:Z});return}if(!J.targetduration)J.playlistParsingError=new Error("Missing Target Duration");let O=J.playlistParsingError;if(O){W.trigger($.ERROR,{type:g.NETWORK_ERROR,details:I.LEVEL_PARSING_ERROR,fatal:!1,url:K,error:O,reason:O.message,response:Y,context:Q,level:U,parent:V,networkDetails:X,stats:Z});return}if(J.live&&q){if(q.getCacheAge)J.ageHeader=q.getCacheAge()||0;if(!q.getCacheAge||isNaN(J.ageHeader))J.ageHeader=0}switch(z){case l.MANIFEST:case l.LEVEL:W.trigger($.LEVEL_LOADED,{details:J,level:U||0,id:G||0,stats:Z,networkDetails:X,deliveryDirectives:N});break;case l.AUDIO_TRACK:W.trigger($.AUDIO_TRACK_LOADED,{details:J,id:G||0,groupId:j||"",stats:Z,networkDetails:X,deliveryDirectives:N});break;case l.SUBTITLE_TRACK:W.trigger($.SUBTITLE_TRACK_LOADED,{details:J,id:G||0,groupId:j||"",stats:Z,networkDetails:X,deliveryDirectives:N});break}}}function GY(J,Y){let Z;try{Z=new Event("addtrack")}catch(Q){Z=document.createEvent("Event"),Z.initEvent("addtrack",!1,!1)}Z.track=J,Y.dispatchEvent(Z)}function jY(J,Y){let Z=J.mode;if(Z==="disabled")J.mode="hidden";if(J.cues&&!J.cues.getCueById(Y.id))try{if(J.addCue(Y),!J.cues.getCueById(Y.id))throw new Error(`addCue is failed for: ${Y}`)}catch(Q){B.debug(`[texttrack-utils]: ${Q}`);try{let X=new self.TextTrackCue(Y.startTime,Y.endTime,Y.text);X.id=Y.id,J.addCue(X)}catch(X){B.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${X}`)}}if(Z==="disabled")J.mode=Z}function d0(J){let Y=J.mode;if(Y==="disabled")J.mode="hidden";if(J.cues)for(let Z=J.cues.length;Z--;)J.removeCue(J.cues[Z]);if(Y==="disabled")J.mode=Y}function NJ(J,Y,Z,Q){let X=J.mode;if(X==="disabled")J.mode="hidden";if(J.cues&&J.cues.length>0){let q=gZ(J.cues,Y,Z);for(let W=0;W<q.length;W++)if(!Q||Q(q[W]))J.removeCue(q[W])}if(X==="disabled")J.mode=X}function mZ(J,Y){if(Y<J[0].startTime)return 0;let Z=J.length-1;if(Y>J[Z].endTime)return-1;let Q=0,X=Z;while(Q<=X){let q=Math.floor((X+Q)/2);if(Y<J[q].startTime)X=q-1;else if(Y>J[q].startTime&&Q<Z)Q=q+1;else return q}return J[Q].startTime-Y<Y-J[X].startTime?Q:X}function gZ(J,Y,Z){let Q=[],X=mZ(J,Y);if(X>-1)for(let q=X,W=J.length;q<W;q++){let z=J[q];if(z.startTime>=Y&&z.endTime<=Z)Q.push(z);else if(z.startTime>Z)return Q}return Q}function _6(J){let Y=[];for(let Z=0;Z<J.length;Z++){let Q=J[Z];if((Q.kind==="subtitles"||Q.kind==="captions")&&Q.label)Y.push(J[Z])}return Y}var A0={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"},uZ=0.25;function KJ(){if(typeof self==="undefined")return;return self.VTTCue||self.TextTrackCue}function A8(J,Y,Z,Q,X){let q=new J(Y,Z,"");try{if(q.value=Q,X)q.type=X}catch(W){q=new J(Y,Z,JSON.stringify(X?z0({type:X},Q):Q))}return q}var H6=(()=>{let J=KJ();try{J&&new J(0,Number.POSITIVE_INFINITY,"")}catch(Y){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function r6(J,Y){return J.getTime()/1000-Y}function fZ(J){return Uint8Array.from(J.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class NY{constructor(J){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=J,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),J.on($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.on($.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),J.off($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.off($.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(J,Y){this.media=Y.media}onMediaDetaching(){if(!this.id3Track)return;d0(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={}}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(J){let Y=this.getID3Track(J.textTracks);return Y.mode="hidden",Y}getID3Track(J){if(!this.media)return;for(let Y=0;Y<J.length;Y++){let Z=J[Y];if(Z.kind==="metadata"&&Z.label==="id3")return GY(Z,this.media),Z}return this.media.addTextTrack("metadata","id3")}onFragParsingMetadata(J,Y){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues:Z,enableID3MetadataCues:Q}}}=this;if(!Z&&!Q)return;let{samples:X}=Y;if(!this.id3Track)this.id3Track=this.createTrack(this.media);let q=KJ();if(!q)return;for(let W=0;W<X.length;W++){let z=X[W].type;if(z===A0.emsg&&!Z||!Q)continue;let H=t8(X[W].data);if(H){let G=X[W].pts,j=G+X[W].duration;if(j>H6)j=H6;if(j-G<=0)j=G+uZ;for(let K=0;K<H.length;K++){let V=H[K];if(!a8(V)){this.updateId3CueEnds(G,z);let U=A8(q,G,j,V,z);if(U)this.id3Track.addCue(U)}}}}}updateId3CueEnds(J,Y){var Z;let Q=(Z=this.id3Track)==null?void 0:Z.cues;if(Q)for(let X=Q.length;X--;){let q=Q[X];if(q.type===Y&&q.startTime<J&&q.endTime===H6)q.endTime=J}}onBufferFlushing(J,{startOffset:Y,endOffset:Z,type:Q}){let{id3Track:X,hls:q}=this;if(!q)return;let{config:{enableEmsgMetadataCues:W,enableID3MetadataCues:z}}=q;if(X&&(W||z)){let H;if(Q==="audio")H=(G)=>G.type===A0.audioId3&&z;else if(Q==="video")H=(G)=>G.type===A0.emsg&&W;else H=(G)=>G.type===A0.audioId3&&z||G.type===A0.emsg&&W;NJ(X,Y,Z,H)}}onLevelUpdated(J,{details:Y}){if(!this.media||!Y.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{dateRangeCuesAppended:Z,id3Track:Q}=this,{dateRanges:X}=Y,q=Object.keys(X);if(Q){let G=Object.keys(Z).filter((j)=>!q.includes(j));for(let j=G.length;j--;){let N=G[j];Object.keys(Z[N].cues).forEach((K)=>{Q.removeCue(Z[N].cues[K])}),delete Z[N]}}let W=Y.fragments[Y.fragments.length-1];if(q.length===0||!h(W==null?void 0:W.programDateTime))return;if(!this.id3Track)this.id3Track=this.createTrack(this.media);let z=W.programDateTime/1000-W.start,H=KJ();for(let G=0;G<q.length;G++){let j=q[G],N=X[j],K=r6(N.startDate,z),V=Z[j],U=(V==null?void 0:V.cues)||{},O=(V==null?void 0:V.durationKnown)||!1,_=H6,A=N.endDate;if(A)_=r6(A,z),O=!0;else if(N.endOnNext&&!O){let E=q.reduce((F,P)=>{if(P!==N.id){let w=X[P];if(w.class===N.class&&w.startDate>N.startDate&&(!F||N.startDate<F.startDate))return w}return F},null);if(E)_=r6(E.startDate,z),O=!0}let R=Object.keys(N.attr);for(let E=0;E<R.length;E++){let F=R[E];if(!s7(F))continue;let P=U[F];if(P){if(O&&!V.durationKnown)P.endTime=_}else if(H){let w=N.attr[F];if(r7(F))w=fZ(w);let b=A8(H,K,_,{key:F,data:w},A0.dateRange);if(b)b.id=j,this.id3Track.addCue(b),U[F]=b}}Z[j]={cues:U,dateRange:N,durationKnown:O}}}}class KY{constructor(J){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=J,this.config=J.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){let{config:J,levelDetails:Y}=this;if(J.liveMaxLatencyDuration!==void 0)return J.liveMaxLatencyDuration;return Y?J.liveMaxLatencyDurationCount*Y.targetduration:0}get targetLatency(){let{levelDetails:J}=this;if(J===null)return null;let{holdBack:Y,partHoldBack:Z,targetduration:Q}=J,{liveSyncDuration:X,liveSyncDurationCount:q,lowLatencyMode:W}=this.config,z=this.hls.userConfig,H=W?Z||Y:Y;if(z.liveSyncDuration||z.liveSyncDurationCount||H===0)H=X!==void 0?X:q*Q;let G=Q,j=1;return H+Math.min(this.stallCount*j,G)}get liveSyncPosition(){let J=this.estimateLiveEdge(),Y=this.targetLatency,Z=this.levelDetails;if(J===null||Y===null||Z===null)return null;let Q=Z.edge,X=J-Y-this.edgeStalled,q=Q-Z.totalduration,W=Q-(this.config.lowLatencyMode&&Z.partTarget||Z.targetduration);return Math.min(Math.max(q,X),W)}get drift(){let{levelDetails:J}=this;if(J===null)return 1;return J.drift}get edgeStalled(){let{levelDetails:J}=this;if(J===null)return 0;let Y=(this.config.lowLatencyMode&&J.partTarget||J.targetduration)*3;return Math.max(J.age-Y,0)}get forwardBufferLength(){let{media:J,levelDetails:Y}=this;if(!J||!Y)return 0;let Z=J.buffered.length;return(Z?J.buffered.end(Z-1):Y.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on($.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on($.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on($.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on($.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on($.ERROR,this.onError,this)}unregisterListeners(){this.hls.off($.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off($.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off($.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off($.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off($.ERROR,this.onError,this)}onMediaAttached(J,Y){this.media=Y.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){if(this.media)this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(J,{details:Y}){if(this.levelDetails=Y,Y.advanced)this.timeupdate();if(!Y.live&&this.media)this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(J,Y){var Z;if(Y.details!==I.BUFFER_STALLED_ERROR)return;if(this.stallCount++,(Z=this.levelDetails)!=null&&Z.live)B.warn("[playback-rate-controller]: Stall detected, adjusting target latency")}timeupdate(){let{media:J,levelDetails:Y}=this;if(!J||!Y)return;this.currentTime=J.currentTime;let Z=this.computeLatency();if(Z===null)return;this._latency=Z;let{lowLatencyMode:Q,maxLiveSyncPlaybackRate:X}=this.config;if(!Q||X===1||!Y.live)return;let q=this.targetLatency;if(q===null)return;let W=Z-q,z=Math.min(this.maxLatency,q+Y.targetduration);if(W<z&&W>0.05&&this.forwardBufferLength>1){let G=Math.min(2,Math.max(1,X)),j=Math.round(2/(1+Math.exp(-0.75*W-this.edgeStalled))*20)/20;J.playbackRate=Math.min(G,Math.max(1,j))}else if(J.playbackRate!==1&&J.playbackRate!==0)J.playbackRate=1}estimateLiveEdge(){let{levelDetails:J}=this;if(J===null)return null;return J.edge+J.age}computeLatency(){let J=this.estimateLiveEdge();if(J===null)return null;return J-this.currentTime}}var VJ=["NONE","TYPE-0","TYPE-1",null];function cZ(J){return VJ.indexOf(J)>-1}var b6=["SDR","PQ","HLG"];function dZ(J){return!!J&&b6.indexOf(J)>-1}var A6={No:"",Yes:"YES",v2:"v2"};function B8(J){let{canSkipUntil:Y,canSkipDateRanges:Z,age:Q}=J,X=Q<Y/2;if(Y&&X){if(Z)return A6.v2;return A6.Yes}return A6.No}class UJ{constructor(J,Y,Z){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=J,this.part=Y,this.skip=Z}addDirectives(J){let Y=new self.URL(J);if(this.msn!==void 0)Y.searchParams.set("_HLS_msn",this.msn.toString());if(this.part!==void 0)Y.searchParams.set("_HLS_part",this.part.toString());if(this.skip)Y.searchParams.set("_HLS_skip",this.skip);return Y.href}}class m0{constructor(J){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[J.url],this._attrs=[J.attrs],this.bitrate=J.bitrate,J.details)this.details=J.details;this.id=J.id||0,this.name=J.name,this.width=J.width||0,this.height=J.height||0,this.frameRate=J.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=J.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=J.audioCodec,this.videoCodec=J.videoCodec,this.codecSet=[J.videoCodec,J.audioCodec].filter((Y)=>!!Y).map((Y)=>Y.substring(0,4)).join(","),this.addGroupId("audio",J.attrs.AUDIO),this.addGroupId("text",J.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(J){return R8(this._audioGroups,J)}hasSubtitleGroup(J){return R8(this._subtitleGroups,J)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(J,Y){if(!Y)return;if(J==="audio"){let Z=this._audioGroups;if(!Z)Z=this._audioGroups=[];if(Z.indexOf(Y)===-1)Z.push(Y)}else if(J==="text"){let Z=this._subtitleGroups;if(!Z)Z=this._subtitleGroups=[];if(Z.indexOf(Y)===-1)Z.push(Y)}}get urlId(){return 0}set urlId(J){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var J;return(J=this.audioGroups)==null?void 0:J[0]}get textGroupId(){var J;return(J=this.subtitleGroups)==null?void 0:J[0]}addFallback(){}}function R8(J,Y){if(!Y||!J)return!1;return J.indexOf(Y)!==-1}function a6(J,Y){let Z=Y.startPTS;if(h(Z)){let Q=0,X;if(Y.sn>J.sn)Q=Z-J.start,X=J;else Q=J.start-Z,X=Y;if(X.duration!==Q)X.duration=Q}else if(Y.sn>J.sn)if(J.cc===Y.cc&&J.minEndPTS)Y.start=J.start+(J.minEndPTS-J.start);else Y.start=J.start+J.duration;else Y.start=Math.max(J.start-Y.duration,0)}function VY(J,Y,Z,Q,X,q){if(Q-Z<=0)B.warn("Fragment should have a positive duration",Y),Q=Z+Y.duration,q=X+Y.duration;let z=Z,H=Q,G=Y.startPTS,j=Y.endPTS;if(h(G)){let _=Math.abs(G-Z);if(!h(Y.deltaPTS))Y.deltaPTS=_;else Y.deltaPTS=Math.max(_,Y.deltaPTS);z=Math.max(Z,G),Z=Math.min(Z,G),X=Math.min(X,Y.startDTS),H=Math.min(Q,j),Q=Math.max(Q,j),q=Math.max(q,Y.endDTS)}let N=Z-Y.start;if(Y.start!==0)Y.start=Z;Y.duration=Q-Y.start,Y.startPTS=Z,Y.maxStartPTS=z,Y.startDTS=X,Y.endPTS=Q,Y.minEndPTS=H,Y.endDTS=q;let K=Y.sn;if(!J||K<J.startSN||K>J.endSN)return 0;let V,U=K-J.startSN,O=J.fragments;O[U]=Y;for(V=U;V>0;V--)a6(O[V],O[V-1]);for(V=U;V<O.length-1;V++)a6(O[V],O[V+1]);if(J.fragmentHint)a6(O[O.length-1],J.fragmentHint);return J.PTSKnown=J.alignedSliding=!0,N}function lZ(J,Y){let Z=null,Q=J.fragments;for(let H=Q.length-1;H>=0;H--){let G=Q[H].initSegment;if(G){Z=G;break}}if(J.fragmentHint)delete J.fragmentHint.endPTS;let X=0,q;if(iZ(J,Y,(H,G)=>{if(H.relurl)X=H.cc-G.cc;if(h(H.startPTS)&&h(H.endPTS)){if(G.start=G.startPTS=H.startPTS,G.startDTS=H.startDTS,G.maxStartPTS=H.maxStartPTS,G.endPTS=H.endPTS,G.endDTS=H.endDTS,G.minEndPTS=H.minEndPTS,G.duration=H.endPTS-H.startPTS,G.duration)q=G;Y.PTSKnown=Y.alignedSliding=!0}if(G.elementaryStreams=H.elementaryStreams,G.loader=H.loader,G.stats=H.stats,H.initSegment)G.initSegment=H.initSegment,Z=H.initSegment}),Z)(Y.fragmentHint?Y.fragments.concat(Y.fragmentHint):Y.fragments).forEach((G)=>{var j;if(G&&(!G.initSegment||G.initSegment.relurl===((j=Z)==null?void 0:j.relurl)))G.initSegment=Z});if(Y.skippedSegments){if(Y.deltaUpdateFailed=Y.fragments.some((H)=>!H),Y.deltaUpdateFailed){B.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let H=Y.skippedSegments;H--;)Y.fragments.shift();Y.startSN=Y.fragments[0].sn,Y.startCC=Y.fragments[0].cc}else if(Y.canSkipDateRanges)Y.dateRanges=oZ(J.dateRanges,Y.dateRanges,Y.recentlyRemovedDateranges)}let W=Y.fragments;if(X){B.warn("discontinuity sliding from playlist, take drift into account");for(let H=0;H<W.length;H++)W[H].cc+=X}if(Y.skippedSegments)Y.startCC=Y.fragments[0].cc;if(nZ(J.partList,Y.partList,(H,G)=>{G.elementaryStreams=H.elementaryStreams,G.stats=H.stats}),q)VY(Y,q,q.startPTS,q.endPTS,q.startDTS,q.endDTS);else UY(J,Y);if(W.length)Y.totalduration=Y.edge-W[0].start;Y.driftStartTime=J.driftStartTime,Y.driftStart=J.driftStart;let z=Y.advancedDateTime;if(Y.advanced&&z){let H=Y.edge;if(!Y.driftStart)Y.driftStartTime=z,Y.driftStart=H;Y.driftEndTime=z,Y.driftEnd=H}else Y.driftEndTime=J.driftEndTime,Y.driftEnd=J.driftEnd,Y.advancedDateTime=J.advancedDateTime}function oZ(J,Y,Z){let Q=Y0({},J);if(Z)Z.forEach((X)=>{delete Q[X]});return Object.keys(Y).forEach((X)=>{let q=new TJ(Y[X].attr,Q[X]);if(q.isValid)Q[X]=q;else B.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(Y[X].attr)}"`)}),Q}function nZ(J,Y,Z){if(J&&Y){let Q=0;for(let X=0,q=J.length;X<=q;X++){let W=J[X],z=Y[X+Q];if(W&&z&&W.index===z.index&&W.fragment.sn===z.fragment.sn)Z(W,z);else Q--}}}function iZ(J,Y,Z){let Q=Y.skippedSegments,X=Math.max(J.startSN,Y.startSN)-Y.startSN,q=(J.fragmentHint?1:0)+(Q?Y.endSN:Math.min(J.endSN,Y.endSN))-Y.startSN,W=Y.startSN-J.startSN,z=Y.fragmentHint?Y.fragments.concat(Y.fragmentHint):Y.fragments,H=J.fragmentHint?J.fragments.concat(J.fragmentHint):J.fragments;for(let G=X;G<=q;G++){let j=H[W+G],N=z[G];if(Q&&!N&&G<Q)N=Y.fragments[G]=j;if(j&&N)Z(j,N)}}function UY(J,Y){let Z=Y.startSN+Y.skippedSegments-J.startSN,Q=J.fragments;if(Z<0||Z>=Q.length)return;$J(Y,Q[Z].start)}function $J(J,Y){if(Y){let Z=J.fragments;for(let Q=J.skippedSegments;Q<Z.length;Q++)Z[Q].start+=Y;if(J.fragmentHint)J.fragmentHint.start+=Y}}function sZ(J,Y=1/0){let Z=1000*J.targetduration;if(J.updated){let Q=J.fragments,X=4;if(Q.length&&Z*4>Y){let q=Q[Q.length-1].duration*1000;if(q<Z)Z=q}}else Z/=2;return Math.round(Z)}function rZ(J,Y,Z){if(!(J!=null&&J.details))return null;let Q=J.details,X=Q.fragments[Y-Q.startSN];if(X)return X;if(X=Q.fragmentHint,X&&X.sn===Y)return X;if(Y<Q.startSN&&Z&&Z.sn===Y)return Z;return null}function M8(J,Y,Z){var Q;if(!(J!=null&&J.details))return null;return $Y((Q=J.details)==null?void 0:Q.partList,Y,Z)}function $Y(J,Y,Z){if(J)for(let Q=J.length;Q--;){let X=J[Q];if(X.index===Z&&X.fragment.sn===Y)return X}return null}function OY(J){J.forEach((Y,Z)=>{let{details:Q}=Y;if(Q!=null&&Q.fragments)Q.fragments.forEach((X)=>{X.level=Z})})}function x6(J){switch(J.details){case I.FRAG_LOAD_TIMEOUT:case I.KEY_LOAD_TIMEOUT:case I.LEVEL_LOAD_TIMEOUT:case I.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function F8(J,Y){let Z=x6(Y);return J.default[`${Z?"timeout":"error"}Retry`]}function vJ(J,Y){let Z=J.backoff==="linear"?1:Math.pow(2,Y);return Math.min(Z*J.retryDelayMs,J.maxRetryDelayMs)}function E8(J){return z0(z0({},J),{errorRetry:null,timeoutRetry:null})}function D6(J,Y,Z,Q){if(!J)return!1;let X=Q==null?void 0:Q.code,q=Y<J.maxNumRetry&&(aZ(X)||!!Z);return J.shouldRetry?J.shouldRetry(J,Y,Z,Q,q):q}function aZ(J){return J===0&&navigator.onLine===!1||!!J&&(J<400||J>499)}var _Y={search:function(J,Y){let Z=0,Q=J.length-1,X=null,q=null;while(Z<=Q){X=(Z+Q)/2|0,q=J[X];let W=Y(q);if(W>0)Z=X+1;else if(W<0)Q=X-1;else return q}return null}};function tZ(J,Y,Z){if(Y===null||!Array.isArray(J)||!J.length||!h(Y))return null;let Q=J[0].programDateTime;if(Y<(Q||0))return null;let X=J[J.length-1].endProgramDateTime;if(Y>=(X||0))return null;Z=Z||0;for(let q=0;q<J.length;++q){let W=J[q];if(JQ(Y,Z,W))return W}return null}function T6(J,Y,Z=0,Q=0,X=0.005){let q=null;if(J){q=Y[J.sn-Y[0].sn+1]||null;let z=J.endDTS-Z;if(z>0&&z<0.0000015)Z+=0.0000015}else if(Z===0&&Y[0].start===0)q=Y[0];if(q&&((!J||J.level===q.level)&&OJ(Z,Q,q)===0||eZ(q,J,Math.min(X,Q))))return q;let W=_Y.search(Y,OJ.bind(null,Z,Q));if(W&&(W!==J||!q))return W;return q}function eZ(J,Y,Z){if(Y&&Y.start===0&&Y.level<J.level&&(Y.endPTS||0)>0){let Q=Y.tagList.reduce((X,q)=>{if(q[0]==="INF")X+=parseFloat(q[1]);return X},Z);return J.start<=Q}return!1}function OJ(J=0,Y=0,Z){if(Z.start<=J&&Z.start+Z.duration>J)return 0;let Q=Math.min(Y,Z.duration+(Z.deltaPTS?Z.deltaPTS:0));if(Z.start+Z.duration-Q<=J)return 1;else if(Z.start-Q>J&&Z.start)return-1;return 0}function JQ(J,Y,Z){let Q=Math.min(Y,Z.duration+(Z.deltaPTS?Z.deltaPTS:0))*1000;return(Z.endProgramDateTime||0)-Q>J}function YQ(J,Y){return _Y.search(J,(Z)=>{if(Z.cc<Y)return 1;else if(Z.cc>Y)return-1;else return 0})}var q0={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},O0={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class AY{constructor(J){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=J,this.log=B.log.bind(B,"[info]:"),this.warn=B.warn.bind(B,"[warning]:"),this.error=B.error.bind(B,"[error]:"),this.registerListeners()}registerListeners(){let J=this.hls;J.on($.ERROR,this.onError,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let J=this.hls;if(!J)return;J.off($.ERROR,this.onError,this),J.off($.ERROR,this.onErrorOut,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.LEVEL_UPDATED,this.onLevelUpdated,this)}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(J){}stopLoad(){this.playlistError=0}getVariantLevelIndex(J){return(J==null?void 0:J.type)===m.MAIN?J.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(J,Y){var Z,Q;if(Y.fatal)return;let X=this.hls,q=Y.context;switch(Y.details){case I.FRAG_LOAD_ERROR:case I.FRAG_LOAD_TIMEOUT:case I.KEY_LOAD_ERROR:case I.KEY_LOAD_TIMEOUT:Y.errorAction=this.getFragRetryOrSwitchAction(Y);return;case I.FRAG_PARSING_ERROR:if((Z=Y.frag)!=null&&Z.gap){Y.errorAction={action:q0.DoNothing,flags:O0.None};return}case I.FRAG_GAP:case I.FRAG_DECRYPT_ERROR:{Y.errorAction=this.getFragRetryOrSwitchAction(Y),Y.errorAction.action=q0.SendAlternateToPenaltyBox;return}case I.LEVEL_EMPTY_ERROR:case I.LEVEL_PARSING_ERROR:{var W,z;let H=Y.parent===m.MAIN?Y.level:X.loadLevel;if(Y.details===I.LEVEL_EMPTY_ERROR&&!!((W=Y.context)!=null&&(z=W.levelDetails)!=null&&z.live))Y.errorAction=this.getPlaylistRetryOrSwitchAction(Y,H);else Y.levelRetry=!1,Y.errorAction=this.getLevelSwitchAction(Y,H)}return;case I.LEVEL_LOAD_ERROR:case I.LEVEL_LOAD_TIMEOUT:if(typeof(q==null?void 0:q.level)==="number")Y.errorAction=this.getPlaylistRetryOrSwitchAction(Y,q.level);return;case I.AUDIO_TRACK_LOAD_ERROR:case I.AUDIO_TRACK_LOAD_TIMEOUT:case I.SUBTITLE_LOAD_ERROR:case I.SUBTITLE_TRACK_LOAD_TIMEOUT:if(q){let H=X.levels[X.loadLevel];if(H&&(q.type===l.AUDIO_TRACK&&H.hasAudioGroup(q.groupId)||q.type===l.SUBTITLE_TRACK&&H.hasSubtitleGroup(q.groupId))){Y.errorAction=this.getPlaylistRetryOrSwitchAction(Y,X.loadLevel),Y.errorAction.action=q0.SendAlternateToPenaltyBox,Y.errorAction.flags=O0.MoveAllAlternatesMatchingHost;return}}return;case I.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let H=X.levels[X.loadLevel],G=H==null?void 0:H.attrs["HDCP-LEVEL"];if(G)Y.errorAction={action:q0.SendAlternateToPenaltyBox,flags:O0.MoveAllAlternatesMatchingHDCP,hdcpLevel:G};else this.keySystemError(Y)}return;case I.BUFFER_ADD_CODEC_ERROR:case I.REMUX_ALLOC_ERROR:case I.BUFFER_APPEND_ERROR:Y.errorAction=this.getLevelSwitchAction(Y,(Q=Y.level)!=null?Q:X.loadLevel);return;case I.INTERNAL_EXCEPTION:case I.BUFFER_APPENDING_ERROR:case I.BUFFER_FULL_ERROR:case I.LEVEL_SWITCH_ERROR:case I.BUFFER_STALLED_ERROR:case I.BUFFER_SEEK_OVER_HOLE:case I.BUFFER_NUDGE_ON_STALL:Y.errorAction={action:q0.DoNothing,flags:O0.None};return}if(Y.type===g.KEY_SYSTEM_ERROR)this.keySystemError(Y)}keySystemError(J){let Y=this.getVariantLevelIndex(J.frag);J.levelRetry=!1,J.errorAction=this.getLevelSwitchAction(J,Y)}getPlaylistRetryOrSwitchAction(J,Y){let Z=this.hls,Q=F8(Z.config.playlistLoadPolicy,J),X=this.playlistError++;if(D6(Q,X,x6(J),J.response))return{action:q0.RetryRequest,flags:O0.None,retryConfig:Q,retryCount:X};let W=this.getLevelSwitchAction(J,Y);if(Q)W.retryConfig=Q,W.retryCount=X;return W}getFragRetryOrSwitchAction(J){let Y=this.hls,Z=this.getVariantLevelIndex(J.frag),Q=Y.levels[Z],{fragLoadPolicy:X,keyLoadPolicy:q}=Y.config,W=F8(J.details.startsWith("key")?q:X,J),z=Y.levels.reduce((G,j)=>G+j.fragmentError,0);if(Q){if(J.details!==I.FRAG_GAP)Q.fragmentError++;if(D6(W,z,x6(J),J.response))return{action:q0.RetryRequest,flags:O0.None,retryConfig:W,retryCount:z}}let H=this.getLevelSwitchAction(J,Z);if(W)H.retryConfig=W,H.retryCount=z;return H}getLevelSwitchAction(J,Y){let Z=this.hls;if(Y===null||Y===void 0)Y=Z.loadLevel;let Q=this.hls.levels[Y];if(Q){var X,q;let H=J.details;if(Q.loadError++,H===I.BUFFER_APPEND_ERROR)Q.fragmentError++;let G=-1,{levels:j,loadLevel:N,minAutoLevel:K,maxAutoLevel:V}=Z;if(!Z.autoLevelEnabled)Z.loadLevel=-1;let U=(X=J.frag)==null?void 0:X.type,_=(U===m.AUDIO&&H===I.FRAG_PARSING_ERROR||J.sourceBufferName==="audio"&&(H===I.BUFFER_ADD_CODEC_ERROR||H===I.BUFFER_APPEND_ERROR))&&j.some(({audioCodec:P})=>Q.audioCodec!==P),R=J.sourceBufferName==="video"&&(H===I.BUFFER_ADD_CODEC_ERROR||H===I.BUFFER_APPEND_ERROR)&&j.some(({codecSet:P,audioCodec:w})=>Q.codecSet!==P&&Q.audioCodec===w),{type:E,groupId:F}=(q=J.context)!=null?q:{};for(let P=j.length;P--;){let w=(P+N)%j.length;if(w!==N&&w>=K&&w<=V&&j[w].loadError===0){var W,z;let b=j[w];if(H===I.FRAG_GAP&&U===m.MAIN&&J.frag){let x=j[w].details;if(x){let D=T6(J.frag,x.fragments,J.frag.start);if(D!=null&&D.gap)continue}}else if(E===l.AUDIO_TRACK&&b.hasAudioGroup(F)||E===l.SUBTITLE_TRACK&&b.hasSubtitleGroup(F))continue;else if(U===m.AUDIO&&(W=Q.audioGroups)!=null&&W.some((x)=>b.hasAudioGroup(x))||U===m.SUBTITLE&&(z=Q.subtitleGroups)!=null&&z.some((x)=>b.hasSubtitleGroup(x))||_&&Q.audioCodec===b.audioCodec||!_&&Q.audioCodec!==b.audioCodec||R&&Q.codecSet===b.codecSet)continue;G=w;break}}if(G>-1&&Z.loadLevel!==G)return J.levelRetry=!0,this.playlistError=0,{action:q0.SendAlternateToPenaltyBox,flags:O0.None,nextAutoLevel:G}}return{action:q0.SendAlternateToPenaltyBox,flags:O0.MoveAllAlternatesMatchingHost}}onErrorOut(J,Y){var Z;switch((Z=Y.errorAction)==null?void 0:Z.action){case q0.DoNothing:break;case q0.SendAlternateToPenaltyBox:if(this.sendAlternateToPenaltyBox(Y),!Y.errorAction.resolved&&Y.details!==I.FRAG_GAP)Y.fatal=!0;else if(/MediaSource readyState: ended/.test(Y.error.message))this.warn(`MediaSource ended after "${Y.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError();break;case q0.RetryRequest:break}if(Y.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(J){let Y=this.hls,Z=J.errorAction;if(!Z)return;let{flags:Q,hdcpLevel:X,nextAutoLevel:q}=Z;switch(Q){case O0.None:this.switchLevel(J,q);break;case O0.MoveAllAlternatesMatchingHDCP:if(X)Y.maxHdcpLevel=VJ[VJ.indexOf(X)-1],Z.resolved=!0;this.warn(`Restricting playback to HDCP-LEVEL of "${Y.maxHdcpLevel}" or lower`);break}if(!Z.resolved)this.switchLevel(J,q)}switchLevel(J,Y){if(Y!==void 0&&J.errorAction)this.warn(`switching to level ${Y} after ${J.details}`),this.hls.nextAutoLevel=Y,J.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel}}class v6{constructor(J,Y){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=B.log.bind(B,`${Y}:`),this.warn=B.warn.bind(B,`${Y}:`),this.hls=J}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){if(this.timer!==-1)self.clearTimeout(this.timer),this.timer=-1}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(J,Y,Z){let Q=Y==null?void 0:Y.renditionReports;if(Q){let X=-1;for(let q=0;q<Q.length;q++){let W=Q[q],z;try{z=new self.URL(W.URI,Y.url).href}catch(H){B.warn(`Could not construct new URL for Rendition Report: ${H}`),z=W.URI||""}if(z===J){X=q;break}else if(z===J.substring(0,z.length))X=q}if(X!==-1){let q=Q[X],W=parseInt(q["LAST-MSN"])||(Y==null?void 0:Y.lastPartSn),z=parseInt(q["LAST-PART"])||(Y==null?void 0:Y.lastPartIndex);if(this.hls.config.lowLatencyMode){let G=Math.min(Y.age-Y.partTarget,Y.targetduration);if(z>=0&&G>Y.partTarget)z+=1}let H=Z&&B8(Z);return new UJ(W,z>=0?z:void 0,H)}}}loadPlaylist(J){if(this.requestScheduled===-1)this.requestScheduled=self.performance.now()}shouldLoadPlaylist(J){return this.canLoad&&!!J&&!!J.url&&(!J.details||J.details.live)}shouldReloadPlaylist(J){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(J)}playlistLoaded(J,Y,Z){let{details:Q,stats:X}=Y,q=self.performance.now(),W=X.loading.first?Math.max(0,q-X.loading.first):0;if(Q.advancedDateTime=Date.now()-W,Q.live||Z!=null&&Z.live){if(Q.reloaded(Z),Z)this.log(`live playlist ${J} ${Q.advanced?"REFRESHED "+Q.lastPartSn+"-"+Q.lastPartIndex:Q.updated?"UPDATED":"MISSED"}`);if(Z&&Q.fragments.length>0)lZ(Z,Q);if(!this.canLoad||!Q.live)return;let z,H=void 0,G=void 0;if(Q.canBlockReload&&Q.endSN&&Q.advanced){let O=this.hls.config.lowLatencyMode,_=Q.lastPartSn,A=Q.endSN,R=Q.lastPartIndex,E=R!==-1,F=_===A,P=O?0:R;if(E)H=F?A+1:_,G=F?P:R+1;else H=A+1;let w=Q.age,b=w+Q.ageHeader,x=Math.min(b-Q.partTarget,Q.targetduration*1.5);if(x>0){if(Z&&x>Z.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${Z.tuneInGoal} to: ${x} with playlist age: ${Q.age}`),x=0;else{let D=Math.floor(x/Q.targetduration);if(H+=D,G!==void 0){let L=Math.round(x%Q.targetduration/Q.partTarget);G+=L}this.log(`CDN Tune-in age: ${Q.ageHeader}s last advanced ${w.toFixed(2)}s goal: ${x} skip sn ${D} to part ${G}`)}Q.tuneInGoal=x}if(z=this.getDeliveryDirectives(Q,Y.deliveryDirectives,H,G),O||!F){this.loadPlaylist(z);return}}else if(Q.canBlockReload||Q.canSkipUntil)z=this.getDeliveryDirectives(Q,Y.deliveryDirectives,H,G);let j=this.hls.mainForwardBufferInfo,N=j?j.end-j.len:0,K=(Q.edge-N)*1000,V=sZ(Q,K);if(Q.updated&&q>this.requestScheduled+V)this.requestScheduled=X.loading.start;if(H!==void 0&&Q.canBlockReload)this.requestScheduled=X.loading.first+V-(Q.partTarget*1000||1000);else if(this.requestScheduled===-1||this.requestScheduled+V<q)this.requestScheduled=q;else if(this.requestScheduled-q<=0)this.requestScheduled+=V;let U=this.requestScheduled-q;U=Math.max(0,U),this.log(`reload live playlist ${J} in ${Math.round(U)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(z),U)}else this.clearTimer()}getDeliveryDirectives(J,Y,Z,Q){let X=B8(J);if(Y!=null&&Y.skip&&J.deltaUpdateFailed)Z=Y.msn,Q=Y.part,X=A6.No;return new UJ(Z,Q,X)}checkRetry(J){let Y=J.details,Z=x6(J),Q=J.errorAction,{action:X,retryCount:q=0,retryConfig:W}=Q||{},z=!!Q&&!!W&&(X===q0.RetryRequest||!Q.resolved&&X===q0.SendAlternateToPenaltyBox);if(z){var H;if(this.requestScheduled=-1,q>=W.maxNumRetry)return!1;if(Z&&(H=J.context)!=null&&H.deliveryDirectives)this.warn(`Retrying playlist loading ${q+1}/${W.maxNumRetry} after "${Y}" without delivery-directives`),this.loadPlaylist();else{let G=vJ(W,q);this.timer=self.setTimeout(()=>this.loadPlaylist(),G),this.warn(`Retrying playlist loading ${q+1}/${W.maxNumRetry} after "${Y}" in ${G}ms`)}J.levelRetry=!0,Q.resolved=!0}return z}}class y0{constructor(J,Y=0,Z=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=J,this.alpha_=J?Math.exp(Math.log(0.5)/J):0,this.estimate_=Y,this.totalWeight_=Z}sample(J,Y){let Z=Math.pow(this.alpha_,J);this.estimate_=Y*(1-Z)+Z*this.estimate_,this.totalWeight_+=J}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let J=1-Math.pow(this.alpha_,this.totalWeight_);if(J)return this.estimate_/J}return this.estimate_}}class BY{constructor(J,Y,Z,Q=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=Z,this.minWeight_=0.001,this.minDelayMs_=50,this.slow_=new y0(J),this.fast_=new y0(Y),this.defaultTTFB_=Q,this.ttfb_=new y0(J)}update(J,Y){let{slow_:Z,fast_:Q,ttfb_:X}=this;if(Z.halfLife!==J)this.slow_=new y0(J,Z.getEstimate(),Z.getTotalWeight());if(Q.halfLife!==Y)this.fast_=new y0(Y,Q.getEstimate(),Q.getTotalWeight());if(X.halfLife!==J)this.ttfb_=new y0(J,X.getEstimate(),X.getTotalWeight())}sample(J,Y){J=Math.max(J,this.minDelayMs_);let Z=8*Y,Q=J/1000,X=Z/Q;this.fast_.sample(Q,X),this.slow_.sample(Q,X)}sampleTTFB(J){let Y=J/1000,Z=Math.sqrt(2)*Math.exp(-Math.pow(Y,2)/2);this.ttfb_.sample(Z,Math.max(J,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){if(this.canEstimate())return Math.min(this.fast_.getEstimate(),this.slow_.getEstimate());else return this.defaultEstimate_}getEstimateTTFB(){if(this.ttfb_.getTotalWeight()>=this.minWeight_)return this.ttfb_.getEstimate();else return this.defaultTTFB_}destroy(){}}var RY={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},I8={};function ZQ(J,Y,Z,Q,X,q){let W=J.audioCodec?J.audioGroups:null,z=q==null?void 0:q.audioCodec,H=q==null?void 0:q.channels,G=H?parseInt(H):z?1/0:2,j=null;if(W!=null&&W.length)try{if(W.length===1&&W[0])j=Y.groups[W[0]].channels;else j=W.reduce((N,K)=>{if(K){let V=Y.groups[K];if(!V)throw new Error(`Audio track group ${K} not found`);Object.keys(V.channels).forEach((U)=>{N[U]=(N[U]||0)+V.channels[U]})}return N},{2:0})}catch(N){return!0}return J.videoCodec!==void 0&&(J.width>1920&&J.height>1088||J.height>1920&&J.width>1088||J.frameRate>Math.max(Q,30)||J.videoRange!=="SDR"&&J.videoRange!==Z||J.bitrate>Math.max(X,8000000))||!!j&&h(G)&&Object.keys(j).some((N)=>parseInt(N)>G)}function QQ(J,Y,Z){let{videoCodec:Q,audioCodec:X}=J;if(!Q||!X||!Z)return Promise.resolve(RY);let q={width:J.width,height:J.height,bitrate:Math.ceil(Math.max(J.bitrate*0.9,J.averageBitrate)),framerate:J.frameRate||30},W=J.videoRange;if(W!=="SDR")q.transferFunction=W.toLowerCase();let z=Q.split(",").map((H)=>({type:"media-source",video:z0(z0({},q),{},{contentType:X6(H,"video")})}));if(X&&J.audioGroups)J.audioGroups.forEach((H)=>{var G;if(!H)return;(G=Y.groups[H])==null||G.tracks.forEach((j)=>{if(j.groupId===H){let N=j.channels||"",K=parseFloat(N);if(h(K)&&K>2)z.push.apply(z,X.split(",").map((V)=>({type:"media-source",audio:{contentType:X6(V,"audio"),channels:""+K}})))}})});return Promise.all(z.map((H)=>{let G=XQ(H);return I8[G]||(I8[G]=Z.decodingInfo(H))})).then((H)=>({supported:!H.some((G)=>!G.supported),configurations:z,decodingInfoResults:H})).catch((H)=>({supported:!1,configurations:z,decodingInfoResults:[],error:H}))}function XQ(J){let{audio:Y,video:Z}=J,Q=Z||Y;if(Q){let X=Q.contentType.split('"')[1];if(Z)return`r${Z.height}x${Z.width}f${Math.ceil(Z.framerate)}${Z.transferFunction||"sd"}_${X}_${Math.ceil(Z.bitrate/1e5)}`;if(Y)return`c${Y.channels}${Y.spatialRendering?"s":"n"}_${X}`}return""}function qQ(){if(typeof matchMedia==="function"){let J=matchMedia("(dynamic-range: high)"),Y=matchMedia("bad query");if(J.media!==Y.media)return J.matches===!0}return!1}function WQ(J,Y){let Z=!1,Q=[];if(J)Z=J!=="SDR",Q=[J];if(Y)if(Q=Y.allowedVideoRanges||b6.slice(0),Z=Y.preferHDR!==void 0?Y.preferHDR:qQ(),Z)Q=Q.filter((X)=>X!=="SDR");else Q=["SDR"];return{preferHDR:Z,allowedVideoRanges:Q}}function zQ(J,Y,Z,Q,X){let q=Object.keys(J),W=Q==null?void 0:Q.channels,z=Q==null?void 0:Q.audioCodec,H=W&&parseInt(W)===2,G=!0,j=!1,N=1/0,K=1/0,V=1/0,U=0,O=[],{preferHDR:_,allowedVideoRanges:A}=WQ(Y,X);for(let P=q.length;P--;){let w=J[q[P]];G=w.channels[2]>0,N=Math.min(N,w.minHeight),K=Math.min(K,w.minFramerate),V=Math.min(V,w.minBitrate);let b=A.filter((x)=>w.videoRanges[x]>0);if(b.length>0)j=!0,O=b}N=h(N)?N:0,K=h(K)?K:0;let R=Math.max(1080,N),E=Math.max(30,K);if(V=h(V)?V:Z,Z=Math.max(V,Z),!j)Y=void 0,O=[];return{codecSet:q.reduce((P,w)=>{let b=J[w];if(w===P)return P;if(b.minBitrate>Z)return P0(w,`min bitrate of ${b.minBitrate} > current estimate of ${Z}`),P;if(!b.hasDefaultAudio)return P0(w,"no renditions with default or auto-select sound found"),P;if(z&&w.indexOf(z.substring(0,4))%5!==0)return P0(w,`audio codec preference "${z}" not found`),P;if(W&&!H){if(!b.channels[W])return P0(w,`no renditions with ${W} channel sound found (channels options: ${Object.keys(b.channels)})`),P}else if((!z||H)&&G&&b.channels["2"]===0)return P0(w,"no renditions with stereo sound found"),P;if(b.minHeight>R)return P0(w,`min resolution of ${b.minHeight} > maximum of ${R}`),P;if(b.minFramerate>E)return P0(w,`min framerate of ${b.minFramerate} > maximum of ${E}`),P;if(!O.some((x)=>b.videoRanges[x]>0))return P0(w,`no variants with VIDEO-RANGE of ${JSON.stringify(O)} found`),P;if(b.maxScore<U)return P0(w,`max score of ${b.maxScore} < selected max of ${U}`),P;if(P&&(P6(w)>=P6(P)||b.fragmentError>J[P].fragmentError))return P;return U=b.maxScore,w},void 0),videoRanges:O,preferHDR:_,minFramerate:K,minBitrate:V}}function P0(J,Y){B.log(`[abr] start candidates with "${J}" ignored because ${Y}`)}function HQ(J){return J.reduce((Y,Z)=>{let Q=Y.groups[Z.groupId];if(!Q)Q=Y.groups[Z.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1};Q.tracks.push(Z);let X=Z.channels||"2";if(Q.channels[X]=(Q.channels[X]||0)+1,Q.hasDefault=Q.hasDefault||Z.default,Q.hasAutoSelect=Q.hasAutoSelect||Z.autoselect,Q.hasDefault)Y.hasDefaultAudio=!0;if(Q.hasAutoSelect)Y.hasAutoSelectAudio=!0;return Y},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function GQ(J,Y,Z,Q){return J.slice(Z,Q+1).reduce((X,q)=>{if(!q.codecSet)return X;let W=q.audioGroups,z=X[q.codecSet];if(!z)X[q.codecSet]=z={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{"2":0},hasDefaultAudio:!W,fragmentError:0};z.minBitrate=Math.min(z.minBitrate,q.bitrate);let H=Math.min(q.height,q.width);if(z.minHeight=Math.min(z.minHeight,H),z.minFramerate=Math.min(z.minFramerate,q.frameRate),z.maxScore=Math.max(z.maxScore,q.score),z.fragmentError+=q.fragmentError,z.videoRanges[q.videoRange]=(z.videoRanges[q.videoRange]||0)+1,W)W.forEach((G)=>{if(!G)return;let j=Y.groups[G];if(!j)return;z.hasDefaultAudio=z.hasDefaultAudio||Y.hasDefaultAudio?j.hasDefault:j.hasAutoSelect||!Y.hasDefaultAudio&&!Y.hasAutoSelectAudio,Object.keys(j.channels).forEach((N)=>{z.channels[N]=(z.channels[N]||0)+j.channels[N]})});return X},{})}function I0(J,Y,Z){if("attrs"in J){let Q=Y.indexOf(J);if(Q!==-1)return Q}for(let Q=0;Q<Y.length;Q++){let X=Y[Q];if(o0(J,X,Z))return Q}return-1}function o0(J,Y,Z){let{groupId:Q,name:X,lang:q,assocLang:W,characteristics:z,default:H}=J,G=J.forced;return(Q===void 0||Y.groupId===Q)&&(X===void 0||Y.name===X)&&(q===void 0||Y.lang===q)&&(q===void 0||Y.assocLang===W)&&(H===void 0||Y.default===H)&&(G===void 0||Y.forced===G)&&(z===void 0||jQ(z,Y.characteristics))&&(Z===void 0||Z(J,Y))}function jQ(J,Y=""){let Z=J.split(","),Q=Y.split(",");return Z.length===Q.length&&!Z.some((X)=>Q.indexOf(X)===-1)}function g0(J,Y){let{audioCodec:Z,channels:Q}=J;return(Z===void 0||(Y.audioCodec||"").substring(0,4)===Z.substring(0,4))&&(Q===void 0||Q===(Y.channels||"2"))}function NQ(J,Y,Z,Q,X){let q=Y[Q],z=Y.reduce((K,V,U)=>{let O=V.uri;return(K[O]||(K[O]=[])).push(U),K},{})[q.uri];if(z.length>1)Q=Math.max.apply(Math,z);let{videoRange:H,frameRate:G}=q,j=q.codecSet.substring(0,4),N=w8(Y,Q,(K)=>{if(K.videoRange!==H||K.frameRate!==G||K.codecSet.substring(0,4)!==j)return!1;let V=K.audioGroups,U=Z.filter((O)=>!V||V.indexOf(O.groupId)!==-1);return I0(J,U,X)>-1});if(N>-1)return N;return w8(Y,Q,(K)=>{let V=K.audioGroups,U=Z.filter((O)=>!V||V.indexOf(O.groupId)!==-1);return I0(J,U,X)>-1})}function w8(J,Y,Z){for(let Q=Y;Q>-1;Q--)if(Z(J[Q]))return Q;for(let Q=Y+1;Q<J.length;Q++)if(Z(J[Q]))return Q;return-1}class MY{constructor(J){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{let{fragCurrent:Y,partCurrent:Z,hls:Q}=this,{autoLevelEnabled:X,media:q}=Q;if(!Y||!q)return;let W=performance.now(),z=Z?Z.stats:Y.stats,H=Z?Z.duration:Y.duration,G=W-z.loading.start,j=Q.minAutoLevel;if(z.aborted||z.loaded&&z.loaded===z.total||Y.level<=j){this.clearTimer(),this._nextAutoLevel=-1;return}if(!X||q.paused||!q.playbackRate||!q.readyState)return;let N=Q.mainForwardBufferInfo;if(N===null)return;let K=this.bwEstimator.getEstimateTTFB(),V=Math.abs(q.playbackRate);if(G<=Math.max(K,1000*(H/(V*2))))return;let U=N.len/V,O=z.loading.first?z.loading.first-z.loading.start:-1,_=z.loaded&&O>-1,A=this.getBwEstimate(),R=Q.levels,E=R[Y.level],F=z.total||Math.max(z.loaded,Math.round(H*E.averageBitrate/8)),P=_?G-O:G;if(P<1&&_)P=Math.min(G,z.loaded*8/A);let w=_?z.loaded*1000/P:0,b=w?(F-z.loaded)/w:F*8/A+K/1000;if(b<=U)return;let x=w?w*8:A,D=Number.POSITIVE_INFINITY,L;for(L=Y.level-1;L>j;L--){let T=R[L].maxBitrate;if(D=this.getTimeToLoadFrag(K/1000,x,H*T,!R[L].details),D<U)break}if(D>=b)return;if(D>H*10)return;if(Q.nextLoadLevel=Q.nextAutoLevel=L,_)this.bwEstimator.sample(G-Math.min(K,O),z.loaded);else this.bwEstimator.sampleTTFB(G);let k=R[L].maxBitrate;if(this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>k)this.resetEstimator(k);this.clearTimer(),B.warn(`[abr] Fragment ${Y.sn}${Z?" part "+Z.index:""} of level ${Y.level} is loading too slowly;
      Time to underbuffer: ${U.toFixed(3)} s
      Estimated load time for current fragment: ${b.toFixed(3)} s
      Estimated load time for down switch fragment: ${D.toFixed(3)} s
      TTFB estimate: ${O|0} ms
      Current BW estimate: ${h(A)?A|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${L} @ ${k|0} bps`),Q.trigger($.FRAG_LOAD_EMERGENCY_ABORTED,{frag:Y,part:Z,stats:z})},this.hls=J,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(J){if(J)B.log(`setting initial bwe to ${J}`),this.hls.config.abrEwmaDefaultEstimate=J;this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let J=this.hls.config;return new BY(J.abrEwmaSlowVoD,J.abrEwmaFastVoD,J.abrEwmaDefaultEstimate)}registerListeners(){let{hls:J}=this;J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.FRAG_LOADING,this.onFragLoading,this),J.on($.FRAG_LOADED,this.onFragLoaded,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this),J.on($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.on($.LEVEL_LOADED,this.onLevelLoaded,this),J.on($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.on($.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),J.on($.ERROR,this.onError,this)}unregisterListeners(){let{hls:J}=this;if(!J)return;J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.FRAG_LOADING,this.onFragLoading,this),J.off($.FRAG_LOADED,this.onFragLoaded,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this),J.off($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.off($.LEVEL_LOADED,this.onLevelLoaded,this),J.off($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.off($.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),J.off($.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(J,Y){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){if(this.lastLoadedFragLevel>-1&&this.fragCurrent)this.lastLoadedFragLevel=this.fragCurrent.level;this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(J,Y){let Z=Y.frag;if(this.ignoreFragment(Z))return;if(!Z.bitrateTest){var Q;this.fragCurrent=Z,this.partCurrent=(Q=Y.part)!=null?Q:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}onLevelSwitching(J,Y){this.clearTimer()}onError(J,Y){if(Y.fatal)return;switch(Y.details){case I.BUFFER_ADD_CODEC_ERROR:case I.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case I.FRAG_LOAD_TIMEOUT:{let Z=Y.frag,{fragCurrent:Q,partCurrent:X}=this;if(Z&&Q&&Z.sn===Q.sn&&Z.level===Q.level){let q=performance.now(),W=X?X.stats:Z.stats,z=q-W.loading.start,H=W.loading.first?W.loading.first-W.loading.start:-1;if(W.loaded&&H>-1){let j=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(z-Math.min(j,H),W.loaded)}else this.bwEstimator.sampleTTFB(z)}break}}}getTimeToLoadFrag(J,Y,Z,Q){let X=J+Z/Y,q=Q?this.lastLevelLoadSec:0;return X+q}onLevelLoaded(J,Y){let Z=this.hls.config,{loading:Q}=Y.stats,X=Q.end-Q.start;if(h(X))this.lastLevelLoadSec=X/1000;if(Y.details.live)this.bwEstimator.update(Z.abrEwmaSlowLive,Z.abrEwmaFastLive);else this.bwEstimator.update(Z.abrEwmaSlowVoD,Z.abrEwmaFastVoD)}onFragLoaded(J,{frag:Y,part:Z}){let Q=Z?Z.stats:Y.stats;if(Y.type===m.MAIN)this.bwEstimator.sampleTTFB(Q.loading.first-Q.loading.start);if(this.ignoreFragment(Y))return;if(this.clearTimer(),Y.level===this._nextAutoLevel)this._nextAutoLevel=-1;if(this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let X=Z?Z.duration:Y.duration,q=this.hls.levels[Y.level],W=(q.loaded?q.loaded.bytes:0)+Q.loaded,z=(q.loaded?q.loaded.duration:0)+X;q.loaded={bytes:W,duration:z},q.realBitrate=Math.round(8*W/z)}if(Y.bitrateTest){let X={stats:Q,frag:Y,part:Z,id:Y.type};this.onFragBuffered($.FRAG_BUFFERED,X),Y.bitrateTest=!1}else this.lastLoadedFragLevel=Y.level}onFragBuffered(J,Y){let{frag:Z,part:Q}=Y,X=Q!=null&&Q.stats.loaded?Q.stats:Z.stats;if(X.aborted)return;if(this.ignoreFragment(Z))return;let q=X.parsing.end-X.loading.start-Math.min(X.loading.first-X.loading.start,this.bwEstimator.getEstimateTTFB());if(this.bwEstimator.sample(q,X.loaded),X.bwEstimate=this.getBwEstimate(),Z.bitrateTest)this.bitrateTestDelay=q/1000;else this.bitrateTestDelay=0}ignoreFragment(J){return J.type!==m.MAIN||J.sn==="initSegment"}clearTimer(){if(this.timer>-1)self.clearInterval(this.timer),this.timer=-1}get firstAutoLevel(){let{maxAutoLevel:J,minAutoLevel:Y}=this.hls,Z=this.getBwEstimate(),Q=this.hls.config.maxStarvationDelay,X=this.findBestLevel(Z,Y,J,0,Q,1,1);if(X>-1)return X;let q=this.hls.firstLevel,W=Math.min(Math.max(q,Y),J);return B.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${q} clamped to ${W}`),W}get forcedAutoLevel(){if(this.nextAutoLevelKey)return-1;return this._nextAutoLevel}get nextAutoLevel(){let J=this.forcedAutoLevel,Z=this.bwEstimator.canEstimate(),Q=this.lastLoadedFragLevel>-1;if(J!==-1&&(!Z||!Q||this.nextAutoLevelKey===this.getAutoLevelKey()))return J;let X=Z&&Q?this.getNextABRAutoLevel():this.firstAutoLevel;if(J!==-1){let q=this.hls.levels;if(q.length>Math.max(J,X)&&q[J].loadError<=q[X].loadError)return J}return this._nextAutoLevel=X,this.nextAutoLevelKey=this.getAutoLevelKey(),X}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent:J,partCurrent:Y,hls:Z}=this,{maxAutoLevel:Q,config:X,minAutoLevel:q}=Z,W=Y?Y.duration:J?J.duration:0,z=this.getBwEstimate(),H=this.getStarvationDelay(),G=X.abrBandWidthFactor,j=X.abrBandWidthUpFactor;if(H){let O=this.findBestLevel(z,q,Q,H,0,G,j);if(O>=0)return O}let N=W?Math.min(W,X.maxStarvationDelay):X.maxStarvationDelay;if(!H){let O=this.bitrateTestDelay;if(O)N=(W?Math.min(W,X.maxLoadingDelay):X.maxLoadingDelay)-O,B.info(`[abr] bitrate test took ${Math.round(1000*O)}ms, set first fragment max fetchDuration to ${Math.round(1000*N)} ms`),G=j=1}let K=this.findBestLevel(z,q,Q,H,N,G,j);if(B.info(`[abr] ${H?"rebuffering expected":"buffer is empty"}, optimal quality level ${K}`),K>-1)return K;let V=Z.levels[q],U=Z.levels[Z.loadLevel];if((V==null?void 0:V.bitrate)<(U==null?void 0:U.bitrate))return q;return Z.loadLevel}getStarvationDelay(){let J=this.hls,Y=J.media;if(!Y)return 1/0;let Z=Y&&Y.playbackRate!==0?Math.abs(Y.playbackRate):1,Q=J.mainForwardBufferInfo;return(Q?Q.len:0)/Z}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(J,Y,Z,Q,X,q,W){var z;let H=Q+X,G=this.lastLoadedFragLevel,j=G===-1?this.hls.firstLevel:G,{fragCurrent:N,partCurrent:K}=this,{levels:V,allAudioTracks:U,loadLevel:O,config:_}=this.hls;if(V.length===1)return 0;let A=V[j],R=!!(A!=null&&(z=A.details)!=null&&z.live),E=O===-1||G===-1,F,P="SDR",w=(A==null?void 0:A.frameRate)||0,{audioPreference:b,videoPreference:x}=_,D=this.audioTracksByGroup||(this.audioTracksByGroup=HQ(U));if(E){if(this.firstSelection!==-1)return this.firstSelection;let f=this.codecTiers||(this.codecTiers=GQ(V,D,Y,Z)),v=zQ(f,P,J,b,x),{codecSet:n,videoRanges:i,minFramerate:y,minBitrate:S,preferHDR:o}=v;F=n,P=o?i[i.length-1]:i[0],w=y,J=Math.max(J,S),B.log(`[abr] picked start tier ${JSON.stringify(v)}`)}else F=A==null?void 0:A.codecSet,P=A==null?void 0:A.videoRange;let L=K?K.duration:N?N.duration:0,k=this.bwEstimator.getEstimateTTFB()/1000,T=[];for(let f=Z;f>=Y;f--){var u;let v=V[f],n=f>j;if(!v)continue;if(_.useMediaCapabilities&&!v.supportedResult&&!v.supportedPromise){let e=navigator.mediaCapabilities;if(typeof(e==null?void 0:e.decodingInfo)==="function"&&ZQ(v,D,P,w,J,b))v.supportedPromise=QQ(v,D,e),v.supportedPromise.then((Q0)=>{if(!this.hls)return;v.supportedResult=Q0;let H0=this.hls.levels,j0=H0.indexOf(v);if(Q0.error)B.warn(`[abr] MediaCapabilities decodingInfo error: "${Q0.error}" for level ${j0} ${JSON.stringify(Q0)}`);else if(!Q0.supported){if(B.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${j0} ${JSON.stringify(Q0)}`),j0>-1&&H0.length>1)B.log(`[abr] Removing unsupported level ${j0}`),this.hls.removeLevel(j0)}});else v.supportedResult=RY}if(F&&v.codecSet!==F||P&&v.videoRange!==P||n&&w>v.frameRate||!n&&w>0&&w<v.frameRate||v.supportedResult&&!((u=v.supportedResult.decodingInfoResults)!=null&&u[0].smooth)){T.push(f);continue}let i=v.details,y=(K?i==null?void 0:i.partTarget:i==null?void 0:i.averagetargetduration)||L,S;if(!n)S=q*J;else S=W*J;let o=L&&Q>=L*2&&X===0?V[f].averageBitrate:V[f].maxBitrate,r=this.getTimeToLoadFrag(k,S,o*y,i===void 0);if(S>=o&&(f===G||v.loadError===0&&v.fragmentError===0)&&(r<=k||!h(r)||R&&!this.bitrateTestDelay||r<H)){let e=this.forcedAutoLevel;if(f!==O&&(e===-1||e!==O)){if(T.length)B.trace(`[abr] Skipped level(s) ${T.join(",")} of ${Z} max with CODECS and VIDEO-RANGE:"${V[T[0]].codecs}" ${V[T[0]].videoRange}; not compatible with "${A.codecs}" ${P}`);B.info(`[abr] switch candidate:${j}->${f} adjustedbw(${Math.round(S)})-bitrate=${Math.round(S-o)} ttfb:${k.toFixed(1)} avgDuration:${y.toFixed(1)} maxFetchDuration:${H.toFixed(1)} fetchDuration:${r.toFixed(1)} firstSelection:${E} codecSet:${F} videoRange:${P} hls.loadLevel:${O}`)}if(E)this.firstSelection=f;return f}}return-1}set nextAutoLevel(J){let{maxAutoLevel:Y,minAutoLevel:Z}=this.hls,Q=Math.min(Math.max(J,Z),Y);if(this._nextAutoLevel!==Q)this.nextAutoLevelKey="",this._nextAutoLevel=Q}}class FY{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(J){if(!this._tickInterval)return this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,J),!0;return!1}clearInterval(){if(this._tickInterval)return self.clearInterval(this._tickInterval),this._tickInterval=null,!0;return!1}clearNextTick(){if(this._tickTimer)return self.clearTimeout(this._tickTimer),this._tickTimer=null,!0;return!1}tick(){if(this._tickCallCount++,this._tickCallCount===1){if(this.doTick(),this._tickCallCount>1)this.tickImmediate();this._tickCallCount=0}}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var W0={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class EY{constructor(J){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=0.2,this.hls=void 0,this.hasGaps=!1,this.hls=J,this._registerListeners()}_registerListeners(){let{hls:J}=this;J.on($.BUFFER_APPENDED,this.onBufferAppended,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this),J.on($.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls:J}=this;J.off($.BUFFER_APPENDED,this.onBufferAppended,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this),J.off($.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(J,Y){let Z=this.activePartLists[Y];if(Z)for(let Q=Z.length;Q--;){let X=Z[Q];if(!X)break;let q=X.end;if(X.start<=J&&q!==null&&J<=q)return X}return this.getBufferedFrag(J,Y)}getBufferedFrag(J,Y){let{fragments:Z}=this,Q=Object.keys(Z);for(let X=Q.length;X--;){let q=Z[Q[X]];if((q==null?void 0:q.body.type)===Y&&q.buffered){let W=q.body;if(W.start<=J&&J<=W.end)return W}}return null}detectEvictedFragments(J,Y,Z,Q){if(this.timeRanges)this.timeRanges[J]=Y;let X=(Q==null?void 0:Q.fragment.sn)||-1;Object.keys(this.fragments).forEach((q)=>{let W=this.fragments[q];if(!W)return;if(X>=W.body.sn)return;if(!W.buffered&&!W.loaded){if(W.body.type===Z)this.removeFragment(W.body);return}let z=W.range[J];if(!z)return;z.time.some((H)=>{let G=!this.isTimeBuffered(H.startPTS,H.endPTS,Y);if(G)this.removeFragment(W.body);return G})})}detectPartialFragments(J){let Y=this.timeRanges,{frag:Z,part:Q}=J;if(!Y||Z.sn==="initSegment")return;let X=u0(Z),q=this.fragments[X];if(!q||q.buffered&&Z.gap)return;let W=!Z.relurl;if(Object.keys(Y).forEach((z)=>{let H=Z.elementaryStreams[z];if(!H)return;let G=Y[z],j=W||H.partial===!0;q.range[z]=this.getBufferedTimes(Z,Q,j,G)}),q.loaded=null,Object.keys(q.range).length){if(q.buffered=!0,q.body.endList=Z.endList||q.body.endList)this.endListFragments[q.body.type]=q;if(!G6(q))this.removeParts(Z.sn-1,Z.type)}else this.removeFragment(q.body)}removeParts(J,Y){let Z=this.activePartLists[Y];if(!Z)return;this.activePartLists[Y]=Z.filter((Q)=>Q.fragment.sn>=J)}fragBuffered(J,Y){let Z=u0(J),Q=this.fragments[Z];if(!Q&&Y){if(Q=this.fragments[Z]={body:J,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},J.gap)this.hasGaps=!0}if(Q)Q.loaded=null,Q.buffered=!0}getBufferedTimes(J,Y,Z,Q){let X={time:[],partial:Z},q=J.start,W=J.end,z=J.minEndPTS||W,H=J.maxStartPTS||q;for(let G=0;G<Q.length;G++){let j=Q.start(G)-this.bufferPadding,N=Q.end(G)+this.bufferPadding;if(H>=j&&z<=N){X.time.push({startPTS:Math.max(q,Q.start(G)),endPTS:Math.min(W,Q.end(G))});break}else if(q<N&&W>j){let K=Math.max(q,Q.start(G)),V=Math.min(W,Q.end(G));if(V>K)X.partial=!0,X.time.push({startPTS:K,endPTS:V})}else if(W<=j)break}return X}getPartialFragment(J){let Y=null,Z,Q,X,q=0,{bufferPadding:W,fragments:z}=this;return Object.keys(z).forEach((H)=>{let G=z[H];if(!G)return;if(G6(G)){if(Q=G.body.start-W,X=G.body.end+W,J>=Q&&J<=X){if(Z=Math.min(J-Q,X-J),q<=Z)Y=G.body,q=Z}}}),Y}isEndListAppended(J){let Y=this.endListFragments[J];return Y!==void 0&&(Y.buffered||G6(Y))}getState(J){let Y=u0(J),Z=this.fragments[Y];if(Z)if(!Z.buffered)return W0.APPENDING;else if(G6(Z))return W0.PARTIAL;else return W0.OK;return W0.NOT_LOADED}isTimeBuffered(J,Y,Z){let Q,X;for(let q=0;q<Z.length;q++){if(Q=Z.start(q)-this.bufferPadding,X=Z.end(q)+this.bufferPadding,J>=Q&&Y<=X)return!0;if(Y<=Q)return!1}return!1}onFragLoaded(J,Y){let{frag:Z,part:Q}=Y;if(Z.sn==="initSegment"||Z.bitrateTest)return;let X=Q?null:Y,q=u0(Z);this.fragments[q]={body:Z,appendedPTS:null,loaded:X,buffered:!1,range:Object.create(null)}}onBufferAppended(J,Y){let{frag:Z,part:Q,timeRanges:X}=Y;if(Z.sn==="initSegment")return;let q=Z.type;if(Q){let W=this.activePartLists[q];if(!W)this.activePartLists[q]=W=[];W.push(Q)}this.timeRanges=X,Object.keys(X).forEach((W)=>{let z=X[W];this.detectEvictedFragments(W,z,q,Q)})}onFragBuffered(J,Y){this.detectPartialFragments(Y)}hasFragment(J){let Y=u0(J);return!!this.fragments[Y]}hasParts(J){var Y;return!!((Y=this.activePartLists[J])!=null&&Y.length)}removeFragmentsInRange(J,Y,Z,Q,X){if(Q&&!this.hasGaps)return;Object.keys(this.fragments).forEach((q)=>{let W=this.fragments[q];if(!W)return;let z=W.body;if(z.type!==Z||Q&&!z.gap)return;if(z.start<Y&&z.end>J&&(W.buffered||X))this.removeFragment(z)})}removeFragment(J){let Y=u0(J);J.stats.loaded=0,J.clearElementaryStreamInfo();let Z=this.activePartLists[J.type];if(Z){let Q=J.sn;this.activePartLists[J.type]=Z.filter((X)=>X.fragment.sn!==Q)}if(delete this.fragments[Y],J.endList)delete this.endListFragments[J.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function G6(J){var Y,Z,Q;return J.buffered&&(J.body.gap||((Y=J.range.video)==null?void 0:Y.partial)||((Z=J.range.audio)==null?void 0:Z.partial)||((Q=J.range.audiovideo)==null?void 0:Q.partial))}function u0(J){return`${J.type}_${J.level}_${J.sn}`}var KQ={length:0,start:()=>0,end:()=>0};class a{static isBuffered(J,Y){try{if(J){let Z=a.getBuffered(J);for(let Q=0;Q<Z.length;Q++)if(Y>=Z.start(Q)&&Y<=Z.end(Q))return!0}}catch(Z){}return!1}static bufferInfo(J,Y,Z){try{if(J){let Q=a.getBuffered(J),X=[],q;for(q=0;q<Q.length;q++)X.push({start:Q.start(q),end:Q.end(q)});return this.bufferedInfo(X,Y,Z)}}catch(Q){}return{len:0,start:Y,end:Y,nextStart:void 0}}static bufferedInfo(J,Y,Z){Y=Math.max(0,Y),J.sort(function(H,G){let j=H.start-G.start;if(j)return j;else return G.end-H.end});let Q=[];if(Z)for(let H=0;H<J.length;H++){let G=Q.length;if(G){let j=Q[G-1].end;if(J[H].start-j<Z){if(J[H].end>j)Q[G-1].end=J[H].end}else Q.push(J[H])}else Q.push(J[H])}else Q=J;let X=0,q,W=Y,z=Y;for(let H=0;H<Q.length;H++){let G=Q[H].start,j=Q[H].end;if(Y+Z>=G&&Y<j)W=G,z=j,X=z-Y;else if(Y+Z<G){q=G;break}}return{len:X,start:W||0,end:z||0,nextStart:q}}static getBuffered(J){try{return J.buffered}catch(Y){return B.log("failed to get media.buffered",Y),KQ}}}class p6{constructor(J,Y,Z,Q=0,X=-1,q=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=j6(),this.buffering={audio:j6(),video:j6(),audiovideo:j6()},this.level=J,this.sn=Y,this.id=Z,this.size=Q,this.part=X,this.partial=q}}function j6(){return{start:0,executeStart:0,executeEnd:0,end:0}}function B6(J,Y){for(let Q=0,X=J.length;Q<X;Q++){var Z;if(((Z=J[Q])==null?void 0:Z.cc)===Y)return J[Q]}return null}function VQ(J,Y,Z){if(Y){if(Z.endCC>Z.startCC||J&&J.cc<Z.startCC)return!0}return!1}function UQ(J,Y){let Z=J.fragments,Q=Y.fragments;if(!Q.length||!Z.length){B.log("No fragments to align");return}let X=B6(Z,Q[0].cc);if(!X||X&&!X.startPTS){B.log("No frag in previous level to align on");return}return X}function L8(J,Y){if(J){let Z=J.start+Y;J.start=J.startPTS=Z,J.endPTS=Z+J.duration}}function IY(J,Y){let Z=Y.fragments;for(let Q=0,X=Z.length;Q<X;Q++)L8(Z[Q],J);if(Y.fragmentHint)L8(Y.fragmentHint,J);Y.alignedSliding=!0}function $Q(J,Y,Z){if(!Y)return;if(OQ(J,Z,Y),!Z.alignedSliding&&Y)S6(Z,Y);if(!Z.alignedSliding&&Y&&!Z.skippedSegments)UY(Y,Z)}function OQ(J,Y,Z){if(VQ(J,Z,Y)){let Q=UQ(Z,Y);if(Q&&h(Q.start))B.log(`Adjusting PTS using last level due to CC increase within current level ${Y.url}`),IY(Q.start,Y)}}function S6(J,Y){if(!J.hasProgramDateTime||!Y.hasProgramDateTime)return;let Z=J.fragments,Q=Y.fragments;if(!Z.length||!Q.length)return;let X,q,W=Math.min(Y.endCC,J.endCC);if(Y.startCC<W&&J.startCC<W)X=B6(Q,W),q=B6(Z,W);if(!X||!q)X=Q[Math.floor(Q.length/2)],q=B6(Z,X.cc)||Z[Math.floor(Z.length/2)];let z=X.programDateTime,H=q.programDateTime;if(!z||!H)return;let G=(H-z)/1000-(q.start-X.start);IY(G,J)}var P8=Math.pow(2,17);class wY{constructor(J){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=J}destroy(){if(this.loader)this.loader.destroy(),this.loader=null}abort(){if(this.loader)this.loader.abort()}load(J,Y){let Z=J.url;if(!Z)return Promise.reject(new M0({type:g.NETWORK_ERROR,details:I.FRAG_LOAD_ERROR,fatal:!1,frag:J,error:new Error(`Fragment does not have a ${Z?"part list":"url"}`),networkDetails:null}));this.abort();let Q=this.config,X=Q.fLoader,q=Q.loader;return new Promise((W,z)=>{if(this.loader)this.loader.destroy();if(J.gap)if(J.tagList.some((K)=>K[0]==="GAP")){z(b8(J));return}else J.gap=!1;let H=this.loader=J.loader=X?new X(Q):new q(Q),G=C8(J),j=E8(Q.fragLoadPolicy.default),N={loadPolicy:j,timeout:j.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:J.sn==="initSegment"?1/0:P8};J.stats=H.stats,H.load(G,N,{onSuccess:(K,V,U,O)=>{this.resetLoader(J,H);let _=K.data;if(U.resetIV&&J.decryptdata)J.decryptdata.iv=new Uint8Array(_.slice(0,16)),_=_.slice(16);W({frag:J,part:null,payload:_,networkDetails:O})},onError:(K,V,U,O)=>{this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.FRAG_LOAD_ERROR,fatal:!1,frag:J,response:z0({url:Z,data:void 0},K),error:new Error(`HTTP Error ${K.code} ${K.text}`),networkDetails:U,stats:O}))},onAbort:(K,V,U)=>{this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.INTERNAL_ABORTED,fatal:!1,frag:J,error:new Error("Aborted"),networkDetails:U,stats:K}))},onTimeout:(K,V,U)=>{this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.FRAG_LOAD_TIMEOUT,fatal:!1,frag:J,error:new Error(`Timeout after ${N.timeout}ms`),networkDetails:U,stats:K}))},onProgress:(K,V,U,O)=>{if(Y)Y({frag:J,part:null,payload:U,networkDetails:O})}})})}loadPart(J,Y,Z){this.abort();let Q=this.config,X=Q.fLoader,q=Q.loader;return new Promise((W,z)=>{if(this.loader)this.loader.destroy();if(J.gap||Y.gap){z(b8(J,Y));return}let H=this.loader=J.loader=X?new X(Q):new q(Q),G=C8(J,Y),j=E8(Q.fragLoadPolicy.default),N={loadPolicy:j,timeout:j.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:P8};Y.stats=H.stats,H.load(G,N,{onSuccess:(K,V,U,O)=>{this.resetLoader(J,H),this.updateStatsFromPart(J,Y);let _={frag:J,part:Y,payload:K.data,networkDetails:O};Z(_),W(_)},onError:(K,V,U,O)=>{this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.FRAG_LOAD_ERROR,fatal:!1,frag:J,part:Y,response:z0({url:G.url,data:void 0},K),error:new Error(`HTTP Error ${K.code} ${K.text}`),networkDetails:U,stats:O}))},onAbort:(K,V,U)=>{J.stats.aborted=Y.stats.aborted,this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.INTERNAL_ABORTED,fatal:!1,frag:J,part:Y,error:new Error("Aborted"),networkDetails:U,stats:K}))},onTimeout:(K,V,U)=>{this.resetLoader(J,H),z(new M0({type:g.NETWORK_ERROR,details:I.FRAG_LOAD_TIMEOUT,fatal:!1,frag:J,part:Y,error:new Error(`Timeout after ${N.timeout}ms`),networkDetails:U,stats:K}))}})})}updateStatsFromPart(J,Y){let Z=J.stats,Q=Y.stats,X=Q.total;if(Z.loaded+=Q.loaded,X){let z=Math.round(J.duration/Y.duration),H=Math.min(Math.round(Z.loaded/X),z),j=(z-H)*Math.round(Z.loaded/H);Z.total=Z.loaded+j}else Z.total=Math.max(Z.loaded,Z.total);let q=Z.loading,W=Q.loading;if(q.start)q.first+=W.first-W.start;else q.start=W.start,q.first=W.first;q.end=W.end}resetLoader(J,Y){if(J.loader=null,this.loader===Y)self.clearTimeout(this.partLoadTimeout),this.loader=null;Y.destroy()}}function C8(J,Y=null){let Z=Y||J,Q={frag:J,part:Y,responseType:"arraybuffer",url:Z.url,headers:{},rangeStart:0,rangeEnd:0},X=Z.byteRangeStartOffset,q=Z.byteRangeEndOffset;if(h(X)&&h(q)){var W;let z=X,H=q;if(J.sn==="initSegment"&&((W=J.decryptdata)==null?void 0:W.method)==="AES-128"){let G=q-X;if(G%16)H=q+(16-G%16);if(X!==0)Q.resetIV=!0,z=X-16}Q.rangeStart=z,Q.rangeEnd=H}return Q}function b8(J,Y){let Z=new Error(`GAP ${J.gap?"tag":"attribute"} found`),Q={type:g.MEDIA_ERROR,details:I.FRAG_GAP,fatal:!1,frag:J,error:Z,networkDetails:null};if(Y)Q.part=Y;return(Y?Y:J).stats.aborted=!0,new M0(Q)}class M0 extends Error{constructor(J){super(J.error.message);this.data=void 0,this.data=J}}class LY{constructor(J,Y){this.subtle=void 0,this.aesIV=void 0,this.subtle=J,this.aesIV=Y}decrypt(J,Y){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},Y,J)}}class PY{constructor(J,Y){this.subtle=void 0,this.key=void 0,this.subtle=J,this.key=Y}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function _Q(J){let Y=J.byteLength,Z=Y&&new DataView(J.buffer).getUint8(Y-1);if(Z)return v0(J,0,Y-Z);return J}class CY{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(J){let Y=new DataView(J),Z=new Uint32Array(4);for(let Q=0;Q<4;Q++)Z[Q]=Y.getUint32(Q*4);return Z}initTable(){let J=this.sBox,Y=this.invSBox,Z=this.subMix,Q=Z[0],X=Z[1],q=Z[2],W=Z[3],z=this.invSubMix,H=z[0],G=z[1],j=z[2],N=z[3],K=new Uint32Array(256),V=0,U=0,O=0;for(O=0;O<256;O++)if(O<128)K[O]=O<<1;else K[O]=O<<1^283;for(O=0;O<256;O++){let _=U^U<<1^U<<2^U<<3^U<<4;_=_>>>8^_&255^99,J[V]=_,Y[_]=V;let A=K[V],R=K[A],E=K[R],F=K[_]*257^_*16843008;if(Q[V]=F<<24|F>>>8,X[V]=F<<16|F>>>16,q[V]=F<<8|F>>>24,W[V]=F,F=E*16843009^R*65537^A*257^V*16843008,H[_]=F<<24|F>>>8,G[_]=F<<16|F>>>16,j[_]=F<<8|F>>>24,N[_]=F,!V)V=U=1;else V=A^K[K[K[E^A]]],U^=K[K[U]]}}expandKey(J){let Y=this.uint8ArrayToUint32Array_(J),Z=!0,Q=0;while(Q<Y.length&&Z)Z=Y[Q]===this.key[Q],Q++;if(Z)return;this.key=Y;let X=this.keySize=Y.length;if(X!==4&&X!==6&&X!==8)throw new Error("Invalid aes key size="+X);let q=this.ksRows=(X+6+1)*4,W,z,H=this.keySchedule=new Uint32Array(q),G=this.invKeySchedule=new Uint32Array(q),j=this.sBox,N=this.rcon,K=this.invSubMix,V=K[0],U=K[1],O=K[2],_=K[3],A,R;for(W=0;W<q;W++){if(W<X){A=H[W]=Y[W];continue}if(R=A,W%X===0)R=R<<8|R>>>24,R=j[R>>>24]<<24|j[R>>>16&255]<<16|j[R>>>8&255]<<8|j[R&255],R^=N[W/X|0]<<24;else if(X>6&&W%X===4)R=j[R>>>24]<<24|j[R>>>16&255]<<16|j[R>>>8&255]<<8|j[R&255];H[W]=A=(H[W-X]^R)>>>0}for(z=0;z<q;z++){if(W=q-z,z&3)R=H[W];else R=H[W-4];if(z<4||W<=4)G[z]=R;else G[z]=V[j[R>>>24]]^U[j[R>>>16&255]]^O[j[R>>>8&255]]^_[j[R&255]];G[z]=G[z]>>>0}}networkToHostOrderSwap(J){return J<<24|(J&65280)<<8|(J&16711680)>>8|J>>>24}decrypt(J,Y,Z){let Q=this.keySize+6,X=this.invKeySchedule,q=this.invSBox,W=this.invSubMix,z=W[0],H=W[1],G=W[2],j=W[3],N=this.uint8ArrayToUint32Array_(Z),K=N[0],V=N[1],U=N[2],O=N[3],_=new Int32Array(J),A=new Int32Array(_.length),R,E,F,P,w,b,x,D,L,k,T,u,f,v,n=this.networkToHostOrderSwap;while(Y<_.length){L=n(_[Y]),k=n(_[Y+1]),T=n(_[Y+2]),u=n(_[Y+3]),w=L^X[0],b=u^X[1],x=T^X[2],D=k^X[3],f=4;for(v=1;v<Q;v++)R=z[w>>>24]^H[b>>16&255]^G[x>>8&255]^j[D&255]^X[f],E=z[b>>>24]^H[x>>16&255]^G[D>>8&255]^j[w&255]^X[f+1],F=z[x>>>24]^H[D>>16&255]^G[w>>8&255]^j[b&255]^X[f+2],P=z[D>>>24]^H[w>>16&255]^G[b>>8&255]^j[x&255]^X[f+3],w=R,b=E,x=F,D=P,f=f+4;R=q[w>>>24]<<24^q[b>>16&255]<<16^q[x>>8&255]<<8^q[D&255]^X[f],E=q[b>>>24]<<24^q[x>>16&255]<<16^q[D>>8&255]<<8^q[w&255]^X[f+1],F=q[x>>>24]<<24^q[D>>16&255]<<16^q[w>>8&255]<<8^q[b&255]^X[f+2],P=q[D>>>24]<<24^q[w>>16&255]<<16^q[b>>8&255]<<8^q[x&255]^X[f+3],A[Y]=n(R^K),A[Y+1]=n(P^V),A[Y+2]=n(F^U),A[Y+3]=n(E^O),K=L,V=k,U=T,O=u,Y=Y+4}return A.buffer}}var AQ=16;class m6{constructor(J,{removePKCS7Padding:Y=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=J.enableSoftwareAES,this.removePKCS7Padding=Y,Y)try{let Z=self.crypto;if(Z)this.subtle=Z.subtle||Z.webkitSubtle}catch(Z){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult:J,remainderData:Y}=this;if(!J||Y)return this.reset(),null;let Z=new Uint8Array(J);if(this.reset(),this.removePKCS7Padding)return _Q(Z);return Z}reset(){if(this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter)this.softwareDecrypter=null}decrypt(J,Y,Z){if(this.useSoftware)return new Promise((Q,X)=>{this.softwareDecrypt(new Uint8Array(J),Y,Z);let q=this.flush();if(q)Q(q.buffer);else X(new Error("[softwareDecrypt] Failed to decrypt data"))});return this.webCryptoDecrypt(new Uint8Array(J),Y,Z)}softwareDecrypt(J,Y,Z){let{currentIV:Q,currentResult:X,remainderData:q}=this;if(this.logOnce("JS AES decrypt"),q)J=$0(q,J),this.remainderData=null;let W=this.getValidChunk(J);if(!W.length)return null;if(Q)Z=Q;let z=this.softwareDecrypter;if(!z)z=this.softwareDecrypter=new CY;z.expandKey(Y);let H=X;if(this.currentResult=z.decrypt(W.buffer,0,Z),this.currentIV=v0(W,-16).buffer,!H)return null;return H}webCryptoDecrypt(J,Y,Z){if(this.key!==Y||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(J,Y,Z));this.key=Y,this.fastAesKey=new PY(this.subtle,Y)}return this.fastAesKey.expandKey().then((Q)=>{if(!this.subtle)return Promise.reject(new Error("web crypto not initialized"));return this.logOnce("WebCrypto AES decrypt"),new LY(this.subtle,new Uint8Array(Z)).decrypt(J.buffer,Q)}).catch((Q)=>{return B.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${Q.name}: ${Q.message}`),this.onWebCryptoError(J,Y,Z)})}onWebCryptoError(J,Y,Z){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(J,Y,Z);let Q=this.flush();if(Q)return Q.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(J){let Y=J,Z=J.length-J.length%AQ;if(Z!==J.length)Y=v0(J,0,Z),this.remainderData=v0(J,Z);return Y}logOnce(J){if(!this.logEnabled)return;B.log(`[decrypter]: ${J}`),this.logEnabled=!1}}var BQ={toString:function(J){let Y="",Z=J.length;for(let Q=0;Q<Z;Q++)Y+=`[${J.start(Q).toFixed(3)}-${J.end(Q).toFixed(3)}]`;return Y}},C={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class g6 extends FY{constructor(J,Y,Z,Q,X){super();this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=C.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=X,this.logPrefix=Q,this.log=B.log.bind(B,`${Q}:`),this.warn=B.warn.bind(B,`${Q}:`),this.hls=J,this.fragmentLoader=new wY(J.config),this.keyLoader=Z,this.fragmentTracker=Y,this.config=J.config,this.decrypter=new m6(J.config),J.on($.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(J){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let J=this.fragCurrent;if(J!=null&&J.loader)J.abortRequests(),this.fragmentTracker.removeFragment(J);this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=C.STOPPED}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}_streamEnded(J,Y){if(Y.live||J.nextStart||!J.end||!this.media)return!1;let Z=Y.partList;if(Z!=null&&Z.length){let X=Z[Z.length-1];return a.isBuffered(this.media,X.start+X.duration/2)}let Q=Y.fragments[Y.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(Q)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var J;return(J=this.levelLastLoaded)==null?void 0:J.details}}onMediaAttached(J,Y){let Z=this.media=this.mediaBuffer=Y.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),Z.addEventListener("seeking",this.onvseeking),Z.addEventListener("ended",this.onvended);let Q=this.config;if(this.levels&&Q.autoStartLoad&&this.state===C.STOPPED)this.startLoad(Q.startPosition)}onMediaDetaching(){let J=this.media;if(J!=null&&J.ended)this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0;if(J&&this.onvseeking&&this.onvended)J.removeEventListener("seeking",this.onvseeking),J.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null;if(this.keyLoader)this.keyLoader.detach();this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){let{config:J,fragCurrent:Y,media:Z,mediaBuffer:Q,state:X}=this,q=Z?Z.currentTime:0,W=a.bufferInfo(Q?Q:Z,q,J.maxBufferHole);if(this.log(`media seeking to ${h(q)?q.toFixed(3):q}, state: ${X}`),this.state===C.ENDED)this.resetLoadingState();else if(Y){let z=J.maxFragLookUpTolerance,H=Y.start-z,G=Y.start+Y.duration+z;if(!W.len||G<W.start||H>W.end){let j=q>G;if(q<H||j){if(j&&Y.loader)this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),Y.abortRequests(),this.resetLoadingState();this.fragPrevious=null}}}if(Z)this.fragmentTracker.removeFragmentsInRange(q,1/0,this.playlistType,!0),this.lastCurrentTime=q;if(!this.loadedmetadata&&!W.len)this.nextLoadPosition=this.startPosition=q;this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(J,Y){this.startTimeOffset=Y.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off($.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){if(this.state=C.STOPPED,this.fragmentLoader)this.fragmentLoader.destroy();if(this.keyLoader)this.keyLoader.destroy();if(this.decrypter)this.decrypter.destroy();this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(J,Y,Z){this._loadFragForPlayback(J,Y,Z)}_loadFragForPlayback(J,Y,Z){let Q=(X)=>{if(this.fragContextChanged(J)){this.warn(`Fragment ${J.sn}${X.part?" p: "+X.part.index:""} of level ${J.level} was dropped during download.`),this.fragmentTracker.removeFragment(J);return}J.stats.chunkCount++,this._handleFragmentLoadProgress(X)};this._doFragLoad(J,Y,Z,Q).then((X)=>{if(!X)return;let q=this.state;if(this.fragContextChanged(J)){if(q===C.FRAG_LOADING||!this.fragCurrent&&q===C.PARSING)this.fragmentTracker.removeFragment(J),this.state=C.IDLE;return}if("payload"in X)this.log(`Loaded fragment ${J.sn} of level ${J.level}`),this.hls.trigger($.FRAG_LOADED,X);this._handleFragmentLoadComplete(X)}).catch((X)=>{if(this.state===C.STOPPED||this.state===C.ERROR)return;this.warn(`Frag error: ${(X==null?void 0:X.message)||X}`),this.resetFragmentLoading(J)})}clearTrackerIfNeeded(J){var Y;let{fragmentTracker:Z}=this;if(Z.getState(J)===W0.APPENDING){let X=J.type,q=this.getFwdBufferInfo(this.mediaBuffer,X),W=Math.max(J.duration,q?q.len:this.config.maxBufferLength),z=this.backtrackFragment;if((z?J.sn-z.sn:0)===1||this.reduceMaxBufferLength(W,J.duration))Z.removeFragment(J)}else if(((Y=this.mediaBuffer)==null?void 0:Y.buffered.length)===0)Z.removeAllFragments();else if(Z.hasParts(J.type)){if(Z.detectPartialFragments({frag:J,part:null,stats:J.stats,id:J.type}),Z.getState(J)===W0.PARTIAL)Z.removeFragment(J)}}checkLiveUpdate(J){if(J.updated&&!J.live){let Y=J.fragments[J.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:Y,part:null,stats:Y.stats,id:Y.type})}if(!J.fragments[0])J.deltaUpdateFailed=!0}flushMainBuffer(J,Y,Z=null){if(!(J-Y))return;let Q={startOffset:J,endOffset:Y,type:Z};this.hls.trigger($.BUFFER_FLUSHING,Q)}_loadInitSegment(J,Y){this._doFragLoad(J,Y).then((Z)=>{if(!Z||this.fragContextChanged(J)||!this.levels)throw new Error("init load aborted");return Z}).then((Z)=>{let{hls:Q}=this,{payload:X}=Z,q=J.decryptdata;if(X&&X.byteLength>0&&q!=null&&q.key&&q.iv&&q.method==="AES-128"){let W=self.performance.now();return this.decrypter.decrypt(new Uint8Array(X),q.key.buffer,q.iv.buffer).catch((z)=>{throw Q.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_DECRYPT_ERROR,fatal:!1,error:z,reason:z.message,frag:J}),z}).then((z)=>{let H=self.performance.now();return Q.trigger($.FRAG_DECRYPTED,{frag:J,payload:z,stats:{tstart:W,tdecrypt:H}}),Z.payload=z,this.completeInitSegmentLoad(Z)})}return this.completeInitSegmentLoad(Z)}).catch((Z)=>{if(this.state===C.STOPPED||this.state===C.ERROR)return;this.warn(Z),this.resetFragmentLoading(J)})}completeInitSegmentLoad(J){let{levels:Y}=this;if(!Y)throw new Error("init load aborted, missing levels");let Z=J.frag.stats;this.state=C.IDLE,J.frag.data=new Uint8Array(J.payload),Z.parsing.start=Z.buffering.start=self.performance.now(),Z.parsing.end=Z.buffering.end=self.performance.now(),this.tick()}fragContextChanged(J){let{fragCurrent:Y}=this;return!J||!Y||J.sn!==Y.sn||J.level!==Y.level}fragBufferedComplete(J,Y){var Z,Q,X,q;let W=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${J.type} sn: ${J.sn}${Y?" part: "+Y.index:""} of ${this.playlistType===m.MAIN?"level":"track"} ${J.level} (frag:[${((Z=J.startPTS)!=null?Z:NaN).toFixed(3)}-${((Q=J.endPTS)!=null?Q:NaN).toFixed(3)}] > buffer:${W?BQ.toString(a.getBuffered(W)):"(detached)"})`),J.sn!=="initSegment"){var z;if(J.type!==m.SUBTITLE){let G=J.elementaryStreams;if(!Object.keys(G).some((j)=>!!G[j])){this.state=C.IDLE;return}}let H=(z=this.levels)==null?void 0:z[J.level];if(H!=null&&H.fragmentError)this.log(`Resetting level fragment error count of ${H.fragmentError} on frag buffered`),H.fragmentError=0}if(this.state=C.IDLE,!W)return;if(!this.loadedmetadata&&J.type==m.MAIN&&W.buffered.length&&((X=this.fragCurrent)==null?void 0:X.sn)===((q=this.fragPrevious)==null?void 0:q.sn))this.loadedmetadata=!0,this.seekToStartPos();this.tick()}seekToStartPos(){}_handleFragmentLoadComplete(J){let{transmuxer:Y}=this;if(!Y)return;let{frag:Z,part:Q,partsLoaded:X}=J,q=!X||X.length===0||X.some((z)=>!z),W=new p6(Z.level,Z.sn,Z.stats.chunkCount+1,0,Q?Q.index:-1,!q);Y.flush(W)}_handleFragmentLoadProgress(J){}_doFragLoad(J,Y,Z=null,Q){var X;let q=Y==null?void 0:Y.details;if(!this.levels||!q)throw new Error(`frag load aborted, missing level${q?"":" detail"}s`);let W=null;if(J.encrypted&&!((X=J.decryptdata)!=null&&X.key)){if(this.log(`Loading key for ${J.sn} of [${q.startSN}-${q.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${J.level}`),this.state=C.KEY_LOADING,this.fragCurrent=J,W=this.keyLoader.load(J).then((G)=>{if(!this.fragContextChanged(G.frag)){if(this.hls.trigger($.KEY_LOADED,G),this.state===C.KEY_LOADING)this.state=C.IDLE;return G}}),this.hls.trigger($.KEY_LOADING,{frag:J}),this.fragCurrent===null)W=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING"))}else if(!J.encrypted&&q.encryptedFragments.length)this.keyLoader.loadClear(J,q.encryptedFragments);if(Z=Math.max(J.start,Z||0),this.config.lowLatencyMode&&J.sn!=="initSegment"){let G=q.partList;if(G&&Q){if(Z>J.end&&q.fragmentHint)J=q.fragmentHint;let j=this.getNextPart(G,J,Z);if(j>-1){let N=G[j];this.log(`Loading part sn: ${J.sn} p: ${N.index} cc: ${J.cc} of playlist [${q.startSN}-${q.endSN}] parts [0-${j}-${G.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${J.level}, target: ${parseFloat(Z.toFixed(3))}`),this.nextLoadPosition=N.start+N.duration,this.state=C.FRAG_LOADING;let K;if(W)K=W.then((V)=>{if(!V||this.fragContextChanged(V.frag))return null;return this.doFragPartsLoad(J,N,Y,Q)}).catch((V)=>this.handleFragLoadError(V));else K=this.doFragPartsLoad(J,N,Y,Q).catch((V)=>this.handleFragLoadError(V));if(this.hls.trigger($.FRAG_LOADING,{frag:J,part:N,targetBufferTime:Z}),this.fragCurrent===null)return Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts"));return K}else if(!J.url||this.loadedEndOfParts(G,Z))return Promise.resolve(null)}}if(this.log(`Loading fragment ${J.sn} cc: ${J.cc} ${q?"of ["+q.startSN+"-"+q.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${J.level}, target: ${parseFloat(Z.toFixed(3))}`),h(J.sn)&&!this.bitrateTest)this.nextLoadPosition=J.start+J.duration;this.state=C.FRAG_LOADING;let z=this.config.progressive,H;if(z&&W)H=W.then((G)=>{if(!G||this.fragContextChanged(G==null?void 0:G.frag))return null;return this.fragmentLoader.load(J,Q)}).catch((G)=>this.handleFragLoadError(G));else H=Promise.all([this.fragmentLoader.load(J,z?Q:void 0),W]).then(([G])=>{if(!z&&G&&Q)Q(G);return G}).catch((G)=>this.handleFragLoadError(G));if(this.hls.trigger($.FRAG_LOADING,{frag:J,targetBufferTime:Z}),this.fragCurrent===null)return Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING"));return H}doFragPartsLoad(J,Y,Z,Q){return new Promise((X,q)=>{var W;let z=[],H=(W=Z.details)==null?void 0:W.partList,G=(j)=>{this.fragmentLoader.loadPart(J,j,Q).then((N)=>{z[j.index]=N;let K=N.part;this.hls.trigger($.FRAG_LOADED,N);let V=M8(Z,J.sn,j.index+1)||$Y(H,J.sn,j.index+1);if(V)G(V);else return X({frag:J,part:K,partsLoaded:z})}).catch(q)};G(Y)})}handleFragLoadError(J){if("data"in J){let Y=J.data;if(J.data&&Y.details===I.INTERNAL_ABORTED)this.handleFragLoadAborted(Y.frag,Y.part);else this.hls.trigger($.ERROR,Y)}else this.hls.trigger($.ERROR,{type:g.OTHER_ERROR,details:I.INTERNAL_EXCEPTION,err:J,error:J,fatal:!0});return null}_handleTransmuxerFlush(J){let Y=this.getCurrentContext(J);if(!Y||this.state!==C.PARSING){if(!this.fragCurrent&&this.state!==C.STOPPED&&this.state!==C.ERROR)this.state=C.IDLE;return}let{frag:Z,part:Q,level:X}=Y,q=self.performance.now();if(Z.stats.parsing.end=q,Q)Q.stats.parsing.end=q;this.updateLevelTiming(Z,Q,X,J.partial)}getCurrentContext(J){let{levels:Y,fragCurrent:Z}=this,{level:Q,sn:X,part:q}=J;if(!(Y!=null&&Y[Q]))return this.warn(`Levels object was unset while buffering fragment ${X} of level ${Q}. The current chunk will not be buffered.`),null;let W=Y[Q],z=q>-1?M8(W,X,q):null,H=z?z.fragment:rZ(W,X,Z);if(!H)return null;if(Z&&Z!==H)H.stats=Z.stats;return{frag:H,part:z,level:W}}bufferFragmentData(J,Y,Z,Q,X){var q;if(!J||this.state!==C.PARSING)return;let{data1:W,data2:z}=J,H=W;if(W&&z)H=$0(W,z);if(!((q=H)!=null&&q.length))return;let G={type:J.type,frag:Y,part:Z,chunkMeta:Q,parent:Y.type,data:H};if(this.hls.trigger($.BUFFER_APPENDING,G),J.dropped&&J.independent&&!Z){if(X)return;this.flushBufferGap(Y)}}flushBufferGap(J){let Y=this.media;if(!Y)return;if(!a.isBuffered(Y,Y.currentTime)){this.flushMainBuffer(0,J.start);return}let Z=Y.currentTime,Q=a.bufferInfo(Y,Z,0),X=J.duration,q=Math.min(this.config.maxFragLookUpTolerance*2,X*0.25),W=Math.max(Math.min(J.start-q,Q.end-q),Z+q);if(J.start-W>q)this.flushMainBuffer(W,J.start)}getFwdBufferInfo(J,Y){let Z=this.getLoadPosition();if(!h(Z))return null;return this.getFwdBufferInfoAtPos(J,Z,Y)}getFwdBufferInfoAtPos(J,Y,Z){let{config:{maxBufferHole:Q}}=this,X=a.bufferInfo(J,Y,Q);if(X.len===0&&X.nextStart!==void 0){let q=this.fragmentTracker.getBufferedFrag(Y,Z);if(q&&X.nextStart<q.end)return a.bufferInfo(J,Y,Math.max(X.nextStart,Q))}return X}getMaxBufferLength(J){let{config:Y}=this,Z;if(J)Z=Math.max(8*Y.maxBufferSize/J,Y.maxBufferLength);else Z=Y.maxBufferLength;return Math.min(Z,Y.maxMaxBufferLength)}reduceMaxBufferLength(J,Y){let Z=this.config,Q=Math.max(Math.min(J-Y,Z.maxBufferLength),Y),X=Math.max(J-Y*3,Z.maxMaxBufferLength/2,Q);if(X>=Q)return Z.maxMaxBufferLength=X,this.warn(`Reduce max buffer length to ${X}s`),!0;return!1}getAppendedFrag(J,Y=m.MAIN){let Z=this.fragmentTracker.getAppendedFrag(J,m.MAIN);if(Z&&"fragment"in Z)return Z.fragment;return Z}getNextFragment(J,Y){let Z=Y.fragments,Q=Z.length;if(!Q)return null;let{config:X}=this,q=Z[0].start,W;if(Y.live){let z=X.initialLiveManifestSize;if(Q<z)return this.warn(`Not enough fragments to start playback (have: ${Q}, need: ${z})`),null;if(!Y.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||J<q)W=this.getInitialLiveFragment(Y,Z),this.startPosition=this.nextLoadPosition=W?this.hls.liveSyncPosition||W.start:J}else if(J<=q)W=Z[0];if(!W){let z=X.lowLatencyMode?Y.partEnd:Y.fragmentEnd;W=this.getFragmentAtPosition(J,z,Y)}return this.mapToInitFragWhenRequired(W)}isLoopLoading(J,Y){let Z=this.fragmentTracker.getState(J);return(Z===W0.OK||Z===W0.PARTIAL&&!!J.gap)&&this.nextLoadPosition>Y}getNextFragmentLoopLoading(J,Y,Z,Q,X){let q=J.gap,W=this.getNextFragment(this.nextLoadPosition,Y);if(W===null)return W;if(J=W,q&&J&&!J.gap&&Z.nextStart){let z=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,Z.nextStart,Q);if(z!==null&&Z.len+z.len>=X)return this.log(`buffer full after gaps in "${Q}" playlist starting at sn: ${J.sn}`),null}return J}mapToInitFragWhenRequired(J){if(J!=null&&J.initSegment&&!(J!=null&&J.initSegment.data)&&!this.bitrateTest)return J.initSegment;return J}getNextPart(J,Y,Z){let Q=-1,X=!1,q=!0;for(let W=0,z=J.length;W<z;W++){let H=J[W];if(q=q&&!H.independent,Q>-1&&Z<H.start)break;let G=H.loaded;if(G)Q=-1;else if((X||H.independent||q)&&H.fragment===Y)Q=W;X=G}return Q}loadedEndOfParts(J,Y){let Z=J[J.length-1];return Z&&Y>Z.start&&Z.loaded}getInitialLiveFragment(J,Y){let Z=this.fragPrevious,Q=null;if(Z){if(J.hasProgramDateTime)this.log(`Live playlist, switching playlist, load frag with same PDT: ${Z.programDateTime}`),Q=tZ(Y,Z.endProgramDateTime,this.config.maxFragLookUpTolerance);if(!Q){let X=Z.sn+1;if(X>=J.startSN&&X<=J.endSN){let q=Y[X-J.startSN];if(Z.cc===q.cc)Q=q,this.log(`Live playlist, switching playlist, load frag with next SN: ${Q.sn}`)}if(!Q){if(Q=YQ(Y,Z.cc),Q)this.log(`Live playlist, switching playlist, load frag with same CC: ${Q.sn}`)}}}else{let X=this.hls.liveSyncPosition;if(X!==null)Q=this.getFragmentAtPosition(X,this.bitrateTest?J.fragmentEnd:J.edge,J)}return Q}getFragmentAtPosition(J,Y,Z){let{config:Q}=this,{fragPrevious:X}=this,{fragments:q,endSN:W}=Z,{fragmentHint:z}=Z,{maxFragLookUpTolerance:H}=Q,G=Z.partList,j=!!(Q.lowLatencyMode&&G!=null&&G.length&&z);if(j&&z&&!this.bitrateTest)q=q.concat(z),W=z.sn;let N;if(J<Y){let K=J>Y-H?0:H;N=T6(X,q,J,K)}else N=q[q.length-1];if(N){let K=N.sn-Z.startSN,V=this.fragmentTracker.getState(N);if(V===W0.OK||V===W0.PARTIAL&&N.gap)X=N;if(X&&N.sn===X.sn&&(!j||G[0].fragment.sn>N.sn)){if(X&&N.level===X.level){let O=q[K+1];if(N.sn<W&&this.fragmentTracker.getState(O)!==W0.OK)N=O;else N=null}}}return N}synchronizeToLiveEdge(J){let{config:Y,media:Z}=this;if(!Z)return;let Q=this.hls.liveSyncPosition,X=Z.currentTime,q=J.fragments[0].start,W=J.edge,z=X>=q-Y.maxFragLookUpTolerance&&X<=W;if(Q!==null&&Z.duration>Q&&(X<Q||!z)){let H=Y.liveMaxLatencyDuration!==void 0?Y.liveMaxLatencyDuration:Y.liveMaxLatencyDurationCount*J.targetduration;if(!z&&Z.readyState<4||X<W-H){if(!this.loadedmetadata)this.nextLoadPosition=Q;if(Z.readyState)this.warn(`Playback: ${X.toFixed(3)} is located too far from the end of live sliding playlist: ${W}, reset currentTime to : ${Q.toFixed(3)}`),Z.currentTime=Q}}}alignPlaylists(J,Y,Z){let Q=J.fragments.length;if(!Q)return this.warn("No fragments in live playlist"),0;let X=J.fragments[0].start,q=!Y,W=J.alignedSliding&&h(X);if(q||!W&&!X){let{fragPrevious:z}=this;$Q(z,Z,J);let H=J.fragments[0].start;return this.log(`Live playlist sliding: ${H.toFixed(2)} start-sn: ${Y?Y.startSN:"na"}->${J.startSN} prev-sn: ${z?z.sn:"na"} fragments: ${Q}`),H}return X}waitForCdnTuneIn(J){return J.live&&J.canBlockReload&&J.partTarget&&J.tuneInGoal>Math.max(J.partHoldBack,J.partTarget*3)}setStartPosition(J,Y){let Z=this.startPosition;if(Z<Y)Z=-1;if(Z===-1||this.lastCurrentTime===-1){let Q=this.startTimeOffset!==null,X=Q?this.startTimeOffset:J.startTimeOffset;if(X!==null&&h(X)){if(Z=Y+X,X<0)Z+=J.totalduration;Z=Math.min(Math.max(Y,Z),Y+J.totalduration),this.log(`Start time offset ${X} found in ${Q?"multivariant":"media"} playlist, adjust startPosition to ${Z}`),this.startPosition=Z}else if(J.live)Z=this.hls.liveSyncPosition||Y;else this.startPosition=Z=0;this.lastCurrentTime=Z}this.nextLoadPosition=Z}getLoadPosition(){let{media:J}=this,Y=0;if(this.loadedmetadata&&J)Y=J.currentTime;else if(this.nextLoadPosition)Y=this.nextLoadPosition;return Y}handleFragLoadAborted(J,Y){if(this.transmuxer&&J.sn!=="initSegment"&&J.stats.aborted)this.warn(`Fragment ${J.sn}${Y?" part "+Y.index:""} of level ${J.level} was aborted`),this.resetFragmentLoading(J)}resetFragmentLoading(J){if(!this.fragCurrent||!this.fragContextChanged(J)&&this.state!==C.FRAG_LOADING_WAITING_RETRY)this.state=C.IDLE}onFragmentOrKeyLoadError(J,Y){if(Y.chunkMeta&&!Y.frag){let G=this.getCurrentContext(Y.chunkMeta);if(G)Y.frag=G.frag}let Z=Y.frag;if(!Z||Z.type!==J||!this.levels)return;if(this.fragContextChanged(Z)){var Q;this.warn(`Frag load error must match current frag to retry ${Z.url} > ${(Q=this.fragCurrent)==null?void 0:Q.url}`);return}let X=Y.details===I.FRAG_GAP;if(X)this.fragmentTracker.fragBuffered(Z,!0);let q=Y.errorAction,{action:W,retryCount:z=0,retryConfig:H}=q||{};if(q&&W===q0.RetryRequest&&H){this.resetStartWhenNotLoaded(this.levelLastLoaded);let G=vJ(H,z);this.warn(`Fragment ${Z.sn} of ${J} ${Z.level} errored with ${Y.details}, retrying loading ${z+1}/${H.maxNumRetry} in ${G}ms`),q.resolved=!0,this.retryDate=self.performance.now()+G,this.state=C.FRAG_LOADING_WAITING_RETRY}else if(H&&q)if(this.resetFragmentErrors(J),z<H.maxNumRetry){if(!X&&W!==q0.RemoveAlternatePermanently)q.resolved=!0}else{B.warn(`${Y.details} reached or exceeded max retry (${z})`);return}else if((q==null?void 0:q.action)===q0.SendAlternateToPenaltyBox)this.state=C.WAITING_LEVEL;else this.state=C.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(J){if(this.state===C.PARSING||this.state===C.PARSED){let{frag:Y,parent:Z}=J,Q=this.getFwdBufferInfo(this.mediaBuffer,Z),X=Q&&Q.len>0.5;if(X)this.reduceMaxBufferLength(Q.len,(Y==null?void 0:Y.duration)||10);let q=!X;if(q)this.warn(`Buffer full error while media.currentTime is not buffered, flush ${Z} buffer`);if(Y)this.fragmentTracker.removeFragment(Y),this.nextLoadPosition=Y.start;return this.resetLoadingState(),q}return!1}resetFragmentErrors(J){if(J===m.AUDIO)this.fragCurrent=null;if(!this.loadedmetadata)this.startFragRequested=!1;if(this.state!==C.STOPPED)this.state=C.IDLE}afterBufferFlushed(J,Y,Z){if(!J)return;let Q=a.getBuffered(J);if(this.fragmentTracker.detectEvictedFragments(Y,Q,Z),this.state===C.ENDED)this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=C.IDLE}resetStartWhenNotLoaded(J){if(!this.loadedmetadata){this.startFragRequested=!1;let Y=J?J.details:null;if(Y!=null&&Y.live)this.startPosition=-1,this.setStartPosition(Y,0),this.resetLoadingState();else this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(J){this.warn(`The loading context changed while buffering fragment ${J.sn} of level ${J.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(J=0){this.fragmentTracker.removeFragmentsInRange(J,1/0,this.playlistType,!1,!0)}updateLevelTiming(J,Y,Z,Q){var X;let q=Z.details;if(!q){this.warn("level.details undefined");return}if(!Object.keys(J.elementaryStreams).reduce((z,H)=>{let G=J.elementaryStreams[H];if(G){let j=G.endPTS-G.startPTS;if(j<=0)return this.warn(`Could not parse fragment ${J.sn} ${H} duration reliably (${j})`),z||!1;let N=Q?0:VY(q,J,G.startPTS,G.endPTS,G.startDTS,G.endDTS);return this.hls.trigger($.LEVEL_PTS_UPDATED,{details:q,level:Z,drift:N,type:H,frag:J,start:G.startPTS,end:G.endPTS}),!0}return z},!1)&&((X=this.transmuxer)==null?void 0:X.error)===null){let z=new Error(`Found no media in fragment ${J.sn} of level ${J.level} resetting transmuxer to fallback to playlist timing`);if(Z.fragmentError===0)Z.fragmentError++,J.gap=!0,this.fragmentTracker.removeFragment(J),this.fragmentTracker.fragBuffered(J,!0);if(this.warn(z.message),this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_PARSING_ERROR,fatal:!1,error:z,frag:J,reason:`Found no media in msn ${J.sn} of level "${Z.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=C.PARSED,this.hls.trigger($.FRAG_PARSED,{frag:J,part:Y})}resetTransmuxer(){if(this.transmuxer)this.transmuxer.destroy(),this.transmuxer=null}recoverWorkerError(J){if(J.event==="demuxerWorker")this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}set state(J){let Y=this._state;if(Y!==J)this._state=J,this.log(`${Y}->${J}`)}get state(){return this._state}}class pJ{constructor(){this.chunks=[],this.dataLength=0}push(J){this.chunks.push(J),this.dataLength+=J.length}flush(){let{chunks:J,dataLength:Y}=this,Z;if(!J.length)return new Uint8Array(0);else if(J.length===1)Z=J[0];else Z=RQ(J,Y);return this.reset(),Z}reset(){this.chunks.length=0,this.dataLength=0}}function RQ(J,Y){let Z=new Uint8Array(Y),Q=0;for(let X=0;X<J.length;X++){let q=J[X];Z.set(q,Q),Q+=q.length}return Z}function MQ(){return typeof __HLS_WORKER_BUNDLE__==="function"}function FQ(){let J=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),Y=self.URL.createObjectURL(J);return{worker:new self.Worker(Y),objectURL:Y}}function EQ(J){let Y=new self.URL(J,self.location.href).href;return{worker:new self.Worker(Y),scriptURL:Y}}function F0(J="",Y=90000){return{type:J,id:-1,pid:-1,inputTimeScale:Y,sequenceNumber:-1,samples:[],dropped:0}}class u6{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(J,Y,Z,Q){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:90000,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(J){this.initPTS=J,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(J,Y){return!1}appendFrame(J,Y,Z){}demux(J,Y){if(this.cachedData)J=$0(this.cachedData,J),this.cachedData=null;let Z=Z6(J,0),Q=Z?Z.length:0,X,q=this._audioTrack,W=this._id3Track,z=Z?kJ(Z):void 0,H=J.length;if(this.basePTS===null||this.frameIndex===0&&h(z))this.basePTS=IQ(z,Y,this.initPTS),this.lastPTS=this.basePTS;if(this.lastPTS===null)this.lastPTS=this.basePTS;if(Z&&Z.length>0)W.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:Z,type:A0.audioId3,duration:Number.POSITIVE_INFINITY});while(Q<H){if(this.canParse(J,Q)){let G=this.appendFrame(q,J,Q);if(G)this.frameIndex++,this.lastPTS=G.sample.pts,Q+=G.length,X=Q;else Q=H}else if(QZ(J,Q))Z=Z6(J,Q),W.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:Z,type:A0.audioId3,duration:Number.POSITIVE_INFINITY}),Q+=Z.length,X=Q;else Q++;if(Q===H&&X!==H){let G=v0(J,X);if(this.cachedData)this.cachedData=$0(this.cachedData,G);else this.cachedData=G}}return{audioTrack:q,videoTrack:F0(),id3Track:W,textTrack:F0()}}demuxSampleAes(J,Y,Z){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(J){let Y=this.cachedData;if(Y)this.cachedData=null,this.demux(Y,0);return{audioTrack:this._audioTrack,videoTrack:F0(),id3Track:this._id3Track,textTrack:F0()}}destroy(){}}var IQ=(J,Y,Z)=>{if(h(J))return J*90;let Q=Z?Z.baseTime*90000/Z.timescale:0;return Y*90000+Q};function wQ(J,Y,Z,Q){let X,q,W,z,H=navigator.userAgent.toLowerCase(),G=Q,j=[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350];X=((Y[Z+2]&192)>>>6)+1;let N=(Y[Z+2]&60)>>>2;if(N>j.length-1){let K=new Error(`invalid ADTS sampling index:${N}`);J.emit($.ERROR,$.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_PARSING_ERROR,fatal:!0,error:K,reason:K.message});return}if(W=(Y[Z+2]&1)<<2,W|=(Y[Z+3]&192)>>>6,B.log(`manifest codec:${Q}, ADTS type:${X}, samplingIndex:${N}`),/firefox/i.test(H))if(N>=6)X=5,z=new Array(4),q=N-3;else X=2,z=new Array(2),q=N;else if(H.indexOf("android")!==-1)X=2,z=new Array(2),q=N;else if(X=5,z=new Array(4),Q&&(Q.indexOf("mp4a.40.29")!==-1||Q.indexOf("mp4a.40.5")!==-1)||!Q&&N>=6)q=N-3;else{if(Q&&Q.indexOf("mp4a.40.2")!==-1&&(N>=6&&W===1||/vivaldi/i.test(H))||!Q&&W===1)X=2,z=new Array(2);q=N}if(z[0]=X<<3,z[0]|=(N&14)>>1,z[1]|=(N&1)<<7,z[1]|=W<<3,X===5)z[1]|=(q&14)>>1,z[2]=(q&1)<<7,z[2]|=8,z[3]=0;return{config:z,samplerate:j[N],channelCount:W,codec:"mp4a.40."+X,manifestCodec:G}}function bY(J,Y){return J[Y]===255&&(J[Y+1]&246)===240}function xY(J,Y){return J[Y+1]&1?7:9}function mJ(J,Y){return(J[Y+3]&3)<<11|J[Y+4]<<3|(J[Y+5]&224)>>>5}function LQ(J,Y){return Y+5<J.length}function h6(J,Y){return Y+1<J.length&&bY(J,Y)}function PQ(J,Y){return LQ(J,Y)&&bY(J,Y)&&mJ(J,Y)<=J.length-Y}function CQ(J,Y){if(h6(J,Y)){let Z=xY(J,Y);if(Y+Z>=J.length)return!1;let Q=mJ(J,Y);if(Q<=Z)return!1;let X=Y+Q;return X===J.length||h6(J,X)}return!1}function DY(J,Y,Z,Q,X){if(!J.samplerate){let q=wQ(Y,Z,Q,X);if(!q)return;J.config=q.config,J.samplerate=q.samplerate,J.channelCount=q.channelCount,J.codec=q.codec,J.manifestCodec=q.manifestCodec,B.log(`parsed codec:${J.codec}, rate:${q.samplerate}, channels:${q.channelCount}`)}}function TY(J){return 92160000/J}function bQ(J,Y){let Z=xY(J,Y);if(Y+Z<=J.length){let Q=mJ(J,Y)-Z;if(Q>0)return{headerLength:Z,frameLength:Q}}}function SY(J,Y,Z,Q,X){let q=TY(J.samplerate),W=Q+X*q,z=bQ(Y,Z),H;if(z){let{frameLength:N,headerLength:K}=z,V=K+N,U=Math.max(0,Z+V-Y.length);if(U)H=new Uint8Array(V-K),H.set(Y.subarray(Z+K,Y.length),0);else H=Y.subarray(Z+K,Z+V);let O={unit:H,pts:W};if(!U)J.samples.push(O);return{sample:O,length:V,missing:U}}let G=Y.length-Z;return H=new Uint8Array(G),H.set(Y.subarray(Z,Y.length),0),{sample:{unit:H,pts:W},length:G,missing:-1}}var N6=null,xQ=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],DQ=[44100,48000,32000,22050,24000,16000,11025,12000,8000],TQ=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],SQ=[0,1,1,4];function hY(J,Y,Z,Q,X){if(Z+24>Y.length)return;let q=yY(Y,Z);if(q&&Z+q.frameLength<=Y.length){let W=q.samplesPerFrame*90000/q.sampleRate,z=Q+X*W,H={unit:Y.subarray(Z,Z+q.frameLength),pts:z,dts:z};return J.config=[],J.channelCount=q.channelCount,J.samplerate=q.sampleRate,J.samples.push(H),{sample:H,length:q.frameLength,missing:0}}}function yY(J,Y){let Z=J[Y+1]>>3&3,Q=J[Y+1]>>1&3,X=J[Y+2]>>4&15,q=J[Y+2]>>2&3;if(Z!==1&&X!==0&&X!==15&&q!==3){let W=J[Y+2]>>1&1,z=J[Y+3]>>6,H=Z===3?3-Q:Q===3?3:4,G=xQ[H*14+X-1]*1000,N=DQ[(Z===3?0:Z===2?1:2)*3+q],K=z===3?1:2,V=TQ[Z][Q],U=SQ[Q],O=V*8*U,_=Math.floor(V*G/N+W)*U;if(N6===null){let E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);N6=E?parseInt(E[1]):0}if(!!N6&&N6<=87&&Q===2&&G>=224000&&z===0)J[Y+3]=J[Y+3]|128;return{sampleRate:N,channelCount:K,frameLength:_,samplesPerFrame:O}}}function gJ(J,Y){return J[Y]===255&&(J[Y+1]&224)===224&&(J[Y+1]&6)!==0}function kY(J,Y){return Y+1<J.length&&gJ(J,Y)}function hQ(J,Y){return gJ(J,Y)&&4<=J.length-Y}function vY(J,Y){if(Y+1<J.length&&gJ(J,Y)){let Q=yY(J,Y),X=4;if(Q!=null&&Q.frameLength)X=Q.frameLength;let q=Y+X;return q===J.length||kY(J,q)}return!1}class pY extends u6{constructor(J,Y){super();this.observer=void 0,this.config=void 0,this.observer=J,this.config=Y}resetInitSegment(J,Y,Z,Q){super.resetInitSegment(J,Y,Z,Q),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:Y,duration:Q,inputTimeScale:90000,dropped:0}}static probe(J){if(!J)return!1;let Y=Z6(J,0),Z=(Y==null?void 0:Y.length)||0;if(vY(J,Z))return!1;for(let Q=J.length;Z<Q;Z++)if(CQ(J,Z))return B.log("ADTS sync word found !"),!0;return!1}canParse(J,Y){return PQ(J,Y)}appendFrame(J,Y,Z){DY(J,this.observer,Y,Z,J.manifestCodec);let Q=SY(J,Y,Z,this.basePTS,this.frameIndex);if(Q&&Q.missing===0)return Q}}var yQ=/\/emsg[-/]ID3/i;class mY{constructor(J,Y){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=Y}resetTimeStamp(){}resetInitSegment(J,Y,Z,Q){let X=this.videoTrack=F0("video",1),q=this.audioTrack=F0("audio",1),W=this.txtTrack=F0("text",1);if(this.id3Track=F0("id3",1),this.timeOffset=0,!(J!=null&&J.byteLength))return;let z=ZY(J);if(z.video){let{id:H,timescale:G,codec:j}=z.video;X.id=H,X.timescale=W.timescale=G,X.codec=j}if(z.audio){let{id:H,timescale:G,codec:j}=z.audio;q.id=H,q.timescale=G,q.codec=j}W.id=e8.text,X.sampleDuration=0,X.duration=q.duration=Q}resetContiguity(){this.remainderData=null}static probe(J){return KZ(J)}demux(J,Y){this.timeOffset=Y;let Z=J,Q=this.videoTrack,X=this.txtTrack;if(this.config.progressive){if(this.remainderData)Z=$0(this.remainderData,J);let W=RZ(Z);this.remainderData=W.remainder,Q.samples=W.valid||new Uint8Array}else Q.samples=Z;let q=this.extractID3Track(Q,Y);return X.samples=Q8(Y,Q),{videoTrack:Q,audioTrack:this.audioTrack,id3Track:q,textTrack:this.txtTrack}}flush(){let J=this.timeOffset,Y=this.videoTrack,Z=this.txtTrack;Y.samples=this.remainderData||new Uint8Array,this.remainderData=null;let Q=this.extractID3Track(Y,this.timeOffset);return Z.samples=Q8(J,Y),{videoTrack:Y,audioTrack:F0(),id3Track:Q,textTrack:F0()}}extractID3Track(J,Y){let Z=this.id3Track;if(J.samples.length){let Q=c(J.samples,["emsg"]);if(Q)Q.forEach((X)=>{let q=EZ(X);if(yQ.test(q.schemeIdUri)){let W=h(q.presentationTime)?q.presentationTime/q.timeScale:Y+q.presentationTimeDelta/q.timeScale,z=q.eventDuration===4294967295?Number.POSITIVE_INFINITY:q.eventDuration/q.timeScale;if(z<=0.001)z=Number.POSITIVE_INFINITY;let H=q.payload;Z.samples.push({data:H,len:H.byteLength,dts:W,pts:W,type:A0.emsg,duration:z})}})}return Z}demuxSampleAes(J,Y,Z){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}var gY=(J,Y)=>{let Z=0,Q=5;Y+=Q;let X=new Uint32Array(1),q=new Uint32Array(1),W=new Uint8Array(1);while(Q>0){W[0]=J[Y];let z=Math.min(Q,8),H=8-z;q[0]=4278190080>>>24+H<<H,X[0]=(W[0]&q[0])>>H,Z=!Z?X[0]:Z<<z|X[0],Y+=1,Q-=z}return Z};class uY extends u6{constructor(J){super();this.observer=void 0,this.observer=J}resetInitSegment(J,Y,Z,Q){super.resetInitSegment(J,Y,Z,Q),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:Y,duration:Q,inputTimeScale:90000,dropped:0}}canParse(J,Y){return Y+64<J.length}appendFrame(J,Y,Z){let Q=fY(J,Y,Z,this.basePTS,this.frameIndex);if(Q!==-1)return{sample:J.samples[J.samples.length-1],length:Q,missing:0}}static probe(J){if(!J)return!1;let Y=Z6(J,0);if(!Y)return!1;let Z=Y.length;if(J[Z]===11&&J[Z+1]===119&&kJ(Y)!==void 0&&gY(J,Z)<16)return!0;return!1}}function fY(J,Y,Z,Q,X){if(Z+8>Y.length)return-1;if(Y[Z]!==11||Y[Z+1]!==119)return-1;let q=Y[Z+4]>>6;if(q>=3)return-1;let z=[48000,44100,32000][q],H=Y[Z+4]&63,j=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][H*3+q]*2;if(Z+j>Y.length)return-1;let N=Y[Z+6]>>5,K=0;if(N===2)K+=2;else{if(N&1&&N!==1)K+=2;if(N&4)K+=2}let V=(Y[Z+6]<<8|Y[Z+7])>>12-K&1,O=[2,1,2,3,3,4,4,5][N]+V,_=Y[Z+5]>>3,A=Y[Z+5]&7,R=new Uint8Array([q<<6|_<<1|A>>2,(A&3)<<6|N<<3|V<<2|H>>4,H<<4&224]),E=1536/z*90000,F=Q+X*E,P=Y.subarray(Z,Z+j);return J.config=R,J.channelCount=O,J.samplerate=z,J.samples.push({unit:P,pts:F}),j}class cY{constructor(){this.VideoSample=null}createVideoSample(J,Y,Z,Q){return{key:J,frame:!1,pts:Y,dts:Z,units:[],debug:Q,length:0}}getLastNalUnit(J){var Y;let Z=this.VideoSample,Q;if(!Z||Z.units.length===0)Z=J[J.length-1];if((Y=Z)!=null&&Y.units){let X=Z.units;Q=X[X.length-1]}return Q}pushAccessUnit(J,Y){if(J.units.length&&J.frame){if(J.pts===void 0){let Z=Y.samples,Q=Z.length;if(Q){let X=Z[Q-1];J.pts=X.pts,J.dts=X.dts}else{Y.dropped++;return}}Y.samples.push(J)}if(J.debug.length)B.log(J.pts+"/"+J.dts+":"+J.debug)}}class _J{constructor(J){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=J,this.bytesAvailable=J.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let J=this.data,Y=this.bytesAvailable,Z=J.byteLength-Y,Q=new Uint8Array(4),X=Math.min(4,Y);if(X===0)throw new Error("no bytes available");Q.set(J.subarray(Z,Z+X)),this.word=new DataView(Q.buffer).getUint32(0),this.bitsAvailable=X*8,this.bytesAvailable-=X}skipBits(J){let Y;if(J=Math.min(J,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>J)this.word<<=J,this.bitsAvailable-=J;else J-=this.bitsAvailable,Y=J>>3,J-=Y<<3,this.bytesAvailable-=Y,this.loadWord(),this.word<<=J,this.bitsAvailable-=J}readBits(J){let Y=Math.min(this.bitsAvailable,J),Z=this.word>>>32-Y;if(J>32)B.error("Cannot read more than 32 bits at a time");if(this.bitsAvailable-=Y,this.bitsAvailable>0)this.word<<=Y;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");if(Y=J-Y,Y>0&&this.bitsAvailable)return Z<<Y|this.readBits(Y);else return Z}skipLZ(){let J;for(J=0;J<this.bitsAvailable;++J)if((this.word&2147483648>>>J)!==0)return this.word<<=J,this.bitsAvailable-=J,J;return this.loadWord(),J+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let J=this.skipLZ();return this.readBits(J+1)-1}readEG(){let J=this.readUEG();if(1&J)return 1+J>>>1;else return-1*(J>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(J){let Y=8,Z=8,Q;for(let X=0;X<J;X++){if(Z!==0)Q=this.readEG(),Z=(Y+Q+256)%256;Y=Z===0?Y:Z}}readSPS(){let J=0,Y=0,Z=0,Q=0,X,q,W,z=this.readUByte.bind(this),H=this.readBits.bind(this),G=this.readUEG.bind(this),j=this.readBoolean.bind(this),N=this.skipBits.bind(this),K=this.skipEG.bind(this),V=this.skipUEG.bind(this),U=this.skipScalingList.bind(this);z();let O=z();if(H(5),N(3),z(),V(),O===100||O===110||O===122||O===244||O===44||O===83||O===86||O===118||O===128){let P=G();if(P===3)N(1);if(V(),V(),N(1),j()){q=P!==3?8:12;for(W=0;W<q;W++)if(j())if(W<6)U(16);else U(64)}}V();let _=G();if(_===0)G();else if(_===1){N(1),K(),K(),X=G();for(W=0;W<X;W++)K()}V(),N(1);let A=G(),R=G(),E=H(1);if(E===0)N(1);if(N(1),j())J=G(),Y=G(),Z=G(),Q=G();let F=[1,1];if(j()){if(j())switch(z()){case 1:F=[1,1];break;case 2:F=[12,11];break;case 3:F=[10,11];break;case 4:F=[16,11];break;case 5:F=[40,33];break;case 6:F=[24,11];break;case 7:F=[20,11];break;case 8:F=[32,11];break;case 9:F=[80,33];break;case 10:F=[18,11];break;case 11:F=[15,11];break;case 12:F=[64,33];break;case 13:F=[160,99];break;case 14:F=[4,3];break;case 15:F=[3,2];break;case 16:F=[2,1];break;case 255:{F=[z()<<8|z(),z()<<8|z()];break}}}return{width:Math.ceil((A+1)*16-J*2-Y*2),height:(2-E)*(R+1)*16-(E?2:4)*(Z+Q),pixelRatio:F}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class dY extends cY{parseAVCPES(J,Y,Z,Q,X){let q=this.parseAVCNALu(J,Z.data),W=this.VideoSample,z,H=!1;if(Z.data=null,W&&q.length&&!J.audFound)this.pushAccessUnit(W,J),W=this.VideoSample=this.createVideoSample(!1,Z.pts,Z.dts,"");if(q.forEach((G)=>{var j;switch(G.type){case 1:{let U=!1;z=!0;let O=G.data;if(H&&O.length>4){let _=new _J(O).readSliceType();if(_===2||_===4||_===7||_===9)U=!0}if(U){var N;if((N=W)!=null&&N.frame&&!W.key)this.pushAccessUnit(W,J),W=this.VideoSample=null}if(!W)W=this.VideoSample=this.createVideoSample(!0,Z.pts,Z.dts,"");W.frame=!0,W.key=U;break}case 5:if(z=!0,(j=W)!=null&&j.frame&&!W.key)this.pushAccessUnit(W,J),W=this.VideoSample=null;if(!W)W=this.VideoSample=this.createVideoSample(!0,Z.pts,Z.dts,"");W.key=!0,W.frame=!0;break;case 6:{z=!0,XY(G.data,1,Z.pts,Y.samples);break}case 7:{var K,V;z=!0,H=!0;let U=G.data,_=new _J(U).readSPS();if(!J.sps||J.width!==_.width||J.height!==_.height||((K=J.pixelRatio)==null?void 0:K[0])!==_.pixelRatio[0]||((V=J.pixelRatio)==null?void 0:V[1])!==_.pixelRatio[1]){J.width=_.width,J.height=_.height,J.pixelRatio=_.pixelRatio,J.sps=[U],J.duration=X;let A=U.subarray(1,4),R="avc1.";for(let E=0;E<3;E++){let F=A[E].toString(16);if(F.length<2)F="0"+F;R+=F}J.codec=R}break}case 8:z=!0,J.pps=[G.data];break;case 9:if(z=!0,J.audFound=!0,W)this.pushAccessUnit(W,J);W=this.VideoSample=this.createVideoSample(!1,Z.pts,Z.dts,"");break;case 12:z=!0;break;default:if(z=!1,W)W.debug+="unknown NAL "+G.type+" ";break}if(W&&z)W.units.push(G)}),Q&&W)this.pushAccessUnit(W,J),this.VideoSample=null}parseAVCNALu(J,Y){let Z=Y.byteLength,Q=J.naluState||0,X=Q,q=[],W=0,z,H,G,j=-1,N=0;if(Q===-1)j=0,N=Y[0]&31,Q=0,W=1;while(W<Z){if(z=Y[W++],!Q){Q=z?0:1;continue}if(Q===1){Q=z?0:2;continue}if(!z)Q=3;else if(z===1){if(H=W-Q-1,j>=0){let K={data:Y.subarray(j,H),type:N};q.push(K)}else{let K=this.getLastNalUnit(J.samples);if(K){if(X&&W<=4-X){if(K.state)K.data=K.data.subarray(0,K.data.byteLength-X)}if(H>0)K.data=$0(K.data,Y.subarray(0,H)),K.state=0}}if(W<Z)G=Y[W]&31,j=W,N=G,Q=0;else Q=-1}else Q=0}if(j>=0&&Q>=0){let K={data:Y.subarray(j,Z),type:N,state:Q};q.push(K)}if(q.length===0){let K=this.getLastNalUnit(J.samples);if(K)K.data=$0(K.data,Y)}return J.naluState=Q,q}}class lY{constructor(J,Y,Z){this.keyData=void 0,this.decrypter=void 0,this.keyData=Z,this.decrypter=new m6(Y,{removePKCS7Padding:!1})}decryptBuffer(J){return this.decrypter.decrypt(J,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(J,Y,Z){let Q=J[Y].unit;if(Q.length<=16)return;let X=Q.subarray(16,Q.length-Q.length%16),q=X.buffer.slice(X.byteOffset,X.byteOffset+X.length);this.decryptBuffer(q).then((W)=>{let z=new Uint8Array(W);if(Q.set(z,16),!this.decrypter.isSync())this.decryptAacSamples(J,Y+1,Z)})}decryptAacSamples(J,Y,Z){for(;;Y++){if(Y>=J.length){Z();return}if(J[Y].unit.length<32)continue;if(this.decryptAacSample(J,Y,Z),!this.decrypter.isSync())return}}getAvcEncryptedData(J){let Y=Math.floor((J.length-48)/160)*16+16,Z=new Int8Array(Y),Q=0;for(let X=32;X<J.length-16;X+=160,Q+=16)Z.set(J.subarray(X,X+16),Q);return Z}getAvcDecryptedUnit(J,Y){let Z=new Uint8Array(Y),Q=0;for(let X=32;X<J.length-16;X+=160,Q+=16)J.set(Z.subarray(Q,Q+16),X);return J}decryptAvcSample(J,Y,Z,Q,X){let q=qY(X.data),W=this.getAvcEncryptedData(q);this.decryptBuffer(W.buffer).then((z)=>{if(X.data=this.getAvcDecryptedUnit(q,z),!this.decrypter.isSync())this.decryptAvcSamples(J,Y,Z+1,Q)})}decryptAvcSamples(J,Y,Z,Q){if(J instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;Y++,Z=0){if(Y>=J.length){Q();return}let X=J[Y].units;for(;;Z++){if(Z>=X.length)break;let q=X[Z];if(q.data.length<=48||q.type!==1&&q.type!==5)continue;if(this.decryptAvcSample(J,Y,Z,Q,q),!this.decrypter.isSync())return}}}}var X0=188;class D0{constructor(J,Y,Z){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=J,this.config=Y,this.typeSupported=Z,this.videoParser=new dY}static probe(J){let Y=D0.syncOffset(J);if(Y>0)B.warn(`MPEG2-TS detected but first sync word found @ offset ${Y}`);return Y!==-1}static syncOffset(J){let Y=J.length,Z=Math.min(X0*5,Y-X0)+1,Q=0;while(Q<Z){let X=!1,q=-1,W=0;for(let z=Q;z<Y;z+=X0)if(J[z]===71&&(Y-z===X0||J[z+X0]===71)){if(W++,q===-1){if(q=z,q!==0)Z=Math.min(q+X0*99,J.length-X0)+1}if(!X)X=AJ(J,z)===0;if(X&&W>1&&(q===0&&W>2||z+X0>Z))return q}else if(W)return-1;else break;Q++}return-1}static createTrack(J,Y){return{container:J==="video"||J==="audio"?"video/mp2t":void 0,type:J,id:e8[J],pid:-1,inputTimeScale:90000,sequenceNumber:0,samples:[],dropped:0,duration:J==="audio"?Y:void 0}}resetInitSegment(J,Y,Z,Q){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=D0.createTrack("video"),this._audioTrack=D0.createTrack("audio",Q),this._id3Track=D0.createTrack("id3"),this._txtTrack=D0.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=Y,this.videoCodec=Z,this._duration=Q}resetTimeStamp(){}resetContiguity(){let{_audioTrack:J,_videoTrack:Y,_id3Track:Z}=this;if(J)J.pesData=null;if(Y)Y.pesData=null;if(Z)Z.pesData=null;this.aacOverFlow=null,this.remainderData=null}demux(J,Y,Z=!1,Q=!1){if(!Z)this.sampleAes=null;let X,q=this._videoTrack,W=this._audioTrack,z=this._id3Track,H=this._txtTrack,G=q.pid,j=q.pesData,N=W.pid,K=z.pid,V=W.pesData,U=z.pesData,O=null,_=this.pmtParsed,A=this._pmtId,R=J.length;if(this.remainderData)J=$0(this.remainderData,J),R=J.length,this.remainderData=null;if(R<X0&&!Q)return this.remainderData=J,{audioTrack:W,videoTrack:q,id3Track:z,textTrack:H};let E=Math.max(0,D0.syncOffset(J));if(R-=(R-E)%X0,R<J.byteLength&&!Q)this.remainderData=new Uint8Array(J.buffer,R,J.buffer.byteLength-R);let F=0;for(let w=E;w<R;w+=X0)if(J[w]===71){let b=!!(J[w+1]&64),x=AJ(J,w),D=(J[w+3]&48)>>4,L;if(D>1){if(L=w+5+J[w+4],L===w+X0)continue}else L=w+4;switch(x){case G:if(b){if(j&&(X=f0(j)))this.videoParser.parseAVCPES(q,H,X,!1,this._duration);j={data:[],size:0}}if(j)j.data.push(J.subarray(L,w+X0)),j.size+=w+X0-L;break;case N:if(b){if(V&&(X=f0(V)))switch(W.segmentCodec){case"aac":this.parseAACPES(W,X);break;case"mp3":this.parseMPEGPES(W,X);break;case"ac3":this.parseAC3PES(W,X);break}V={data:[],size:0}}if(V)V.data.push(J.subarray(L,w+X0)),V.size+=w+X0-L;break;case K:if(b){if(U&&(X=f0(U)))this.parseID3PES(z,X);U={data:[],size:0}}if(U)U.data.push(J.subarray(L,w+X0)),U.size+=w+X0-L;break;case 0:if(b)L+=J[L]+1;A=this._pmtId=kQ(J,L);break;case A:{if(b)L+=J[L]+1;let k=vQ(J,L,this.typeSupported,Z,this.observer);if(G=k.videoPid,G>0)q.pid=G,q.segmentCodec=k.segmentVideoCodec;if(N=k.audioPid,N>0)W.pid=N,W.segmentCodec=k.segmentAudioCodec;if(K=k.id3Pid,K>0)z.pid=K;if(O!==null&&!_)B.warn(`MPEG-TS PMT found at ${w} after unknown PID '${O}'. Backtracking to sync byte @${E} to parse all TS packets.`),O=null,w=E-188;_=this.pmtParsed=!0;break}case 17:case 8191:break;default:O=x;break}}else F++;if(F>0)y6(this.observer,new Error(`Found ${F} TS packet/s that do not start with 0x47`));q.pesData=j,W.pesData=V,z.pesData=U;let P={audioTrack:W,videoTrack:q,id3Track:z,textTrack:H};if(Q)this.extractRemainingSamples(P);return P}flush(){let{remainderData:J}=this;this.remainderData=null;let Y;if(J)Y=this.demux(J,-1,!1,!0);else Y={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack};if(this.extractRemainingSamples(Y),this.sampleAes)return this.decrypt(Y,this.sampleAes);return Y}extractRemainingSamples(J){let{audioTrack:Y,videoTrack:Z,id3Track:Q,textTrack:X}=J,q=Z.pesData,W=Y.pesData,z=Q.pesData,H;if(q&&(H=f0(q)))this.videoParser.parseAVCPES(Z,X,H,!0,this._duration),Z.pesData=null;else Z.pesData=q;if(W&&(H=f0(W))){switch(Y.segmentCodec){case"aac":this.parseAACPES(Y,H);break;case"mp3":this.parseMPEGPES(Y,H);break;case"ac3":this.parseAC3PES(Y,H);break}Y.pesData=null}else{if(W!=null&&W.size)B.log("last AAC PES packet truncated,might overlap between fragments");Y.pesData=W}if(z&&(H=f0(z)))this.parseID3PES(Q,H),Q.pesData=null;else Q.pesData=z}demuxSampleAes(J,Y,Z){let Q=this.demux(J,Z,!0,!this.config.progressive),X=this.sampleAes=new lY(this.observer,this.config,Y);return this.decrypt(Q,X)}decrypt(J,Y){return new Promise((Z)=>{let{audioTrack:Q,videoTrack:X}=J;if(Q.samples&&Q.segmentCodec==="aac")Y.decryptAacSamples(Q.samples,0,()=>{if(X.samples)Y.decryptAvcSamples(X.samples,0,0,()=>{Z(J)});else Z(J)});else if(X.samples)Y.decryptAvcSamples(X.samples,0,0,()=>{Z(J)})})}destroy(){this._duration=0}parseAACPES(J,Y){let Z=0,Q=this.aacOverFlow,X=Y.data;if(Q){this.aacOverFlow=null;let j=Q.missing,N=Q.sample.unit.byteLength;if(j===-1)X=$0(Q.sample.unit,X);else{let K=N-j;Q.sample.unit.set(X.subarray(0,j),K),J.samples.push(Q.sample),Z=Q.missing}}let q,W;for(q=Z,W=X.length;q<W-1;q++)if(h6(X,q))break;if(q!==Z){let j,N=q<W-1;if(N)j=`AAC PES did not start with ADTS header,offset:${q}`;else j="No ADTS header found in AAC PES";if(y6(this.observer,new Error(j),N),!N)return}DY(J,this.observer,X,q,this.audioCodec);let z;if(Y.pts!==void 0)z=Y.pts;else if(Q){let j=TY(J.samplerate);z=Q.sample.pts+j}else{B.warn("[tsdemuxer]: AAC PES unknown PTS");return}let H=0,G;while(q<W)if(G=SY(J,X,q,z,H),q+=G.length,!G.missing){H++;for(;q<W-1;q++)if(h6(X,q))break}else{this.aacOverFlow=G;break}}parseMPEGPES(J,Y){let Z=Y.data,Q=Z.length,X=0,q=0,W=Y.pts;if(W===void 0){B.warn("[tsdemuxer]: MPEG PES unknown PTS");return}while(q<Q)if(kY(Z,q)){let z=hY(J,Z,q,W,X);if(z)q+=z.length,X++;else break}else q++}parseAC3PES(J,Y){{let{data:Z,pts:Q}=Y;if(Q===void 0){B.warn("[tsdemuxer]: AC3 PES unknown PTS");return}let X=Z.length,q=0,W=0,z;while(W<X&&(z=fY(J,Z,W,Q,q++))>0)W+=z}}parseID3PES(J,Y){if(Y.pts===void 0){B.warn("[tsdemuxer]: ID3 PES unknown PTS");return}let Z=Y0({},Y,{type:this._videoTrack?A0.emsg:A0.audioId3,duration:Number.POSITIVE_INFINITY});J.samples.push(Z)}}function AJ(J,Y){return((J[Y+1]&31)<<8)+J[Y+2]}function kQ(J,Y){return(J[Y+10]&31)<<8|J[Y+11]}function vQ(J,Y,Z,Q,X){let q={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},W=(J[Y+1]&15)<<8|J[Y+2],z=Y+3+W-4,H=(J[Y+10]&15)<<8|J[Y+11];Y+=12+H;while(Y<z){let G=AJ(J,Y),j=(J[Y+3]&15)<<8|J[Y+4];switch(J[Y]){case 207:if(!Q){t6("ADTS AAC");break}case 15:if(q.audioPid===-1)q.audioPid=G;break;case 21:if(q.id3Pid===-1)q.id3Pid=G;break;case 219:if(!Q){t6("H.264");break}case 27:if(q.videoPid===-1)q.videoPid=G,q.segmentVideoCodec="avc";break;case 3:case 4:if(!Z.mpeg&&!Z.mp3)B.log("MPEG audio found, not supported in this browser");else if(q.audioPid===-1)q.audioPid=G,q.segmentAudioCodec="mp3";break;case 193:if(!Q){t6("AC-3");break}case 129:if(!Z.ac3)B.log("AC-3 audio found, not supported in this browser");else if(q.audioPid===-1)q.audioPid=G,q.segmentAudioCodec="ac3";break;case 6:if(q.audioPid===-1&&j>0){let N=Y+5,K=j;while(K>2){switch(J[N]){case 106:if(Z.ac3!==!0)B.log("AC-3 audio found, not supported in this browser for now");else q.audioPid=G,q.segmentAudioCodec="ac3";break}let U=J[N+1]+2;N+=U,K-=U}}break;case 194:case 135:return y6(X,new Error("Unsupported EC-3 in M2TS found")),q;case 36:return y6(X,new Error("Unsupported HEVC in M2TS found")),q}Y+=j+5}return q}function y6(J,Y,Z){B.warn(`parsing error: ${Y.message}`),J.emit($.ERROR,$.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_PARSING_ERROR,fatal:!1,levelRetry:Z,error:Y,reason:Y.message})}function t6(J){B.log(`${J} with AES-128-CBC encryption found in unencrypted stream`)}function f0(J){let Y=0,Z,Q,X,q,W,z=J.data;if(!J||J.size===0)return null;while(z[0].length<19&&z.length>1)z[0]=$0(z[0],z[1]),z.splice(1,1);if(Z=z[0],(Z[0]<<16)+(Z[1]<<8)+Z[2]===1){if(Q=(Z[4]<<8)+Z[5],Q&&Q>J.size-6)return null;let G=Z[7];if(G&192)if(q=(Z[9]&14)*536870912+(Z[10]&255)*4194304+(Z[11]&254)*16384+(Z[12]&255)*128+(Z[13]&254)/2,G&64){if(W=(Z[14]&14)*536870912+(Z[15]&255)*4194304+(Z[16]&254)*16384+(Z[17]&255)*128+(Z[18]&254)/2,q-W>5400000)B.warn(`${Math.round((q-W)/90000)}s delta between PTS and DTS, align them`),q=W}else W=q;X=Z[8];let j=X+9;if(J.size<=j)return null;J.size-=j;let N=new Uint8Array(J.size);for(let K=0,V=z.length;K<V;K++){Z=z[K];let U=Z.byteLength;if(j)if(j>U){j-=U;continue}else Z=Z.subarray(j),U-=j,j=0;N.set(Z,Y),Y+=U}if(Q)Q-=X+3;return{data:N,pts:q,dts:W,len:Q}}return null}class oY extends u6{resetInitSegment(J,Y,Z,Q){super.resetInitSegment(J,Y,Z,Q),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:Y,duration:Q,inputTimeScale:90000,dropped:0}}static probe(J){if(!J)return!1;let Y=Z6(J,0),Z=(Y==null?void 0:Y.length)||0;if(Y&&J[Z]===11&&J[Z+1]===119&&kJ(Y)!==void 0&&gY(J,Z)<=16)return!1;for(let Q=J.length;Z<Q;Z++)if(vY(J,Z))return B.log("MPEG Audio sync word found !"),!0;return!1}canParse(J,Y){return hQ(J,Y)}appendFrame(J,Y,Z){if(this.basePTS===null)return;return hY(J,Y,Z,this.basePTS,this.frameIndex)}}class BJ{static getSilentFrame(J,Y){switch(J){case"mp4a.40.2":if(Y===1)return new Uint8Array([0,200,0,128,35,128]);else if(Y===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);else if(Y===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);else if(Y===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(Y===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(Y===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(Y===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);else if(Y===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);else if(Y===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}return}}var x0=Math.pow(2,32)-1;class M{static init(){M.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let J;for(J in M.types)if(M.types.hasOwnProperty(J))M.types[J]=[J.charCodeAt(0),J.charCodeAt(1),J.charCodeAt(2),J.charCodeAt(3)];let Y=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),Z=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);M.HDLR_TYPES={video:Y,audio:Z};let Q=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),X=new Uint8Array([0,0,0,0,0,0,0,0]);M.STTS=M.STSC=M.STCO=X,M.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),M.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),M.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),M.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let q=new Uint8Array([105,115,111,109]),W=new Uint8Array([97,118,99,49]),z=new Uint8Array([0,0,0,1]);M.FTYP=M.box(M.types.ftyp,q,z,q,W),M.DINF=M.box(M.types.dinf,M.box(M.types.dref,Q))}static box(J,...Y){let Z=8,Q=Y.length,X=Q;while(Q--)Z+=Y[Q].byteLength;let q=new Uint8Array(Z);q[0]=Z>>24&255,q[1]=Z>>16&255,q[2]=Z>>8&255,q[3]=Z&255,q.set(J,4);for(Q=0,Z=8;Q<X;Q++)q.set(Y[Q],Z),Z+=Y[Q].byteLength;return q}static hdlr(J){return M.box(M.types.hdlr,M.HDLR_TYPES[J])}static mdat(J){return M.box(M.types.mdat,J)}static mdhd(J,Y){Y*=J;let Z=Math.floor(Y/(x0+1)),Q=Math.floor(Y%(x0+1));return M.box(M.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,J>>24&255,J>>16&255,J>>8&255,J&255,Z>>24,Z>>16&255,Z>>8&255,Z&255,Q>>24,Q>>16&255,Q>>8&255,Q&255,85,196,0,0]))}static mdia(J){return M.box(M.types.mdia,M.mdhd(J.timescale,J.duration),M.hdlr(J.type),M.minf(J))}static mfhd(J){return M.box(M.types.mfhd,new Uint8Array([0,0,0,0,J>>24,J>>16&255,J>>8&255,J&255]))}static minf(J){if(J.type==="audio")return M.box(M.types.minf,M.box(M.types.smhd,M.SMHD),M.DINF,M.stbl(J));else return M.box(M.types.minf,M.box(M.types.vmhd,M.VMHD),M.DINF,M.stbl(J))}static moof(J,Y,Z){return M.box(M.types.moof,M.mfhd(J),M.traf(Z,Y))}static moov(J){let Y=J.length,Z=[];while(Y--)Z[Y]=M.trak(J[Y]);return M.box.apply(null,[M.types.moov,M.mvhd(J[0].timescale,J[0].duration)].concat(Z).concat(M.mvex(J)))}static mvex(J){let Y=J.length,Z=[];while(Y--)Z[Y]=M.trex(J[Y]);return M.box.apply(null,[M.types.mvex,...Z])}static mvhd(J,Y){Y*=J;let Z=Math.floor(Y/(x0+1)),Q=Math.floor(Y%(x0+1)),X=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,J>>24&255,J>>16&255,J>>8&255,J&255,Z>>24,Z>>16&255,Z>>8&255,Z&255,Q>>24,Q>>16&255,Q>>8&255,Q&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return M.box(M.types.mvhd,X)}static sdtp(J){let Y=J.samples||[],Z=new Uint8Array(4+Y.length),Q,X;for(Q=0;Q<Y.length;Q++)X=Y[Q].flags,Z[Q+4]=X.dependsOn<<4|X.isDependedOn<<2|X.hasRedundancy;return M.box(M.types.sdtp,Z)}static stbl(J){return M.box(M.types.stbl,M.stsd(J),M.box(M.types.stts,M.STTS),M.box(M.types.stsc,M.STSC),M.box(M.types.stsz,M.STSZ),M.box(M.types.stco,M.STCO))}static avc1(J){let Y=[],Z=[],Q,X,q;for(Q=0;Q<J.sps.length;Q++)X=J.sps[Q],q=X.byteLength,Y.push(q>>>8&255),Y.push(q&255),Y=Y.concat(Array.prototype.slice.call(X));for(Q=0;Q<J.pps.length;Q++)X=J.pps[Q],q=X.byteLength,Z.push(q>>>8&255),Z.push(q&255),Z=Z.concat(Array.prototype.slice.call(X));let W=M.box(M.types.avcC,new Uint8Array([1,Y[3],Y[4],Y[5],255,224|J.sps.length].concat(Y).concat([J.pps.length]).concat(Z))),z=J.width,H=J.height,G=J.pixelRatio[0],j=J.pixelRatio[1];return M.box(M.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,z>>8&255,z&255,H>>8&255,H&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),W,M.box(M.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),M.box(M.types.pasp,new Uint8Array([G>>24,G>>16&255,G>>8&255,G&255,j>>24,j>>16&255,j>>8&255,j&255])))}static esds(J){let Y=J.config.length;return new Uint8Array([0,0,0,0,3,23+Y,0,1,0,4,15+Y,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([Y]).concat(J.config).concat([6,1,2]))}static audioStsd(J){let Y=J.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,J.channelCount,0,16,0,0,0,0,Y>>8&255,Y&255,0,0])}static mp4a(J){return M.box(M.types.mp4a,M.audioStsd(J),M.box(M.types.esds,M.esds(J)))}static mp3(J){return M.box(M.types[".mp3"],M.audioStsd(J))}static ac3(J){return M.box(M.types["ac-3"],M.audioStsd(J),M.box(M.types.dac3,J.config))}static stsd(J){if(J.type==="audio"){if(J.segmentCodec==="mp3"&&J.codec==="mp3")return M.box(M.types.stsd,M.STSD,M.mp3(J));if(J.segmentCodec==="ac3")return M.box(M.types.stsd,M.STSD,M.ac3(J));return M.box(M.types.stsd,M.STSD,M.mp4a(J))}else return M.box(M.types.stsd,M.STSD,M.avc1(J))}static tkhd(J){let Y=J.id,Z=J.duration*J.timescale,Q=J.width,X=J.height,q=Math.floor(Z/(x0+1)),W=Math.floor(Z%(x0+1));return M.box(M.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,Y>>24&255,Y>>16&255,Y>>8&255,Y&255,0,0,0,0,q>>24,q>>16&255,q>>8&255,q&255,W>>24,W>>16&255,W>>8&255,W&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,Q>>8&255,Q&255,0,0,X>>8&255,X&255,0,0]))}static traf(J,Y){let Z=M.sdtp(J),Q=J.id,X=Math.floor(Y/(x0+1)),q=Math.floor(Y%(x0+1));return M.box(M.types.traf,M.box(M.types.tfhd,new Uint8Array([0,0,0,0,Q>>24,Q>>16&255,Q>>8&255,Q&255])),M.box(M.types.tfdt,new Uint8Array([1,0,0,0,X>>24,X>>16&255,X>>8&255,X&255,q>>24,q>>16&255,q>>8&255,q&255])),M.trun(J,Z.length+16+20+8+16+8+8),Z)}static trak(J){return J.duration=J.duration||4294967295,M.box(M.types.trak,M.tkhd(J),M.mdia(J))}static trex(J){let Y=J.id;return M.box(M.types.trex,new Uint8Array([0,0,0,0,Y>>24,Y>>16&255,Y>>8&255,Y&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(J,Y){let Z=J.samples||[],Q=Z.length,X=12+16*Q,q=new Uint8Array(X),W,z,H,G,j,N;Y+=8+X,q.set([J.type==="video"?1:0,0,15,1,Q>>>24&255,Q>>>16&255,Q>>>8&255,Q&255,Y>>>24&255,Y>>>16&255,Y>>>8&255,Y&255],0);for(W=0;W<Q;W++)z=Z[W],H=z.duration,G=z.size,j=z.flags,N=z.cts,q.set([H>>>24&255,H>>>16&255,H>>>8&255,H&255,G>>>24&255,G>>>16&255,G>>>8&255,G&255,j.isLeading<<2|j.dependsOn,j.isDependedOn<<6|j.hasRedundancy<<4|j.paddingValue<<1|j.isNonSync,j.degradPrio&61440,j.degradPrio&15,N>>>24&255,N>>>16&255,N>>>8&255,N&255],12+16*W);return M.box(M.types.trun,q)}static initSegment(J){if(!M.types)M.init();let Y=M.moov(J);return $0(M.FTYP,Y)}}M.types=void 0;M.HDLR_TYPES=void 0;M.STTS=void 0;M.STSC=void 0;M.STCO=void 0;M.STSZ=void 0;M.VMHD=void 0;M.SMHD=void 0;M.STSD=void 0;M.FTYP=void 0;M.DINF=void 0;var nY=90000;function uJ(J,Y,Z=1,Q=!1){let X=J*Y*Z;return Q?Math.round(X):X}function pQ(J,Y,Z=1,Q=!1){return uJ(J,Y,1/Z,Q)}function a0(J,Y=!1){return uJ(J,1000,1/nY,Y)}function mQ(J,Y=1){return uJ(J,nY,1/Y)}var gQ=1e4,x8=1024,uQ=1152,fQ=1536,c0=null,e6=null;class Y6{constructor(J,Y,Z,Q=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=J,this.config=Y,this.typeSupported=Z,this.ISGenerated=!1,c0===null){let q=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);c0=q?parseInt(q[1]):0}if(e6===null){let X=navigator.userAgent.match(/Safari\/(\d+)/i);e6=X?parseInt(X[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(J){B.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=J}resetNextTimestamp(){B.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){B.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(J){let Y=!1,Z=J[0].pts,Q=J.reduce((X,q)=>{let W=q.pts,z=W-X;if(z<-4294967296)Y=!0,W=U0(W,Z),z=W-X;if(z>0)return X;return W},Z);if(Y)B.debug("PTS rollover detected");return Q}remux(J,Y,Z,Q,X,q,W,z){let H,G,j,N,K,V,U=X,O=X,_=J.pid>-1,A=Y.pid>-1,R=Y.samples.length,E=J.samples.length>0,F=W&&R>0||R>1;if((!_||E)&&(!A||F)||this.ISGenerated||W){if(this.ISGenerated){var w,b,x,D;let u=this.videoTrackConfig;if(u&&(Y.width!==u.width||Y.height!==u.height||((w=Y.pixelRatio)==null?void 0:w[0])!==((b=u.pixelRatio)==null?void 0:b[0])||((x=Y.pixelRatio)==null?void 0:x[1])!==((D=u.pixelRatio)==null?void 0:D[1])))this.resetInitSegment()}else j=this.generateIS(J,Y,X,q);let L=this.isVideoContiguous,k=-1,T;if(F){if(k=cQ(Y.samples),!L&&this.config.forceKeyFrameOnDiscontinuity){if(V=!0,k>0){B.warn(`[mp4-remuxer]: Dropped ${k} out of ${R} video samples due to a missing keyframe`);let u=this.getVideoStartPts(Y.samples);Y.samples=Y.samples.slice(k),Y.dropped+=k,O+=(Y.samples[0].pts-u)/Y.inputTimeScale,T=O}else if(k===-1)B.warn(`[mp4-remuxer]: No keyframe found out of ${R} video samples`),V=!1}}if(this.ISGenerated){if(E&&F){let u=this.getVideoStartPts(Y.samples),v=(U0(J.samples[0].pts,u)-u)/Y.inputTimeScale;U+=Math.max(0,v),O+=Math.max(0,-v)}if(E){if(!J.samplerate)B.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),j=this.generateIS(J,Y,X,q);if(G=this.remuxAudio(J,U,this.isAudioContiguous,q,A||F||z===m.AUDIO?O:void 0),F){let u=G?G.endPTS-G.startPTS:0;if(!Y.inputTimeScale)B.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),j=this.generateIS(J,Y,X,q);H=this.remuxVideo(Y,O,L,u)}}else if(F)H=this.remuxVideo(Y,O,L,0);if(H)H.firstKeyFrame=k,H.independent=k!==-1,H.firstKeyFramePTS=T}}if(this.ISGenerated&&this._initPTS&&this._initDTS){if(Z.samples.length)K=iY(Z,X,this._initPTS,this._initDTS);if(Q.samples.length)N=sY(Q,X,this._initPTS)}return{audio:G,video:H,initSegment:j,independent:V,text:N,id3:K}}generateIS(J,Y,Z,Q){let X=J.samples,q=Y.samples,W=this.typeSupported,z={},H=this._initPTS,G=!H||Q,j="audio/mp4",N,K,V;if(G)N=K=1/0;if(J.config&&X.length){switch(J.timescale=J.samplerate,J.segmentCodec){case"mp3":if(W.mpeg)j="audio/mpeg",J.codec="";else if(W.mp3)J.codec="mp3";break;case"ac3":J.codec="ac-3";break}if(z.audio={id:"audio",container:j,codec:J.codec,initSegment:J.segmentCodec==="mp3"&&W.mpeg?new Uint8Array(0):M.initSegment([J]),metadata:{channelCount:J.channelCount}},G)if(V=J.inputTimeScale,!H||V!==H.timescale)N=K=X[0].pts-Math.round(V*Z);else G=!1}if(Y.sps&&Y.pps&&q.length){if(Y.timescale=Y.inputTimeScale,z.video={id:"main",container:"video/mp4",codec:Y.codec,initSegment:M.initSegment([Y]),metadata:{width:Y.width,height:Y.height}},G)if(V=Y.inputTimeScale,!H||V!==H.timescale){let U=this.getVideoStartPts(q),O=Math.round(V*Z);K=Math.min(K,U0(q[0].dts,U)-O),N=Math.min(N,U-O)}else G=!1;this.videoTrackConfig={width:Y.width,height:Y.height,pixelRatio:Y.pixelRatio}}if(Object.keys(z).length){if(this.ISGenerated=!0,G)this._initPTS={baseTime:N,timescale:V},this._initDTS={baseTime:K,timescale:V};else N=V=void 0;return{tracks:z,initPTS:N,timescale:V}}}remuxVideo(J,Y,Z,Q){let{inputTimeScale:X,samples:q}=J,W=[],z=q.length,H=this._initPTS,G=this.nextAvcDts,j=8,N=this.videoSampleDuration,K,V,U=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,_=!1;if(!Z||G===null){let y=Y*X,S=q[0].pts-U0(q[0].dts,q[0].pts);if(c0&&G!==null&&Math.abs(y-S-G)<15000)Z=!0;else G=y-S}let A=H.baseTime*X/H.timescale;for(let y=0;y<z;y++){let S=q[y];if(S.pts=U0(S.pts-A,G),S.dts=U0(S.dts-A,G),S.dts<q[y>0?y-1:y].dts)_=!0}if(_)q.sort(function(y,S){let o=y.dts-S.dts,r=y.pts-S.pts;return o||r});K=q[0].dts,V=q[q.length-1].dts;let R=V-K,E=R?Math.round(R/(z-1)):N||J.inputTimeScale/30;if(Z){let y=K-G,S=y>E,o=y<-1;if(S||o){if(S)B.warn(`AVC: ${a0(y,!0)} ms (${y}dts) hole between fragments detected at ${Y.toFixed(3)}`);else B.warn(`AVC: ${a0(-y,!0)} ms (${y}dts) overlapping between fragments detected at ${Y.toFixed(3)}`);if(!o||G>=q[0].pts||c0){K=G;let r=q[0].pts-y;if(S)q[0].dts=K,q[0].pts=r;else for(let d=0;d<q.length;d++){if(q[d].dts>r)break;q[d].dts-=y,q[d].pts-=y}B.log(`Video: Initial PTS/DTS adjusted: ${a0(r,!0)}/${a0(K,!0)}, delta: ${a0(y,!0)} ms`)}}}K=Math.max(0,K);let F=0,P=0,w=K;for(let y=0;y<z;y++){let S=q[y],o=S.units,r=o.length,d=0;for(let e=0;e<r;e++)d+=o[e].data.length;if(P+=d,F+=r,S.length=d,S.dts<w)S.dts=w,w+=E/4|0||1;else w=S.dts;U=Math.min(S.pts,U),O=Math.max(S.pts,O)}V=q[z-1].dts;let b=P+4*F+8,x;try{x=new Uint8Array(b)}catch(y){this.observer.emit($.ERROR,$.ERROR,{type:g.MUX_ERROR,details:I.REMUX_ALLOC_ERROR,fatal:!1,error:y,bytes:b,reason:`fail allocating video mdat ${b}`});return}let D=new DataView(x.buffer);D.setUint32(0,b),x.set(M.types.mdat,4);let L=!1,k=Number.POSITIVE_INFINITY,T=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY,f=Number.NEGATIVE_INFINITY;for(let y=0;y<z;y++){let S=q[y],o=S.units,r=0;for(let Q0=0,H0=o.length;Q0<H0;Q0++){let j0=o[Q0],T0=j0.data,f6=j0.data.byteLength;D.setUint32(j,f6),j+=4,x.set(T0,j),j+=f6,r+=4+f6}let d;if(y<z-1)N=q[y+1].dts-S.dts,d=q[y+1].pts-S.pts;else{let Q0=this.config,H0=y>0?S.dts-q[y-1].dts:E;if(d=y>0?S.pts-q[y-1].pts:E,Q0.stretchShortVideoTrack&&this.nextAudioPts!==null){let j0=Math.floor(Q0.maxBufferHole*X),T0=(Q?U+Q*X:this.nextAudioPts)-S.pts;if(T0>j0){if(N=T0-H0,N<0)N=H0;else L=!0;B.log(`[mp4-remuxer]: It is approximately ${T0/90} ms to the next segment; using duration ${N/90} ms for the last video frame.`)}else N=H0}else N=H0}let e=Math.round(S.pts-S.dts);k=Math.min(k,N),u=Math.max(u,N),T=Math.min(T,d),f=Math.max(f,d),W.push(new RJ(S.key,N,r,e))}if(W.length){if(c0){if(c0<70){let y=W[0].flags;y.dependsOn=2,y.isNonSync=0}}else if(e6){if(f-T<u-k&&E/u<0.025&&W[0].cts===0){B.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let y=K;for(let S=0,o=W.length;S<o;S++){let r=y+W[S].duration,d=y+W[S].cts;if(S<o-1){let e=r+W[S+1].cts;W[S].duration=e-d}else W[S].duration=S?W[S-1].duration:E;W[S].cts=0,y=r}}}}N=L||!N?E:N,this.nextAvcDts=G=V+N,this.videoSampleDuration=N,this.isVideoContiguous=!0;let v=M.moof(J.sequenceNumber++,K,Y0({},J,{samples:W})),n="video",i={data1:v,data2:x,startPTS:U/X,endPTS:(O+N)/X,startDTS:K/X,endDTS:G/X,type:n,hasAudio:!1,hasVideo:!0,nb:W.length,dropped:J.dropped};return J.samples=[],J.dropped=0,i}getSamplesPerFrame(J){switch(J.segmentCodec){case"mp3":return uQ;case"ac3":return fQ;default:return x8}}remuxAudio(J,Y,Z,Q,X){let q=J.inputTimeScale,W=J.samplerate?J.samplerate:q,z=q/W,H=this.getSamplesPerFrame(J),G=H*z,j=this._initPTS,N=J.segmentCodec==="mp3"&&this.typeSupported.mpeg,K=[],V=X!==void 0,U=J.samples,O=N?0:8,_=this.nextAudioPts||-1,A=Y*q,R=j.baseTime*q/j.timescale;if(this.isAudioContiguous=Z=Z||U.length&&_>0&&(Q&&Math.abs(A-_)<9000||Math.abs(U0(U[0].pts-R,A)-_)<20*G),U.forEach(function(v){v.pts=U0(v.pts-R,A)}),!Z||_<0){if(U=U.filter((v)=>v.pts>=0),!U.length)return;if(X===0)_=0;else if(Q&&!V)_=Math.max(0,A);else _=U[0].pts}if(J.segmentCodec==="aac"){let v=this.config.maxAudioFramesDrift;for(let n=0,i=_;n<U.length;n++){let y=U[n],S=y.pts,o=S-i,r=Math.abs(1000*o/q);if(o<=-v*G&&V){if(n===0)B.warn(`Audio frame @ ${(S/q).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1000*o/q)} ms.`),this.nextAudioPts=_=i=S}else if(o>=v*G&&r<gQ&&V){let d=Math.round(o/G);if(i=S-d*G,i<0)d--,i+=G;if(n===0)this.nextAudioPts=_=i;B.warn(`[mp4-remuxer]: Injecting ${d} audio frame @ ${(i/q).toFixed(3)}s due to ${Math.round(1000*o/q)} ms gap.`);for(let e=0;e<d;e++){let Q0=Math.max(i,0),H0=BJ.getSilentFrame(J.manifestCodec||J.codec,J.channelCount);if(!H0)B.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),H0=y.unit.subarray();U.splice(n,0,{unit:H0,pts:Q0}),i+=G,n++}}y.pts=i,i+=G}}let E=null,F=null,P,w=0,b=U.length;while(b--)w+=U[b].unit.byteLength;for(let v=0,n=U.length;v<n;v++){let i=U[v],y=i.unit,S=i.pts;if(F!==null){let r=K[v-1];r.duration=Math.round((S-F)/z)}else{if(Z&&J.segmentCodec==="aac")S=_;if(E=S,w>0){w+=O;try{P=new Uint8Array(w)}catch(r){this.observer.emit($.ERROR,$.ERROR,{type:g.MUX_ERROR,details:I.REMUX_ALLOC_ERROR,fatal:!1,error:r,bytes:w,reason:`fail allocating audio mdat ${w}`});return}if(!N)new DataView(P.buffer).setUint32(0,w),P.set(M.types.mdat,4)}else return}P.set(y,O);let o=y.byteLength;O+=o,K.push(new RJ(!0,H,o,0)),F=S}let x=K.length;if(!x)return;let D=K[K.length-1];this.nextAudioPts=_=F+z*D.duration;let L=N?new Uint8Array(0):M.moof(J.sequenceNumber++,E/z,Y0({},J,{samples:K}));J.samples=[];let k=E/q,T=_/q,f={data1:L,data2:P,startPTS:k,endPTS:T,startDTS:k,endDTS:T,type:"audio",hasAudio:!0,hasVideo:!1,nb:x};return this.isAudioContiguous=!0,f}remuxEmptyAudio(J,Y,Z,Q){let X=J.inputTimeScale,q=J.samplerate?J.samplerate:X,W=X/q,z=this.nextAudioPts,H=this._initDTS,G=H.baseTime*90000/H.timescale,j=(z!==null?z:Q.startDTS*X)+G,N=Q.endDTS*X+G,K=W*x8,V=Math.ceil((N-j)/K),U=BJ.getSilentFrame(J.manifestCodec||J.codec,J.channelCount);if(B.warn("[mp4-remuxer]: remux empty Audio"),!U){B.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}let O=[];for(let _=0;_<V;_++){let A=j+_*K;O.push({unit:U,pts:A,dts:A})}return J.samples=O,this.remuxAudio(J,Y,Z,!1)}}function U0(J,Y){let Z;if(Y===null)return J;if(Y<J)Z=-8589934592;else Z=8589934592;while(Math.abs(J-Y)>4294967296)J+=Z;return J}function cQ(J){for(let Y=0;Y<J.length;Y++)if(J[Y].key)return Y;return-1}function iY(J,Y,Z,Q){let X=J.samples.length;if(!X)return;let q=J.inputTimeScale;for(let z=0;z<X;z++){let H=J.samples[z];H.pts=U0(H.pts-Z.baseTime*q/Z.timescale,Y*q)/q,H.dts=U0(H.dts-Q.baseTime*q/Q.timescale,Y*q)/q}let W=J.samples;return J.samples=[],{samples:W}}function sY(J,Y,Z){let Q=J.samples.length;if(!Q)return;let X=J.inputTimeScale;for(let W=0;W<Q;W++){let z=J.samples[W];z.pts=U0(z.pts-Z.baseTime*X/Z.timescale,Y*X)/X}J.samples.sort((W,z)=>W.pts-z.pts);let q=J.samples;return J.samples=[],{samples:q}}class RJ{constructor(J,Y,Z,Q){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=Y,this.size=Z,this.cts=Q,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:J?2:1,isNonSync:J?0:1}}}class rY{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(J){this.initPTS=J,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(J,Y,Z,Q){this.audioCodec=Y,this.videoCodec=Z,this.generateInitSegment($Z(J,Q)),this.emitInitSegment=!0}generateInitSegment(J){let{audioCodec:Y,videoCodec:Z}=this;if(!(J!=null&&J.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let Q=this.initData=ZY(J);if(Q.audio)Y=D8(Q.audio,s.AUDIO);if(Q.video)Z=D8(Q.video,s.VIDEO);let X={};if(Q.audio&&Q.video)X.audiovideo={container:"video/mp4",codec:Y+","+Z,initSegment:J,id:"main"};else if(Q.audio)X.audio={container:"audio/mp4",codec:Y,initSegment:J,id:"audio"};else if(Q.video)X.video={container:"video/mp4",codec:Z,initSegment:J,id:"main"};else B.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes.");this.initTracks=X}remux(J,Y,Z,Q,X,q){var W,z;let{initPTS:H,lastEndTime:G}=this,j={audio:void 0,video:void 0,text:Q,id3:Z,initSegment:void 0};if(!h(G))G=this.lastEndTime=X||0;let N=Y.samples;if(!(N!=null&&N.length))return j;let K={initPTS:void 0,timescale:1},V=this.initData;if(!((W=V)!=null&&W.length))this.generateInitSegment(N),V=this.initData;if(!((z=V)!=null&&z.length))return B.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),j;if(this.emitInitSegment)K.tracks=this.initTracks,this.emitInitSegment=!1;let U=_Z(N,V),O=OZ(V,N),_=O===null?X:O;if(dQ(H,_,X,U)||K.timescale!==H.timescale&&q){if(K.initPTS=_-X,H&&H.timescale===1)B.warn(`Adjusting initPTS by ${K.initPTS-H.baseTime}`);this.initPTS=H={baseTime:K.initPTS,timescale:1}}let A=J?_-H.baseTime/H.timescale:G,R=A+U;if(BZ(V,N,H.baseTime/H.timescale),U>0)this.lastEndTime=R;else B.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp();let E=!!V.audio,F=!!V.video,P="";if(E)P+="audio";if(F)P+="video";let w={data1:N,startPTS:A,startDTS:A,endPTS:R,endDTS:R,type:P,hasAudio:E,hasVideo:F,nb:1,dropped:0};if(j.audio=w.type==="audio"?w:void 0,j.video=w.type!=="audio"?w:void 0,j.initSegment=K,j.id3=iY(Z,X,H,H),Q.samples.length)j.text=sY(Q,X,H);return j}}function dQ(J,Y,Z,Q){if(J===null)return!0;let X=Math.max(Q,1),q=Y-J.baseTime/J.timescale;return Math.abs(q-Z)>X}function D8(J,Y){let Z=J==null?void 0:J.codec;if(Z&&Z.length>4)return Z;if(Y===s.AUDIO){if(Z==="ec-3"||Z==="ac-3"||Z==="alac")return Z;if(Z==="fLaC"||Z==="Opus")return C6(Z,!1);let Q="mp4a.40.5";return B.info(`Parsed audio codec "${Z}" or audio object type not handled. Using "${Q}"`),Q}if(B.warn(`Unhandled video codec "${Z}"`),Z==="hvc1"||Z==="hev1")return"hvc1.1.6.L120.90";if(Z==="av01")return"av01.0.04M.08";return"avc1.42e01e"}var b0;try{b0=self.performance.now.bind(self.performance)}catch(J){B.debug("Unable to use Performance API on this environment"),b0=i0==null?void 0:i0.Date.now}var R6=[{demux:mY,remux:rY},{demux:D0,remux:Y6},{demux:pY,remux:Y6},{demux:oY,remux:Y6}];R6.splice(2,0,{demux:uY,remux:Y6});class MJ{constructor(J,Y,Z,Q,X){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=J,this.typeSupported=Y,this.config=Z,this.vendor=Q,this.id=X}configure(J){if(this.transmuxConfig=J,this.decrypter)this.decrypter.reset()}push(J,Y,Z,Q){let X=Z.transmuxing;X.executeStart=b0();let q=new Uint8Array(J),{currentTransmuxState:W,transmuxConfig:z}=this;if(Q)this.currentTransmuxState=Q;let{contiguous:H,discontinuity:G,trackSwitch:j,accurateTimeOffset:N,timeOffset:K,initSegmentChange:V}=Q||W,{audioCodec:U,videoCodec:O,defaultInitPts:_,duration:A,initSegmentData:R}=z,E=lQ(q,Y);if(E&&E.method==="AES-128"){let b=this.getDecrypter();if(b.isSync()){let x=b.softwareDecrypt(q,E.key.buffer,E.iv.buffer);if(Z.part>-1)x=b.flush();if(!x)return X.executeEnd=b0(),JJ(Z);q=new Uint8Array(x)}else return this.decryptionPromise=b.webCryptoDecrypt(q,E.key.buffer,E.iv.buffer).then((x)=>{let D=this.push(x,null,Z);return this.decryptionPromise=null,D}),this.decryptionPromise}let F=this.needsProbing(G,j);if(F){let b=this.configureTransmuxer(q);if(b)return B.warn(`[transmuxer] ${b.message}`),this.observer.emit($.ERROR,$.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_PARSING_ERROR,fatal:!1,error:b,reason:b.message}),X.executeEnd=b0(),JJ(Z)}if(G||j||V||F)this.resetInitSegment(R,U,O,A,Y);if(G||V||F)this.resetInitialTimestamp(_);if(!H)this.resetContiguity();let P=this.transmux(q,E,K,N,Z),w=this.currentTransmuxState;return w.contiguous=!0,w.discontinuity=!1,w.trackSwitch=!1,X.executeEnd=b0(),P}flush(J){let Y=J.transmuxing;Y.executeStart=b0();let{decrypter:Z,currentTransmuxState:Q,decryptionPromise:X}=this;if(X)return X.then(()=>{return this.flush(J)});let q=[],{timeOffset:W}=Q;if(Z){let j=Z.flush();if(j)q.push(this.push(j,null,J))}let{demuxer:z,remuxer:H}=this;if(!z||!H)return Y.executeEnd=b0(),[JJ(J)];let G=z.flush(W);if(M6(G))return G.then((j)=>{return this.flushRemux(q,j,J),q});return this.flushRemux(q,G,J),q}flushRemux(J,Y,Z){let{audioTrack:Q,videoTrack:X,id3Track:q,textTrack:W}=Y,{accurateTimeOffset:z,timeOffset:H}=this.currentTransmuxState;B.log(`[transmuxer.ts]: Flushed fragment ${Z.sn}${Z.part>-1?" p: "+Z.part:""} of level ${Z.level}`);let G=this.remuxer.remux(Q,X,q,W,H,z,!0,this.id);J.push({remuxResult:G,chunkMeta:Z}),Z.transmuxing.executeEnd=b0()}resetInitialTimestamp(J){let{demuxer:Y,remuxer:Z}=this;if(!Y||!Z)return;Y.resetTimeStamp(J),Z.resetTimeStamp(J)}resetContiguity(){let{demuxer:J,remuxer:Y}=this;if(!J||!Y)return;J.resetContiguity(),Y.resetNextTimestamp()}resetInitSegment(J,Y,Z,Q,X){let{demuxer:q,remuxer:W}=this;if(!q||!W)return;q.resetInitSegment(J,Y,Z,Q),W.resetInitSegment(J,Y,Z,X)}destroy(){if(this.demuxer)this.demuxer.destroy(),this.demuxer=void 0;if(this.remuxer)this.remuxer.destroy(),this.remuxer=void 0}transmux(J,Y,Z,Q,X){let q;if(Y&&Y.method==="SAMPLE-AES")q=this.transmuxSampleAes(J,Y,Z,Q,X);else q=this.transmuxUnencrypted(J,Z,Q,X);return q}transmuxUnencrypted(J,Y,Z,Q){let{audioTrack:X,videoTrack:q,id3Track:W,textTrack:z}=this.demuxer.demux(J,Y,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(X,q,W,z,Y,Z,!1,this.id),chunkMeta:Q}}transmuxSampleAes(J,Y,Z,Q,X){return this.demuxer.demuxSampleAes(J,Y,Z).then((q)=>{return{remuxResult:this.remuxer.remux(q.audioTrack,q.videoTrack,q.id3Track,q.textTrack,Z,Q,!1,this.id),chunkMeta:X}})}configureTransmuxer(J){let{config:Y,observer:Z,typeSupported:Q,vendor:X}=this,q;for(let N=0,K=R6.length;N<K;N++){var W;if((W=R6[N].demux)!=null&&W.probe(J)){q=R6[N];break}}if(!q)return new Error("Failed to find demuxer by probing fragment data");let z=this.demuxer,H=this.remuxer,G=q.remux,j=q.demux;if(!H||!(H instanceof G))this.remuxer=new G(Z,Y,Q,X);if(!z||!(z instanceof j))this.demuxer=new j(Z,Y,Q),this.probe=j.probe}needsProbing(J,Y){return!this.demuxer||!this.remuxer||J||Y}getDecrypter(){let J=this.decrypter;if(!J)J=this.decrypter=new m6(this.config);return J}}function lQ(J,Y){let Z=null;if(J.byteLength>0&&(Y==null?void 0:Y.key)!=null&&Y.iv!==null&&Y.method!=null)Z=Y;return Z}var JJ=(J)=>({remuxResult:{},chunkMeta:J});function M6(J){return"then"in J&&J.then instanceof Function}class aY{constructor(J,Y,Z,Q,X){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=J,this.videoCodec=Y,this.initSegmentData=Z,this.duration=Q,this.defaultInitPts=X||null}}class tY{constructor(J,Y,Z,Q,X,q){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=J,this.contiguous=Y,this.accurateTimeOffset=Z,this.trackSwitch=Q,this.timeOffset=X,this.initSegmentChange=q}}var eY={exports:{}};(function(J){var Y=Object.prototype.hasOwnProperty,Z="~";function Q(){}if(Object.create){if(Q.prototype=Object.create(null),!new Q().__proto__)Z=!1}function X(H,G,j){this.fn=H,this.context=G,this.once=j||!1}function q(H,G,j,N,K){if(typeof j!=="function")throw new TypeError("The listener must be a function");var V=new X(j,N||H,K),U=Z?Z+G:G;if(!H._events[U])H._events[U]=V,H._eventsCount++;else if(!H._events[U].fn)H._events[U].push(V);else H._events[U]=[H._events[U],V];return H}function W(H,G){if(--H._eventsCount===0)H._events=new Q;else delete H._events[G]}function z(){this._events=new Q,this._eventsCount=0}z.prototype.eventNames=function H(){var G=[],j,N;if(this._eventsCount===0)return G;for(N in j=this._events)if(Y.call(j,N))G.push(Z?N.slice(1):N);if(Object.getOwnPropertySymbols)return G.concat(Object.getOwnPropertySymbols(j));return G},z.prototype.listeners=function H(G){var j=Z?Z+G:G,N=this._events[j];if(!N)return[];if(N.fn)return[N.fn];for(var K=0,V=N.length,U=new Array(V);K<V;K++)U[K]=N[K].fn;return U},z.prototype.listenerCount=function H(G){var j=Z?Z+G:G,N=this._events[j];if(!N)return 0;if(N.fn)return 1;return N.length},z.prototype.emit=function H(G,j,N,K,V,U){var O=Z?Z+G:G;if(!this._events[O])return!1;var _=this._events[O],A=arguments.length,R,E;if(_.fn){if(_.once)this.removeListener(G,_.fn,void 0,!0);switch(A){case 1:return _.fn.call(_.context),!0;case 2:return _.fn.call(_.context,j),!0;case 3:return _.fn.call(_.context,j,N),!0;case 4:return _.fn.call(_.context,j,N,K),!0;case 5:return _.fn.call(_.context,j,N,K,V),!0;case 6:return _.fn.call(_.context,j,N,K,V,U),!0}for(E=1,R=new Array(A-1);E<A;E++)R[E-1]=arguments[E];_.fn.apply(_.context,R)}else{var F=_.length,P;for(E=0;E<F;E++){if(_[E].once)this.removeListener(G,_[E].fn,void 0,!0);switch(A){case 1:_[E].fn.call(_[E].context);break;case 2:_[E].fn.call(_[E].context,j);break;case 3:_[E].fn.call(_[E].context,j,N);break;case 4:_[E].fn.call(_[E].context,j,N,K);break;default:if(!R)for(P=1,R=new Array(A-1);P<A;P++)R[P-1]=arguments[P];_[E].fn.apply(_[E].context,R)}}}return!0},z.prototype.on=function H(G,j,N){return q(this,G,j,N,!1)},z.prototype.once=function H(G,j,N){return q(this,G,j,N,!0)},z.prototype.removeListener=function H(G,j,N,K){var V=Z?Z+G:G;if(!this._events[V])return this;if(!j)return W(this,V),this;var U=this._events[V];if(U.fn){if(U.fn===j&&(!K||U.once)&&(!N||U.context===N))W(this,V)}else{for(var O=0,_=[],A=U.length;O<A;O++)if(U[O].fn!==j||K&&!U[O].once||N&&U[O].context!==N)_.push(U[O]);if(_.length)this._events[V]=_.length===1?_[0]:_;else W(this,V)}return this},z.prototype.removeAllListeners=function H(G){var j;if(G){if(j=Z?Z+G:G,this._events[j])W(this,j)}else this._events=new Q,this._eventsCount=0;return this},z.prototype.off=z.prototype.removeListener,z.prototype.addListener=z.prototype.on,z.prefixed=Z,z.EventEmitter=z,J.exports=z})(eY);var oQ=eY.exports,fJ=m7(oQ);class cJ{constructor(J,Y,Z,Q){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;let X=J.config;this.hls=J,this.id=Y,this.useWorker=!!X.enableWorker,this.onTransmuxComplete=Z,this.onFlush=Q;let q=(H,G)=>{if(G=G||{},G.frag=this.frag,G.id=this.id,H===$.ERROR)this.error=G.error;this.hls.trigger(H,G)};this.observer=new fJ,this.observer.on($.FRAG_DECRYPTED,q),this.observer.on($.ERROR,q);let W=p0(X.preferManagedMediaSource)||{isTypeSupported:()=>!1},z={mpeg:W.isTypeSupported("audio/mpeg"),mp3:W.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:W.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&typeof Worker!=="undefined"){if(X.workerPath||MQ()){try{if(X.workerPath)B.log(`loading Web Worker ${X.workerPath} for "${Y}"`),this.workerContext=EQ(X.workerPath);else B.log(`injecting Web Worker for "${Y}"`),this.workerContext=FQ();this.onwmsg=(j)=>this.onWorkerMessage(j);let{worker:G}=this.workerContext;G.addEventListener("message",this.onwmsg),G.onerror=(j)=>{let N=new Error(`${j.message}  (${j.filename}:${j.lineno})`);X.enableWorker=!1,B.warn(`Error in "${Y}" Web Worker, fallback to inline`),this.hls.trigger($.ERROR,{type:g.OTHER_ERROR,details:I.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:N})},G.postMessage({cmd:"init",typeSupported:z,vendor:"",id:Y,config:JSON.stringify(X)})}catch(G){B.warn(`Error setting up "${Y}" Web Worker, fallback to inline`,G),this.resetWorker(),this.error=null,this.transmuxer=new MJ(this.observer,z,X,"",Y)}return}}this.transmuxer=new MJ(this.observer,z,X,"",Y)}resetWorker(){if(this.workerContext){let{worker:J,objectURL:Y}=this.workerContext;if(Y)self.URL.revokeObjectURL(Y);J.removeEventListener("message",this.onwmsg),J.onerror=null,J.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{let Y=this.transmuxer;if(Y)Y.destroy(),this.transmuxer=null}let J=this.observer;if(J)J.removeAllListeners();this.frag=null,this.observer=null,this.hls=null}push(J,Y,Z,Q,X,q,W,z,H,G){var j,N;H.transmuxing.start=self.performance.now();let{transmuxer:K}=this,V=q?q.start:X.start,U=X.decryptdata,O=this.frag,_=!(O&&X.cc===O.cc),A=!(O&&H.level===O.level),R=O?H.sn-O.sn:-1,E=this.part?H.part-this.part.index:-1,F=R===0&&H.id>1&&H.id===(O==null?void 0:O.stats.chunkCount),P=!A&&(R===1||R===0&&(E===1||F&&E<=0)),w=self.performance.now();if(A||R||X.stats.parsing.start===0)X.stats.parsing.start=w;if(q&&(E||!P))q.stats.parsing.start=w;let b=!(O&&((j=X.initSegment)==null?void 0:j.url)===((N=O.initSegment)==null?void 0:N.url)),x=new tY(_,P,z,A,V,b);if(!P||_||b){B.log(`[transmuxer-interface, ${X.type}]: Starting new transmux session for sn: ${H.sn} p: ${H.part} level: ${H.level} id: ${H.id}
        discontinuity: ${_}
        trackSwitch: ${A}
        contiguous: ${P}
        accurateTimeOffset: ${z}
        timeOffset: ${V}
        initSegmentChange: ${b}`);let D=new aY(Z,Q,Y,W,G);this.configureTransmuxer(D)}if(this.frag=X,this.part=q,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:J,decryptdata:U,chunkMeta:H,state:x},J instanceof ArrayBuffer?[J]:[]);else if(K){let D=K.push(J,U,H,x);if(M6(D))K.async=!0,D.then((L)=>{this.handleTransmuxComplete(L)}).catch((L)=>{this.transmuxerError(L,H,"transmuxer-interface push error")});else K.async=!1,this.handleTransmuxComplete(D)}}flush(J){J.transmuxing.start=self.performance.now();let{transmuxer:Y}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:J});else if(Y){let Z=Y.flush(J);if(M6(Z)||Y.async){if(!M6(Z))Z=Promise.resolve(Z);Z.then((X)=>{this.handleFlushResult(X,J)}).catch((X)=>{this.transmuxerError(X,J,"transmuxer-interface flush error")})}else this.handleFlushResult(Z,J)}}transmuxerError(J,Y,Z){if(!this.hls)return;this.error=J,this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_PARSING_ERROR,chunkMeta:Y,frag:this.frag||void 0,fatal:!1,error:J,err:J,reason:Z})}handleFlushResult(J,Y){J.forEach((Z)=>{this.handleTransmuxComplete(Z)}),this.onFlush(Y)}onWorkerMessage(J){let Y=J.data;if(!(Y!=null&&Y.event)){B.warn(`worker message received with no ${Y?"event name":"data"}`);return}let Z=this.hls;if(!this.hls)return;switch(Y.event){case"init":{var Q;let X=(Q=this.workerContext)==null?void 0:Q.objectURL;if(X)self.URL.revokeObjectURL(X);break}case"transmuxComplete":{this.handleTransmuxComplete(Y.data);break}case"flush":{this.onFlush(Y.data);break}case"workerLog":if(B[Y.data.logType])B[Y.data.logType](Y.data.message);break;default:{Y.data=Y.data||{},Y.data.frag=this.frag,Y.data.id=this.id,Z.trigger(Y.event,Y.data);break}}}configureTransmuxer(J){let{transmuxer:Y}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"configure",config:J});else if(Y)Y.configure(J)}handleTransmuxComplete(J){J.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(J)}}function J7(J,Y){if(J.length!==Y.length)return!1;for(let Z=0;Z<J.length;Z++)if(!s0(J[Z].attrs,Y[Z].attrs))return!1;return!0}function s0(J,Y,Z){let Q=J["STABLE-RENDITION-ID"];if(Q&&!Z)return Q===Y["STABLE-RENDITION-ID"];return!(Z||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some((X)=>J[X]!==Y[X])}function FJ(J,Y){return Y.label.toLowerCase()===J.name.toLowerCase()&&(!Y.language||Y.language.toLowerCase()===(J.lang||"").toLowerCase())}var T8=100;class Y7 extends g6{constructor(J,Y,Z){super(J,Y,Z,"[audio-stream-controller]",m.AUDIO);this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.LEVEL_LOADED,this.onLevelLoaded,this),J.on($.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),J.on($.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),J.on($.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),J.on($.ERROR,this.onError,this),J.on($.BUFFER_RESET,this.onBufferReset,this),J.on($.BUFFER_CREATED,this.onBufferCreated,this),J.on($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.on($.BUFFER_FLUSHED,this.onBufferFlushed,this),J.on($.INIT_PTS_FOUND,this.onInitPtsFound,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.LEVEL_LOADED,this.onLevelLoaded,this),J.off($.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),J.off($.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),J.off($.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),J.off($.ERROR,this.onError,this),J.off($.BUFFER_RESET,this.onBufferReset,this),J.off($.BUFFER_CREATED,this.onBufferCreated,this),J.off($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.off($.BUFFER_FLUSHED,this.onBufferFlushed,this),J.off($.INIT_PTS_FOUND,this.onInitPtsFound,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(J,{frag:Y,id:Z,initPTS:Q,timescale:X}){if(Z==="main"){let q=Y.cc;if(this.initPTS[Y.cc]={baseTime:Q,timescale:X},this.log(`InitPTS for cc: ${q} found from main: ${Q}`),this.videoTrackCC=q,this.state===C.WAITING_INIT_PTS)this.tick()}}startLoad(J){if(!this.levels){this.startPosition=J,this.state=C.STOPPED;return}let Y=this.lastCurrentTime;if(this.stopLoad(),this.setInterval(T8),Y>0&&J===-1)this.log(`Override startPosition with lastCurrentTime @${Y.toFixed(3)}`),J=Y,this.state=C.IDLE;else this.loadedmetadata=!1,this.state=C.WAITING_TRACK;this.nextLoadPosition=this.startPosition=this.lastCurrentTime=J,this.tick()}doTick(){switch(this.state){case C.IDLE:this.doTickIdle();break;case C.WAITING_TRACK:{var J;let{levels:Z,trackId:Q}=this,X=Z==null?void 0:(J=Z[Q])==null?void 0:J.details;if(X){if(this.waitForCdnTuneIn(X))break;this.state=C.WAITING_INIT_PTS}break}case C.FRAG_LOADING_WAITING_RETRY:{var Y;let Z=performance.now(),Q=this.retryDate;if(!Q||Z>=Q||(Y=this.media)!=null&&Y.seeking){let{levels:X,trackId:q}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((X==null?void 0:X[q])||null),this.state=C.IDLE}break}case C.WAITING_INIT_PTS:{let Z=this.waitingData;if(Z){let{frag:Q,part:X,cache:q,complete:W}=Z;if(this.initPTS[Q.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=C.FRAG_LOADING;let z=q.flush(),H={frag:Q,part:X,payload:z,networkDetails:null};if(this._handleFragmentLoadProgress(H),W)super._handleFragmentLoadComplete(H)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${Q.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{let z=this.getLoadPosition(),H=a.bufferInfo(this.mediaBuffer,z,this.config.maxBufferHole);if(OJ(H.end,this.config.maxFragLookUpTolerance,Q)<0)this.log(`Waiting fragment cc (${Q.cc}) @ ${Q.start} cancelled because another fragment at ${H.end} is needed`),this.clearWaitingFragment()}}else this.state=C.IDLE}}this.onTickEnd()}clearWaitingFragment(){let J=this.waitingData;if(J)this.fragmentTracker.removeFragment(J.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=C.IDLE}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){let{media:J}=this;if(!(J!=null&&J.readyState))return;this.lastCurrentTime=J.currentTime}doTickIdle(){let{hls:J,levels:Y,media:Z,trackId:Q}=this,X=J.config;if(!this.buffering||!Z&&(this.startFragRequested||!X.startFragPrefetch)||!(Y!=null&&Y[Q]))return;let q=Y[Q],W=q.details;if(!W||W.live&&this.levelLastLoaded!==q||this.waitForCdnTuneIn(W)){this.state=C.WAITING_TRACK;return}let z=this.mediaBuffer?this.mediaBuffer:this.media;if(this.bufferFlushed&&z)this.bufferFlushed=!1,this.afterBufferFlushed(z,s.AUDIO,m.AUDIO);let H=this.getFwdBufferInfo(z,m.AUDIO);if(H===null)return;let{bufferedTrack:G,switchingTrack:j}=this;if(!j&&this._streamEnded(H,W)){J.trigger($.BUFFER_EOS,{type:"audio"}),this.state=C.ENDED;return}let N=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,m.MAIN),K=H.len,V=this.getMaxBufferLength(N==null?void 0:N.len),U=W.fragments,O=U[0].start,_=this.flushing?this.getLoadPosition():H.end;if(j&&Z){let F=this.getLoadPosition();if(G&&!s0(j.attrs,G.attrs))_=F;if(W.PTSKnown&&F<O){if(H.end>O||H.nextStart)this.log("Alt audio track ahead of main track, seek to start of alt audio track"),Z.currentTime=O+0.05}}if(K>=V&&!j&&_<U[U.length-1].start)return;let A=this.getNextFragment(_,W),R=!1;if(A&&this.isLoopLoading(A,_))R=!!A.gap,A=this.getNextFragmentLoopLoading(A,W,H,m.MAIN,V);if(!A){this.bufferFlushed=!0;return}let E=N&&A.start>N.end+W.targetduration;if(E||!(N!=null&&N.len)&&H.len){let F=this.getAppendedFrag(A.start,m.MAIN);if(F===null)return;if(R||(R=!!F.gap||!!E&&N.len===0),E&&!R||R&&H.nextStart&&H.nextStart<F.end)return}this.loadFragment(A,q,_)}getMaxBufferLength(J){let Y=super.getMaxBufferLength();if(!J)return Y;return Math.min(Math.max(Y,J),this.config.maxMaxBufferLength)}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(J,{audioTracks:Y}){this.resetTransmuxer(),this.levels=Y.map((Z)=>new m0(Z))}onAudioTrackSwitching(J,Y){let Z=!!Y.url;this.trackId=Y.id;let{fragCurrent:Q}=this;if(Q)Q.abortRequests(),this.removeUnbufferedFrags(Q.start);if(this.resetLoadingState(),!Z)this.resetTransmuxer();else this.setInterval(T8);if(Z)this.switchingTrack=Y,this.state=C.IDLE,this.flushAudioIfNeeded(Y);else this.switchingTrack=null,this.bufferedTrack=Y,this.state=C.STOPPED;this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(J,Y){if(this.mainDetails=Y.details,this.cachedTrackLoadedData!==null)this.hls.trigger($.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null}onAudioTrackLoaded(J,Y){var Z;if(this.mainDetails==null){this.cachedTrackLoadedData=Y;return}let{levels:Q}=this,{details:X,id:q}=Y;if(!Q){this.warn(`Audio tracks were reset while loading level ${q}`);return}this.log(`Audio track ${q} loaded [${X.startSN},${X.endSN}]${X.lastPartSn?`[part-${X.lastPartSn}-${X.lastPartIndex}]`:""},duration:${X.totalduration}`);let W=Q[q],z=0;if(X.live||(Z=W.details)!=null&&Z.live){this.checkLiveUpdate(X);let G=this.mainDetails;if(X.deltaUpdateFailed||!G)return;if(!W.details&&X.hasProgramDateTime&&G.hasProgramDateTime)S6(X,G),z=X.fragments[0].start;else{var H;z=this.alignPlaylists(X,W.details,(H=this.levelLastLoaded)==null?void 0:H.details)}}if(W.details=X,this.levelLastLoaded=W,!this.startFragRequested&&(this.mainDetails||!X.live))this.setStartPosition(this.mainDetails||X,z);if(this.state===C.WAITING_TRACK&&!this.waitForCdnTuneIn(X))this.state=C.IDLE;this.tick()}_handleFragmentLoadProgress(J){var Y;let{frag:Z,part:Q,payload:X}=J,{config:q,trackId:W,levels:z}=this;if(!z){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${Z.sn} of level ${Z.level} will not be buffered`);return}let H=z[W];if(!H){this.warn("Audio track is undefined on fragment load progress");return}let G=H.details;if(!G){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(Z.start);return}let j=q.defaultAudioCodec||H.audioCodec||"mp4a.40.2",N=this.transmuxer;if(!N)N=this.transmuxer=new cJ(this.hls,m.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this));let K=this.initPTS[Z.cc],V=(Y=Z.initSegment)==null?void 0:Y.data;if(K!==void 0){let O=Q?Q.index:-1,_=O!==-1,A=new p6(Z.level,Z.sn,Z.stats.chunkCount,X.byteLength,O,_);N.push(X,V,j,"",Z,Q,G.totalduration,!1,A,K)}else{this.log(`Unknown video PTS for cc ${Z.cc}, waiting for video PTS before demuxing audio frag ${Z.sn} of [${G.startSN} ,${G.endSN}],track ${W}`);let{cache:U}=this.waitingData=this.waitingData||{frag:Z,part:Q,cache:new pJ,complete:!1};U.push(new Uint8Array(X)),this.waitingVideoCC=this.videoTrackCC,this.state=C.WAITING_INIT_PTS}}_handleFragmentLoadComplete(J){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(J)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(J,Y){let Z=Y.tracks.audio;if(Z)this.mediaBuffer=Z.buffer||null;if(Y.tracks.video)this.videoBuffer=Y.tracks.video.buffer||null}onFragBuffered(J,Y){let{frag:Z,part:Q}=Y;if(Z.type!==m.AUDIO){if(!this.loadedmetadata&&Z.type===m.MAIN){let X=this.videoBuffer||this.media;if(X){if(a.getBuffered(X).length)this.loadedmetadata=!0}}return}if(this.fragContextChanged(Z)){this.warn(`Fragment ${Z.sn}${Q?" p: "+Q.index:""} of level ${Z.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(Z.sn!=="initSegment"){this.fragPrevious=Z;let X=this.switchingTrack;if(X)this.bufferedTrack=X,this.switchingTrack=null,this.hls.trigger($.AUDIO_TRACK_SWITCHED,z0({},X))}this.fragBufferedComplete(Z,Q)}onError(J,Y){var Z;if(Y.fatal){this.state=C.ERROR;return}switch(Y.details){case I.FRAG_GAP:case I.FRAG_PARSING_ERROR:case I.FRAG_DECRYPT_ERROR:case I.FRAG_LOAD_ERROR:case I.FRAG_LOAD_TIMEOUT:case I.KEY_LOAD_ERROR:case I.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(m.AUDIO,Y);break;case I.AUDIO_TRACK_LOAD_ERROR:case I.AUDIO_TRACK_LOAD_TIMEOUT:case I.LEVEL_PARSING_ERROR:if(!Y.levelRetry&&this.state===C.WAITING_TRACK&&((Z=Y.context)==null?void 0:Z.type)===l.AUDIO_TRACK)this.state=C.IDLE;break;case I.BUFFER_APPEND_ERROR:case I.BUFFER_FULL_ERROR:if(!Y.parent||Y.parent!=="audio")return;if(Y.details===I.BUFFER_APPEND_ERROR){this.resetLoadingState();return}if(this.reduceLengthAndFlushBuffer(Y))this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio");break;case I.INTERNAL_EXCEPTION:this.recoverWorkerError(Y);break}}onBufferFlushing(J,{type:Y}){if(Y!==s.VIDEO)this.flushing=!0}onBufferFlushed(J,{type:Y}){if(Y!==s.VIDEO){if(this.flushing=!1,this.bufferFlushed=!0,this.state===C.ENDED)this.state=C.IDLE;let Z=this.mediaBuffer||this.media;if(Z)this.afterBufferFlushed(Z,Y,m.AUDIO),this.tick()}}_handleTransmuxComplete(J){var Y;let Z="audio",{hls:Q}=this,{remuxResult:X,chunkMeta:q}=J,W=this.getCurrentContext(q);if(!W){this.resetWhenMissingContext(q);return}let{frag:z,part:H,level:G}=W,{details:j}=G,{audio:N,text:K,id3:V,initSegment:U}=X;if(this.fragContextChanged(z)||!j){this.fragmentTracker.removeFragment(z);return}if(this.state=C.PARSING,this.switchingTrack&&N)this.completeAudioSwitch(this.switchingTrack);if(U!=null&&U.tracks){let O=z.initSegment||z;this._bufferInitSegment(G,U.tracks,O,q),Q.trigger($.FRAG_PARSING_INIT_SEGMENT,{frag:O,id:"audio",tracks:U.tracks})}if(N){let{startPTS:O,endPTS:_,startDTS:A,endDTS:R}=N;if(H)H.elementaryStreams[s.AUDIO]={startPTS:O,endPTS:_,startDTS:A,endDTS:R};z.setElementaryStreamInfo(s.AUDIO,O,_,A,R),this.bufferFragmentData(N,z,H,q)}if(V!=null&&(Y=V.samples)!=null&&Y.length){let O=Y0({id:"audio",frag:z,details:j},V);Q.trigger($.FRAG_PARSING_METADATA,O)}if(K){let O=Y0({id:"audio",frag:z,details:j},K);Q.trigger($.FRAG_PARSING_USERDATA,O)}}_bufferInitSegment(J,Y,Z,Q){if(this.state!==C.PARSING)return;if(Y.video)delete Y.video;let X=Y.audio;if(!X)return;X.id="audio";let q=J.audioCodec;if(this.log(`Init audio buffer, container:${X.container}, codecs[level/parsed]=[${q}/${X.codec}]`),q&&q.split(",").length===1)X.levelCodec=q;this.hls.trigger($.BUFFER_CODECS,Y);let W=X.initSegment;if(W!=null&&W.byteLength){let z={type:"audio",frag:Z,part:null,chunkMeta:Q,parent:Z.type,data:W};this.hls.trigger($.BUFFER_APPENDING,z)}this.tickImmediate()}loadFragment(J,Y,Z){let Q=this.fragmentTracker.getState(J);if(this.fragCurrent=J,this.switchingTrack||Q===W0.NOT_LOADED||Q===W0.PARTIAL){var X;if(J.sn==="initSegment")this._loadInitSegment(J,Y);else if((X=Y.details)!=null&&X.live&&!this.initPTS[J.cc]){this.log(`Waiting for video PTS in continuity counter ${J.cc} of live stream before loading audio fragment ${J.sn} of level ${this.trackId}`),this.state=C.WAITING_INIT_PTS;let q=this.mainDetails;if(q&&q.fragments[0].start!==Y.details.fragments[0].start)S6(Y.details,q)}else this.startFragRequested=!0,super.loadFragment(J,Y,Z)}else this.clearTrackerIfNeeded(J)}flushAudioIfNeeded(J){let{media:Y,bufferedTrack:Z}=this,Q=Z==null?void 0:Z.attrs,X=J.attrs;if(Y&&Q&&(Q.CHANNELS!==X.CHANNELS||Z.name!==J.name||Z.lang!==J.lang))this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null}completeAudioSwitch(J){let{hls:Y}=this;this.flushAudioIfNeeded(J),this.bufferedTrack=J,this.switchingTrack=null,Y.trigger($.AUDIO_TRACK_SWITCHED,z0({},J))}}class Z7 extends v6{constructor(J){super(J,"[audio-track-controller]");this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){let{hls:J}=this;J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.LEVEL_LOADING,this.onLevelLoading,this),J.on($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.on($.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),J.on($.ERROR,this.onError,this)}unregisterListeners(){let{hls:J}=this;J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.LEVEL_LOADING,this.onLevelLoading,this),J.off($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.off($.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),J.off($.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(J,Y){this.tracks=Y.audioTracks||[]}onAudioTrackLoaded(J,Y){let{id:Z,groupId:Q,details:X}=Y,q=this.tracksInGroup[Z];if(!q||q.groupId!==Q){this.warn(`Audio track with id:${Z} and group:${Q} not found in active group ${q==null?void 0:q.groupId}`);return}let W=q.details;if(q.details=Y.details,this.log(`Audio track ${Z} "${q.name}" lang:${q.lang} group:${Q} loaded [${X.startSN}-${X.endSN}]`),Z===this.trackId)this.playlistLoaded(Z,Y,W)}onLevelLoading(J,Y){this.switchLevel(Y.level)}onLevelSwitching(J,Y){this.switchLevel(Y.level)}switchLevel(J){let Y=this.hls.levels[J];if(!Y)return;let Z=Y.audioGroups||null,Q=this.groupIds,X=this.currentTrack;if(!Z||(Q==null?void 0:Q.length)!==(Z==null?void 0:Z.length)||Z!=null&&Z.some((W)=>(Q==null?void 0:Q.indexOf(W))===-1)){this.groupIds=Z,this.trackId=-1,this.currentTrack=null;let W=this.tracks.filter((N)=>!Z||Z.indexOf(N.groupId)!==-1);if(W.length){if(this.selectDefaultTrack&&!W.some((N)=>N.default))this.selectDefaultTrack=!1;W.forEach((N,K)=>{N.id=K})}else if(!X&&!this.tracksInGroup.length)return;this.tracksInGroup=W;let z=this.hls.config.audioPreference;if(!X&&z){let N=I0(z,W,g0);if(N>-1)X=W[N];else{let K=I0(z,this.tracks);X=this.tracks[K]}}let H=this.findTrackId(X);if(H===-1&&X)H=this.findTrackId(null);let G={audioTracks:W};this.log(`Updating audio tracks, ${W.length} track(s) found in group(s): ${Z==null?void 0:Z.join(",")}`),this.hls.trigger($.AUDIO_TRACKS_UPDATED,G);let j=this.trackId;if(H!==-1&&j===-1)this.setAudioTrack(H);else if(W.length&&j===-1){var q;let N=new Error(`No audio track selected for current audio group-ID(s): ${(q=this.groupIds)==null?void 0:q.join(",")} track count: ${W.length}`);this.warn(N.message),this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:N})}}else if(this.shouldReloadPlaylist(X))this.setAudioTrack(this.trackId)}onError(J,Y){if(Y.fatal||!Y.context)return;if(Y.context.type===l.AUDIO_TRACK&&Y.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(Y.context.groupId)!==-1))this.requestScheduled=-1,this.checkRetry(Y)}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(J){this.selectDefaultTrack=!1,this.setAudioTrack(J)}setAudioOption(J){let Y=this.hls;if(Y.config.audioPreference=J,J){let Z=this.allAudioTracks;if(this.selectDefaultTrack=!1,Z.length){let Q=this.currentTrack;if(Q&&o0(J,Q,g0))return Q;let X=I0(J,this.tracksInGroup,g0);if(X>-1){let q=this.tracksInGroup[X];return this.setAudioTrack(X),q}else if(Q){let q=Y.loadLevel;if(q===-1)q=Y.firstAutoLevel;let W=NQ(J,Y.levels,Z,q,g0);if(W===-1)return null;Y.nextLoadLevel=W}if(J.channels||J.audioCodec){let q=I0(J,Z);if(q>-1)return Z[q]}}}return null}setAudioTrack(J){let Y=this.tracksInGroup;if(J<0||J>=Y.length){this.warn(`Invalid audio track id: ${J}`);return}this.clearTimer(),this.selectDefaultTrack=!1;let Z=this.currentTrack,Q=Y[J],X=Q.details&&!Q.details.live;if(J===this.trackId&&Q===Z&&X)return;if(this.log(`Switching to audio-track ${J} "${Q.name}" lang:${Q.lang} group:${Q.groupId} channels:${Q.channels}`),this.trackId=J,this.currentTrack=Q,this.hls.trigger($.AUDIO_TRACK_SWITCHING,z0({},Q)),X)return;let q=this.switchParams(Q.url,Z==null?void 0:Z.details,Q.details);this.loadPlaylist(q)}findTrackId(J){let Y=this.tracksInGroup;for(let Z=0;Z<Y.length;Z++){let Q=Y[Z];if(this.selectDefaultTrack&&!Q.default)continue;if(!J||o0(J,Q,g0))return Z}if(J){let{name:Z,lang:Q,assocLang:X,characteristics:q,audioCodec:W,channels:z}=J;for(let H=0;H<Y.length;H++){let G=Y[H];if(o0({name:Z,lang:Q,assocLang:X,characteristics:q,audioCodec:W,channels:z},G,g0))return H}for(let H=0;H<Y.length;H++){let G=Y[H];if(s0(J.attrs,G.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return H}for(let H=0;H<Y.length;H++){let G=Y[H];if(s0(J.attrs,G.attrs,["LANGUAGE"]))return H}}return-1}loadPlaylist(J){let Y=this.currentTrack;if(this.shouldLoadPlaylist(Y)&&Y){super.loadPlaylist();let{id:Z,groupId:Q,url:X}=Y;if(J)try{X=J.addDirectives(X)}catch(q){this.warn(`Could not construct new URL with HLS Delivery Directives: ${q}`)}this.log(`loading audio-track playlist ${Z} "${Y.name}" lang:${Y.lang} group:${Q}`),this.clearTimer(),this.hls.trigger($.AUDIO_TRACK_LOADING,{url:X,id:Z,groupId:Q,deliveryDirectives:J||null})}}}var S8=500;class Q7 extends g6{constructor(J,Y,Z){super(J,Y,Z,"[subtitle-stream-controller]",m.SUBTITLE);this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.LEVEL_LOADED,this.onLevelLoaded,this),J.on($.ERROR,this.onError,this),J.on($.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),J.on($.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),J.on($.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),J.on($.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),J.on($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.LEVEL_LOADED,this.onLevelLoaded,this),J.off($.ERROR,this.onError,this),J.off($.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),J.off($.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),J.off($.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),J.off($.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),J.off($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(J){this.stopLoad(),this.state=C.IDLE,this.setInterval(S8),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=J,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(J,Y){this.mainDetails=Y.details}onSubtitleFragProcessed(J,Y){let{frag:Z,success:Q}=Y;if(this.fragPrevious=Z,this.state=C.IDLE,!Q)return;let X=this.tracksBuffered[this.currentTrackId];if(!X)return;let q,W=Z.start;for(let H=0;H<X.length;H++)if(W>=X[H].start&&W<=X[H].end){q=X[H];break}let z=Z.start+Z.duration;if(q)q.end=z;else q={start:W,end:z},X.push(q);this.fragmentTracker.fragBuffered(Z),this.fragBufferedComplete(Z,null)}onBufferFlushing(J,Y){let{startOffset:Z,endOffset:Q}=Y;if(Z===0&&Q!==Number.POSITIVE_INFINITY){let X=Q-1;if(X<=0)return;Y.endOffsetSubtitles=Math.max(0,X),this.tracksBuffered.forEach((q)=>{for(let W=0;W<q.length;){if(q[W].end<=X){q.shift();continue}else if(q[W].start<X)q[W].start=X;else break;W++}}),this.fragmentTracker.removeFragmentsInRange(Z,X,m.SUBTITLE)}}onFragBuffered(J,Y){if(!this.loadedmetadata&&Y.frag.type===m.MAIN){var Z;if((Z=this.media)!=null&&Z.buffered.length)this.loadedmetadata=!0}}onError(J,Y){let Z=Y.frag;if((Z==null?void 0:Z.type)===m.SUBTITLE){if(Y.details===I.FRAG_GAP)this.fragmentTracker.fragBuffered(Z,!0);if(this.fragCurrent)this.fragCurrent.abortRequests();if(this.state!==C.STOPPED)this.state=C.IDLE}}onSubtitleTracksUpdated(J,{subtitleTracks:Y}){if(this.levels&&J7(this.levels,Y)){this.levels=Y.map((Z)=>new m0(Z));return}this.tracksBuffered=[],this.levels=Y.map((Z)=>{let Q=new m0(Z);return this.tracksBuffered[Q.id]=[],Q}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,m.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(J,Y){var Z;if(this.currentTrackId=Y.id,!((Z=this.levels)!=null&&Z.length)||this.currentTrackId===-1){this.clearInterval();return}let Q=this.levels[this.currentTrackId];if(Q!=null&&Q.details)this.mediaBuffer=this.mediaBufferTimeRanges;else this.mediaBuffer=null;if(Q)this.setInterval(S8)}onSubtitleTrackLoaded(J,Y){var Z;let{currentTrackId:Q,levels:X}=this,{details:q,id:W}=Y;if(!X){this.warn(`Subtitle tracks were reset while loading level ${W}`);return}let z=X[W];if(W>=X.length||!z)return;this.log(`Subtitle track ${W} loaded [${q.startSN},${q.endSN}]${q.lastPartSn?`[part-${q.lastPartSn}-${q.lastPartIndex}]`:""},duration:${q.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let H=0;if(q.live||(Z=z.details)!=null&&Z.live){let j=this.mainDetails;if(q.deltaUpdateFailed||!j)return;let N=j.fragments[0];if(!z.details){if(q.hasProgramDateTime&&j.hasProgramDateTime)S6(q,j),H=q.fragments[0].start;else if(N)H=N.start,$J(q,H)}else{var G;if(H=this.alignPlaylists(q,z.details,(G=this.levelLastLoaded)==null?void 0:G.details),H===0&&N)H=N.start,$J(q,H)}}if(z.details=q,this.levelLastLoaded=z,W!==Q)return;if(!this.startFragRequested&&(this.mainDetails||!q.live))this.setStartPosition(this.mainDetails||q,H);if(this.tick(),q.live&&!this.fragCurrent&&this.media&&this.state===C.IDLE){if(!T6(null,q.fragments,this.media.currentTime,0))this.warn("Subtitle playlist not aligned with playback"),z.details=void 0}}_handleFragmentLoadComplete(J){let{frag:Y,payload:Z}=J,Q=Y.decryptdata,X=this.hls;if(this.fragContextChanged(Y))return;if(Z&&Z.byteLength>0&&Q!=null&&Q.key&&Q.iv&&Q.method==="AES-128"){let q=performance.now();this.decrypter.decrypt(new Uint8Array(Z),Q.key.buffer,Q.iv.buffer).catch((W)=>{throw X.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.FRAG_DECRYPT_ERROR,fatal:!1,error:W,reason:W.message,frag:Y}),W}).then((W)=>{let z=performance.now();X.trigger($.FRAG_DECRYPTED,{frag:Y,payload:W,stats:{tstart:q,tdecrypt:z}})}).catch((W)=>{this.warn(`${W.name}: ${W.message}`),this.state=C.IDLE})}}doTick(){if(!this.media){this.state=C.IDLE;return}if(this.state===C.IDLE){let{currentTrackId:J,levels:Y}=this,Z=Y==null?void 0:Y[J];if(!Z||!Y.length||!Z.details)return;let{config:Q}=this,X=this.getLoadPosition(),q=a.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],X,Q.maxBufferHole),{end:W,len:z}=q,H=this.getFwdBufferInfo(this.media,m.MAIN),G=Z.details,j=this.getMaxBufferLength(H==null?void 0:H.len)+G.levelTargetDuration;if(z>j)return;let N=G.fragments,K=N.length,V=G.edge,U=null,O=this.fragPrevious;if(W<V){let _=Q.maxFragLookUpTolerance,A=W>V-_?0:_;if(U=T6(O,N,Math.max(N[0].start,W),A),!U&&O&&O.start<N[0].start)U=N[0]}else U=N[K-1];if(!U)return;if(U=this.mapToInitFragWhenRequired(U),U.sn!=="initSegment"){let _=U.sn-G.startSN,A=N[_-1];if(A&&A.cc===U.cc&&this.fragmentTracker.getState(A)===W0.NOT_LOADED)U=A}if(this.fragmentTracker.getState(U)===W0.NOT_LOADED)this.loadFragment(U,Z,W)}}getMaxBufferLength(J){let Y=super.getMaxBufferLength();if(!J)return Y;return Math.max(Y,J)}loadFragment(J,Y,Z){if(this.fragCurrent=J,J.sn==="initSegment")this._loadInitSegment(J,Y);else this.startFragRequested=!0,super.loadFragment(J,Y,Z)}get mediaBufferTimeRanges(){return new X7(this.tracksBuffered[this.currentTrackId]||[])}}class X7{constructor(J){this.buffered=void 0;let Y=(Z,Q,X)=>{if(Q=Q>>>0,Q>X-1)throw new DOMException(`Failed to execute '${Z}' on 'TimeRanges': The index provided (${Q}) is greater than the maximum bound (${X})`);return J[Q][Z]};this.buffered={get length(){return J.length},end(Z){return Y("end",Z,J.length)},start(Z){return Y("start",Z,J.length)}}}}class q7 extends v6{constructor(J){super(J,"[subtitle-track-controller]");this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(!this.useTextTrackPolling)self.clearInterval(this.subtitlePollingInterval);if(!this.media||!this.hls.config.renderTextTracksNatively)return;let Y=null,Z=_6(this.media.textTracks);for(let X=0;X<Z.length;X++)if(Z[X].mode==="hidden")Y=Z[X];else if(Z[X].mode==="showing"){Y=Z[X];break}let Q=this.findTrackForTextTrack(Y);if(this.subtitleTrack!==Q)this.setSubtitleTrack(Q)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(J){if(this._subtitleDisplay=J,this.trackId>-1)this.toggleTrackModes()}registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.LEVEL_LOADING,this.onLevelLoading,this),J.on($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.on($.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),J.on($.ERROR,this.onError,this)}unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.LEVEL_LOADING,this.onLevelLoading,this),J.off($.LEVEL_SWITCHING,this.onLevelSwitching,this),J.off($.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),J.off($.ERROR,this.onError,this)}onMediaAttached(J,Y){if(this.media=Y.media,!this.media)return;if(this.queuedDefaultTrack>-1)this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1;if(this.useTextTrackPolling=!(this.media.textTracks&&("onchange"in this.media.textTracks)),this.useTextTrackPolling)this.pollTrackChange(500);else this.media.textTracks.addEventListener("change",this.asyncPollTrackChange)}pollTrackChange(J){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,J)}onMediaDetaching(){if(!this.media)return;if(self.clearInterval(this.subtitlePollingInterval),!this.useTextTrackPolling)this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange);if(this.trackId>-1)this.queuedDefaultTrack=this.trackId;_6(this.media.textTracks).forEach((Y)=>{d0(Y)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(J,Y){this.tracks=Y.subtitleTracks}onSubtitleTrackLoaded(J,Y){let{id:Z,groupId:Q,details:X}=Y,q=this.tracksInGroup[Z];if(!q||q.groupId!==Q){this.warn(`Subtitle track with id:${Z} and group:${Q} not found in active group ${q==null?void 0:q.groupId}`);return}let W=q.details;if(q.details=Y.details,this.log(`Subtitle track ${Z} "${q.name}" lang:${q.lang} group:${Q} loaded [${X.startSN}-${X.endSN}]`),Z===this.trackId)this.playlistLoaded(Z,Y,W)}onLevelLoading(J,Y){this.switchLevel(Y.level)}onLevelSwitching(J,Y){this.switchLevel(Y.level)}switchLevel(J){let Y=this.hls.levels[J];if(!Y)return;let Z=Y.subtitleGroups||null,Q=this.groupIds,X=this.currentTrack;if(!Z||(Q==null?void 0:Q.length)!==(Z==null?void 0:Z.length)||Z!=null&&Z.some((q)=>(Q==null?void 0:Q.indexOf(q))===-1)){this.groupIds=Z,this.trackId=-1,this.currentTrack=null;let q=this.tracks.filter((G)=>!Z||Z.indexOf(G.groupId)!==-1);if(q.length){if(this.selectDefaultTrack&&!q.some((G)=>G.default))this.selectDefaultTrack=!1;q.forEach((G,j)=>{G.id=j})}else if(!X&&!this.tracksInGroup.length)return;this.tracksInGroup=q;let W=this.hls.config.subtitlePreference;if(!X&&W){this.selectDefaultTrack=!1;let G=I0(W,q);if(G>-1)X=q[G];else{let j=I0(W,this.tracks);X=this.tracks[j]}}let z=this.findTrackId(X);if(z===-1&&X)z=this.findTrackId(null);let H={subtitleTracks:q};if(this.log(`Updating subtitle tracks, ${q.length} track(s) found in "${Z==null?void 0:Z.join(",")}" group-id`),this.hls.trigger($.SUBTITLE_TRACKS_UPDATED,H),z!==-1&&this.trackId===-1)this.setSubtitleTrack(z)}else if(this.shouldReloadPlaylist(X))this.setSubtitleTrack(this.trackId)}findTrackId(J){let Y=this.tracksInGroup,Z=this.selectDefaultTrack;for(let Q=0;Q<Y.length;Q++){let X=Y[Q];if(Z&&!X.default||!Z&&!J)continue;if(!J||o0(X,J))return Q}if(J){for(let Q=0;Q<Y.length;Q++){let X=Y[Q];if(s0(J.attrs,X.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return Q}for(let Q=0;Q<Y.length;Q++){let X=Y[Q];if(s0(J.attrs,X.attrs,["LANGUAGE"]))return Q}}return-1}findTrackForTextTrack(J){if(J){let Y=this.tracksInGroup;for(let Z=0;Z<Y.length;Z++){let Q=Y[Z];if(FJ(Q,J))return Z}}return-1}onError(J,Y){if(Y.fatal||!Y.context)return;if(Y.context.type===l.SUBTITLE_TRACK&&Y.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(Y.context.groupId)!==-1))this.checkRetry(Y)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(J){this.selectDefaultTrack=!1,this.setSubtitleTrack(J)}setSubtitleOption(J){if(this.hls.config.subtitlePreference=J,J){let Y=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,Y.length){let Z=this.currentTrack;if(Z&&o0(J,Z))return Z;let Q=I0(J,this.tracksInGroup);if(Q>-1){let X=this.tracksInGroup[Q];return this.setSubtitleTrack(Q),X}else if(Z)return null;else{let X=I0(J,Y);if(X>-1)return Y[X]}}}return null}loadPlaylist(J){super.loadPlaylist();let Y=this.currentTrack;if(this.shouldLoadPlaylist(Y)&&Y){let{id:Z,groupId:Q,url:X}=Y;if(J)try{X=J.addDirectives(X)}catch(q){this.warn(`Could not construct new URL with HLS Delivery Directives: ${q}`)}this.log(`Loading subtitle playlist for id ${Z}`),this.hls.trigger($.SUBTITLE_TRACK_LOADING,{url:X,id:Z,groupId:Q,deliveryDirectives:J||null})}}toggleTrackModes(){let{media:J}=this;if(!J)return;let Y=_6(J.textTracks),Z=this.currentTrack,Q;if(Z){if(Q=Y.filter((X)=>FJ(Z,X))[0],!Q)this.warn(`Unable to find subtitle TextTrack with name "${Z.name}" and language "${Z.lang}"`)}if([].slice.call(Y).forEach((X)=>{if(X.mode!=="disabled"&&X!==Q)X.mode="disabled"}),Q){let X=this.subtitleDisplay?"showing":"hidden";if(Q.mode!==X)Q.mode=X}}setSubtitleTrack(J){let Y=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=J;return}if(J<-1||J>=Y.length||!h(J)){this.warn(`Invalid subtitle track id: ${J}`);return}this.clearTimer(),this.selectDefaultTrack=!1;let Z=this.currentTrack,Q=Y[J]||null;if(this.trackId=J,this.currentTrack=Q,this.toggleTrackModes(),!Q){this.hls.trigger($.SUBTITLE_TRACK_SWITCH,{id:J});return}let X=!!Q.details&&!Q.details.live;if(J===this.trackId&&Q===Z&&X)return;this.log(`Switching to subtitle-track ${J}`+(Q?` "${Q.name}" lang:${Q.lang} group:${Q.groupId}`:""));let{id:q,groupId:W="",name:z,type:H,url:G}=Q;this.hls.trigger($.SUBTITLE_TRACK_SWITCH,{id:q,groupId:W,name:z,type:H,url:G});let j=this.switchParams(Q.url,Z==null?void 0:Z.details,Q.details);this.loadPlaylist(j)}}class W7{constructor(J){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=J}append(J,Y,Z){let Q=this.queues[Y];if(Q.push(J),Q.length===1&&!Z)this.executeNext(Y)}insertAbort(J,Y){this.queues[Y].unshift(J),this.executeNext(Y)}appendBlocker(J){let Y,Z=new Promise((X)=>{Y=X}),Q={execute:Y,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(Q,J),Z}executeNext(J){let Y=this.queues[J];if(Y.length){let Z=Y[0];try{Z.execute()}catch(Q){B.warn(`[buffer-operation-queue]: Exception executing "${J}" SourceBuffer operation: ${Q}`),Z.onError(Q);let X=this.buffers[J];if(!(X!=null&&X.updating))this.shiftAndExecuteNext(J)}}}shiftAndExecuteNext(J){this.queues[J].shift(),this.executeNext(J)}current(J){return this.queues[J][0]}}var h8=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class z7{constructor(J){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=(Z)=>{if(!this.hls)return;this.hls.pauseBuffering()},this._onStartStreaming=(Z)=>{if(!this.hls)return;this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{let{media:Z,mediaSource:Q}=this;if(this.log("Media source opened"),Z)Z.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger($.MEDIA_ATTACHED,{media:Z,mediaSource:Q});if(Q)Q.removeEventListener("sourceopen",this._onMediaSourceOpen);this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc:Z,_objectUrl:Q}=this;if(Z!==Q)B.error(`Media element src was set while attaching MediaSource (${Q} > ${Z})`)},this.hls=J;let Y="[buffer-controller]";this.appendSource=xZ(p0(J.config.preferManagedMediaSource)),this.log=B.log.bind(B,Y),this.warn=B.warn.bind(B,Y),this.error=B.error.bind(B,Y),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.BUFFER_RESET,this.onBufferReset,this),J.on($.BUFFER_APPENDING,this.onBufferAppending,this),J.on($.BUFFER_CODECS,this.onBufferCodecs,this),J.on($.BUFFER_EOS,this.onBufferEos,this),J.on($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.on($.LEVEL_UPDATED,this.onLevelUpdated,this),J.on($.FRAG_PARSED,this.onFragParsed,this),J.on($.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.BUFFER_RESET,this.onBufferReset,this),J.off($.BUFFER_APPENDING,this.onBufferAppending,this),J.off($.BUFFER_CODECS,this.onBufferCodecs,this),J.off($.BUFFER_EOS,this.onBufferEos,this),J.off($.BUFFER_FLUSHING,this.onBufferFlushing,this),J.off($.LEVEL_UPDATED,this.onLevelUpdated,this),J.off($.FRAG_PARSED,this.onFragParsed,this),J.off($.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new W7(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(J,Y){let Z=2;if(Y.audio&&!Y.video||!Y.altAudio)Z=1;this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=Z,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(J,Y){let Z=this.media=Y.media,Q=p0(this.appendSource);if(Z&&Q){var X;let q=this.mediaSource=new Q;if(this.log(`created media source: ${(X=q.constructor)==null?void 0:X.name}`),q.addEventListener("sourceopen",this._onMediaSourceOpen),q.addEventListener("sourceended",this._onMediaSourceEnded),q.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource)q.addEventListener("startstreaming",this._onStartStreaming),q.addEventListener("endstreaming",this._onEndStreaming);let W=this._objectUrl=self.URL.createObjectURL(q);if(this.appendSource)try{Z.removeAttribute("src");let z=self.ManagedMediaSource;Z.disableRemotePlayback=Z.disableRemotePlayback||z&&q instanceof z,y8(Z),nQ(Z,W),Z.load()}catch(z){Z.src=W}else Z.src=W;Z.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){let{media:J,mediaSource:Y,_objectUrl:Z}=this;if(Y){if(this.log("media source detaching"),Y.readyState==="open")try{Y.endOfStream()}catch(Q){this.warn(`onMediaDetaching: ${Q.message} while calling endOfStream`)}if(this.onBufferReset(),Y.removeEventListener("sourceopen",this._onMediaSourceOpen),Y.removeEventListener("sourceended",this._onMediaSourceEnded),Y.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource)Y.removeEventListener("startstreaming",this._onStartStreaming),Y.removeEventListener("endstreaming",this._onEndStreaming);if(J){if(J.removeEventListener("emptied",this._onMediaEmptied),Z)self.URL.revokeObjectURL(Z);if(this.mediaSrc===Z){if(J.removeAttribute("src"),this.appendSource)y8(J);J.load()}else this.warn("media|source.src was changed by a third party - skip cleanup")}this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger($.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach((J)=>{this.resetBuffer(J)}),this._initSourceBuffer(),this.hls.resumeBuffering()}resetBuffer(J){let Y=this.sourceBuffer[J];try{if(Y){var Z;if(this.removeBufferListeners(J),this.sourceBuffer[J]=void 0,(Z=this.mediaSource)!=null&&Z.sourceBuffers.length)this.mediaSource.removeSourceBuffer(Y)}}catch(Q){this.warn(`onBufferReset ${J}`,Q)}}onBufferCodecs(J,Y){let Z=this.getSourceBufferTypes().length,Q=Object.keys(Y);if(Q.forEach((q)=>{if(Z){let z=this.tracks[q];if(z&&typeof z.buffer.changeType==="function"){var W;let{id:H,codec:G,levelCodec:j,container:N,metadata:K}=Y[q],V=z8(z.codec,z.levelCodec),U=V==null?void 0:V.replace(h8,"$1"),O=z8(G,j),_=(W=O)==null?void 0:W.replace(h8,"$1");if(O&&U!==_){if(q.slice(0,5)==="audio")O=C6(O,this.appendSource);let A=`${N};codecs=${O}`;this.appendChangeType(q,A),this.log(`switching codec ${V} to ${O}`),this.tracks[q]={buffer:z.buffer,codec:G,container:N,levelCodec:j,metadata:K,id:H}}}}else this.pendingTracks[q]=Y[q]}),Z)return;let X=Math.max(this.bufferCodecEventsExpected-1,0);if(this.bufferCodecEventsExpected!==X)this.log(`${X} bufferCodec event(s) expected ${Q.join(",")}`),this.bufferCodecEventsExpected=X;if(this.mediaSource&&this.mediaSource.readyState==="open")this.checkPendingTracks()}appendChangeType(J,Y){let{operationQueue:Z}=this,Q={execute:()=>{let X=this.sourceBuffer[J];if(X)this.log(`changing ${J} sourceBuffer type to ${Y}`),X.changeType(Y);Z.shiftAndExecuteNext(J)},onStart:()=>{},onComplete:()=>{},onError:(X)=>{this.warn(`Failed to change ${J} SourceBuffer type`,X)}};Z.append(Q,J,!!this.pendingTracks[J])}onBufferAppending(J,Y){let{hls:Z,operationQueue:Q,tracks:X}=this,{data:q,type:W,frag:z,part:H,chunkMeta:G}=Y,j=G.buffering[W],N=self.performance.now();j.start=N;let K=z.stats.buffering,V=H?H.stats.buffering:null;if(K.start===0)K.start=N;if(V&&V.start===0)V.start=N;let U=X.audio,O=!1;if(W==="audio"&&(U==null?void 0:U.container)==="audio/mpeg")O=!this.lastMpegAudioChunk||G.id===1||this.lastMpegAudioChunk.sn!==G.sn,this.lastMpegAudioChunk=G;let _=z.start,A={execute:()=>{if(j.executeStart=self.performance.now(),O){let R=this.sourceBuffer[W];if(R){let E=_-R.timestampOffset;if(Math.abs(E)>=0.1)this.log(`Updating audio SourceBuffer timestampOffset to ${_} (delta: ${E}) sn: ${z.sn})`),R.timestampOffset=_}}this.appendExecutor(q,W)},onStart:()=>{},onComplete:()=>{let R=self.performance.now();if(j.executeEnd=j.end=R,K.first===0)K.first=R;if(V&&V.first===0)V.first=R;let{sourceBuffer:E}=this,F={};for(let P in E)F[P]=a.getBuffered(E[P]);if(this.appendErrors[W]=0,W==="audio"||W==="video")this.appendErrors.audiovideo=0;else this.appendErrors.audio=0,this.appendErrors.video=0;this.hls.trigger($.BUFFER_APPENDED,{type:W,frag:z,part:H,chunkMeta:G,parent:z.type,timeRanges:F})},onError:(R)=>{let E={type:g.MEDIA_ERROR,parent:z.type,details:I.BUFFER_APPEND_ERROR,sourceBufferName:W,frag:z,part:H,chunkMeta:G,error:R,err:R,fatal:!1};if(R.code===DOMException.QUOTA_EXCEEDED_ERR)E.details=I.BUFFER_FULL_ERROR;else{let F=++this.appendErrors[W];if(E.details=I.BUFFER_APPEND_ERROR,this.warn(`Failed ${F}/${Z.config.appendErrorMaxRetry} times to append segment in "${W}" sourceBuffer`),F>=Z.config.appendErrorMaxRetry)E.fatal=!0}Z.trigger($.ERROR,E)}};Q.append(A,W,!!this.pendingTracks[W])}onBufferFlushing(J,Y){let{operationQueue:Z}=this,Q=(X)=>({execute:this.removeExecutor.bind(this,X,Y.startOffset,Y.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger($.BUFFER_FLUSHED,{type:X})},onError:(q)=>{this.warn(`Failed to remove from ${X} SourceBuffer`,q)}});if(Y.type)Z.append(Q(Y.type),Y.type);else this.getSourceBufferTypes().forEach((X)=>{Z.append(Q(X),X)})}onFragParsed(J,Y){let{frag:Z,part:Q}=Y,X=[],q=Q?Q.elementaryStreams:Z.elementaryStreams;if(q[s.AUDIOVIDEO])X.push("audiovideo");else{if(q[s.AUDIO])X.push("audio");if(q[s.VIDEO])X.push("video")}let W=()=>{let z=self.performance.now();if(Z.stats.buffering.end=z,Q)Q.stats.buffering.end=z;let H=Q?Q.stats:Z.stats;this.hls.trigger($.FRAG_BUFFERED,{frag:Z,part:Q,stats:H,id:Z.type})};if(X.length===0)this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${Z.type} level: ${Z.level} sn: ${Z.sn}`);this.blockBuffers(W,X)}onFragChanged(J,Y){this.trimBuffers()}onBufferEos(J,Y){if(this.getSourceBufferTypes().reduce((Q,X)=>{let q=this.sourceBuffer[X];if(q&&(!Y.type||Y.type===X)){if(q.ending=!0,!q.ended)q.ended=!0,this.log(`${X} sourceBuffer now EOS`)}return Q&&!!(!q||q.ended)},!0))this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach((X)=>{let q=this.sourceBuffer[X];if(q)q.ending=!1});let{mediaSource:Q}=this;if(!Q||Q.readyState!=="open"){if(Q)this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${Q.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),Q.endOfStream()})}onLevelUpdated(J,{details:Y}){if(!Y.fragments.length)return;if(this.details=Y,this.getSourceBufferTypes().length)this.blockBuffers(this.updateMediaElementDuration.bind(this));else this.updateMediaElementDuration()}trimBuffers(){let{hls:J,details:Y,media:Z}=this;if(!Z||Y===null)return;if(!this.getSourceBufferTypes().length)return;let X=J.config,q=Z.currentTime,W=Y.levelTargetDuration,z=Y.live&&X.liveBackBufferLength!==null?X.liveBackBufferLength:X.backBufferLength;if(h(z)&&z>0){let H=Math.max(z,W),G=Math.floor(q/W)*W-H;this.flushBackBuffer(q,W,G)}if(h(X.frontBufferFlushThreshold)&&X.frontBufferFlushThreshold>0){let H=Math.max(X.maxBufferLength,X.frontBufferFlushThreshold),G=Math.max(H,W),j=Math.floor(q/W)*W+G;this.flushFrontBuffer(q,W,j)}}flushBackBuffer(J,Y,Z){let{details:Q,sourceBuffer:X}=this;this.getSourceBufferTypes().forEach((W)=>{let z=X[W];if(z){let H=a.getBuffered(z);if(H.length>0&&Z>H.start(0)){if(this.hls.trigger($.BACK_BUFFER_REACHED,{bufferEnd:Z}),Q!=null&&Q.live)this.hls.trigger($.LIVE_BACK_BUFFER_REACHED,{bufferEnd:Z});else if(z.ended&&H.end(H.length-1)-J<Y*2){this.log(`Cannot flush ${W} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger($.BUFFER_FLUSHING,{startOffset:0,endOffset:Z,type:W})}}})}flushFrontBuffer(J,Y,Z){let{sourceBuffer:Q}=this;this.getSourceBufferTypes().forEach((q)=>{let W=Q[q];if(W){let z=a.getBuffered(W),H=z.length;if(H<2)return;let G=z.start(H-1),j=z.end(H-1);if(Z>G||J>=G&&J<=j)return;else if(W.ended&&J-j<2*Y){this.log(`Cannot flush ${q} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger($.BUFFER_FLUSHING,{startOffset:G,endOffset:1/0,type:q})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;let{details:J,hls:Y,media:Z,mediaSource:Q}=this,X=J.fragments[0].start+J.totalduration,q=Z.duration,W=h(Q.duration)?Q.duration:0;if(J.live&&Y.config.liveDurationInfinity)Q.duration=1/0,this.updateSeekableRange(J);else if(X>W&&X>q||!h(q))this.log(`Updating Media Source duration to ${X.toFixed(3)}`),Q.duration=X}updateSeekableRange(J){let Y=this.mediaSource,Z=J.fragments;if(Z.length&&J.live&&Y!=null&&Y.setLiveSeekableRange){let X=Math.max(0,Z[0].start),q=Math.max(X,X+J.totalduration);this.log(`Media Source duration is set to ${Y.duration}. Setting seekable range to ${X}-${q}.`),Y.setLiveSeekableRange(X,q)}}checkPendingTracks(){let{bufferCodecEventsExpected:J,operationQueue:Y,pendingTracks:Z}=this,Q=Object.keys(Z).length;if(Q&&(!J||Q===2||("audiovideo"in Z))){this.createSourceBuffers(Z),this.pendingTracks={};let X=this.getSourceBufferTypes();if(X.length)this.hls.trigger($.BUFFER_CREATED,{tracks:this.tracks}),X.forEach((q)=>{Y.executeNext(q)});else{let q=new Error("could not create source buffer for media codec(s)");this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:q,reason:q.message})}}}createSourceBuffers(J){let{sourceBuffer:Y,mediaSource:Z}=this;if(!Z)throw Error("createSourceBuffers called when mediaSource was null");for(let X in J)if(!Y[X]){var Q;let q=J[X];if(!q)throw Error(`source buffer exists for track ${X}, however track does not`);let W=((Q=q.levelCodec)==null?void 0:Q.indexOf(","))===-1?q.levelCodec:q.codec;if(W){if(X.slice(0,5)==="audio")W=C6(W,this.appendSource)}let z=`${q.container};codecs=${W}`;this.log(`creating sourceBuffer(${z})`);try{let H=Y[X]=Z.addSourceBuffer(z),G=X;if(this.addBufferListener(G,"updatestart",this._onSBUpdateStart),this.addBufferListener(G,"updateend",this._onSBUpdateEnd),this.addBufferListener(G,"error",this._onSBUpdateError),this.appendSource)this.addBufferListener(G,"bufferedchange",(j,N)=>{let K=N.removedRanges;if(K!=null&&K.length)this.hls.trigger($.BUFFER_FLUSHED,{type:X})});this.tracks[X]={buffer:H,codec:W,container:q.container,levelCodec:q.levelCodec,metadata:q.metadata,id:q.id}}catch(H){this.error(`error while trying to add sourceBuffer: ${H.message}`),this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:H,sourceBufferName:X,mimeType:z})}}}get mediaSrc(){var J,Y;let Z=((J=this.media)==null?void 0:(Y=J.querySelector)==null?void 0:Y.call(J,"source"))||this.media;return Z==null?void 0:Z.src}_onSBUpdateStart(J){let{operationQueue:Y}=this;Y.current(J).onStart()}_onSBUpdateEnd(J){var Y;if(((Y=this.mediaSource)==null?void 0:Y.readyState)==="closed"){this.resetBuffer(J);return}let{operationQueue:Z}=this;Z.current(J).onComplete(),Z.shiftAndExecuteNext(J)}_onSBUpdateError(J,Y){var Z;let Q=new Error(`${J} SourceBuffer error. MediaSource readyState: ${(Z=this.mediaSource)==null?void 0:Z.readyState}`);this.error(`${Q}`,Y),this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_APPENDING_ERROR,sourceBufferName:J,error:Q,fatal:!1});let X=this.operationQueue.current(J);if(X)X.onError(Q)}removeExecutor(J,Y,Z){let{media:Q,mediaSource:X,operationQueue:q,sourceBuffer:W}=this,z=W[J];if(!Q||!X||!z){this.warn(`Attempting to remove from the ${J} SourceBuffer, but it does not exist`),q.shiftAndExecuteNext(J);return}let H=h(Q.duration)?Q.duration:1/0,G=h(X.duration)?X.duration:1/0,j=Math.max(0,Y),N=Math.min(Z,H,G);if(N>j&&(!z.ending||z.ended))z.ended=!1,this.log(`Removing [${j},${N}] from the ${J} SourceBuffer`),z.remove(j,N);else q.shiftAndExecuteNext(J)}appendExecutor(J,Y){let Z=this.sourceBuffer[Y];if(!Z){if(!this.pendingTracks[Y])throw new Error(`Attempting to append to the ${Y} SourceBuffer, but it does not exist`);return}Z.ended=!1,Z.appendBuffer(J)}blockBuffers(J,Y=this.getSourceBufferTypes()){if(!Y.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(J);return}let{operationQueue:Z}=this,Q=Y.map((X)=>Z.appendBlocker(X));Promise.all(Q).then(()=>{J(),Y.forEach((X)=>{let q=this.sourceBuffer[X];if(!(q!=null&&q.updating))Z.shiftAndExecuteNext(X)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(J,Y,Z){let Q=this.sourceBuffer[J];if(!Q)return;let X=Z.bind(this,J);this.listeners[J].push({event:Y,listener:X}),Q.addEventListener(Y,X)}removeBufferListeners(J){let Y=this.sourceBuffer[J];if(!Y)return;this.listeners[J].forEach((Z)=>{Y.removeEventListener(Z.event,Z.listener)})}}function y8(J){let Y=J.querySelectorAll("source");[].slice.call(Y).forEach((Z)=>{J.removeChild(Z)})}function nQ(J,Y){let Z=self.document.createElement("source");Z.type="video/mp4",Z.src=Y,J.appendChild(Z)}var iQ={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},H7=(J)=>String.fromCharCode(iQ[J]||J),_0=15,C0=100,sQ={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},rQ={17:2,18:4,21:6,22:8,23:10,19:13,20:15},aQ={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},tQ={25:2,26:4,29:6,30:8,31:10,27:13,28:15},eQ=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class G7{constructor(){this.time=null,this.verboseLevel=0}log(J,Y){if(this.verboseLevel>=J){let Z=typeof Y==="function"?Y():Y;B.log(`${this.time} [${J}] ${Z}`)}}}var S0=function J(Y){let Z=[];for(let Q=0;Q<Y.length;Q++)Z.push(Y[Q].toString(16));return Z};class dJ{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(J){let Y=["foreground","underline","italics","background","flash"];for(let Z=0;Z<Y.length;Z++){let Q=Y[Z];if(J.hasOwnProperty(Q))this[Q]=J[Q]}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(J){return this.foreground===J.foreground&&this.underline===J.underline&&this.italics===J.italics&&this.background===J.background&&this.flash===J.flash}copy(J){this.foreground=J.foreground,this.underline=J.underline,this.italics=J.italics,this.background=J.background,this.flash=J.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class j7{constructor(){this.uchar=" ",this.penState=new dJ}reset(){this.uchar=" ",this.penState.reset()}setChar(J,Y){this.uchar=J,this.penState.copy(Y)}setPenState(J){this.penState.copy(J)}equals(J){return this.uchar===J.uchar&&this.penState.equals(J.penState)}copy(J){this.uchar=J.uchar,this.penState.copy(J.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class N7{constructor(J){this.chars=[],this.pos=0,this.currPenState=new dJ,this.cueStartTime=null,this.logger=void 0;for(let Y=0;Y<C0;Y++)this.chars.push(new j7);this.logger=J}equals(J){for(let Y=0;Y<C0;Y++)if(!this.chars[Y].equals(J.chars[Y]))return!1;return!0}copy(J){for(let Y=0;Y<C0;Y++)this.chars[Y].copy(J.chars[Y])}isEmpty(){let J=!0;for(let Y=0;Y<C0;Y++)if(!this.chars[Y].isEmpty()){J=!1;break}return J}setCursor(J){if(this.pos!==J)this.pos=J;if(this.pos<0)this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0;else if(this.pos>C0)this.logger.log(3,"Too large cursor position "+this.pos),this.pos=C0}moveCursor(J){let Y=this.pos+J;if(J>1)for(let Z=this.pos+1;Z<Y+1;Z++)this.chars[Z].setPenState(this.currPenState);this.setCursor(Y)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(J){if(J>=144)this.backSpace();let Y=H7(J);if(this.pos>=C0){this.logger.log(0,()=>"Cannot insert "+J.toString(16)+" ("+Y+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(Y,this.currPenState),this.moveCursor(1)}clearFromPos(J){let Y;for(Y=J;Y<C0;Y++)this.chars[Y].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){let J=[],Y=!0;for(let Z=0;Z<C0;Z++){let Q=this.chars[Z].uchar;if(Q!==" ")Y=!1;J.push(Q)}if(Y)return"";else return J.join("")}setPenStyles(J){this.currPenState.setStyles(J),this.chars[this.pos].setPenState(this.currPenState)}}class F6{constructor(J){this.rows=[],this.currRow=_0-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let Y=0;Y<_0;Y++)this.rows.push(new N7(J));this.logger=J}reset(){for(let J=0;J<_0;J++)this.rows[J].clear();this.currRow=_0-1}equals(J){let Y=!0;for(let Z=0;Z<_0;Z++)if(!this.rows[Z].equals(J.rows[Z])){Y=!1;break}return Y}copy(J){for(let Y=0;Y<_0;Y++)this.rows[Y].copy(J.rows[Y])}isEmpty(){let J=!0;for(let Y=0;Y<_0;Y++)if(!this.rows[Y].isEmpty()){J=!1;break}return J}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(J){this.rows[this.currRow].insertChar(J)}setPen(J){this.rows[this.currRow].setPenStyles(J)}moveCursor(J){this.rows[this.currRow].moveCursor(J)}setCursor(J){this.logger.log(2,"setCursor: "+J),this.rows[this.currRow].setCursor(J)}setPAC(J){this.logger.log(2,()=>"pacData = "+JSON.stringify(J));let Y=J.row-1;if(this.nrRollUpRows&&Y<this.nrRollUpRows-1)Y=this.nrRollUpRows-1;if(this.nrRollUpRows&&this.currRow!==Y){for(let W=0;W<_0;W++)this.rows[W].clear();let X=this.currRow+1-this.nrRollUpRows,q=this.lastOutputScreen;if(q){let W=q.rows[X].cueStartTime,z=this.logger.time;if(W!==null&&z!==null&&W<z)for(let H=0;H<this.nrRollUpRows;H++)this.rows[Y-this.nrRollUpRows+H+1].copy(q.rows[X+H])}}this.currRow=Y;let Z=this.rows[this.currRow];if(J.indent!==null){let X=J.indent,q=Math.max(X-1,0);Z.setCursor(J.indent),J.color=Z.chars[q].penState.foreground}let Q={foreground:J.color,underline:J.underline,italics:J.italics,background:"black",flash:!1};this.setPen(Q)}setBkgData(J){this.logger.log(2,()=>"bkgData = "+JSON.stringify(J)),this.backSpace(),this.setPen(J),this.insertChar(32)}setRollUpRows(J){this.nrRollUpRows=J}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());let J=this.currRow+1-this.nrRollUpRows,Y=this.rows.splice(J,1)[0];Y.clear(),this.rows.splice(this.currRow,0,Y),this.logger.log(2,"Rolling up")}getDisplayText(J){J=J||!1;let Y=[],Z="",Q=-1;for(let X=0;X<_0;X++){let q=this.rows[X].getTextString();if(q)if(Q=X+1,J)Y.push("Row "+Q+": '"+q+"'");else Y.push(q.trim())}if(Y.length>0)if(J)Z="["+Y.join(" | ")+"]";else Z=Y.join(`
`);return Z}getTextAndFormat(){return this.rows}}class EJ{constructor(J,Y,Z){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=J,this.outputFilter=Y,this.mode=null,this.verbose=0,this.displayedMemory=new F6(Z),this.nonDisplayedMemory=new F6(Z),this.lastOutputScreen=new F6(Z),this.currRollUpRow=this.displayedMemory.rows[_0-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=Z}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[_0-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(J){this.outputFilter=J}setPAC(J){this.writeScreen.setPAC(J)}setBkgData(J){this.writeScreen.setBkgData(J)}setMode(J){if(J===this.mode)return;if(this.mode=J,this.logger.log(2,()=>"MODE="+J),this.mode==="MODE_POP-ON")this.writeScreen=this.nonDisplayedMemory;else this.writeScreen=this.displayedMemory,this.writeScreen.reset();if(this.mode!=="MODE_ROLL-UP")this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null;this.mode=J}insertChars(J){for(let Z=0;Z<J.length;Z++)this.writeScreen.insertChar(J[Z]);let Y=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";if(this.logger.log(2,()=>Y+": "+this.writeScreen.getDisplayText(!0)),this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate()}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){if(this.logger.log(2,"BS - BackSpace"),this.mode==="MODE_TEXT")return;if(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory)this.outputDataUpdate()}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(J){this.logger.log(2,"RU("+J+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(J)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){let J=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=J,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(J){this.logger.log(2,"TO("+J+") - Tab Offset"),this.writeScreen.moveCursor(J)}ccMIDROW(J){let Y={flash:!1};if(Y.underline=J%2===1,Y.italics=J>=46,!Y.italics){let Z=Math.floor(J/2)-16,Q=["white","green","blue","cyan","red","yellow","magenta"];Y.foreground=Q[Z]}else Y.foreground="white";this.logger.log(2,"MIDROW: "+JSON.stringify(Y)),this.writeScreen.setPen(Y)}outputDataUpdate(J=!1){let Y=this.logger.time;if(Y===null)return;if(this.outputFilter){if(this.cueStartTime===null&&!this.displayedMemory.isEmpty())this.cueStartTime=Y;else if(!this.displayedMemory.equals(this.lastOutputScreen)){if(this.outputFilter.newCue(this.cueStartTime,Y,this.lastOutputScreen),J&&this.outputFilter.dispatchCue)this.outputFilter.dispatchCue();this.cueStartTime=this.displayedMemory.isEmpty()?null:Y}this.lastOutputScreen.copy(this.displayedMemory)}}cueSplitAtTime(J){if(this.outputFilter){if(!this.displayedMemory.isEmpty()){if(this.outputFilter.newCue)this.outputFilter.newCue(this.cueStartTime,J,this.displayedMemory);this.cueStartTime=J}}}}class IJ{constructor(J,Y,Z){this.channels=void 0,this.currentChannel=0,this.cmdHistory=Y9(),this.logger=void 0;let Q=this.logger=new G7;this.channels=[null,new EJ(J,Y,Q),new EJ(J+1,Z,Q)]}getHandler(J){return this.channels[J].getHandler()}setHandler(J,Y){this.channels[J].setHandler(Y)}addData(J,Y){this.logger.time=J;for(let Z=0;Z<Y.length;Z+=2){let Q=Y[Z]&127,X=Y[Z+1]&127,q=!1,W=null;if(Q===0&&X===0)continue;else this.logger.log(3,()=>"["+S0([Y[Z],Y[Z+1]])+"] -> ("+S0([Q,X])+")");let z=this.cmdHistory;if(Q>=16&&Q<=31){if(J9(Q,X,z)){K6(null,null,z),this.logger.log(3,()=>"Repeated command ("+S0([Q,X])+") is dropped");continue}if(K6(Q,X,this.cmdHistory),q=this.parseCmd(Q,X),!q)q=this.parseMidrow(Q,X);if(!q)q=this.parsePAC(Q,X);if(!q)q=this.parseBackgroundAttributes(Q,X)}else K6(null,null,z);if(!q){if(W=this.parseChars(Q,X),W){let G=this.currentChannel;if(G&&G>0)this.channels[G].insertChars(W);else this.logger.log(2,"No channel found yet. TEXT-MODE?")}}if(!q&&!W)this.logger.log(2,()=>"Couldn't parse cleaned data "+S0([Q,X])+" orig: "+S0([Y[Z],Y[Z+1]]))}}parseCmd(J,Y){let Z=(J===20||J===28||J===21||J===29)&&Y>=32&&Y<=47,Q=(J===23||J===31)&&Y>=33&&Y<=35;if(!(Z||Q))return!1;let X=J===20||J===21||J===23?1:2,q=this.channels[X];if(J===20||J===21||J===28||J===29){if(Y===32)q.ccRCL();else if(Y===33)q.ccBS();else if(Y===34)q.ccAOF();else if(Y===35)q.ccAON();else if(Y===36)q.ccDER();else if(Y===37)q.ccRU(2);else if(Y===38)q.ccRU(3);else if(Y===39)q.ccRU(4);else if(Y===40)q.ccFON();else if(Y===41)q.ccRDC();else if(Y===42)q.ccTR();else if(Y===43)q.ccRTD();else if(Y===44)q.ccEDM();else if(Y===45)q.ccCR();else if(Y===46)q.ccENM();else if(Y===47)q.ccEOC()}else q.ccTO(Y-32);return this.currentChannel=X,!0}parseMidrow(J,Y){let Z=0;if((J===17||J===25)&&Y>=32&&Y<=47){if(J===17)Z=1;else Z=2;if(Z!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;let Q=this.channels[Z];if(!Q)return!1;return Q.ccMIDROW(Y),this.logger.log(3,()=>"MIDROW ("+S0([J,Y])+")"),!0}return!1}parsePAC(J,Y){let Z,Q=(J>=17&&J<=23||J>=25&&J<=31)&&Y>=64&&Y<=127,X=(J===16||J===24)&&Y>=64&&Y<=95;if(!(Q||X))return!1;let q=J<=23?1:2;if(Y>=64&&Y<=95)Z=q===1?sQ[J]:aQ[J];else Z=q===1?rQ[J]:tQ[J];let W=this.channels[q];if(!W)return!1;return W.setPAC(this.interpretPAC(Z,Y)),this.currentChannel=q,!0}interpretPAC(J,Y){let Z,Q={color:null,italics:!1,indent:null,underline:!1,row:J};if(Y>95)Z=Y-96;else Z=Y-64;if(Q.underline=(Z&1)===1,Z<=13)Q.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(Z/2)];else if(Z<=15)Q.italics=!0,Q.color="white";else Q.indent=Math.floor((Z-16)/2)*4;return Q}parseChars(J,Y){let Z,Q=null,X=null;if(J>=25)Z=2,X=J-8;else Z=1,X=J;if(X>=17&&X<=19){let q;if(X===17)q=Y+80;else if(X===18)q=Y+112;else q=Y+144;this.logger.log(2,()=>"Special char '"+H7(q)+"' in channel "+Z),Q=[q]}else if(J>=32&&J<=127)Q=Y===0?[J]:[J,Y];if(Q)this.logger.log(3,()=>"Char codes =  "+S0(Q).join(","));return Q}parseBackgroundAttributes(J,Y){let Z=(J===16||J===24)&&Y>=32&&Y<=47,Q=(J===23||J===31)&&Y>=45&&Y<=47;if(!(Z||Q))return!1;let X,q={};if(J===16||J===24){if(X=Math.floor((Y-32)/2),q.background=eQ[X],Y%2===1)q.background=q.background+"_semi"}else if(Y===45)q.background="transparent";else if(q.foreground="black",Y===47)q.underline=!0;let W=J<=23?1:2;return this.channels[W].setBkgData(q),!0}reset(){for(let J=0;J<Object.keys(this.channels).length;J++){let Y=this.channels[J];if(Y)Y.reset()}K6(null,null,this.cmdHistory)}cueSplitAtTime(J){for(let Y=0;Y<this.channels.length;Y++){let Z=this.channels[Y];if(Z)Z.cueSplitAtTime(J)}}}function K6(J,Y,Z){Z.a=J,Z.b=Y}function J9(J,Y,Z){return Z.a===J&&Z.b===Y}function Y9(){return{a:null,b:null}}class e0{constructor(J,Y){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=J,this.trackName=Y}dispatchCue(){if(this.startTime===null)return;this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null}newCue(J,Y,Z){if(this.startTime===null||this.startTime>J)this.startTime=J;this.endTime=Y,this.screen=Z,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var lJ=function(){if(i0!=null&&i0.VTTCue)return self.VTTCue;let J=["","lr","rl"],Y=["start","middle","end","left","right"];function Z(z,H){if(typeof H!=="string")return!1;if(!Array.isArray(z))return!1;let G=H.toLowerCase();if(~z.indexOf(G))return G;return!1}function Q(z){return Z(J,z)}function X(z){return Z(Y,z)}function q(z,...H){let G=1;for(;G<arguments.length;G++){let j=arguments[G];for(let N in j)z[N]=j[N]}return z}function W(z,H,G){let j=this,N={enumerable:!0};j.hasBeenReset=!1;let K="",V=!1,U=z,O=H,_=G,A=null,R="",E=!0,F="auto",P="start",w=50,b="middle",x=50,D="middle";Object.defineProperty(j,"id",q({},N,{get:function(){return K},set:function(L){K=""+L}})),Object.defineProperty(j,"pauseOnExit",q({},N,{get:function(){return V},set:function(L){V=!!L}})),Object.defineProperty(j,"startTime",q({},N,{get:function(){return U},set:function(L){if(typeof L!=="number")throw new TypeError("Start time must be set to a number.");U=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"endTime",q({},N,{get:function(){return O},set:function(L){if(typeof L!=="number")throw new TypeError("End time must be set to a number.");O=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"text",q({},N,{get:function(){return _},set:function(L){_=""+L,this.hasBeenReset=!0}})),Object.defineProperty(j,"region",q({},N,{get:function(){return A},set:function(L){A=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"vertical",q({},N,{get:function(){return R},set:function(L){let k=Q(L);if(k===!1)throw new SyntaxError("An invalid or illegal string was specified.");R=k,this.hasBeenReset=!0}})),Object.defineProperty(j,"snapToLines",q({},N,{get:function(){return E},set:function(L){E=!!L,this.hasBeenReset=!0}})),Object.defineProperty(j,"line",q({},N,{get:function(){return F},set:function(L){if(typeof L!=="number"&&L!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");F=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"lineAlign",q({},N,{get:function(){return P},set:function(L){let k=X(L);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");P=k,this.hasBeenReset=!0}})),Object.defineProperty(j,"position",q({},N,{get:function(){return w},set:function(L){if(L<0||L>100)throw new Error("Position must be between 0 and 100.");w=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"positionAlign",q({},N,{get:function(){return b},set:function(L){let k=X(L);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");b=k,this.hasBeenReset=!0}})),Object.defineProperty(j,"size",q({},N,{get:function(){return x},set:function(L){if(L<0||L>100)throw new Error("Size must be between 0 and 100.");x=L,this.hasBeenReset=!0}})),Object.defineProperty(j,"align",q({},N,{get:function(){return D},set:function(L){let k=X(L);if(!k)throw new SyntaxError("An invalid or illegal string was specified.");D=k,this.hasBeenReset=!0}})),j.displayState=void 0}return W.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},W}();class K7{decode(J,Y){if(!J)return"";if(typeof J!=="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(J))}}function V7(J){function Y(Q,X,q,W){return(Q|0)*3600+(X|0)*60+(q|0)+parseFloat(W||0)}let Z=J.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);if(!Z)return null;if(parseFloat(Z[2])>59)return Y(Z[2],Z[3],0,Z[4]);return Y(Z[1],Z[2],Z[3],Z[4])}class U7{constructor(){this.values=Object.create(null)}set(J,Y){if(!this.get(J)&&Y!=="")this.values[J]=Y}get(J,Y,Z){if(Z)return this.has(J)?this.values[J]:Y[Z];return this.has(J)?this.values[J]:Y}has(J){return J in this.values}alt(J,Y,Z){for(let Q=0;Q<Z.length;++Q)if(Y===Z[Q]){this.set(J,Y);break}}integer(J,Y){if(/^-?\d+$/.test(Y))this.set(J,parseInt(Y,10))}percent(J,Y){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(Y)){let Z=parseFloat(Y);if(Z>=0&&Z<=100)return this.set(J,Z),!0}return!1}}function $7(J,Y,Z,Q){let X=Q?J.split(Q):[J];for(let q in X){if(typeof X[q]!=="string")continue;let W=X[q].split(Z);if(W.length!==2)continue;let z=W[0],H=W[1];Y(z,H)}}var wJ=new lJ(0,0,""),V6=wJ.align==="middle"?"middle":"center";function Z9(J,Y,Z){let Q=J;function X(){let z=V7(J);if(z===null)throw new Error("Malformed timestamp: "+Q);return J=J.replace(/^[^\sa-zA-Z-]+/,""),z}function q(z,H){let G=new U7;$7(z,function(K,V){let U;switch(K){case"region":for(let O=Z.length-1;O>=0;O--)if(Z[O].id===V){G.set(K,Z[O].region);break}break;case"vertical":G.alt(K,V,["rl","lr"]);break;case"line":if(U=V.split(","),G.integer(K,U[0]),G.percent(K,U[0]))G.set("snapToLines",!1);if(G.alt(K,U[0],["auto"]),U.length===2)G.alt("lineAlign",U[1],["start",V6,"end"]);break;case"position":if(U=V.split(","),G.percent(K,U[0]),U.length===2)G.alt("positionAlign",U[1],["start",V6,"end","line-left","line-right","auto"]);break;case"size":G.percent(K,V);break;case"align":G.alt(K,V,["start",V6,"end","left","right"]);break}},/:/,/\s/),H.region=G.get("region",null),H.vertical=G.get("vertical","");let j=G.get("line","auto");if(j==="auto"&&wJ.line===-1)j=-1;H.line=j,H.lineAlign=G.get("lineAlign","start"),H.snapToLines=G.get("snapToLines",!0),H.size=G.get("size",100),H.align=G.get("align",V6);let N=G.get("position","auto");if(N==="auto"&&wJ.position===50)N=H.align==="start"||H.align==="left"?0:H.align==="end"||H.align==="right"?100:50;H.position=N}function W(){J=J.replace(/^\s+/,"")}if(W(),Y.startTime=X(),W(),J.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+Q);J=J.slice(3),W(),Y.endTime=X(),W(),q(J,Y)}function O7(J){return J.replace(/<br(?: \/)?>/gi,`
`)}class _7{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new K7,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(J){let Y=this;if(J)Y.buffer+=Y.decoder.decode(J,{stream:!0});function Z(){let X=Y.buffer,q=0;X=O7(X);while(q<X.length&&X[q]!=="\r"&&X[q]!==`
`)++q;let W=X.slice(0,q);if(X[q]==="\r")++q;if(X[q]===`
`)++q;return Y.buffer=X.slice(q),W}function Q(X){$7(X,function(q,W){},/:/)}try{let X="";if(Y.state==="INITIAL"){if(!/\r\n|\n/.test(Y.buffer))return this;X=Z();let W=X.match(/^()?WEBVTT([ \t].*)?$/);if(!(W!=null&&W[0]))throw new Error("Malformed WebVTT signature.");Y.state="HEADER"}let q=!1;while(Y.buffer){if(!/\r\n|\n/.test(Y.buffer))return this;if(!q)X=Z();else q=!1;switch(Y.state){case"HEADER":if(/:/.test(X))Q(X);else if(!X)Y.state="ID";continue;case"NOTE":if(!X)Y.state="ID";continue;case"ID":if(/^NOTE($|[ \t])/.test(X)){Y.state="NOTE";break}if(!X)continue;if(Y.cue=new lJ(0,0,""),Y.state="CUE",X.indexOf("-->")===-1){Y.cue.id=X;continue}case"CUE":if(!Y.cue){Y.state="BADCUE";continue}try{Z9(X,Y.cue,Y.regionList)}catch(W){Y.cue=null,Y.state="BADCUE";continue}Y.state="CUETEXT";continue;case"CUETEXT":{let W=X.indexOf("-->")!==-1;if(!X||W&&(q=!0)){if(Y.oncue&&Y.cue)Y.oncue(Y.cue);Y.cue=null,Y.state="ID";continue}if(Y.cue===null)continue;if(Y.cue.text)Y.cue.text+=`
`;Y.cue.text+=X}continue;case"BADCUE":if(!X)Y.state="ID"}}}catch(X){if(Y.state==="CUETEXT"&&Y.cue&&Y.oncue)Y.oncue(Y.cue);Y.cue=null,Y.state=Y.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){let J=this;try{if(J.cue||J.state==="HEADER")J.buffer+=`

`,J.parse();if(J.state==="INITIAL"||J.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(Y){if(J.onparsingerror)J.onparsingerror(Y)}if(J.onflush)J.onflush();return this}}var Q9=/\r\n|\n\r|\n|\r/g,YJ=function J(Y,Z,Q=0){return Y.slice(Q,Q+Z.length)===Z},X9=function J(Y){let Z=parseInt(Y.slice(-3)),Q=parseInt(Y.slice(-6,-4)),X=parseInt(Y.slice(-9,-7)),q=Y.length>9?parseInt(Y.substring(0,Y.indexOf(":"))):0;if(!h(Z)||!h(Q)||!h(X)||!h(q))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${Y}`);return Z+=1000*Q,Z+=60000*X,Z+=3600000*q,Z},ZJ=function J(Y){let Z=5381,Q=Y.length;while(Q)Z=Z*33^Y.charCodeAt(--Q);return(Z>>>0).toString()};function oJ(J,Y,Z){return ZJ(J.toString())+ZJ(Y.toString())+ZJ(Z)}var q9=function J(Y,Z,Q){let X=Y[Z],q=Y[X.prevCC];if(!q||!q.new&&X.new){Y.ccOffset=Y.presentationOffset=X.start,X.new=!1;return}while((W=q)!=null&&W.new){var W;Y.ccOffset+=X.start-q.start,X.new=!1,X=q,q=Y[X.prevCC]}Y.presentationOffset=Q};function W9(J,Y,Z,Q,X,q,W){let z=new _7,H=w0(new Uint8Array(J)).trim().replace(Q9,`
`).split(`
`),G=[],j=Y?mQ(Y.baseTime,Y.timescale):0,N="00:00.000",K=0,V=0,U,O=!0;z.oncue=function(_){let A=Z[Q],R=Z.ccOffset,E=(K-j)/90000;if(A!=null&&A.new)if(V!==void 0)R=Z.ccOffset=A.start;else q9(Z,Q,E);if(E){if(!Y){U=new Error("Missing initPTS for VTT MPEGTS");return}R=E-Z.presentationOffset}let F=_.endTime-_.startTime,P=U0((_.startTime+R-V)*90000,X*90000)/90000;_.startTime=Math.max(P,0),_.endTime=Math.max(P+F,0);let w=_.text.trim();if(_.text=decodeURIComponent(encodeURIComponent(w)),!_.id)_.id=oJ(_.startTime,_.endTime,w);if(_.endTime>0)G.push(_)},z.onparsingerror=function(_){U=_},z.onflush=function(){if(U){W(U);return}q(G)},H.forEach((_)=>{if(O){if(YJ(_,"X-TIMESTAMP-MAP=")){O=!1,_.slice(16).split(",").forEach((A)=>{if(YJ(A,"LOCAL:"))N=A.slice(6);else if(YJ(A,"MPEGTS:"))K=parseInt(A.slice(7))});try{V=X9(N)/1000}catch(A){U=A}return}else if(_==="")O=!1}z.parse(_+`
`)}),z.flush()}var QJ="stpp.ttml.im1t",A7=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,B7=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,z9={left:"start",center:"center",right:"end",start:"start",end:"end"};function k8(J,Y,Z,Q){let X=c(new Uint8Array(J),["mdat"]);if(X.length===0){Q(new Error("Could not parse IMSC1 mdat"));return}let q=X.map((z)=>w0(z)),W=pQ(Y.baseTime,1,Y.timescale);try{q.forEach((z)=>Z(H9(z,W)))}catch(z){Q(z)}}function H9(J,Y){let X=new DOMParser().parseFromString(J,"text/xml").getElementsByTagName("tt")[0];if(!X)throw new Error("Invalid ttml");let q={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},W=Object.keys(q).reduce((N,K)=>{return N[K]=X.getAttribute(`ttp:${K}`)||q[K],N},{}),z=X.getAttribute("xml:space")!=="preserve",H=v8(XJ(X,"styling","style")),G=v8(XJ(X,"layout","region")),j=XJ(X,"body","[begin]");return[].map.call(j,(N)=>{let K=R7(N,z);if(!K||!N.hasAttribute("begin"))return null;let V=WJ(N.getAttribute("begin"),W),U=WJ(N.getAttribute("dur"),W),O=WJ(N.getAttribute("end"),W);if(V===null)throw p8(N);if(O===null){if(U===null)throw p8(N);O=V+U}let _=new lJ(V-Y,O-Y,K);_.id=oJ(_.startTime,_.endTime,_.text);let A=G[N.getAttribute("region")],R=H[N.getAttribute("style")],E=G9(A,R,H),{textAlign:F}=E;if(F){let P=z9[F];if(P)_.lineAlign=P;_.align=F}return Y0(_,E),_}).filter((N)=>N!==null)}function XJ(J,Y,Z){let Q=J.getElementsByTagName(Y)[0];if(Q)return[].slice.call(Q.querySelectorAll(Z));return[]}function v8(J){return J.reduce((Y,Z)=>{let Q=Z.getAttribute("xml:id");if(Q)Y[Q]=Z;return Y},{})}function R7(J,Y){return[].slice.call(J.childNodes).reduce((Z,Q,X)=>{var q;if(Q.nodeName==="br"&&X)return Z+`
`;if((q=Q.childNodes)!=null&&q.length)return R7(Q,Y);else if(Y)return Z+Q.textContent.trim().replace(/\s+/g," ");return Z+Q.textContent},"")}function G9(J,Y,Z){let X=null,q=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],W=J!=null&&J.hasAttribute("style")?J.getAttribute("style"):null;if(W&&Z.hasOwnProperty(W))X=Z[W];return q.reduce((z,H)=>{let G=qJ(Y,"http://www.w3.org/ns/ttml#styling",H)||qJ(J,"http://www.w3.org/ns/ttml#styling",H)||qJ(X,"http://www.w3.org/ns/ttml#styling",H);if(G)z[H]=G;return z},{})}function qJ(J,Y,Z){if(!J)return null;return J.hasAttributeNS(Y,Z)?J.getAttributeNS(Y,Z):null}function p8(J){return new Error(`Could not parse ttml timestamp ${J}`)}function WJ(J,Y){if(!J)return null;let Z=V7(J);if(Z===null){if(A7.test(J))Z=j9(J,Y);else if(B7.test(J))Z=N9(J,Y)}return Z}function j9(J,Y){let Z=A7.exec(J),Q=(Z[4]|0)+(Z[5]|0)/Y.subFrameRate;return(Z[1]|0)*3600+(Z[2]|0)*60+(Z[3]|0)+Q/Y.frameRate}function N9(J,Y){let Z=B7.exec(J),Q=Number(Z[1]);switch(Z[2]){case"h":return Q*3600;case"m":return Q*60;case"ms":return Q*1000;case"f":return Q/Y.frameRate;case"t":return Q/Y.tickRate}return Q}class M7{constructor(J){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=g8(),this.captionsProperties=void 0,this.hls=J,this.config=J.config,this.Cues=J.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},J.on($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_LOADED,this.onManifestLoaded,this),J.on($.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),J.on($.FRAG_LOADING,this.onFragLoading,this),J.on($.FRAG_LOADED,this.onFragLoaded,this),J.on($.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),J.on($.FRAG_DECRYPTED,this.onFragDecrypted,this),J.on($.INIT_PTS_FOUND,this.onInitPtsFound,this),J.on($.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),J.on($.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){let{hls:J}=this;J.off($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_LOADED,this.onManifestLoaded,this),J.off($.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),J.off($.FRAG_LOADING,this.onFragLoading,this),J.off($.FRAG_LOADED,this.onFragLoaded,this),J.off($.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),J.off($.FRAG_DECRYPTED,this.onFragDecrypted,this),J.off($.INIT_PTS_FOUND,this.onInitPtsFound,this),J.off($.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),J.off($.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){let J=new e0(this,"textTrack1"),Y=new e0(this,"textTrack2"),Z=new e0(this,"textTrack3"),Q=new e0(this,"textTrack4");this.cea608Parser1=new IJ(1,J,Y),this.cea608Parser2=new IJ(3,Z,Q)}}addCues(J,Y,Z,Q,X){let q=!1;for(let W=X.length;W--;){let z=X[W],H=K9(z[0],z[1],Y,Z);if(H>=0){if(z[0]=Math.min(z[0],Y),z[1]=Math.max(z[1],Z),q=!0,H/(Z-Y)>0.5)return}}if(!q)X.push([Y,Z]);if(this.config.renderTextTracksNatively){let W=this.captionsTracks[J];this.Cues.newCue(W,Y,Z,Q)}else{let W=this.Cues.newCue(null,Y,Z,Q);this.hls.trigger($.CUES_PARSED,{type:"captions",cues:W,track:J})}}onInitPtsFound(J,{frag:Y,id:Z,initPTS:Q,timescale:X}){let{unparsedVttFrags:q}=this;if(Z==="main")this.initPTS[Y.cc]={baseTime:Q,timescale:X};if(q.length)this.unparsedVttFrags=[],q.forEach((W)=>{this.onFragLoaded($.FRAG_LOADED,W)})}getExistingTrack(J,Y){let{media:Z}=this;if(Z)for(let Q=0;Q<Z.textTracks.length;Q++){let X=Z.textTracks[Q];if(m8(X,{name:J,lang:Y,attrs:{}}))return X}return null}createCaptionsTrack(J){if(this.config.renderTextTracksNatively)this.createNativeTrack(J);else this.createNonNativeTrack(J)}createNativeTrack(J){if(this.captionsTracks[J])return;let{captionsProperties:Y,captionsTracks:Z,media:Q}=this,{label:X,languageCode:q}=Y[J],W=this.getExistingTrack(X,q);if(!W){let z=this.createTextTrack("captions",X,q);if(z)z[J]=!0,Z[J]=z}else Z[J]=W,d0(Z[J]),GY(Z[J],Q)}createNonNativeTrack(J){if(this.nonNativeCaptionsTracks[J])return;let Y=this.captionsProperties[J];if(!Y)return;let Z=Y.label,Q={_id:J,label:Z,kind:"captions",default:Y.media?!!Y.media.default:!1,closedCaptions:Y.media};this.nonNativeCaptionsTracks[J]=Q,this.hls.trigger($.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[Q]})}createTextTrack(J,Y,Z){let Q=this.media;if(!Q)return;return Q.addTextTrack(J,Y,Z)}onMediaAttaching(J,Y){this.media=Y.media,this._cleanTracks()}onMediaDetaching(){let{captionsTracks:J}=this;Object.keys(J).forEach((Y)=>{d0(J[Y]),delete J[Y]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){if(this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=g8(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2)this.cea608Parser1.reset(),this.cea608Parser2.reset()}_cleanTracks(){let{media:J}=this;if(!J)return;let Y=J.textTracks;if(Y)for(let Z=0;Z<Y.length;Z++)d0(Y[Z])}onSubtitleTracksUpdated(J,Y){let Z=Y.subtitleTracks||[],Q=Z.some((X)=>X.textCodec===QJ);if(this.config.enableWebVTT||Q&&this.config.enableIMSC1){if(J7(this.tracks,Z)){this.tracks=Z;return}if(this.textTracks=[],this.tracks=Z,this.config.renderTextTracksNatively){let q=this.media,W=q?_6(q.textTracks):null;if(this.tracks.forEach((z,H)=>{let G;if(W){let j=null;for(let N=0;N<W.length;N++)if(W[N]&&m8(W[N],z)){j=W[N],W[N]=null;break}if(j)G=j}if(G)d0(G);else{let j=F7(z);if(G=this.createTextTrack(j,z.name,z.lang),G)G.mode="disabled"}if(G)this.textTracks.push(G)}),W!=null&&W.length){let z=W.filter((H)=>H!==null).map((H)=>H.label);if(z.length)B.warn(`Media element contains unused subtitle tracks: ${z.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){let q=this.tracks.map((W)=>{return{label:W.name,kind:W.type.toLowerCase(),default:W.default,subtitleTrack:W}});this.hls.trigger($.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:q})}}}onManifestLoaded(J,Y){if(this.config.enableCEA708Captions&&Y.captions)Y.captions.forEach((Z)=>{let Q=/(?:CC|SERVICE)([1-4])/.exec(Z.instreamId);if(!Q)return;let X=`textTrack${Q[1]}`,q=this.captionsProperties[X];if(!q)return;if(q.label=Z.name,Z.lang)q.languageCode=Z.lang;q.media=Z})}closedCaptionsForLevel(J){let Y=this.hls.levels[J.level];return Y==null?void 0:Y.attrs["CLOSED-CAPTIONS"]}onFragLoading(J,Y){if(this.enabled&&Y.frag.type===m.MAIN){var Z,Q;let{cea608Parser1:X,cea608Parser2:q,lastSn:W}=this,{cc:z,sn:H}=Y.frag,G=(Z=(Q=Y.part)==null?void 0:Q.index)!=null?Z:-1;if(X&&q){if(H!==W+1||H===W&&G!==this.lastPartIndex+1||z!==this.lastCc)X.reset(),q.reset()}this.lastCc=z,this.lastSn=H,this.lastPartIndex=G}}onFragLoaded(J,Y){let{frag:Z,payload:Q}=Y;if(Z.type===m.SUBTITLE)if(Q.byteLength){let X=Z.decryptdata,q="stats"in Y;if(X==null||!X.encrypted||q){let W=this.tracks[Z.level],z=this.vttCCs;if(!z[Z.cc])z[Z.cc]={start:Z.start,prevCC:this.prevCC,new:!0},this.prevCC=Z.cc;if(W&&W.textCodec===QJ)this._parseIMSC1(Z,Q);else this._parseVTTs(Y)}}else this.hls.trigger($.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:Z,error:new Error("Empty subtitle payload")})}_parseIMSC1(J,Y){let Z=this.hls;k8(Y,this.initPTS[J.cc],(Q)=>{this._appendCues(Q,J.level),Z.trigger($.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:J})},(Q)=>{B.log(`Failed to parse IMSC1: ${Q}`),Z.trigger($.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:J,error:Q})})}_parseVTTs(J){var Y;let{frag:Z,payload:Q}=J,{initPTS:X,unparsedVttFrags:q}=this,W=X.length-1;if(!X[Z.cc]&&W===-1){q.push(J);return}let z=this.hls,H=(Y=Z.initSegment)!=null&&Y.data?$0(Z.initSegment.data,new Uint8Array(Q)):Q;W9(H,this.initPTS[Z.cc],this.vttCCs,Z.cc,Z.start,(G)=>{this._appendCues(G,Z.level),z.trigger($.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:Z})},(G)=>{let j=G.message==="Missing initPTS for VTT MPEGTS";if(j)q.push(J);else this._fallbackToIMSC1(Z,Q);if(B.log(`Failed to parse VTT cue: ${G}`),j&&W>Z.cc)return;z.trigger($.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:Z,error:G})})}_fallbackToIMSC1(J,Y){let Z=this.tracks[J.level];if(!Z.textCodec)k8(Y,this.initPTS[J.cc],()=>{Z.textCodec=QJ,this._parseIMSC1(J,Y)},()=>{Z.textCodec="wvtt"})}_appendCues(J,Y){let Z=this.hls;if(this.config.renderTextTracksNatively){let Q=this.textTracks[Y];if(!Q||Q.mode==="disabled")return;J.forEach((X)=>jY(Q,X))}else{let Q=this.tracks[Y];if(!Q)return;let X=Q.default?"default":"subtitles"+Y;Z.trigger($.CUES_PARSED,{type:"subtitles",cues:J,track:X})}}onFragDecrypted(J,Y){let{frag:Z}=Y;if(Z.type===m.SUBTITLE)this.onFragLoaded($.FRAG_LOADED,Y)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(J,Y){this.initCea608Parsers();let{cea608Parser1:Z,cea608Parser2:Q}=this;if(!this.enabled||!Z||!Q)return;let{frag:X,samples:q}=Y;if(X.type===m.MAIN&&this.closedCaptionsForLevel(X)==="NONE")return;for(let W=0;W<q.length;W++){let z=q[W].bytes;if(z){let H=this.extractCea608Data(z);Z.addData(q[W].pts,H[0]),Q.addData(q[W].pts,H[1])}}}onBufferFlushing(J,{startOffset:Y,endOffset:Z,endOffsetSubtitles:Q,type:X}){let{media:q}=this;if(!q||q.currentTime<Z)return;if(!X||X==="video"){let{captionsTracks:W}=this;Object.keys(W).forEach((z)=>NJ(W[z],Y,Z))}if(this.config.renderTextTracksNatively){if(Y===0&&Q!==void 0){let{textTracks:W}=this;Object.keys(W).forEach((z)=>NJ(W[z],Y,Q))}}}extractCea608Data(J){let Y=[[],[]],Z=J[0]&31,Q=2;for(let X=0;X<Z;X++){let q=J[Q++],W=127&J[Q++],z=127&J[Q++];if(W===0&&z===0)continue;if((4&q)!==0){let G=3&q;if(G===0||G===1)Y[G].push(W),Y[G].push(z)}}return Y}}function F7(J){if(J.characteristics){if(/transcribes-spoken-dialog/gi.test(J.characteristics)&&/describes-music-and-sound/gi.test(J.characteristics))return"captions"}return"subtitles"}function m8(J,Y){return!!J&&J.kind===F7(Y)&&FJ(Y,J)}function K9(J,Y,Z,Q){return Math.min(Y,Q)-Math.max(J,Z)}function g8(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class nJ{constructor(J){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=J,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(J){this.streamController=J}destroy(){if(this.hls)this.unregisterListener();if(this.timer)this.stopCapping();this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls:J}=this;J.on($.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),J.on($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.on($.BUFFER_CODECS,this.onBufferCodecs,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls:J}=this;J.off($.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),J.off($.MEDIA_ATTACHING,this.onMediaAttaching,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.off($.BUFFER_CODECS,this.onBufferCodecs,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(J,Y){let Z=this.hls.levels[Y.droppedLevel];if(this.isLevelAllowed(Z))this.restrictedLevels.push({bitrate:Z.bitrate,height:Z.height,width:Z.width})}onMediaAttaching(J,Y){if(this.media=Y.media instanceof HTMLVideoElement?Y.media:null,this.clientRect=null,this.timer&&this.hls.levels.length)this.detectPlayerSize()}onManifestParsed(J,Y){let Z=this.hls;if(this.restrictedLevels=[],this.firstLevel=Y.firstLevel,Z.config.capLevelToPlayerSize&&Y.video)this.startCapping()}onLevelsUpdated(J,Y){if(this.timer&&h(this.autoLevelCapping))this.detectPlayerSize()}onBufferCodecs(J,Y){if(this.hls.config.capLevelToPlayerSize&&Y.video)this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let J=this.hls.levels;if(J.length){let Y=this.hls,Z=this.getMaxLevel(J.length-1);if(Z!==this.autoLevelCapping)B.log(`Setting autoLevelCapping to ${Z}: ${J[Z].height}p@${J[Z].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`);if(Y.autoLevelCapping=Z,Y.autoLevelCapping>this.autoLevelCapping&&this.streamController)this.streamController.nextLevelSwitch();this.autoLevelCapping=Y.autoLevelCapping}}}getMaxLevel(J){let Y=this.hls.levels;if(!Y.length)return-1;let Z=Y.filter((Q,X)=>this.isLevelAllowed(Q)&&X<=J);return this.clientRect=null,nJ.getMaxLevelByMediaSize(Z,this.mediaWidth,this.mediaHeight)}startCapping(){if(this.timer)return;this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1000),this.detectPlayerSize()}stopCapping(){if(this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer)self.clearInterval(this.timer),this.timer=void 0}getDimensions(){if(this.clientRect)return this.clientRect;let J=this.media,Y={width:0,height:0};if(J){let Z=J.getBoundingClientRect();if(Y.width=Z.width,Y.height=Z.height,!Y.width&&!Y.height)Y.width=Z.right-Z.left||J.width||0,Y.height=Z.bottom-Z.top||J.height||0}return this.clientRect=Y,Y}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let J=1;if(!this.hls.config.ignoreDevicePixelRatio)try{J=self.devicePixelRatio}catch(Y){}return J}isLevelAllowed(J){return!this.restrictedLevels.some((Z)=>{return J.bitrate===Z.bitrate&&J.width===Z.width&&J.height===Z.height})}static getMaxLevelByMediaSize(J,Y,Z){if(!(J!=null&&J.length))return-1;let Q=(W,z)=>{if(!z)return!0;return W.width!==z.width||W.height!==z.height},X=J.length-1,q=Math.max(Y,Z);for(let W=0;W<J.length;W+=1){let z=J[W];if((z.width>=q||z.height>=q)&&Q(z,J[W+1])){X=W;break}}return X}}class E7{constructor(J){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=J,this.registerListeners()}setStreamController(J){this.streamController=J}registerListeners(){this.hls.on($.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off($.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){if(this.timer)clearInterval(this.timer);this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(J,Y){let Z=this.hls.config;if(Z.capLevelOnFPSDrop){let Q=Y.media instanceof self.HTMLVideoElement?Y.media:null;if(this.media=Q,Q&&typeof Q.getVideoPlaybackQuality==="function")this.isVideoPlaybackQualityAvailable=!0;self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),Z.fpsDroppedMonitoringPeriod)}}checkFPS(J,Y,Z){let Q=performance.now();if(Y){if(this.lastTime){let X=Q-this.lastTime,q=Z-this.lastDroppedFrames,W=Y-this.lastDecodedFrames,z=1000*q/X,H=this.hls;if(H.trigger($.FPS_DROP,{currentDropped:q,currentDecoded:W,totalDroppedFrames:Z}),z>0){if(q>H.config.fpsDroppedMonitoringThreshold*W){let G=H.currentLevel;if(B.warn("drop FPS ratio greater than max allowed value for currentLevel: "+G),G>0&&(H.autoLevelCapping===-1||H.autoLevelCapping>=G))G=G-1,H.trigger($.FPS_DROP_LEVEL_CAPPING,{level:G,droppedLevel:H.currentLevel}),H.autoLevelCapping=G,this.streamController.nextLevelSwitch()}}}this.lastTime=Q,this.lastDroppedFrames=Z,this.lastDecodedFrames=Y}}checkFPSInterval(){let J=this.media;if(J)if(this.isVideoPlaybackQualityAvailable){let Y=J.getVideoPlaybackQuality();this.checkFPS(J,Y.totalVideoFrames,Y.droppedVideoFrames)}else this.checkFPS(J,J.webkitDecodedFrameCount,J.webkitDroppedFrameCount)}}var U6="[eme]";class n0{constructor(J){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=n0.CDMCleanupPromise?[n0.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=B.debug.bind(B,U6),this.log=B.log.bind(B,U6),this.warn=B.warn.bind(B,U6),this.error=B.error.bind(B,U6),this.hls=J,this.config=J.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();let J=this.config;J.requestMediaKeySystemAccessFunc=null,J.licenseXhrSetup=J.licenseResponseCallback=void 0,J.drmSystems=J.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on($.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on($.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on($.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on($.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off($.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off($.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off($.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off($.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(J){let{drmSystems:Y,widevineLicenseUrl:Z}=this.config,Q=Y[J];if(Q)return Q.licenseUrl;if(J===t.WIDEVINE&&Z)return Z;throw new Error(`no license server URL configured for key-system "${J}"`)}getServerCertificateUrl(J){let{drmSystems:Y}=this.config,Z=Y[J];if(Z)return Z.serverCertificateUrl;else this.log(`No Server Certificate in config.drmSystems["${J}"]`)}attemptKeySystemAccess(J){let Y=this.hls.levels,Z=(q,W,z)=>!!q&&z.indexOf(q)===W,Q=Y.map((q)=>q.audioCodec).filter(Z),X=Y.map((q)=>q.videoCodec).filter(Z);if(Q.length+X.length===0)X.push("avc1.42e01e");return new Promise((q,W)=>{let z=(H)=>{let G=H.shift();this.getMediaKeysPromise(G,Q,X).then((j)=>q({keySystem:G,mediaKeys:j})).catch((j)=>{if(H.length)z(H);else if(j instanceof V0)W(j);else W(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_NO_ACCESS,error:j,fatal:!0},j.message))})};z(J)})}requestMediaKeySystemAccess(J,Y){let{requestMediaKeySystemAccessFunc:Z}=this.config;if(typeof Z!=="function"){let Q=`Configured requestMediaKeySystemAccess is not a function ${Z}`;if(s8===null&&self.location.protocol==="http:")Q=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`;return Promise.reject(new Error(Q))}return Z(J,Y)}getMediaKeysPromise(J,Y,Z){let Q=YZ(J,Y,Z,this.config.drmSystemOptions),X=this.keySystemAccessPromises[J],q=X==null?void 0:X.keySystemAccess;if(!q){this.log(`Requesting encrypted media "${J}" key-system access with config: ${JSON.stringify(Q)}`),q=this.requestMediaKeySystemAccess(J,Q);let W=this.keySystemAccessPromises[J]={keySystemAccess:q};return q.catch((z)=>{this.log(`Failed to obtain access to key-system "${J}": ${z}`)}),q.then((z)=>{this.log(`Access for key-system "${z.keySystem}" obtained`);let H=this.fetchServerCertificate(J);return this.log(`Create media-keys for "${J}"`),W.mediaKeys=z.createMediaKeys().then((G)=>{return this.log(`Media-keys created for "${J}"`),H.then((j)=>{if(j)return this.setMediaKeysServerCertificate(G,J,j);return G})}),W.mediaKeys.catch((G)=>{this.error(`Failed to create media-keys for "${J}"}: ${G}`)}),W.mediaKeys})}return q.then(()=>X.mediaKeys)}createMediaKeySessionContext({decryptdata:J,keySystem:Y,mediaKeys:Z}){this.log(`Creating key-system session "${Y}" keyId: ${R0.hexDump(J.keyId||[])}`);let Q=Z.createSession(),X={decryptdata:J,keySystem:Y,mediaKeys:Z,mediaKeysSession:Q,keyStatus:"status-pending"};return this.mediaKeySessions.push(X),X}renewKeySession(J){let Y=J.decryptdata;if(Y.pssh){let Z=this.createMediaKeySessionContext(J),Q=this.getKeyIdString(Y),X="cenc";this.keyIdToKeySessionPromise[Q]=this.generateRequestWithPreferredKeySession(Z,"cenc",Y.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(J)}getKeyIdString(J){if(!J)throw new Error("Could not read keyId of undefined decryptdata");if(J.keyId===null)throw new Error("keyId is null");return R0.hexDump(J.keyId)}updateKeySession(J,Y){var Z;let Q=J.mediaKeysSession;return this.log(`Updating key-session "${Q.sessionId}" for keyID ${R0.hexDump(((Z=J.decryptdata)==null?void 0:Z.keyId)||[])}
      } (data length: ${Y?Y.byteLength:Y})`),Q.update(Y)}selectKeySystemFormat(J){let Y=Object.keys(J.levelkeys||{});if(!this.keyFormatPromise)this.log(`Selecting key-system from fragment (sn: ${J.sn} ${J.type}: ${J.level}) key formats ${Y.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(Y);return this.keyFormatPromise}getKeyFormatPromise(J){return new Promise((Y,Z)=>{let Q=c6(this.config),X=J.map(eJ).filter((q)=>!!q&&Q.indexOf(q)!==-1);return this.getKeySystemSelectionPromise(X).then(({keySystem:q})=>{let W=Y8(q);if(W)Y(W);else Z(new Error(`Unable to find format for key-system "${q}"`))}).catch(Z)})}loadKey(J){let Y=J.keyInfo.decryptdata,Z=this.getKeyIdString(Y),Q=`(keyId: ${Z} format: "${Y.keyFormat}" method: ${Y.method} uri: ${Y.uri})`;this.log(`Starting session for key ${Q}`);let X=this.keyIdToKeySessionPromise[Z];if(!X)X=this.keyIdToKeySessionPromise[Z]=this.getKeySystemForKeyPromise(Y).then(({keySystem:q,mediaKeys:W})=>{return this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${J.frag.sn} ${J.frag.type}: ${J.frag.level} using key ${Q}`),this.attemptSetMediaKeys(q,W).then(()=>{this.throwIfDestroyed();let z=this.createMediaKeySessionContext({keySystem:q,mediaKeys:W,decryptdata:Y}),H="cenc";return this.generateRequestWithPreferredKeySession(z,H,Y.pssh,"playlist-key")})}),X.catch((q)=>this.handleError(q));return X}throwIfDestroyed(J="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(J){if(!this.hls)return;if(this.error(J.message),J instanceof V0)this.hls.trigger($.ERROR,J.data);else this.hls.trigger($.ERROR,{type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_NO_KEYS,error:J,fatal:!0})}getKeySystemForKeyPromise(J){let Y=this.getKeyIdString(J),Z=this.keyIdToKeySessionPromise[Y];if(!Z){let Q=eJ(J.keyFormat),X=Q?[Q]:c6(this.config);return this.attemptKeySystemAccess(X)}return Z}getKeySystemSelectionPromise(J){if(!J.length)J=c6(this.config);if(J.length===0)throw new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(J)}_onMediaEncrypted(J){let{initDataType:Y,initData:Z}=J,Q=`"${J.type}" event: init data type: "${Y}"`;if(this.debug(Q),Z===null)return;let X,q;if(Y==="sinf"&&this.config.drmSystems[t.FAIRPLAY]){let j=Z0(new Uint8Array(Z));try{let N=hJ(JSON.parse(j).sinf),K=QY(new Uint8Array(N));if(!K)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");X=K.subarray(8,24),q=t.FAIRPLAY}catch(N){this.warn(`${Q} Failed to parse sinf: ${N}`);return}}else{let j=LZ(Z),N=j.filter((K)=>K.systemId===t0.WIDEVINE)[0];if(!N){if(j.length===0||j.some((K)=>!K.systemId))this.warn(`${Q} contains incomplete or invalid pssh data`);else this.log(`ignoring ${Q} for ${j.map((K)=>J8(K.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(q=J8(N.systemId),N.version===0&&N.data){let K=N.data.length-22;X=N.data.subarray(K,K+16)}}if(!q||!X)return;let W=R0.hexDump(X),{keyIdToKeySessionPromise:z,mediaKeySessions:H}=this,G=z[W];for(let j=0;j<H.length;j++){let N=H[j],K=N.decryptdata;if(!K.keyId)continue;let V=R0.hexDump(K.keyId);if(W===V||K.uri.replace(/-/g,"").indexOf(W)!==-1){if(G=z[V],K.pssh)break;delete z[V],K.pssh=new Uint8Array(Z),K.keyId=X,G=z[W]=G.then(()=>{return this.generateRequestWithPreferredKeySession(N,Y,Z,"encrypted-event-key-match")});break}}if(!G)G=z[W]=this.getKeySystemSelectionPromise([q]).then(({keySystem:j,mediaKeys:N})=>{var K;this.throwIfDestroyed();let V=new Q6("ISO-23001-7",W,(K=Y8(j))!=null?K:"");return V.pssh=new Uint8Array(Z),V.keyId=X,this.attemptSetMediaKeys(j,N).then(()=>{this.throwIfDestroyed();let U=this.createMediaKeySessionContext({decryptdata:V,keySystem:j,mediaKeys:N});return this.generateRequestWithPreferredKeySession(U,Y,Z,"encrypted-event-no-match")})});G.catch((j)=>this.handleError(j))}_onWaitingForKey(J){this.log(`"${J.type}" event`)}attemptSetMediaKeys(J,Y){let Z=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${J}"`);let Q=Promise.all(Z).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(Y)});return this.setMediaKeysQueue.push(Q),Q.then(()=>{this.log(`Media-keys set for "${J}"`),Z.push(Q),this.setMediaKeysQueue=this.setMediaKeysQueue.filter((X)=>Z.indexOf(X)===-1)})}generateRequestWithPreferredKeySession(J,Y,Z,Q){var X,q;let W=(X=this.config.drmSystems)==null?void 0:(q=X[J.keySystem])==null?void 0:q.generateRequest;if(W)try{let V=W.call(this.hls,Y,Z,J);if(!V)throw new Error("Invalid response from configured generateRequest filter");Y=V.initDataType,Z=J.decryptdata.pssh=V.initData?new Uint8Array(V.initData):null}catch(V){var z;if(this.warn(V.message),(z=this.hls)!=null&&z.config.debug)throw V}if(Z===null)return this.log(`Skipping key-session request for "${Q}" (no initData)`),Promise.resolve(J);let H=this.getKeyIdString(J.decryptdata);this.log(`Generating key-session request for "${Q}": ${H} (init data type: ${Y} length: ${Z?Z.byteLength:null})`);let G=new fJ,j=J._onmessage=(V)=>{let U=J.mediaKeysSession;if(!U){G.emit("error",new Error("invalid state"));return}let{messageType:O,message:_}=V;if(this.log(`"${O}" message event for session "${U.sessionId}" message size: ${_.byteLength}`),O==="license-request"||O==="license-renewal")this.renewLicense(J,_).catch((A)=>{this.handleError(A),G.emit("error",A)});else if(O==="license-release"){if(J.keySystem===t.FAIRPLAY)this.updateKeySession(J,GJ("acknowledged")),this.removeSession(J)}else this.warn(`unhandled media key message type "${O}"`)},N=J._onkeystatuseschange=(V)=>{if(!J.mediaKeysSession){G.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(J);let O=J.keyStatus;if(G.emit("keyStatus",O),O==="expired")this.warn(`${J.keySystem} expired for key ${H}`),this.renewKeySession(J)};J.mediaKeysSession.addEventListener("message",j),J.mediaKeysSession.addEventListener("keystatuseschange",N);let K=new Promise((V,U)=>{G.on("error",U),G.on("keyStatus",(O)=>{if(O.startsWith("usable"))V();else if(O==="output-restricted")U(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted"));else if(O==="internal-error")U(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${O}"`));else if(O==="expired")U(new Error("key expired while generating request"));else this.warn(`unhandled key status change "${O}"`)})});return J.mediaKeysSession.generateRequest(Y,Z).then(()=>{var V;this.log(`Request generated for key-session "${(V=J.mediaKeysSession)==null?void 0:V.sessionId}" keyId: ${H}`)}).catch((V)=>{throw new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_NO_SESSION,error:V,fatal:!1},`Error generating key-session request: ${V}`)}).then(()=>K).catch((V)=>{throw G.removeAllListeners(),this.removeSession(J),V}).then(()=>{return G.removeAllListeners(),J})}onKeyStatusChange(J){J.mediaKeysSession.keyStatuses.forEach((Y,Z)=>{this.log(`key status change "${Y}" for keyStatuses keyId: ${R0.hexDump("buffer"in Z?new Uint8Array(Z.buffer,Z.byteOffset,Z.byteLength):new Uint8Array(Z))} session keyId: ${R0.hexDump(new Uint8Array(J.decryptdata.keyId||[]))} uri: ${J.decryptdata.uri}`),J.keyStatus=Y})}fetchServerCertificate(J){let Y=this.config,Q=new Y.loader(Y),X=this.getServerCertificateUrl(J);if(!X)return Promise.resolve();return this.log(`Fetching server certificate for "${J}"`),new Promise((q,W)=>{let z={responseType:"arraybuffer",url:X},H=Y.certLoadPolicy.default,G={loadPolicy:H,timeout:H.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},j={onSuccess:(N,K,V,U)=>{q(N.data)},onError:(N,K,V,U)=>{W(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:V,response:z0({url:z.url,data:void 0},N)},`"${J}" certificate request failed (${X}). Status: ${N.code} (${N.text})`))},onTimeout:(N,K,V)=>{W(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:V,response:{url:z.url,data:void 0}},`"${J}" certificate request timed out (${X})`))},onAbort:(N,K,V)=>{W(new Error("aborted"))}};Q.load(z,G,j)})}setMediaKeysServerCertificate(J,Y,Z){return new Promise((Q,X)=>{J.setServerCertificate(Z).then((q)=>{this.log(`setServerCertificate ${q?"success":"not supported by CDM"} (${Z==null?void 0:Z.byteLength}) on "${Y}"`),Q(J)}).catch((q)=>{X(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:q,fatal:!0},q.message))})})}renewLicense(J,Y){return this.requestLicense(J,new Uint8Array(Y)).then((Z)=>{return this.updateKeySession(J,new Uint8Array(Z)).catch((Q)=>{throw new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:Q,fatal:!0},Q.message)})})}unpackPlayReadyKeyMessage(J,Y){let Z=String.fromCharCode.apply(null,new Uint16Array(Y.buffer));if(!Z.includes("PlayReadyKeyMessage"))return J.setRequestHeader("Content-Type","text/xml; charset=utf-8"),Y;let Q=new DOMParser().parseFromString(Z,"application/xml"),X=Q.querySelectorAll("HttpHeader");if(X.length>0){let G;for(let j=0,N=X.length;j<N;j++){var q,W;G=X[j];let K=(q=G.querySelector("name"))==null?void 0:q.textContent,V=(W=G.querySelector("value"))==null?void 0:W.textContent;if(K&&V)J.setRequestHeader(K,V)}}let z=Q.querySelector("Challenge"),H=z==null?void 0:z.textContent;if(!H)throw new Error("Cannot find <Challenge> in key message");return GJ(atob(H))}setupLicenseXHR(J,Y,Z,Q){let X=this.config.licenseXhrSetup;if(!X)return J.open("POST",Y,!0),Promise.resolve({xhr:J,licenseChallenge:Q});return Promise.resolve().then(()=>{if(!Z.decryptdata)throw new Error("Key removed");return X.call(this.hls,J,Y,Z,Q)}).catch((q)=>{if(!Z.decryptdata)throw q;return J.open("POST",Y,!0),X.call(this.hls,J,Y,Z,Q)}).then((q)=>{if(!J.readyState)J.open("POST",Y,!0);return{xhr:J,licenseChallenge:q?q:Q}})}requestLicense(J,Y){let Z=this.config.keyLoadPolicy.default;return new Promise((Q,X)=>{let q=this.getLicenseServerUrl(J.keySystem);this.log(`Sending license request to URL: ${q}`);let W=new XMLHttpRequest;if(W.responseType="arraybuffer",W.onreadystatechange=()=>{if(!this.hls||!J.mediaKeysSession)return X(new Error("invalid state"));if(W.readyState===4)if(W.status===200){this._requestLicenseFailureCount=0;let z=W.response;this.log(`License received ${z instanceof ArrayBuffer?z.byteLength:z}`);let H=this.config.licenseResponseCallback;if(H)try{z=H.call(this.hls,W,q,J)}catch(G){this.error(G)}Q(z)}else{let z=Z.errorRetry,H=z?z.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>H||W.status>=400&&W.status<500)X(new V0({type:g.KEY_SYSTEM_ERROR,details:I.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:W,response:{url:q,data:void 0,code:W.status,text:W.statusText}},`License Request XHR failed (${q}). Status: ${W.status} (${W.statusText})`));else{let G=H-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${G} attempts left`),this.requestLicense(J,Y).then(Q,X)}}},J.licenseXhr&&J.licenseXhr.readyState!==XMLHttpRequest.DONE)J.licenseXhr.abort();J.licenseXhr=W,this.setupLicenseXHR(W,q,J,Y).then(({xhr:z,licenseChallenge:H})=>{if(J.keySystem==t.PLAYREADY)H=this.unpackPlayReadyKeyMessage(z,H);z.send(H)})})}onMediaAttached(J,Y){if(!this.config.emeEnabled)return;let Z=Y.media;this.media=Z,Z.addEventListener("encrypted",this.onMediaEncrypted),Z.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){let J=this.media,Y=this.mediaKeySessions;if(J)J.removeEventListener("encrypted",this.onMediaEncrypted),J.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null;this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},Q6.clearKeyUriToKeyIdMap();let Z=Y.length;n0.CDMCleanupPromise=Promise.all(Y.map((Q)=>this.removeSession(Q)).concat(J==null?void 0:J.setMediaKeys(null).catch((Q)=>{this.log(`Could not clear media keys: ${Q}`)}))).then(()=>{if(Z)this.log("finished closing key sessions and clearing media keys"),Y.length=0}).catch((Q)=>{this.log(`Could not close sessions and clear media keys: ${Q}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(J,{sessionKeys:Y}){if(!Y||!this.config.emeEnabled)return;if(!this.keyFormatPromise){let Z=Y.reduce((Q,X)=>{if(Q.indexOf(X.keyFormat)===-1)Q.push(X.keyFormat);return Q},[]);this.log(`Selecting key-system from session-keys ${Z.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(Z)}}removeSession(J){let{mediaKeysSession:Y,licenseXhr:Z}=J;if(Y){if(this.log(`Remove licenses and keys and close session ${Y.sessionId}`),J._onmessage)Y.removeEventListener("message",J._onmessage),J._onmessage=void 0;if(J._onkeystatuseschange)Y.removeEventListener("keystatuseschange",J._onkeystatuseschange),J._onkeystatuseschange=void 0;if(Z&&Z.readyState!==XMLHttpRequest.DONE)Z.abort();J.mediaKeysSession=J.decryptdata=J.licenseXhr=void 0;let Q=this.mediaKeySessions.indexOf(J);if(Q>-1)this.mediaKeySessions.splice(Q,1);return Y.remove().catch((X)=>{this.log(`Could not remove session: ${X}`)}).then(()=>{return Y.close()}).catch((X)=>{this.log(`Could not close session: ${X}`)})}}}n0.CDMCleanupPromise=void 0;class V0 extends Error{constructor(J,Y){super(Y);this.data=void 0,J.error||(J.error=new Error(Y)),this.data=J,J.err=J.error}}var G0;(function(J){J.MANIFEST="m",J.AUDIO="a",J.VIDEO="v",J.MUXED="av",J.INIT="i",J.CAPTION="c",J.TIMED_TEXT="tt",J.KEY="k",J.OTHER="o"})(G0||(G0={}));var LJ;(function(J){J.DASH="d",J.HLS="h",J.SMOOTH="s",J.OTHER="o"})(LJ||(LJ={}));var k0;(function(J){J.OBJECT="CMCD-Object",J.REQUEST="CMCD-Request",J.SESSION="CMCD-Session",J.STATUS="CMCD-Status"})(k0||(k0={}));var V9={[k0.OBJECT]:["br","d","ot","tb"],[k0.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[k0.SESSION]:["cid","pr","sf","sid","st","v"],[k0.STATUS]:["bs","rtp"]};class r0{constructor(J,Y){if(this.value=void 0,this.params=void 0,Array.isArray(J))J=J.map((Z)=>Z instanceof r0?Z:new r0(Z));this.value=J,this.params=Y}}class iJ{constructor(J){this.description=void 0,this.description=J}}var U9="Dict";function $9(J){if(Array.isArray(J))return JSON.stringify(J);if(J instanceof Map)return"Map{}";if(J instanceof Set)return"Set{}";if(typeof J==="object")return JSON.stringify(J);return String(J)}function O9(J,Y,Z,Q){return new Error(`failed to ${J} "${$9(Y)}" as ${Z}`,{cause:Q})}var u8="Bare Item",_9="Boolean",A9="Byte Sequence",B9="Decimal",R9="Integer";function M9(J){return J<-999999999999999||999999999999999<J}var F9=/[\x00-\x1f\x7f]+/,E9="Token",I9="Key";function L0(J,Y,Z){return O9("serialize",J,Y,Z)}function w9(J){if(typeof J!=="boolean")throw L0(J,_9);return J?"?1":"?0"}function L9(J){return btoa(String.fromCharCode(...J))}function P9(J){if(ArrayBuffer.isView(J)===!1)throw L0(J,A9);return`:${L9(J)}:`}function I7(J){if(M9(J))throw L0(J,R9);return J.toString()}function C9(J){return`@${I7(J.getTime()/1000)}`}function w7(J,Y){if(J<0)return-w7(-J,Y);let Z=Math.pow(10,Y);if(Math.abs(J*Z%1-0.5)<Number.EPSILON){let X=Math.floor(J*Z);return(X%2===0?X:X+1)/Z}else return Math.round(J*Z)/Z}function b9(J){let Y=w7(J,3);if(Math.floor(Math.abs(Y)).toString().length>12)throw L0(J,B9);let Z=Y.toString();return Z.includes(".")?Z:`${Z}.0`}var x9="String";function D9(J){if(F9.test(J))throw L0(J,x9);return`"${J.replace(/\\/g,"\\\\").replace(/"/g,"\\\"")}"`}function T9(J){return J.description||J.toString().slice(7,-1)}function f8(J){let Y=T9(J);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(Y)===!1)throw L0(Y,E9);return Y}function PJ(J){switch(typeof J){case"number":if(!h(J))throw L0(J,u8);if(Number.isInteger(J))return I7(J);return b9(J);case"string":return D9(J);case"symbol":return f8(J);case"boolean":return w9(J);case"object":if(J instanceof Date)return C9(J);if(J instanceof Uint8Array)return P9(J);if(J instanceof iJ)return f8(J);default:throw L0(J,u8)}}function CJ(J){if(/^[a-z*][a-z0-9\-_.*]*$/.test(J)===!1)throw L0(J,I9);return J}function sJ(J){if(J==null)return"";return Object.entries(J).map(([Y,Z])=>{if(Z===!0)return`;${CJ(Y)}`;return`;${CJ(Y)}=${PJ(Z)}`}).join("")}function L7(J){if(J instanceof r0)return`${PJ(J.value)}${sJ(J.params)}`;else return PJ(J)}function S9(J){return`(${J.value.map(L7).join(" ")})${sJ(J.params)}`}function h9(J,Y={whitespace:!0}){if(typeof J!=="object")throw L0(J,U9);let Z=J instanceof Map?J.entries():Object.entries(J),Q=Y!=null&&Y.whitespace?" ":"";return Array.from(Z).map(([X,q])=>{if(q instanceof r0===!1)q=new r0(q);let W=CJ(X);if(q.value===!0)W+=sJ(q.params);else if(W+="=",Array.isArray(q.value))W+=S9(q);else W+=L7(q);return W}).join(`,${Q}`)}function y9(J,Y){return h9(J,Y)}var k9=(J)=>J==="ot"||J==="sf"||J==="st",v9=(J)=>{if(typeof J==="number")return h(J);return J!=null&&J!==""&&J!==!1};function p9(J,Y){let Z=new URL(J),Q=new URL(Y);if(Z.origin!==Q.origin)return J;let X=Z.pathname.split("/").slice(1),q=Q.pathname.split("/").slice(1,-1);while(X[0]===q[0])X.shift(),q.shift();while(q.length)q.shift(),X.unshift("..");return X.join("/")}function m9(){try{return crypto.randomUUID()}catch(J){try{let Y=URL.createObjectURL(new Blob),Z=Y.toString();return URL.revokeObjectURL(Y),Z.slice(Z.lastIndexOf("/")+1)}catch(Y){let Z=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(X)=>{let q=(Z+Math.random()*16)%16|0;return Z=Math.floor(Z/16),(X=="x"?q:q&3|8).toString(16)})}}}var E6=(J)=>Math.round(J),g9=(J,Y)=>{if(Y!=null&&Y.baseUrl)J=p9(J,Y.baseUrl);return encodeURIComponent(J)},$6=(J)=>E6(J/100)*100,u9={br:E6,d:E6,bl:$6,dl:$6,mtp:$6,nor:g9,rtp:$6,tb:E6};function f9(J,Y){let Z={};if(J==null||typeof J!=="object")return Z;let Q=Object.keys(J).sort(),X=Y0({},u9,Y==null?void 0:Y.formatters),q=Y==null?void 0:Y.filter;return Q.forEach((W)=>{if(q!=null&&q(W))return;let z=J[W],H=X[W];if(H)z=H(z,Y);if(W==="v"&&z===1)return;if(W=="pr"&&z===1)return;if(!v9(z))return;if(k9(W)&&typeof z==="string")z=new iJ(z);Z[W]=z}),Z}function P7(J,Y={}){if(!J)return"";return y9(f9(J,Y),Y0({whitespace:!1},Y))}function c9(J,Y={}){if(!J)return{};let Z=Object.entries(J),Q=Object.entries(V9).concat(Object.entries((Y==null?void 0:Y.customHeaderMap)||{})),X=Z.reduce((q,W)=>{var z,H;let[G,j]=W,N=((z=Q.find((K)=>K[1].includes(G)))==null?void 0:z[0])||k0.REQUEST;return(H=q[N])!=null||(q[N]={}),q[N][G]=j,q},{});return Object.entries(X).reduce((q,[W,z])=>{return q[W]=P7(z,Y),q},{})}function d9(J,Y,Z){return Y0(J,c9(Y,Z))}var l9="CMCD";function o9(J,Y={}){if(!J)return"";let Z=P7(J,Y);return`${l9}=${encodeURIComponent(Z)}`}var c8=/CMCD=[^&#]+/;function n9(J,Y,Z){let Q=o9(Y,Z);if(!Q)return J;if(c8.test(J))return J.replace(c8,Q);let X=J.includes("?")?"&":"?";return`${J}${X}${Q}`}class C7{constructor(J){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{if(this.initialized)this.starved=!0;this.buffering=!0},this.onPlaying=()=>{if(!this.initialized)this.initialized=!0;this.buffering=!1},this.applyPlaylistData=(Q)=>{try{this.apply(Q,{ot:G0.MANIFEST,su:!this.initialized})}catch(X){B.warn("Could not generate manifest CMCD data.",X)}},this.applyFragmentData=(Q)=>{try{let X=Q.frag,q=this.hls.levels[X.level],W=this.getObjectType(X),z={d:X.duration*1000,ot:W};if(W===G0.VIDEO||W===G0.AUDIO||W==G0.MUXED)z.br=q.bitrate/1000,z.tb=this.getTopBandwidth(W)/1000,z.bl=this.getBufferLength(W);this.apply(Q,z)}catch(X){B.warn("Could not generate segment CMCD data.",X)}},this.hls=J;let Y=this.config=J.config,{cmcd:Z}=Y;if(Z!=null)Y.pLoader=this.createPlaylistLoader(),Y.fLoader=this.createFragmentLoader(),this.sid=Z.sessionId||m9(),this.cid=Z.contentId,this.useHeaders=Z.useHeaders===!0,this.includeKeys=Z.includeKeys,this.registerListeners()}registerListeners(){let J=this.hls;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHED,this.onMediaDetached,this),J.on($.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){let J=this.hls;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHED,this.onMediaDetached,this),J.off($.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(J,Y){this.media=Y.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){if(!this.media)return;this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null}onBufferCreated(J,Y){var Z,Q;this.audioBuffer=(Z=Y.tracks.audio)==null?void 0:Z.buffer,this.videoBuffer=(Q=Y.tracks.video)==null?void 0:Q.buffer}createData(){var J;return{v:1,sf:LJ.HLS,sid:this.sid,cid:this.cid,pr:(J=this.media)==null?void 0:J.playbackRate,mtp:this.hls.bandwidthEstimate/1000}}apply(J,Y={}){Y0(Y,this.createData());let Z=Y.ot===G0.INIT||Y.ot===G0.VIDEO||Y.ot===G0.MUXED;if(this.starved&&Z)Y.bs=!0,Y.su=!0,this.starved=!1;if(Y.su==null)Y.su=this.buffering;let{includeKeys:Q}=this;if(Q)Y=Object.keys(Y).reduce((X,q)=>{return Q.includes(q)&&(X[q]=Y[q]),X},{});if(this.useHeaders){if(!J.headers)J.headers={};d9(J.headers,Y)}else J.url=n9(J.url,Y)}getObjectType(J){let{type:Y}=J;if(Y==="subtitle")return G0.TIMED_TEXT;if(J.sn==="initSegment")return G0.INIT;if(Y==="audio")return G0.AUDIO;if(Y==="main"){if(!this.hls.audioTracks.length)return G0.MUXED;return G0.VIDEO}return}getTopBandwidth(J){let Y=0,Z,Q=this.hls;if(J===G0.AUDIO)Z=Q.audioTracks;else{let X=Q.maxAutoLevel,q=X>-1?X+1:Q.levels.length;Z=Q.levels.slice(0,q)}for(let X of Z)if(X.bitrate>Y)Y=X.bitrate;return Y>0?Y:NaN}getBufferLength(J){let Y=this.hls.media,Z=J===G0.AUDIO?this.audioBuffer:this.videoBuffer;if(!Z||!Y)return NaN;return a.bufferInfo(Z,Y.currentTime,this.config.maxBufferHole).len*1000}createPlaylistLoader(){let{pLoader:J}=this.config,Y=this.applyPlaylistData,Z=J||this.config.loader;return class Q{constructor(X){this.loader=void 0,this.loader=new Z(X)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(X,q,W){Y(X),this.loader.load(X,q,W)}}}createFragmentLoader(){let{fLoader:J}=this.config,Y=this.applyFragmentData,Z=J||this.config.loader;return class Q{constructor(X){this.loader=void 0,this.loader=new Z(X)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(X,q,W){Y(X),this.loader.load(X,q,W)}}}}var i9=300000;class b7{constructor(J){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=J,this.log=B.log.bind(B,"[content-steering]:"),this.registerListeners()}registerListeners(){let J=this.hls;J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_LOADED,this.onManifestLoaded,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.ERROR,this.onError,this)}unregisterListeners(){let J=this.hls;if(!J)return;J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_LOADED,this.onManifestLoaded,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.ERROR,this.onError,this)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let J=this.timeToLoad*1000-(performance.now()-this.updated);if(J>0){this.scheduleRefresh(this.uri,J);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){if(this.started=!1,this.loader)this.loader.destroy(),this.loader=null;this.clearTimeout()}clearTimeout(){if(this.reloadTimer!==-1)self.clearTimeout(this.reloadTimer),this.reloadTimer=-1}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(J){let Y=this.levels;if(Y)this.levels=Y.filter((Z)=>Z!==J)}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(J,Y){let{contentSteering:Z}=Y;if(Z===null)return;if(this.pathwayId=Z.pathwayId,this.uri=Z.uri,this.started)this.startLoad()}onManifestParsed(J,Y){this.audioTracks=Y.audioTracks,this.subtitleTracks=Y.subtitleTracks}onError(J,Y){let{errorAction:Z}=Y;if((Z==null?void 0:Z.action)===q0.SendAlternateToPenaltyBox&&Z.flags===O0.MoveAllAlternatesMatchingHost){let Q=this.levels,X=this.pathwayPriority,q=this.pathwayId;if(Y.context){let{groupId:W,pathwayId:z,type:H}=Y.context;if(W&&Q)q=this.getPathwayForGroupId(W,H,q);else if(z)q=z}if(!(q in this.penalizedPathways))this.penalizedPathways[q]=performance.now();if(!X&&Q)X=Q.reduce((W,z)=>{if(W.indexOf(z.pathwayId)===-1)W.push(z.pathwayId);return W},[]);if(X&&X.length>1)this.updatePathwayPriority(X),Z.resolved=this.pathwayId!==q;if(!Z.resolved)B.warn(`Could not resolve ${Y.details} ("${Y.error.message}") with content-steering for Pathway: ${q} levels: ${Q?Q.length:Q} priorities: ${JSON.stringify(X)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(J){this.levels=J;let Y=this.getLevelsForPathway(this.pathwayId);if(Y.length===0){let Z=J[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${Z}"`),Y=this.getLevelsForPathway(Z),this.pathwayId=Z}if(Y.length!==J.length)this.log(`Found ${Y.length}/${J.length} levels in Pathway "${this.pathwayId}"`);return Y}getLevelsForPathway(J){if(this.levels===null)return[];return this.levels.filter((Y)=>J===Y.pathwayId)}updatePathwayPriority(J){this.pathwayPriority=J;let Y,Z=this.penalizedPathways,Q=performance.now();Object.keys(Z).forEach((X)=>{if(Q-Z[X]>i9)delete Z[X]});for(let X=0;X<J.length;X++){let q=J[X];if(q in Z)continue;if(q===this.pathwayId)return;let W=this.hls.nextLoadLevel,z=this.hls.levels[W];if(Y=this.getLevelsForPathway(q),Y.length>0){this.log(`Setting Pathway to "${q}"`),this.pathwayId=q,OY(Y),this.hls.trigger($.LEVELS_UPDATED,{levels:Y});let H=this.hls.levels[W];if(z&&H&&this.levels){if(H.attrs["STABLE-VARIANT-ID"]!==z.attrs["STABLE-VARIANT-ID"]&&H.bitrate!==z.bitrate)this.log(`Unstable Pathways change from bitrate ${z.bitrate} to ${H.bitrate}`);this.hls.nextLoadLevel=W}break}}}getPathwayForGroupId(J,Y,Z){let Q=this.getLevelsForPathway(Z).concat(this.levels||[]);for(let X=0;X<Q.length;X++)if(Y===l.AUDIO_TRACK&&Q[X].hasAudioGroup(J)||Y===l.SUBTITLE_TRACK&&Q[X].hasSubtitleGroup(J))return Q[X].pathwayId;return Z}clonePathways(J){let Y=this.levels;if(!Y)return;let Z={},Q={};J.forEach((X)=>{let{ID:q,"BASE-ID":W,"URI-REPLACEMENT":z}=X;if(Y.some((G)=>G.pathwayId===q))return;let H=this.getLevelsForPathway(W).map((G)=>{let j=new J0(G.attrs);j["PATHWAY-ID"]=q;let N=j.AUDIO&&`${j.AUDIO}_clone_${q}`,K=j.SUBTITLES&&`${j.SUBTITLES}_clone_${q}`;if(N)Z[j.AUDIO]=N,j.AUDIO=N;if(K)Q[j.SUBTITLES]=K,j.SUBTITLES=K;let V=x7(G.uri,j["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",z),U=new m0({attrs:j,audioCodec:G.audioCodec,bitrate:G.bitrate,height:G.height,name:G.name,url:V,videoCodec:G.videoCodec,width:G.width});if(G.audioGroups)for(let O=1;O<G.audioGroups.length;O++)U.addGroupId("audio",`${G.audioGroups[O]}_clone_${q}`);if(G.subtitleGroups)for(let O=1;O<G.subtitleGroups.length;O++)U.addGroupId("text",`${G.subtitleGroups[O]}_clone_${q}`);return U});Y.push(...H),d8(this.audioTracks,Z,z,q),d8(this.subtitleTracks,Q,z,q)})}loadSteeringManifest(J){let Y=this.hls.config,Z=Y.loader;if(this.loader)this.loader.destroy();this.loader=new Z(Y);let Q;try{Q=new self.URL(J)}catch(G){this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${J}`);return}if(Q.protocol!=="data:"){let G=(this.hls.bandwidthEstimate||Y.abrEwmaDefaultEstimate)|0;Q.searchParams.set("_HLS_pathway",this.pathwayId),Q.searchParams.set("_HLS_throughput",""+G)}let X={responseType:"json",url:Q.href},q=Y.steeringManifestLoadPolicy.default,W=q.errorRetry||q.timeoutRetry||{},z={loadPolicy:q,timeout:q.maxLoadTimeMs,maxRetry:W.maxNumRetry||0,retryDelay:W.retryDelayMs||0,maxRetryDelay:W.maxRetryDelayMs||0},H={onSuccess:(G,j,N,K)=>{this.log(`Loaded steering manifest: "${Q}"`);let V=G.data;if(V.VERSION!==1){this.log(`Steering VERSION ${V.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=V.TTL;let{"RELOAD-URI":U,"PATHWAY-CLONES":O,"PATHWAY-PRIORITY":_}=V;if(U)try{this.uri=new self.URL(U,Q).href}catch(R){this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${U}`);return}if(this.scheduleRefresh(this.uri||N.url),O)this.clonePathways(O);let A={steeringManifest:V,url:Q.toString()};if(this.hls.trigger($.STEERING_MANIFEST_LOADED,A),_)this.updatePathwayPriority(_)},onError:(G,j,N,K)=>{if(this.log(`Error loading steering manifest: ${G.code} ${G.text} (${j.url})`),this.stopLoad(),G.code===410){this.enabled=!1,this.log(`Steering manifest ${j.url} no longer available`);return}let V=this.timeToLoad*1000;if(G.code===429){let U=this.loader;if(typeof(U==null?void 0:U.getResponseHeader)==="function"){let O=U.getResponseHeader("Retry-After");if(O)V=parseFloat(O)*1000}this.log(`Steering manifest ${j.url} rate limited`);return}this.scheduleRefresh(this.uri||j.url,V)},onTimeout:(G,j,N)=>{this.log(`Timeout loading steering manifest (${j.url})`),this.scheduleRefresh(this.uri||j.url)}};this.log(`Requesting steering manifest: ${Q}`),this.loader.load(X,z,H)}scheduleRefresh(J,Y=this.timeToLoad*1000){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var Z;let Q=(Z=this.hls)==null?void 0:Z.media;if(Q&&!Q.ended){this.loadSteeringManifest(J);return}this.scheduleRefresh(J,this.timeToLoad*1000)},Y)}}function d8(J,Y,Z,Q){if(!J)return;Object.keys(Y).forEach((X)=>{let q=J.filter((W)=>W.groupId===X).map((W)=>{let z=Y0({},W);return z.details=void 0,z.attrs=new J0(z.attrs),z.url=z.attrs.URI=x7(W.url,W.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",Z),z.groupId=z.attrs["GROUP-ID"]=Y[X],z.attrs["PATHWAY-ID"]=Q,z});J.push(...q)})}function x7(J,Y,Z,Q){let{HOST:X,PARAMS:q,[Z]:W}=Q,z;if(Y){if(z=W==null?void 0:W[Y],z)J=z}let H=new self.URL(J);if(X&&!z)H.host=X;if(q)Object.keys(q).sort().forEach((G)=>{if(G)H.searchParams.set(G,q[G])});return H.href}var s9=/^age:\s*[\d.]+\s*$/im;class rJ{constructor(J){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=J?J.xhrSetup||null:null,this.stats=new q6,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let J=this.loader;if(self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),J){if(J.onreadystatechange=null,J.onprogress=null,J.readyState!==4)this.stats.aborted=!0,J.abort()}}abort(){var J;if(this.abortInternal(),(J=this.callbacks)!=null&&J.onAbort)this.callbacks.onAbort(this.stats,this.context,this.loader)}load(J,Y,Z){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=J,this.config=Y,this.callbacks=Z,this.loadInternal()}loadInternal(){let{config:J,context:Y}=this;if(!J||!Y)return;let Z=this.loader=new self.XMLHttpRequest,Q=this.stats;Q.loading.first=0,Q.loaded=0,Q.aborted=!1;let X=this.xhrSetup;if(X)Promise.resolve().then(()=>{if(this.loader!==Z||this.stats.aborted)return;return X(Z,Y.url)}).catch((q)=>{if(this.loader!==Z||this.stats.aborted)return;return Z.open("GET",Y.url,!0),X(Z,Y.url)}).then(()=>{if(this.loader!==Z||this.stats.aborted)return;this.openAndSendXhr(Z,Y,J)}).catch((q)=>{this.callbacks.onError({code:Z.status,text:q.message},Y,Z,Q);return});else this.openAndSendXhr(Z,Y,J)}openAndSendXhr(J,Y,Z){if(!J.readyState)J.open("GET",Y.url,!0);let Q=Y.headers,{maxTimeToFirstByteMs:X,maxLoadTimeMs:q}=Z.loadPolicy;if(Q)for(let W in Q)J.setRequestHeader(W,Q[W]);if(Y.rangeEnd)J.setRequestHeader("Range","bytes="+Y.rangeStart+"-"+(Y.rangeEnd-1));J.onreadystatechange=this.readystatechange.bind(this),J.onprogress=this.loadprogress.bind(this),J.responseType=Y.responseType,self.clearTimeout(this.requestTimeout),Z.timeout=X&&h(X)?X:q,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),Z.timeout),J.send()}readystatechange(){let{context:J,loader:Y,stats:Z}=this;if(!J||!Y)return;let Q=Y.readyState,X=this.config;if(Z.aborted)return;if(Q>=2){if(Z.loading.first===0){if(Z.loading.first=Math.max(self.performance.now(),Z.loading.start),X.timeout!==X.loadPolicy.maxLoadTimeMs)self.clearTimeout(this.requestTimeout),X.timeout=X.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),X.loadPolicy.maxLoadTimeMs-(Z.loading.first-Z.loading.start))}if(Q===4){self.clearTimeout(this.requestTimeout),Y.onreadystatechange=null,Y.onprogress=null;let q=Y.status,W=Y.responseType==="text"?Y.responseText:null;if(q>=200&&q<300){let j=W!=null?W:Y.response;if(j!=null){Z.loading.end=Math.max(self.performance.now(),Z.loading.first);let N=Y.responseType==="arraybuffer"?j.byteLength:j.length;if(Z.loaded=Z.total=N,Z.bwEstimate=Z.total*8000/(Z.loading.end-Z.loading.first),!this.callbacks)return;let K=this.callbacks.onProgress;if(K)K(Z,J,j,Y);if(!this.callbacks)return;let V={url:Y.responseURL,data:j,code:q};this.callbacks.onSuccess(V,Z,J,Y);return}}let z=X.loadPolicy.errorRetry,H=Z.retry,G={url:J.url,data:void 0,code:q};if(D6(z,H,!1,G))this.retry(z);else B.error(`${q} while loading ${J.url}`),this.callbacks.onError({code:q,text:Y.statusText},J,Y,Z)}}}loadtimeout(){if(!this.config)return;let J=this.config.loadPolicy.timeoutRetry,Y=this.stats.retry;if(D6(J,Y,!0))this.retry(J);else{var Z;B.warn(`timeout while loading ${(Z=this.context)==null?void 0:Z.url}`);let Q=this.callbacks;if(Q)this.abortInternal(),Q.onTimeout(this.stats,this.context,this.loader)}}retry(J){let{context:Y,stats:Z}=this;this.retryDelay=vJ(J,Z.retry),Z.retry++,B.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${Y==null?void 0:Y.url}, retrying ${Z.retry}/${J.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(J){let Y=this.stats;if(Y.loaded=J.loaded,J.lengthComputable)Y.total=J.total}getCacheAge(){let J=null;if(this.loader&&s9.test(this.loader.getAllResponseHeaders())){let Y=this.loader.getResponseHeader("age");J=Y?parseFloat(Y):null}return J}getResponseHeader(J){if(this.loader&&new RegExp(`^${J}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders()))return this.loader.getResponseHeader(J);return null}}function r9(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(J){}return!1}var a9=/(\d+)-(\d+)\/(\d+)/;class bJ{constructor(J){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=J.fetchSetup||YX,this.controller=new self.AbortController,this.stats=new q6}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){if(this.controller&&!this.stats.loading.end)this.stats.aborted=!0,this.controller.abort()}abort(){var J;if(this.abortInternal(),(J=this.callbacks)!=null&&J.onAbort)this.callbacks.onAbort(this.stats,this.context,this.response)}load(J,Y,Z){let Q=this.stats;if(Q.loading.start)throw new Error("Loader can only be used once.");Q.loading.start=self.performance.now();let X=t9(J,this.controller.signal),q=Z.onProgress,W=J.responseType==="arraybuffer",z=W?"byteLength":"length",{maxTimeToFirstByteMs:H,maxLoadTimeMs:G}=Y.loadPolicy;this.context=J,this.config=Y,this.callbacks=Z,this.request=this.fetchSetup(J,X),self.clearTimeout(this.requestTimeout),Y.timeout=H&&h(H)?H:G,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),Z.onTimeout(Q,J,this.response)},Y.timeout),self.fetch(this.request).then((j)=>{this.response=this.loader=j;let N=Math.max(self.performance.now(),Q.loading.start);if(self.clearTimeout(this.requestTimeout),Y.timeout=G,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),Z.onTimeout(Q,J,this.response)},G-(N-Q.loading.start)),!j.ok){let{status:K,statusText:V}=j;throw new D7(V||"fetch, bad network response",K,j)}if(Q.loading.first=N,Q.total=JX(j.headers)||Q.total,q&&h(Y.highWaterMark))return this.loadProgressively(j,Q,J,Y.highWaterMark,q);if(W)return j.arrayBuffer();if(J.responseType==="json")return j.json();return j.text()}).then((j)=>{let N=this.response;if(!N)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),Q.loading.end=Math.max(self.performance.now(),Q.loading.first);let K=j[z];if(K)Q.loaded=Q.total=K;let V={url:N.url,data:j,code:N.status};if(q&&!h(Y.highWaterMark))q(Q,J,j,N);Z.onSuccess(V,Q,J,N)}).catch((j)=>{if(self.clearTimeout(this.requestTimeout),Q.aborted)return;let N=!j?0:j.code||0,K=!j?null:j.message;Z.onError({code:N,text:K},J,j?j.details:null,Q)})}getCacheAge(){let J=null;if(this.response){let Y=this.response.headers.get("age");J=Y?parseFloat(Y):null}return J}getResponseHeader(J){return this.response?this.response.headers.get(J):null}loadProgressively(J,Y,Z,Q=0,X){let q=new pJ,W=J.body.getReader(),z=()=>{return W.read().then((H)=>{if(H.done){if(q.dataLength)X(Y,Z,q.flush(),J);return Promise.resolve(new ArrayBuffer(0))}let G=H.value,j=G.length;if(Y.loaded+=j,j<Q||q.dataLength){if(q.push(G),q.dataLength>=Q)X(Y,Z,q.flush(),J)}else X(Y,Z,G,J);return z()}).catch(()=>{return Promise.reject()})};return z()}}function t9(J,Y){let Z={method:"GET",mode:"cors",credentials:"same-origin",signal:Y,headers:new self.Headers(Y0({},J.headers))};if(J.rangeEnd)Z.headers.set("Range","bytes="+J.rangeStart+"-"+String(J.rangeEnd-1));return Z}function e9(J){let Y=a9.exec(J);if(Y)return parseInt(Y[2])-parseInt(Y[1])+1}function JX(J){let Y=J.get("Content-Range");if(Y){let Q=e9(Y);if(h(Q))return Q}let Z=J.get("Content-Length");if(Z)return parseInt(Z)}function YX(J,Y){return new self.Request(J.url,Y)}class D7 extends Error{constructor(J,Y,Z){super(J);this.code=void 0,this.details=void 0,this.code=Y,this.details=Z}}var ZX=/\s/,QX={newCue(J,Y,Z,Q){let X=[],q,W,z,H,G,j=self.VTTCue||self.TextTrackCue;for(let K=0;K<Q.rows.length;K++)if(q=Q.rows[K],z=!0,H=0,G="",!q.isEmpty()){var N;for(let O=0;O<q.chars.length;O++)if(ZX.test(q.chars[O].uchar)&&z)H++;else G+=q.chars[O].uchar,z=!1;if(q.cueStartTime=Y,Y===Z)Z+=0.0001;if(H>=16)H--;else H++;let V=O7(G.trim()),U=oJ(Y,Z,V);if(!(J!=null&&(N=J.cues)!=null&&N.getCueById(U)))W=new j(Y,Z,V),W.id=U,W.line=K+1,W.align="left",W.position=10+Math.min(80,Math.floor(H*8/32)*10),X.push(W)}if(J&&X.length)X.sort((K,V)=>{if(K.line==="auto"||V.line==="auto")return 0;if(K.line>8&&V.line>8)return V.line-K.line;return K.line-V.line}),X.forEach((K)=>jY(J,K));return X}},XX={maxTimeToFirstByteMs:8000,maxLoadTimeMs:20000,timeoutRetry:null,errorRetry:null},T7=z0(z0({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60000000,maxBufferHole:0.1,highBufferWatchdogPeriod:2,nudgeOffset:0.1,nudgeMaxRetry:3,maxFragLookUpTolerance:0.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5000,fpsDroppedMonitoringThreshold:0.2,appendErrorMaxRetry:3,loader:rJ,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:MY,bufferController:z7,capLevelController:nJ,errorController:AY,fpsController:E7,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:500000,abrEwmaDefaultEstimateMax:5000000,abrBandWidthFactor:0.95,abrBandWidthUpFactor:0.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:s8,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:XX},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8000,maxLoadTimeMs:20000,timeoutRetry:{maxNumRetry:1,retryDelayMs:1000,maxRetryDelayMs:20000,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1000,maxRetryDelayMs:20000,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:20000,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1000,maxRetryDelayMs:8000}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:20000,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1000,maxRetryDelayMs:8000}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:120000,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1000,maxRetryDelayMs:8000}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:20000,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1000,maxRetryDelayMs:8000}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1000,manifestLoadingMaxRetryTimeout:64000,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1000,levelLoadingMaxRetryTimeout:64000,fragLoadingTimeOut:20000,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1000,fragLoadingMaxRetryTimeout:64000},qX()),{},{subtitleStreamController:Q7,subtitleTrackController:q7,timelineController:M7,audioStreamController:Y7,audioTrackController:Z7,emeController:n0,cmcdController:C7,contentSteeringController:b7});function qX(){return{cueHandler:QX,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function WX(J,Y){if((Y.liveSyncDurationCount||Y.liveMaxLatencyDurationCount)&&(Y.liveSyncDuration||Y.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(Y.liveMaxLatencyDurationCount!==void 0&&(Y.liveSyncDurationCount===void 0||Y.liveMaxLatencyDurationCount<=Y.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(Y.liveMaxLatencyDuration!==void 0&&(Y.liveSyncDuration===void 0||Y.liveMaxLatencyDuration<=Y.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let Z=xJ(J),Q=["manifest","level","frag"],X=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return Q.forEach((q)=>{let W=`${q==="level"?"playlist":q}LoadPolicy`,z=Y[W]===void 0,H=[];if(X.forEach((G)=>{let j=`${q}Loading${G}`,N=Y[j];if(N!==void 0&&z){H.push(j);let K=Z[W].default;switch(Y[W]={default:K},G){case"TimeOut":K.maxLoadTimeMs=N,K.maxTimeToFirstByteMs=N;break;case"MaxRetry":K.errorRetry.maxNumRetry=N,K.timeoutRetry.maxNumRetry=N;break;case"RetryDelay":K.errorRetry.retryDelayMs=N,K.timeoutRetry.retryDelayMs=N;break;case"MaxRetryTimeout":K.errorRetry.maxRetryDelayMs=N,K.timeoutRetry.maxRetryDelayMs=N;break}}}),H.length)B.warn(`hls.js config: "${H.join('", "')}" setting(s) are deprecated, use "${W}": ${JSON.stringify(Y[W])}`)}),z0(z0({},Z),Y)}function xJ(J){if(J&&typeof J==="object"){if(Array.isArray(J))return J.map(xJ);return Object.keys(J).reduce((Y,Z)=>{return Y[Z]=xJ(J[Z]),Y},{})}return J}function zX(J){let Y=J.loader;if(Y!==bJ&&Y!==rJ)B.log("[config]: Custom loader detected, cannot enable progressive streaming"),J.progressive=!1;else if(r9())J.loader=bJ,J.progressive=!0,J.enableSoftwareAES=!0,B.log("[config]: Progressive streaming enabled, using FetchLoader")}var zJ;class S7 extends v6{constructor(J,Y){super(J,"[level-controller]");this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=Y,this._registerListeners()}_registerListeners(){let{hls:J}=this;J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_LOADED,this.onManifestLoaded,this),J.on($.LEVEL_LOADED,this.onLevelLoaded,this),J.on($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this),J.on($.ERROR,this.onError,this)}_unregisterListeners(){let{hls:J}=this;J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_LOADED,this.onManifestLoaded,this),J.off($.LEVEL_LOADED,this.onLevelLoaded,this),J.off($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this),J.off($.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach((Y)=>{Y.loadError=0,Y.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(J,Y){this.resetLevels()}onManifestLoaded(J,Y){let Z=this.hls.config.preferManagedMediaSource,Q=[],X={},q={},W=!1,z=!1,H=!1;Y.levels.forEach((G)=>{var j,N;let K=G.attrs,{audioCodec:V,videoCodec:U}=G;if(((j=V)==null?void 0:j.indexOf("mp4a.40.34"))!==-1){if(zJ||(zJ=/chrome|firefox/i.test(navigator.userAgent)),zJ)G.audioCodec=V=void 0}if(V)G.audioCodec=V=C6(V,Z);if(((N=U)==null?void 0:N.indexOf("avc1"))===0)U=G.videoCodec=hZ(U);let{width:O,height:_,unknownCodecs:A}=G;if(W||(W=!!(O&&_)),z||(z=!!U),H||(H=!!V),A!=null&&A.length||V&&!n6(V,"audio",Z)||U&&!n6(U,"video",Z))return;let{CODECS:R,"FRAME-RATE":E,"HDCP-LEVEL":F,"PATHWAY-ID":P,RESOLUTION:w,"VIDEO-RANGE":b}=K,D=`${`${P||"."}-`}${G.bitrate}-${w}-${E}-${R}-${b}-${F}`;if(!X[D]){let L=new m0(G);X[D]=L,q[D]=1,Q.push(L)}else if(X[D].uri!==G.url&&!G.attrs["PATHWAY-ID"]){let L=q[D]+=1;G.attrs["PATHWAY-ID"]=new Array(L+1).join(".");let k=new m0(G);X[D]=k,Q.push(k)}else X[D].addGroupId("audio",K.AUDIO),X[D].addGroupId("text",K.SUBTITLES)}),this.filterAndSortMediaOptions(Q,Y,W,z,H)}filterAndSortMediaOptions(J,Y,Z,Q,X){let q=[],W=[],z=J;if((Z||Q)&&X)z=z.filter(({videoCodec:V,videoRange:U,width:O,height:_})=>(!!V||!!(O&&_))&&dZ(U));if(z.length===0){Promise.resolve().then(()=>{if(this.hls){if(Y.levels.length)this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(Y.levels[0].attrs)}`);let V=new Error("no level with compatible codecs found in manifest");this.hls.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:Y.url,error:V,reason:V.message})}});return}if(Y.audioTracks){let{preferManagedMediaSource:V}=this.hls.config;q=Y.audioTracks.filter((U)=>!U.audioCodec||n6(U.audioCodec,"audio",V)),l8(q)}if(Y.subtitles)W=Y.subtitles,l8(W);let H=z.slice(0);z.sort((V,U)=>{if(V.attrs["HDCP-LEVEL"]!==U.attrs["HDCP-LEVEL"])return(V.attrs["HDCP-LEVEL"]||"")>(U.attrs["HDCP-LEVEL"]||"")?1:-1;if(Z&&V.height!==U.height)return V.height-U.height;if(V.frameRate!==U.frameRate)return V.frameRate-U.frameRate;if(V.videoRange!==U.videoRange)return b6.indexOf(V.videoRange)-b6.indexOf(U.videoRange);if(V.videoCodec!==U.videoCodec){let O=W8(V.videoCodec),_=W8(U.videoCodec);if(O!==_)return _-O}if(V.uri===U.uri&&V.codecSet!==U.codecSet){let O=P6(V.codecSet),_=P6(U.codecSet);if(O!==_)return _-O}if(V.averageBitrate!==U.averageBitrate)return V.averageBitrate-U.averageBitrate;return 0});let G=H[0];if(this.steering){if(z=this.steering.filterParsedLevels(z),z.length!==H.length){for(let V=0;V<H.length;V++)if(H[V].pathwayId===z[0].pathwayId){G=H[V];break}}}this._levels=z;for(let V=0;V<z.length;V++)if(z[V]===G){var j;this._firstLevel=V;let U=G.bitrate,O=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${z.length} level(s) found, first bitrate: ${U}`),((j=this.hls.userConfig)==null?void 0:j.abrEwmaDefaultEstimate)===void 0){let _=Math.min(U,this.hls.config.abrEwmaDefaultEstimateMax);if(_>O&&O===T7.abrEwmaDefaultEstimate)this.hls.bandwidthEstimate=_}break}let N=X&&!Q,K={levels:z,audioTracks:q,subtitleTracks:W,sessionData:Y.sessionData,sessionKeys:Y.sessionKeys,firstLevel:this._firstLevel,stats:Y.stats,audio:X,video:Q,altAudio:!N&&q.some((V)=>!!V.url)};if(this.hls.trigger($.MANIFEST_PARSED,K),this.hls.config.autoStartLoad||this.hls.forceStartLoad)this.hls.startLoad(this.hls.config.startPosition)}get levels(){if(this._levels.length===0)return null;return this._levels}get level(){return this.currentLevelIndex}set level(J){let Y=this._levels;if(Y.length===0)return;if(J<0||J>=Y.length){let G=new Error("invalid level idx"),j=J<0;if(this.hls.trigger($.ERROR,{type:g.OTHER_ERROR,details:I.LEVEL_SWITCH_ERROR,level:J,fatal:j,error:G,reason:G.message}),j)return;J=Math.min(J,Y.length-1)}let Z=this.currentLevelIndex,Q=this.currentLevel,X=Q?Q.attrs["PATHWAY-ID"]:void 0,q=Y[J],W=q.attrs["PATHWAY-ID"];if(this.currentLevelIndex=J,this.currentLevel=q,Z===J&&q.details&&Q&&X===W)return;this.log(`Switching to level ${J} (${q.height?q.height+"p ":""}${q.videoRange?q.videoRange+" ":""}${q.codecSet?q.codecSet+" ":""}@${q.bitrate})${W?" with Pathway "+W:""} from level ${Z}${X?" with Pathway "+X:""}`);let z={level:J,attrs:q.attrs,details:q.details,bitrate:q.bitrate,averageBitrate:q.averageBitrate,maxBitrate:q.maxBitrate,realBitrate:q.realBitrate,width:q.width,height:q.height,codecSet:q.codecSet,audioCodec:q.audioCodec,videoCodec:q.videoCodec,audioGroups:q.audioGroups,subtitleGroups:q.subtitleGroups,loaded:q.loaded,loadError:q.loadError,fragmentError:q.fragmentError,name:q.name,id:q.id,uri:q.uri,url:q.url,urlId:0,audioGroupIds:q.audioGroupIds,textGroupIds:q.textGroupIds};this.hls.trigger($.LEVEL_SWITCHING,z);let H=q.details;if(!H||H.live){let G=this.switchParams(q.uri,Q==null?void 0:Q.details,H);this.loadPlaylist(G)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(J){if(this.manualLevelIndex=J,this._startLevel===void 0)this._startLevel=J;if(J!==-1)this.level=J}get firstLevel(){return this._firstLevel}set firstLevel(J){this._firstLevel=J}get startLevel(){if(this._startLevel===void 0){let J=this.hls.config.startLevel;if(J!==void 0)return J;return this.hls.firstAutoLevel}return this._startLevel}set startLevel(J){this._startLevel=J}onError(J,Y){if(Y.fatal||!Y.context)return;if(Y.context.type===l.LEVEL&&Y.context.level===this.level)this.checkRetry(Y)}onFragBuffered(J,{frag:Y}){if(Y!==void 0&&Y.type===m.MAIN){let Z=Y.elementaryStreams;if(!Object.keys(Z).some((X)=>!!Z[X]))return;let Q=this._levels[Y.level];if(Q!=null&&Q.loadError)this.log(`Resetting level error count of ${Q.loadError} on frag buffered`),Q.loadError=0}}onLevelLoaded(J,Y){var Z;let{level:Q,details:X}=Y,q=this._levels[Q];if(!q){var W;if(this.warn(`Invalid level index ${Q}`),(W=Y.deliveryDirectives)!=null&&W.skip)X.deltaUpdateFailed=!0;return}if(Q===this.currentLevelIndex){if(q.fragmentError===0)q.loadError=0;this.playlistLoaded(Q,Y,q.details)}else if((Z=Y.deliveryDirectives)!=null&&Z.skip)X.deltaUpdateFailed=!0}loadPlaylist(J){super.loadPlaylist();let Y=this.currentLevelIndex,Z=this.currentLevel;if(Z&&this.shouldLoadPlaylist(Z)){let Q=Z.uri;if(J)try{Q=J.addDirectives(Q)}catch(q){this.warn(`Could not construct new URL with HLS Delivery Directives: ${q}`)}let X=Z.attrs["PATHWAY-ID"];this.log(`Loading level index ${Y}${(J==null?void 0:J.msn)!==void 0?" at sn "+J.msn+" part "+J.part:""} with${X?" Pathway "+X:""} ${Q}`),this.clearTimer(),this.hls.trigger($.LEVEL_LOADING,{url:Q,level:Y,pathwayId:Z.attrs["PATHWAY-ID"],id:0,deliveryDirectives:J||null})}}get nextLoadLevel(){if(this.manualLevelIndex!==-1)return this.manualLevelIndex;else return this.hls.nextAutoLevel}set nextLoadLevel(J){if(this.level=J,this.manualLevelIndex===-1)this.hls.nextAutoLevel=J}removeLevel(J){var Y;let Z=this._levels.filter((Q,X)=>{if(X!==J)return!0;if(this.steering)this.steering.removeLevel(Q);if(Q===this.currentLevel){if(this.currentLevel=null,this.currentLevelIndex=-1,Q.details)Q.details.fragments.forEach((q)=>q.level=-1)}return!1});if(OY(Z),this._levels=Z,this.currentLevelIndex>-1&&(Y=this.currentLevel)!=null&&Y.details)this.currentLevelIndex=this.currentLevel.details.fragments[0].level;this.hls.trigger($.LEVELS_UPDATED,{levels:Z})}onLevelsUpdated(J,{levels:Y}){this._levels=Y}checkMaxAutoUpdated(){let{autoLevelCapping:J,maxAutoLevel:Y,maxHdcpLevel:Z}=this.hls;if(this._maxAutoLevel!==Y)this._maxAutoLevel=Y,this.hls.trigger($.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:J,levels:this.levels,maxAutoLevel:Y,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:Z})}}function l8(J){let Y={};J.forEach((Z)=>{let Q=Z.groupId||"";Z.id=Y[Q]=Y[Q]||0,Y[Q]++})}class h7{constructor(J){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=J}abort(J){for(let Z in this.keyUriToKeyInfo){let Q=this.keyUriToKeyInfo[Z].loader;if(Q){var Y;if(J&&J!==((Y=Q.context)==null?void 0:Y.frag.type))return;Q.abort()}}}detach(){for(let J in this.keyUriToKeyInfo){let Y=this.keyUriToKeyInfo[J];if(Y.mediaKeySessionContext||Y.decryptdata.isCommonEncryption)delete this.keyUriToKeyInfo[J]}}destroy(){this.detach();for(let J in this.keyUriToKeyInfo){let Y=this.keyUriToKeyInfo[J].loader;if(Y)Y.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(J,Y=I.KEY_LOAD_ERROR,Z,Q,X){return new M0({type:g.NETWORK_ERROR,details:Y,fatal:!1,frag:J,response:X,error:Z,networkDetails:Q})}loadClear(J,Y){if(this.emeController&&this.config.emeEnabled){let{sn:Z,cc:Q}=J;for(let X=0;X<Y.length;X++){let q=Y[X];if(Q<=q.cc&&(Z==="initSegment"||q.sn==="initSegment"||Z<q.sn)){this.emeController.selectKeySystemFormat(q).then((W)=>{q.setKeyFormat(W)});break}}}}load(J){if(!J.decryptdata&&J.encrypted&&this.emeController)return this.emeController.selectKeySystemFormat(J).then((Y)=>{return this.loadInternal(J,Y)});return this.loadInternal(J)}loadInternal(J,Y){var Z,Q;if(Y)J.setKeyFormat(Y);let X=J.decryptdata;if(!X){let H=new Error(Y?`Expected frag.decryptdata to be defined after setting format ${Y}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(J,I.KEY_LOAD_ERROR,H))}let q=X.uri;if(!q)return Promise.reject(this.createKeyLoadError(J,I.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${q}"`)));let W=this.keyUriToKeyInfo[q];if((Z=W)!=null&&Z.decryptdata.key)return X.key=W.decryptdata.key,Promise.resolve({frag:J,keyInfo:W});if((Q=W)!=null&&Q.keyLoadPromise){var z;switch((z=W.mediaKeySessionContext)==null?void 0:z.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return W.keyLoadPromise.then((H)=>{return X.key=H.keyInfo.decryptdata.key,{frag:J,keyInfo:W}})}}switch(W=this.keyUriToKeyInfo[q]={decryptdata:X,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},X.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":if(X.keyFormat==="identity")return this.loadKeyHTTP(W,J);return this.loadKeyEME(W,J);case"AES-128":return this.loadKeyHTTP(W,J);default:return Promise.reject(this.createKeyLoadError(J,I.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${X.method}"`)))}}loadKeyEME(J,Y){let Z={frag:Y,keyInfo:J};if(this.emeController&&this.config.emeEnabled){let Q=this.emeController.loadKey(Z);if(Q)return(J.keyLoadPromise=Q.then((X)=>{return J.mediaKeySessionContext=X,Z})).catch((X)=>{throw J.keyLoadPromise=null,X})}return Promise.resolve(Z)}loadKeyHTTP(J,Y){let Z=this.config,X=new Z.loader(Z);return Y.keyLoader=J.loader=X,J.keyLoadPromise=new Promise((q,W)=>{let z={keyInfo:J,frag:Y,responseType:"arraybuffer",url:J.decryptdata.uri},H=Z.keyLoadPolicy.default,G={loadPolicy:H,timeout:H.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},j={onSuccess:(N,K,V,U)=>{let{frag:O,keyInfo:_,url:A}=V;if(!O.decryptdata||_!==this.keyUriToKeyInfo[A])return W(this.createKeyLoadError(O,I.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),U));_.decryptdata.key=O.decryptdata.key=new Uint8Array(N.data),O.keyLoader=null,_.loader=null,q({frag:O,keyInfo:_})},onError:(N,K,V,U)=>{this.resetLoader(K),W(this.createKeyLoadError(Y,I.KEY_LOAD_ERROR,new Error(`HTTP Error ${N.code} loading key ${N.text}`),V,z0({url:z.url,data:void 0},N)))},onTimeout:(N,K,V)=>{this.resetLoader(K),W(this.createKeyLoadError(Y,I.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),V))},onAbort:(N,K,V)=>{this.resetLoader(K),W(this.createKeyLoadError(Y,I.INTERNAL_ABORTED,new Error("key loading aborted"),V))}};X.load(z,G,j)})}resetLoader(J){let{frag:Y,keyInfo:Z,url:Q}=J,X=Z.loader;if(Y.keyLoader===X)Y.keyLoader=null,Z.loader=null;if(delete this.keyUriToKeyInfo[Q],X)X.destroy()}}function y7(){return self.SourceBuffer||self.WebKitSourceBuffer}function k7(){if(!p0())return!1;let Y=y7();return!Y||Y.prototype&&typeof Y.prototype.appendBuffer==="function"&&typeof Y.prototype.remove==="function"}function HX(){if(!k7())return!1;let J=p0();return typeof(J==null?void 0:J.isTypeSupported)==="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some((Y)=>J.isTypeSupported(X6(Y,"video")))||["mp4a.40.2","fLaC"].some((Y)=>J.isTypeSupported(X6(Y,"audio"))))}function GX(){var J;let Y=y7();return typeof(Y==null?void 0:(J=Y.prototype)==null?void 0:J.changeType)==="function"}var jX=250,I6=2,NX=0.1,KX=0.05;class v7{constructor(J,Y,Z,Q){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=J,this.media=Y,this.fragmentTracker=Z,this.hls=Q}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(J,Y){let{config:Z,media:Q,stalled:X}=this;if(Q===null)return;let{currentTime:q,seeking:W}=Q,z=this.seeking&&!W,H=!this.seeking&&W;if(this.seeking=W,q!==J){if(this.moved=!0,!W)this.nudgeRetry=0;if(X!==null){if(this.stallReported){let O=self.performance.now()-X;B.warn(`playback not stuck anymore @${q}, after ${Math.round(O)}ms`),this.stallReported=!1}this.stalled=null}return}if(H||z){this.stalled=null;return}if(Q.paused&&!W||Q.ended||Q.playbackRate===0||!a.getBuffered(Q).length){this.nudgeRetry=0;return}let G=a.bufferInfo(Q,q,0),j=G.nextStart||0;if(W){let O=G.len>I6,_=!j||Y&&Y.start<=q||j-q>I6&&!this.fragmentTracker.getPartialFragment(q);if(O||_)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var N;if(!(G.len>0)&&!j)return;let _=Math.max(j,G.start||0)-q,A=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,E=(A==null?void 0:(N=A.details)==null?void 0:N.live)?A.details.targetduration*2:I6,F=this.fragmentTracker.getPartialFragment(q);if(_>0&&(_<=E||F)){if(!Q.paused)this._trySkipBufferHole(F);return}}let K=self.performance.now();if(X===null){this.stalled=K;return}let V=K-X;if(!W&&V>=jX){if(this._reportStall(G),!this.media)return}let U=a.bufferInfo(Q,q,Z.maxBufferHole);this._tryFixBufferStall(U,V)}_tryFixBufferStall(J,Y){let{config:Z,fragmentTracker:Q,media:X}=this;if(X===null)return;let q=X.currentTime,W=Q.getPartialFragment(q);if(W){if(this._trySkipBufferHole(W)||!this.media)return}if((J.len>Z.maxBufferHole||J.nextStart&&J.nextStart-q<Z.maxBufferHole)&&Y>Z.highBufferWatchdogPeriod*1000)B.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer()}_reportStall(J){let{hls:Y,media:Z,stallReported:Q}=this;if(!Q&&Z){this.stallReported=!0;let X=new Error(`Playback stalling at @${Z.currentTime} due to low buffer (${JSON.stringify(J)})`);B.warn(X.message),Y.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_STALLED_ERROR,fatal:!1,error:X,buffer:J.len})}}_trySkipBufferHole(J){let{config:Y,hls:Z,media:Q}=this;if(Q===null)return 0;let X=Q.currentTime,q=a.bufferInfo(Q,X,0),W=X<q.start?q.start:q.nextStart;if(W){let z=q.len<=Y.maxBufferHole,H=q.len>0&&q.len<1&&Q.readyState<3,G=W-X;if(G>0&&(z||H)){if(G>Y.maxBufferHole){let{fragmentTracker:N}=this,K=!1;if(X===0){let V=N.getAppendedFrag(0,m.MAIN);if(V&&W<V.end)K=!0}if(!K){let V=J||N.getAppendedFrag(X,m.MAIN);if(V){let U=!1,O=V.end;while(O<W){let _=N.getPartialFragment(O);if(_)O+=_.duration;else{U=!0;break}}if(U)return 0}}}let j=Math.max(W+KX,X+NX);if(B.warn(`skipping hole, adjusting currentTime from ${X} to ${j}`),this.moved=!0,this.stalled=null,Q.currentTime=j,J&&!J.gap){let N=new Error(`fragment loaded with buffer holes, seeking from ${X} to ${j}`);Z.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:N,reason:N.message,frag:J})}return j}}return 0}_tryNudgeBuffer(){let{config:J,hls:Y,media:Z,nudgeRetry:Q}=this;if(Z===null)return;let X=Z.currentTime;if(this.nudgeRetry++,Q<J.nudgeMaxRetry){let q=X+(Q+1)*J.nudgeOffset,W=new Error(`Nudging 'currentTime' from ${X} to ${q}`);B.warn(W.message),Z.currentTime=q,Y.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_NUDGE_ON_STALL,error:W,fatal:!1})}else{let q=new Error(`Playhead still not moving while enough data buffered @${X} after ${J.nudgeMaxRetry} nudges`);B.error(q.message),Y.trigger($.ERROR,{type:g.MEDIA_ERROR,details:I.BUFFER_STALLED_ERROR,error:q,fatal:!0})}}}var VX=100;class p7 extends g6{constructor(J,Y,Z){super(J,Y,Z,"[stream-controller]",m.MAIN);this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){let{hls:J}=this;J.on($.MEDIA_ATTACHED,this.onMediaAttached,this),J.on($.MEDIA_DETACHING,this.onMediaDetaching,this),J.on($.MANIFEST_LOADING,this.onManifestLoading,this),J.on($.MANIFEST_PARSED,this.onManifestParsed,this),J.on($.LEVEL_LOADING,this.onLevelLoading,this),J.on($.LEVEL_LOADED,this.onLevelLoaded,this),J.on($.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),J.on($.ERROR,this.onError,this),J.on($.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),J.on($.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),J.on($.BUFFER_CREATED,this.onBufferCreated,this),J.on($.BUFFER_FLUSHED,this.onBufferFlushed,this),J.on($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.on($.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls:J}=this;J.off($.MEDIA_ATTACHED,this.onMediaAttached,this),J.off($.MEDIA_DETACHING,this.onMediaDetaching,this),J.off($.MANIFEST_LOADING,this.onManifestLoading,this),J.off($.MANIFEST_PARSED,this.onManifestParsed,this),J.off($.LEVEL_LOADED,this.onLevelLoaded,this),J.off($.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),J.off($.ERROR,this.onError,this),J.off($.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),J.off($.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),J.off($.BUFFER_CREATED,this.onBufferCreated,this),J.off($.BUFFER_FLUSHED,this.onBufferFlushed,this),J.off($.LEVELS_UPDATED,this.onLevelsUpdated,this),J.off($.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(J){if(this.levels){let{lastCurrentTime:Y,hls:Z}=this;if(this.stopLoad(),this.setInterval(VX),this.level=-1,!this.startFragRequested){let Q=Z.startLevel;if(Q===-1)if(Z.config.testBandwidth&&this.levels.length>1)Q=0,this.bitrateTest=!0;else Q=Z.firstAutoLevel;Z.nextLoadLevel=Q,this.level=Z.loadLevel,this.loadedmetadata=!1}if(Y>0&&J===-1)this.log(`Override startPosition with lastCurrentTime @${Y.toFixed(3)}`),J=Y;this.state=C.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=J,this.tick()}else this._forceStartLoad=!0,this.state=C.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case C.WAITING_LEVEL:{let{levels:Y,level:Z}=this,Q=Y==null?void 0:Y[Z],X=Q==null?void 0:Q.details;if(X&&(!X.live||this.levelLastLoaded===Q)){if(this.waitForCdnTuneIn(X))break;this.state=C.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=C.IDLE;break}break}case C.FRAG_LOADING_WAITING_RETRY:{var J;let Y=self.performance.now(),Z=this.retryDate;if(!Z||Y>=Z||(J=this.media)!=null&&J.seeking){let{levels:Q,level:X}=this,q=Q==null?void 0:Q[X];this.resetStartWhenNotLoaded(q||null),this.state=C.IDLE}}break}if(this.state===C.IDLE)this.doTickIdle();this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){let{hls:J,levelLastLoaded:Y,levels:Z,media:Q}=this;if(Y===null||!Q&&(this.startFragRequested||!J.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;let X=this.buffering?J.nextLoadLevel:J.loadLevel;if(!(Z!=null&&Z[X]))return;let q=Z[X],W=this.getMainFwdBufferInfo();if(W===null)return;let z=this.getLevelDetails();if(z&&this._streamEnded(W,z)){let U={};if(this.altAudio)U.type="video";this.hls.trigger($.BUFFER_EOS,U),this.state=C.ENDED;return}if(!this.buffering)return;if(J.loadLevel!==X&&J.manualLevel===-1)this.log(`Adapting to level ${X} from level ${this.level}`);this.level=J.nextLoadLevel=X;let H=q.details;if(!H||this.state===C.WAITING_LEVEL||H.live&&this.levelLastLoaded!==q){this.level=X,this.state=C.WAITING_LEVEL;return}let G=W.len,j=this.getMaxBufferLength(q.maxBitrate);if(G>=j)return;if(this.backtrackFragment&&this.backtrackFragment.start>W.end)this.backtrackFragment=null;let N=this.backtrackFragment?this.backtrackFragment.start:W.end,K=this.getNextFragment(N,H);if(this.couldBacktrack&&!this.fragPrevious&&K&&K.sn!=="initSegment"&&this.fragmentTracker.getState(K)!==W0.OK){var V;let O=((V=this.backtrackFragment)!=null?V:K).sn-H.startSN,_=H.fragments[O-1];if(_&&K.cc===_.cc)K=_,this.fragmentTracker.removeFragment(_)}else if(this.backtrackFragment&&W.len)this.backtrackFragment=null;if(K&&this.isLoopLoading(K,N)){if(!K.gap){let O=this.audioOnly&&!this.altAudio?s.AUDIO:s.VIDEO,_=(O===s.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;if(_)this.afterBufferFlushed(_,O,m.MAIN)}K=this.getNextFragmentLoopLoading(K,H,W,m.MAIN,j)}if(!K)return;if(K.initSegment&&!K.initSegment.data&&!this.bitrateTest)K=K.initSegment;this.loadFragment(K,q,N)}loadFragment(J,Y,Z){let Q=this.fragmentTracker.getState(J);if(this.fragCurrent=J,Q===W0.NOT_LOADED||Q===W0.PARTIAL)if(J.sn==="initSegment")this._loadInitSegment(J,Y);else if(this.bitrateTest)this.log(`Fragment ${J.sn} of level ${J.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(J,Y);else this.startFragRequested=!0,super.loadFragment(J,Y,Z);else this.clearTrackerIfNeeded(J)}getBufferedFrag(J){return this.fragmentTracker.getBufferedFrag(J,m.MAIN)}followingBufferedFrag(J){if(J)return this.getBufferedFrag(J.end+0.5);return null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){let{levels:J,media:Y}=this;if(Y!=null&&Y.readyState){let Z,Q=this.getAppendedFrag(Y.currentTime);if(Q&&Q.start>1)this.flushMainBuffer(0,Q.start-1);let X=this.getLevelDetails();if(X!=null&&X.live){let W=this.getMainFwdBufferInfo();if(!W||W.len<X.targetduration*2)return}if(!Y.paused&&J){let W=this.hls.nextLoadLevel,z=J[W],H=this.fragLastKbps;if(H&&this.fragCurrent)Z=this.fragCurrent.duration*z.maxBitrate/(1000*H)+1;else Z=0}else Z=0;let q=this.getBufferedFrag(Y.currentTime+Z);if(q){let W=this.followingBufferedFrag(q);if(W){this.abortCurrentFrag();let z=W.maxStartPTS?W.maxStartPTS:W.start,H=W.duration,G=Math.max(q.end,z+Math.min(Math.max(H-this.config.maxFragLookUpTolerance,H*(this.couldBacktrack?0.5:0.125)),H*(this.couldBacktrack?0.75:0.25)));this.flushMainBuffer(G,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){let J=this.fragCurrent;if(this.fragCurrent=null,this.backtrackFragment=null,J)J.abortRequests(),this.fragmentTracker.removeFragment(J);switch(this.state){case C.KEY_LOADING:case C.FRAG_LOADING:case C.FRAG_LOADING_WAITING_RETRY:case C.PARSING:case C.PARSED:this.state=C.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(J,Y){super.flushMainBuffer(J,Y,this.altAudio?"video":null)}onMediaAttached(J,Y){super.onMediaAttached(J,Y);let Z=Y.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),Z.addEventListener("playing",this.onvplaying),Z.addEventListener("seeked",this.onvseeked),this.gapController=new v7(this.config,Z,this.fragmentTracker,this.hls)}onMediaDetaching(){let{media:J}=this;if(J&&this.onvplaying&&this.onvseeked)J.removeEventListener("playing",this.onvplaying),J.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null;if(this.fragPlaying=null,this.gapController)this.gapController.destroy(),this.gapController=null;super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){let J=this.media,Y=J?J.currentTime:null;if(h(Y))this.log(`Media seeked to ${Y.toFixed(3)}`);let Z=this.getMainFwdBufferInfo();if(Z===null||Z.len===0){this.warn(`Main forward buffer length on "seeked" event ${Z?Z.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger($.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(J,Y){let Z=!1,Q=!1;if(Y.levels.forEach((X)=>{let q=X.audioCodec;if(q)Z=Z||q.indexOf("mp4a.40.2")!==-1,Q=Q||q.indexOf("mp4a.40.5")!==-1}),this.audioCodecSwitch=Z&&Q&&!GX(),this.audioCodecSwitch)this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC");this.levels=Y.levels,this.startFragRequested=!1}onLevelLoading(J,Y){let{levels:Z}=this;if(!Z||this.state!==C.IDLE)return;let Q=Z[Y.level];if(!Q.details||Q.details.live&&this.levelLastLoaded!==Q||this.waitForCdnTuneIn(Q.details))this.state=C.WAITING_LEVEL}onLevelLoaded(J,Y){var Z;let{levels:Q}=this,X=Y.level,q=Y.details,W=q.totalduration;if(!Q){this.warn(`Levels were reset while loading level ${X}`);return}this.log(`Level ${X} loaded [${q.startSN},${q.endSN}]${q.lastPartSn?`[part-${q.lastPartSn}-${q.lastPartIndex}]`:""}, cc [${q.startCC}, ${q.endCC}] duration:${W}`);let z=Q[X],H=this.fragCurrent;if(H&&(this.state===C.FRAG_LOADING||this.state===C.FRAG_LOADING_WAITING_RETRY)){if(H.level!==Y.level&&H.loader)this.abortCurrentFrag()}let G=0;if(q.live||(Z=z.details)!=null&&Z.live){var j;if(this.checkLiveUpdate(q),q.deltaUpdateFailed)return;G=this.alignPlaylists(q,z.details,(j=this.levelLastLoaded)==null?void 0:j.details)}if(z.details=q,this.levelLastLoaded=z,this.hls.trigger($.LEVEL_UPDATED,{details:q,level:X}),this.state===C.WAITING_LEVEL){if(this.waitForCdnTuneIn(q))return;this.state=C.IDLE}if(!this.startFragRequested)this.setStartPosition(q,G);else if(q.live)this.synchronizeToLiveEdge(q);this.tick()}_handleFragmentLoadProgress(J){var Y;let{frag:Z,part:Q,payload:X}=J,{levels:q}=this;if(!q){this.warn(`Levels were reset while fragment load was in progress. Fragment ${Z.sn} of level ${Z.level} will not be buffered`);return}let W=q[Z.level],z=W.details;if(!z){this.warn(`Dropping fragment ${Z.sn} of level ${Z.level} after level details were reset`),this.fragmentTracker.removeFragment(Z);return}let H=W.videoCodec,G=z.PTSKnown||!z.live,j=(Y=Z.initSegment)==null?void 0:Y.data,N=this._getAudioCodec(W),K=this.transmuxer=this.transmuxer||new cJ(this.hls,m.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),V=Q?Q.index:-1,U=V!==-1,O=new p6(Z.level,Z.sn,Z.stats.chunkCount,X.byteLength,V,U),_=this.initPTS[Z.cc];K.push(X,j,N,H,Z,Q,z.totalduration,G,O,_)}onAudioTrackSwitching(J,Y){let Z=this.altAudio;if(!Y.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let q=this.fragCurrent;if(q)this.log("Switching to main audio track, cancel main fragment load"),q.abortRequests(),this.fragmentTracker.removeFragment(q);this.resetTransmuxer(),this.resetLoadingState()}else if(this.audioOnly)this.resetTransmuxer();let X=this.hls;if(Z)X.trigger($.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments();X.trigger($.AUDIO_TRACK_SWITCHED,Y)}}onAudioTrackSwitched(J,Y){let Z=Y.id,Q=!!this.hls.audioTracks[Z].url;if(Q){let X=this.videoBuffer;if(X&&this.mediaBuffer!==X)this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=X}this.altAudio=Q,this.tick()}onBufferCreated(J,Y){let Z=Y.tracks,Q,X,q=!1;for(let W in Z){let z=Z[W];if(z.id==="main"){if(X=W,Q=z,W==="video"){let H=Z[W];if(H)this.videoBuffer=H.buffer}}else q=!0}if(q&&Q)this.log(`Alternate track found, use ${X}.buffered to schedule main fragment loading`),this.mediaBuffer=Q.buffer;else this.mediaBuffer=this.media}onFragBuffered(J,Y){let{frag:Z,part:Q}=Y;if(Z&&Z.type!==m.MAIN)return;if(this.fragContextChanged(Z)){if(this.warn(`Fragment ${Z.sn}${Q?" p: "+Q.index:""} of level ${Z.level} finished buffering, but was aborted. state: ${this.state}`),this.state===C.PARSED)this.state=C.IDLE;return}let X=Q?Q.stats:Z.stats;if(this.fragLastKbps=Math.round(8*X.total/(X.buffering.end-X.loading.first)),Z.sn!=="initSegment")this.fragPrevious=Z;this.fragBufferedComplete(Z,Q)}onError(J,Y){var Z;if(Y.fatal){this.state=C.ERROR;return}switch(Y.details){case I.FRAG_GAP:case I.FRAG_PARSING_ERROR:case I.FRAG_DECRYPT_ERROR:case I.FRAG_LOAD_ERROR:case I.FRAG_LOAD_TIMEOUT:case I.KEY_LOAD_ERROR:case I.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(m.MAIN,Y);break;case I.LEVEL_LOAD_ERROR:case I.LEVEL_LOAD_TIMEOUT:case I.LEVEL_PARSING_ERROR:if(!Y.levelRetry&&this.state===C.WAITING_LEVEL&&((Z=Y.context)==null?void 0:Z.type)===l.LEVEL)this.state=C.IDLE;break;case I.BUFFER_APPEND_ERROR:case I.BUFFER_FULL_ERROR:if(!Y.parent||Y.parent!=="main")return;if(Y.details===I.BUFFER_APPEND_ERROR){this.resetLoadingState();return}if(this.reduceLengthAndFlushBuffer(Y))this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case I.INTERNAL_EXCEPTION:this.recoverWorkerError(Y);break}}checkBuffer(){let{media:J,gapController:Y}=this;if(!J||!Y||!J.readyState)return;if(this.loadedmetadata||!a.getBuffered(J).length){let Z=this.state!==C.IDLE?this.fragCurrent:null;Y.poll(this.lastCurrentTime,Z)}this.lastCurrentTime=J.currentTime}onFragLoadEmergencyAborted(){if(this.state=C.IDLE,!this.loadedmetadata)this.startFragRequested=!1,this.nextLoadPosition=this.startPosition;this.tickImmediate()}onBufferFlushed(J,{type:Y}){if(Y!==s.AUDIO||this.audioOnly&&!this.altAudio){let Z=(Y===s.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(Z,Y,m.MAIN),this.tick()}}onLevelsUpdated(J,Y){if(this.level>-1&&this.fragCurrent)this.level=this.fragCurrent.level;this.levels=Y.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media:J}=this;if(!J)return;let Y=J.currentTime,Z=this.startPosition;if(Z>=0&&Y<Z){if(J.seeking){this.log(`could not seek to ${Z}, already seeking at ${Y}`);return}let Q=a.getBuffered(J),q=(Q.length?Q.start(0):0)-Z;if(q>0&&(q<this.config.maxBufferHole||q<this.config.maxFragLookUpTolerance))this.log(`adjusting start position by ${q} to match buffer start`),Z+=q,this.startPosition=Z;this.log(`seek to target start position ${Z} from current time ${Y}`),J.currentTime=Z}}_getAudioCodec(J){let Y=this.config.defaultAudioCodec||J.audioCodec;if(this.audioCodecSwap&&Y)if(this.log("Swapping audio codec"),Y.indexOf("mp4a.40.5")!==-1)Y="mp4a.40.2";else Y="mp4a.40.5";return Y}_loadBitrateTestFrag(J,Y){J.bitrateTest=!0,this._doFragLoad(J,Y).then((Z)=>{let{hls:Q}=this;if(!Z||this.fragContextChanged(J))return;Y.fragmentError=0,this.state=C.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let X=J.stats;X.parsing.start=X.parsing.end=X.buffering.start=X.buffering.end=self.performance.now(),Q.trigger($.FRAG_LOADED,Z),J.bitrateTest=!1})}_handleTransmuxComplete(J){var Y;let Z="main",{hls:Q}=this,{remuxResult:X,chunkMeta:q}=J,W=this.getCurrentContext(q);if(!W){this.resetWhenMissingContext(q);return}let{frag:z,part:H,level:G}=W,{video:j,text:N,id3:K,initSegment:V}=X,{details:U}=G,O=this.altAudio?void 0:X.audio;if(this.fragContextChanged(z)){this.fragmentTracker.removeFragment(z);return}if(this.state=C.PARSING,V){if(V!=null&&V.tracks){let R=z.initSegment||z;this._bufferInitSegment(G,V.tracks,R,q),Q.trigger($.FRAG_PARSING_INIT_SEGMENT,{frag:R,id:"main",tracks:V.tracks})}let{initPTS:_,timescale:A}=V;if(h(_))this.initPTS[z.cc]={baseTime:_,timescale:A},Q.trigger($.INIT_PTS_FOUND,{frag:z,id:"main",initPTS:_,timescale:A})}if(j&&U&&z.sn!=="initSegment"){let _=U.fragments[z.sn-1-U.startSN],A=z.sn===U.startSN,R=!_||z.cc>_.cc;if(X.independent!==!1){let{startPTS:E,endPTS:F,startDTS:P,endDTS:w}=j;if(H)H.elementaryStreams[j.type]={startPTS:E,endPTS:F,startDTS:P,endDTS:w};else{if(j.firstKeyFrame&&j.independent&&q.id===1&&!R)this.couldBacktrack=!0;if(j.dropped&&j.independent){let b=this.getMainFwdBufferInfo(),x=(b?b.end:this.getLoadPosition())+this.config.maxBufferHole,D=j.firstKeyFramePTS?j.firstKeyFramePTS:E;if(!A&&x<D-this.config.maxBufferHole&&!R){this.backtrack(z);return}else if(R)z.gap=!0;z.setElementaryStreamInfo(j.type,z.start,F,z.start,w,!0)}else if(A&&E>I6)z.gap=!0}if(z.setElementaryStreamInfo(j.type,E,F,P,w),this.backtrackFragment)this.backtrackFragment=z;this.bufferFragmentData(j,z,H,q,A||R)}else if(A||R)z.gap=!0;else{this.backtrack(z);return}}if(O){let{startPTS:_,endPTS:A,startDTS:R,endDTS:E}=O;if(H)H.elementaryStreams[s.AUDIO]={startPTS:_,endPTS:A,startDTS:R,endDTS:E};z.setElementaryStreamInfo(s.AUDIO,_,A,R,E),this.bufferFragmentData(O,z,H,q)}if(U&&K!=null&&(Y=K.samples)!=null&&Y.length){let _={id:"main",frag:z,details:U,samples:K.samples};Q.trigger($.FRAG_PARSING_METADATA,_)}if(U&&N){let _={id:"main",frag:z,details:U,samples:N.samples};Q.trigger($.FRAG_PARSING_USERDATA,_)}}_bufferInitSegment(J,Y,Z,Q){if(this.state!==C.PARSING)return;if(this.audioOnly=!!Y.audio&&!Y.video,this.altAudio&&!this.audioOnly)delete Y.audio;let{audio:X,video:q,audiovideo:W}=Y;if(X){let z=J.audioCodec,H=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){if(z)if(z.indexOf("mp4a.40.5")!==-1)z="mp4a.40.2";else z="mp4a.40.5";let G=X.metadata;if(G&&"channelCount"in G&&(G.channelCount||1)!==1&&H.indexOf("firefox")===-1)z="mp4a.40.5"}if(z&&z.indexOf("mp4a.40.5")!==-1&&H.indexOf("android")!==-1&&X.container!=="audio/mpeg")z="mp4a.40.2",this.log(`Android: force audio codec to ${z}`);if(J.audioCodec&&J.audioCodec!==z)this.log(`Swapping manifest audio codec "${J.audioCodec}" for "${z}"`);X.levelCodec=z,X.id="main",this.log(`Init audio buffer, container:${X.container}, codecs[selected/level/parsed]=[${z||""}/${J.audioCodec||""}/${X.codec}]`)}if(q)q.levelCodec=J.videoCodec,q.id="main",this.log(`Init video buffer, container:${q.container}, codecs[level/parsed]=[${J.videoCodec||""}/${q.codec}]`);if(W)this.log(`Init audiovideo buffer, container:${W.container}, codecs[level/parsed]=[${J.codecs}/${W.codec}]`);this.hls.trigger($.BUFFER_CODECS,Y),Object.keys(Y).forEach((z)=>{let G=Y[z].initSegment;if(G!=null&&G.byteLength)this.hls.trigger($.BUFFER_APPENDING,{type:z,data:G,frag:Z,part:null,chunkMeta:Q,parent:Z.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,m.MAIN)}backtrack(J){this.couldBacktrack=!0,this.backtrackFragment=J,this.resetTransmuxer(),this.flushBufferGap(J),this.fragmentTracker.removeFragment(J),this.fragPrevious=null,this.nextLoadPosition=J.start,this.state=C.IDLE}checkFragmentChanged(){let J=this.media,Y=null;if(J&&J.readyState>1&&J.seeking===!1){let Z=J.currentTime;if(a.isBuffered(J,Z))Y=this.getAppendedFrag(Z);else if(a.isBuffered(J,Z+0.1))Y=this.getAppendedFrag(Z+0.1);if(Y){this.backtrackFragment=null;let Q=this.fragPlaying,X=Y.level;if(!Q||Y.sn!==Q.sn||Q.level!==X){if(this.fragPlaying=Y,this.hls.trigger($.FRAG_CHANGED,{frag:Y}),!Q||Q.level!==X)this.hls.trigger($.LEVEL_SWITCHED,{level:X})}}}}get nextLevel(){let J=this.nextBufferedFrag;if(J)return J.level;return-1}get currentFrag(){let J=this.media;if(J)return this.fragPlaying||this.getAppendedFrag(J.currentTime);return null}get currentProgramDateTime(){let J=this.media;if(J){let Y=J.currentTime,Z=this.currentFrag;if(Z&&h(Y)&&h(Z.programDateTime)){let Q=Z.programDateTime+(Y-Z.start)*1000;return new Date(Q)}}return null}get currentLevel(){let J=this.currentFrag;if(J)return J.level;return-1}get nextBufferedFrag(){let J=this.currentFrag;if(J)return this.followingBufferedFrag(J);return null}get forceStartLoad(){return this._forceStartLoad}}class l0{static get version(){return"1.5.18"}static isMSESupported(){return k7()}static isSupported(){return HX()}static getMediaSource(){return p0()}static get Events(){return $}static get ErrorTypes(){return g}static get ErrorDetails(){return I}static get DefaultConfig(){if(!l0.defaultConfig)return T7;return l0.defaultConfig}static set DefaultConfig(J){l0.defaultConfig=J}constructor(J={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new fJ,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,n7(J.debug||!1,"Hls instance");let Y=this.config=WX(l0.DefaultConfig,J);if(this.userConfig=J,Y.progressive)zX(Y);let{abrController:Z,bufferController:Q,capLevelController:X,errorController:q,fpsController:W}=Y,z=new q(this),H=this.abrController=new Z(this),G=this.bufferController=new Q(this),j=this.capLevelController=new X(this),N=new W(this),K=new HY(this),V=new NY(this),U=Y.contentSteeringController,O=U?new U(this):null,_=this.levelController=new S7(this,O),A=new EY(this),R=new h7(this.config),E=this.streamController=new p7(this,A,R);j.setStreamController(E),N.setStreamController(E);let F=[K,_,E];if(O)F.splice(1,0,O);this.networkControllers=F;let P=[H,G,j,N,V,A];this.audioTrackController=this.createController(Y.audioTrackController,F);let w=Y.audioStreamController;if(w)F.push(new w(this,A,R));this.subtitleTrackController=this.createController(Y.subtitleTrackController,F);let b=Y.subtitleStreamController;if(b)F.push(new b(this,A,R));this.createController(Y.timelineController,P),R.emeController=this.emeController=this.createController(Y.emeController,P),this.cmcdController=this.createController(Y.cmcdController,P),this.latencyController=this.createController(KY,P),this.coreComponents=P,F.push(z);let x=z.onErrorOut;if(typeof x==="function")this.on($.ERROR,x,z)}createController(J,Y){if(J){let Z=new J(this);if(Y)Y.push(Z);return Z}return null}on(J,Y,Z=this){this._emitter.on(J,Y,Z)}once(J,Y,Z=this){this._emitter.once(J,Y,Z)}removeAllListeners(J){this._emitter.removeAllListeners(J)}off(J,Y,Z=this,Q){this._emitter.off(J,Y,Z,Q)}listeners(J){return this._emitter.listeners(J)}emit(J,Y,Z){return this._emitter.emit(J,Y,Z)}trigger(J,Y){if(this.config.debug)return this.emit(J,J,Y);else try{return this.emit(J,J,Y)}catch(Z){if(B.error("An internal error happened while handling event "+J+'. Error message: "'+Z.message+'". Here is a stacktrace:',Z),!this.triggeringException){this.triggeringException=!0;let Q=J===$.ERROR;this.trigger($.ERROR,{type:g.OTHER_ERROR,details:I.INTERNAL_EXCEPTION,fatal:Q,event:J,error:Z}),this.triggeringException=!1}}return!1}listenerCount(J){return this._emitter.listenerCount(J)}destroy(){B.log("destroy"),this.trigger($.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach((Y)=>Y.destroy()),this.networkControllers.length=0,this.coreComponents.forEach((Y)=>Y.destroy()),this.coreComponents.length=0;let J=this.config;J.xhrSetup=J.fetchSetup=void 0,this.userConfig=null}attachMedia(J){B.log("attachMedia"),this._media=J,this.trigger($.MEDIA_ATTACHING,{media:J})}detachMedia(){B.log("detachMedia"),this.trigger($.MEDIA_DETACHING,void 0),this._media=null}loadSource(J){this.stopLoad();let Y=this.media,Z=this.url,Q=this.url=DJ.buildAbsoluteURL(self.location.href,J,{alwaysNormalize:!0});if(this._autoLevelCapping=-1,this._maxHdcpLevel=null,B.log(`loadSource:${Q}`),Y&&Z&&(Z!==Q||this.bufferController.hasSourceTypes()))this.detachMedia(),this.attachMedia(Y);this.trigger($.MANIFEST_LOADING,{url:J})}startLoad(J=-1){B.log(`startLoad(${J})`),this.started=!0,this.resumeBuffering();for(let Y=0;Y<this.networkControllers.length;Y++)if(this.networkControllers[Y].startLoad(J),!this.started||!this.networkControllers)break}stopLoad(){B.log("stopLoad"),this.started=!1;for(let J=0;J<this.networkControllers.length;J++)if(this.networkControllers[J].stopLoad(),this.started||!this.networkControllers)break}resumeBuffering(){B.log("resume buffering"),this.networkControllers.forEach((J)=>{if(J.resumeBuffering)J.resumeBuffering()})}pauseBuffering(){B.log("pause buffering"),this.networkControllers.forEach((J)=>{if(J.pauseBuffering)J.pauseBuffering()})}swapAudioCodec(){B.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){B.log("recoverMediaError");let J=this._media;if(this.detachMedia(),J)this.attachMedia(J)}removeLevel(J){this.levelController.removeLevel(J)}get levels(){let J=this.levelController.levels;return J?J:[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(J){B.log(`set currentLevel:${J}`),this.levelController.manualLevel=J,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(J){B.log(`set nextLevel:${J}`),this.levelController.manualLevel=J,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(J){B.log(`set loadLevel:${J}`),this.levelController.manualLevel=J}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(J){this.levelController.nextLoadLevel=J}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(J){B.log(`set firstLevel:${J}`),this.levelController.firstLevel=J}get startLevel(){let J=this.levelController.startLevel;if(J===-1&&this.abrController.forcedAutoLevel>-1)return this.abrController.forcedAutoLevel;return J}set startLevel(J){if(B.log(`set startLevel:${J}`),J!==-1)J=Math.max(J,this.minAutoLevel);this.levelController.startLevel=J}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(J){let Y=!!J;if(Y!==this.config.capLevelToPlayerSize){if(Y)this.capLevelController.startCapping();else this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch();this.config.capLevelToPlayerSize=Y}}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator:J}=this.abrController;if(!J)return NaN;return J.getEstimate()}set bandwidthEstimate(J){this.abrController.resetEstimator(J)}get ttfbEstimate(){let{bwEstimator:J}=this.abrController;if(!J)return NaN;return J.getEstimateTTFB()}set autoLevelCapping(J){if(this._autoLevelCapping!==J)B.log(`set autoLevelCapping:${J}`),this._autoLevelCapping=J,this.levelController.checkMaxAutoUpdated()}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(J){if(cZ(J)&&this._maxHdcpLevel!==J)this._maxHdcpLevel=J,this.levelController.checkMaxAutoUpdated()}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels:J,config:{minAutoBitrate:Y}}=this;if(!J)return 0;let Z=J.length;for(let Q=0;Q<Z;Q++)if(J[Q].maxBitrate>=Y)return Q;return 0}get maxAutoLevel(){let{levels:J,autoLevelCapping:Y,maxHdcpLevel:Z}=this,Q;if(Y===-1&&J!=null&&J.length)Q=J.length-1;else Q=Y;if(Z)for(let X=Q;X--;){let q=J[X].attrs["HDCP-LEVEL"];if(q&&q<=Z)return X}return Q}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(J){this.abrController.nextAutoLevel=J}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(J){var Y;return(Y=this.audioTrackController)==null?void 0:Y.setAudioOption(J)}setSubtitleOption(J){var Y;return(Y=this.subtitleTrackController)==null||Y.setSubtitleOption(J),null}get allAudioTracks(){let J=this.audioTrackController;return J?J.allAudioTracks:[]}get audioTracks(){let J=this.audioTrackController;return J?J.audioTracks:[]}get audioTrack(){let J=this.audioTrackController;return J?J.audioTrack:-1}set audioTrack(J){let Y=this.audioTrackController;if(Y)Y.audioTrack=J}get allSubtitleTracks(){let J=this.subtitleTrackController;return J?J.allSubtitleTracks:[]}get subtitleTracks(){let J=this.subtitleTrackController;return J?J.subtitleTracks:[]}get subtitleTrack(){let J=this.subtitleTrackController;return J?J.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(J){let Y=this.subtitleTrackController;if(Y)Y.subtitleTrack=J}get subtitleDisplay(){let J=this.subtitleTrackController;return J?J.subtitleDisplay:!1}set subtitleDisplay(J){let Y=this.subtitleTrackController;if(Y)Y.subtitleDisplay=J}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(J){this.config.lowLatencyMode=J}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}l0.defaultConfig=void 0;export{HX as isSupported,k7 as isMSESupported,p0 as getMediaSource,l0 as default,M7 as TimelineController,q7 as SubtitleTrackController,Q7 as SubtitleStreamController,m as PlaylistLevelType,n8 as Part,q0 as NetworkErrorAction,A0 as MetadataSchema,q6 as LoadStats,Q6 as LevelKey,i8 as LevelDetails,m0 as Level,t as KeySystems,K0 as KeySystemFormats,UJ as HlsUrlParameters,A6 as HlsSkip,l0 as Hls,O6 as Fragment,E7 as FPSController,$ as Events,g as ErrorTypes,I as ErrorDetails,AY as ErrorController,O0 as ErrorActionFlags,n0 as EMEController,TJ as DateRange,b7 as ContentSteeringController,p6 as ChunkMetadata,nJ as CapLevelController,C7 as CMCDController,z7 as BufferController,g6 as BaseStreamController,SJ as BaseSegment,v6 as BasePlaylistController,Z7 as AudioTrackController,Y7 as AudioStreamController,J0 as AttrList,MY as AbrController};

//# debugId=D629B769CD9ECD1464756E2164756E21
//# sourceMappingURL=chunk-eyp45axx.js.map
